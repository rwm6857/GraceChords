name: Share Updates to Telegram

on:
  push:
    branches:
      - main
  workflow_dispatch: # allows manual run from Actions tab

jobs:
  announce:
    name: Post Update Summary to Telegram
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # needed for diff comparisons

      # 2ï¸âƒ£ Determine if update should be announced
      - name: Determine if update should be announced
        id: announce_check
        shell: bash
        run: |
          set -euo pipefail

          COMMIT_MSG="$(git log -1 --pretty=%B)"
          SHOULD_ANNOUNCE="false"

          echo "ðŸ” Checking commit message and changed files..."

          # 1ï¸âƒ£ Manual flags (case-insensitive)
          if echo "$COMMIT_MSG" | grep -Ei '\#post|\#announce|\[major\]|\[release\]' >/dev/null; then
            echo "âœ… Detected manual post flag in commit message."
            SHOULD_ANNOUNCE="true"
          fi

          # 2ï¸âƒ£ Auto-trigger for song/resource updates (guard first commit)
          if git rev-parse HEAD^ >/dev/null 2>&1 && \
             git diff --name-only HEAD^ HEAD | grep -E '^public/(songs|resources)/' >/dev/null 2>&1; then
            echo "âœ… Detected song or resource changes."
            SHOULD_ANNOUNCE="true"
          fi

          # 3ï¸âƒ£ Default: skip posting
          echo "should_announce=$SHOULD_ANNOUNCE" >> "$GITHUB_OUTPUT"
          echo "Announcement flag set to: $SHOULD_ANNOUNCE"

      # 3ï¸âƒ£ Get commit and diff info (only if posting)
      - name: Get recent commit info
        if: ${{ steps.announce_check.outputs.should_announce == 'true' }}
        id: commits
        shell: bash
        run: |
          set -euo pipefail
          message_file="$RUNNER_TEMP/commit_message.txt"
          diff_file="$RUNNER_TEMP/changed_files.txt"

          git log -1 --pretty=format:"%s%n%b" > "$message_file"
          if git rev-parse HEAD^ >/dev/null 2>&1; then
            git diff --name-only HEAD^ HEAD > "$diff_file"
          else
            git show --name-only --pretty="" HEAD > "$diff_file"
          fi

          echo "message_path=$message_file" >> "$GITHUB_OUTPUT"
          echo "diff_path=$diff_file" >> "$GITHUB_OUTPUT"

      # 4ï¸âƒ£ Generate AI-written summary via ChatGPT
      - name: Generate summary with ChatGPT
        if: ${{ steps.announce_check.outputs.should_announce == 'true' }}
        id: chatgpt
        shell: bash
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -euo pipefail

          message=$(cat "${{ steps.commits.outputs.message_path }}" 2>/dev/null || echo "")
          diff=$(cat "${{ steps.commits.outputs.diff_path }}" 2>/dev/null || echo "")

          payload=$(jq -n \
            --arg message "$message" \
            --arg diff "$diff" \
            '{
              model: "gpt-4o-mini",
              messages: [
                {
                  "role": "system",
                  "content": "You are the GraceChords Bot, a friendly, upbeat writer for end users. Write a short Telegram update with a casual, human voice. Keep it tight: 1â€“3 short sentences OR a tiny bullet list. Focus on whatâ€™s new or improved for users. You may add 1â€“2 fitting emojis, but donâ€™t overdo it. Use real newlines (no literal \\n). No hashtags or links. Do not copy the commit message; rephrase. If most changes are songs (public/songs), list the song names as bullets using readable titles (underscores â†’ spaces)."
                },
                {
                  "role": "user",
                  "content": ("Commit message:\\n" + $message + "\\n\\nChanged files:\\n" + $diff + "\\n\\nWrite a friendly, endâ€‘user update now. Keep it concise and approachable; 1â€“2 emojis max.")
                }
              ],
              max_tokens: 300,
              temperature: 0.7
            }')

          response=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d "$payload")

          summary=$(echo "$response" | jq -r '.choices[0].message.content // empty')
          if [ -z "$summary" ] || [ "$summary" = "null" ]; then
            summary="(No summary generated â€” possibly empty commit message)"
          fi
          printf "%s" "$summary" > "$RUNNER_TEMP/summary.txt"
          echo "summary_path=$RUNNER_TEMP/summary.txt" >> "$GITHUB_OUTPUT"

      # 5ï¸âƒ£ Send the formatted summary to Telegram (HTML with safe escaping)
      - name: Send update to Telegram
        if: ${{ steps.announce_check.outputs.should_announce == 'true' }}
        shell: bash
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          set -euo pipefail
          if [ -z "${TELEGRAM_BOT_TOKEN:-}" ] || [ -z "${TELEGRAM_CHAT_ID:-}" ]; then
            echo "Telegram secrets missing; skipping send." >&2
            exit 0
          fi

          # Load ChatGPT output from temp file
          summary="$(cat "${{ steps.chatgpt.outputs.summary_path }}" 2>/dev/null || true)"

          # Normalize any escaped newlines to real newlines
          summary=$(printf '%s' "$summary" | perl -pe 's/\r//g; s/\\r\\n|\r\n|\r|\n/\n/g; s/\\n/\n/g')

          if [ -z "$summary" ] || [ "$summary" = "null" ]; then
            summary="(No summary generated â€” possibly empty commit message)"
          fi

          # Replace markdown bullets with real bullets
          summary=$(printf '%s' "$summary" | sed -E 's/^[[:space:]]*-\s/â€¢ /')

          # Escape unsafe HTML chars for Telegram
          summary=$(printf '%s' "$summary" | sed -e 's/&/\&amp;/g' -e 's/</\&lt;/g' -e 's/>/\&gt;/g')

          title='<b>ðŸŽ¸ GraceChords Update</b>'
          footer='<i><a href="https://www.gracechords.com/">Check it out!</a></i>'
          text="$title\n\n$summary\n\n$footer"

          # Build payload with jq --arg (newlines preserved in JSON)
          payload=$(jq -n \
            --arg chat_id "$TELEGRAM_CHAT_ID" \
            --arg text "$text" \
            --arg mode "HTML" \
            '{chat_id: $chat_id, text: $text, parse_mode: $mode, disable_web_page_preview: true}')

          # Simulate a short, realistic typing delay
          delay=$((3 + RANDOM % 3))
          echo "GraceChords Bot is 'typing' for $delay seconds..."
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendChatAction" \
               -d chat_id="$TELEGRAM_CHAT_ID" \
               -d action="typing" >/dev/null || true
          sleep "$delay"

          # Send message
          curl -sS -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -H 'Content-Type: application/json' \
            -d "$payload"
