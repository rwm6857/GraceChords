name: Share Updates to Telegram

on:
  push:
    branches:
      - main
  workflow_dispatch: # allows manual trigger

jobs:
  announce:
    name: Post Update Summary to Telegram
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout repository for diff + commit info
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2ï¸âƒ£ Decide whether to post an update
      - name: Determine if update should be announced
        id: announce_check
        shell: bash
        run: |
          set -euo pipefail
          COMMIT_MSG="$(git log -1 --pretty=%B)"
          SHOULD_ANNOUNCE="false"

          echo "ðŸ” Checking commit message and changed files..."

          # Manual flags
          if echo "$COMMIT_MSG" | grep -Ei '\#post|\#announce|\[major\]|\[release\]' >/dev/null; then
            echo "âœ… Detected manual post flag in commit message."
            SHOULD_ANNOUNCE="true"
          fi

          # Auto-trigger: song or resource updates
          if git rev-parse HEAD^ >/dev/null 2>&1 && \
             git diff --name-only HEAD^ HEAD | grep -E '^public/(songs|resources)/' >/dev/null 2>&1; then
            echo "âœ… Detected song or resource changes."
            SHOULD_ANNOUNCE="true"
          fi

          echo "should_announce=$SHOULD_ANNOUNCE" >> "$GITHUB_OUTPUT"
          echo "Announcement flag set to: $SHOULD_ANNOUNCE"

      # 3ï¸âƒ£ Gather commit and diff info (only if posting)
      - name: Get recent commit info
        if: ${{ steps.announce_check.outputs.should_announce == 'true' }}
        id: commits
        shell: bash
        run: |
          set -euo pipefail
          message_file="$RUNNER_TEMP/commit_message.txt"
          diff_file="$RUNNER_TEMP/changed_files.txt"

          git log -1 --pretty=format:"%s%n%b" > "$message_file"
          if git rev-parse HEAD^ >/dev/null 2>&1; then
            git diff --name-only HEAD^ HEAD > "$diff_file"
          else
            git show --name-only --pretty="" HEAD > "$diff_file"
          fi

          echo "message_path=$message_file" >> "$GITHUB_OUTPUT"
          echo "diff_path=$diff_file" >> "$GITHUB_OUTPUT"

      # 4ï¸âƒ£ Generate a summary using ChatGPT
      - name: Generate summary with ChatGPT
        if: ${{ steps.announce_check.outputs.should_announce == 'true' }}
        id: chatgpt
        shell: bash
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -euo pipefail

          message=$(cat "${{ steps.commits.outputs.message_path }}" 2>/dev/null || echo "")
          diff=$(cat "${{ steps.commits.outputs.diff_path }}" 2>/dev/null || echo "")

          payload=$(jq -n \
            --arg message "$message" \
            --arg diff "$diff" \
            '{
              model: "gpt-4o-mini",
              messages: [
                {
                  "role": "system",
                  "content": "You are the GraceChords Bot, a friendly and upbeat writer. Write a short Telegram update for end users, in a casual tone. Keep it to 1â€“3 short sentences or a small bullet list. Use real newlines (no literal \\n). Avoid hashtags and links. You may include 1â€“2 fitting emojis."
                },
                {
                  "role": "user",
                  "content": ("Commit message:\\n" + $message + "\\n\\nChanged files:\\n" + $diff)
                }
              ],
              max_tokens: 300,
              temperature: 0.7
            }')

          response=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$payload")

          summary=$(echo "$response" | jq -r '.choices[0].message.content // empty')
          [ -z "$summary" ] || [ "$summary" = "null" ] && summary="(No summary generated â€” possibly empty commit message)"
          printf "%s" "$summary" > "$RUNNER_TEMP/summary.txt"
          echo "summary_path=$RUNNER_TEMP/summary.txt" >> "$GITHUB_OUTPUT"

      # 5ï¸âƒ£ Send formatted message to Telegram (with real newlines + typing delay)
      - name: Send update to Telegram
        if: ${{ steps.announce_check.outputs.should_announce == 'true' }}
        shell: bash
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          set -euo pipefail
          if [ -z "${TELEGRAM_BOT_TOKEN:-}" ] || [ -z "${TELEGRAM_CHAT_ID:-}" ]; then
            echo "âš ï¸ Telegram secrets missing; skipping send."
            exit 0
          fi

          summary="$(cat "${{ steps.chatgpt.outputs.summary_path }}" 2>/dev/null || true)"

          # Normalize newlines
          summary=$(printf '%s' "$summary" | perl -pe 's/\r//g; s/\\r\\n|\r\n|\r|\n/\n/g')
          [ -z "$summary" ] || [ "$summary" = "null" ] && summary="(No summary generated â€” possibly empty commit message)"

          # Replace leading "- " with "â€¢ "
          summary=$(printf '%s' "$summary" | sed -E 's/^[[:space:]]*-\s/â€¢ /')

          # Escape unsafe HTML chars
          summary=$(printf '%s' "$summary" | sed -e 's/&/\&amp;/g' -e 's/</\&lt;/g' -e 's/>/\&gt;/g')

          title='<b>ðŸŽ¸ GraceChords Update</b>'
          footer='<i><a href="https://www.gracechords.com/">Check it out!</a></i>'

          # Properly build text with *real newlines*
          text=$(printf "%b" "$title\n\n$summary\n\n$footer")

          # Use jq --rawfile to preserve newlines exactly
          payload=$(jq -n \
            --arg chat_id "$TELEGRAM_CHAT_ID" \
            --arg mode "HTML" \
            --rawfile text <(printf "%s" "$text") \
            '{chat_id: $chat_id, text: $text, parse_mode: $mode, disable_web_page_preview: true}')

          # Simulate "typing..." for 3â€“5 seconds
          delay=$((3 + RANDOM % 3))
          echo "âŒ› GraceChords Bot is typing for $delay seconds..."
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendChatAction" \
               -d chat_id="$TELEGRAM_CHAT_ID" \
               -d action="typing" >/dev/null || true
          sleep "$delay"

          echo "ðŸš€ Sending message to Telegram..."
          curl -sS -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
               -H 'Content-Type: application/json' \
               -d "$payload"

      # 6ï¸âƒ£ Debug output (always visible)
      - name: Debug summary output
        if: always()
        run: |
          echo "=== Announce Decision ==="
          echo "should_announce=${{ steps.announce_check.outputs.should_announce }}"
          echo
          echo "=== Commit Message ==="
          git log -1 --pretty=%B
          echo
          echo "=== Summary ==="
          cat "$RUNNER_TEMP/summary.txt" 2>/dev/null || echo "(none)"
