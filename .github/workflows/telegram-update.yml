name: Share Updates to Telegram

on:
  push:
    branches:
      - main
  workflow_dispatch: # allows manual run from Actions tab

jobs:
  announce:
    name: Post Update Summary to Telegram
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Get the latest commit message and changed files
      - name: Get recent commit info
        id: commits
        run: |
          # Capture latest commit message and body
          message=$(git log -1 --pretty=format:"%s%n%b")

          # Check if previous commit exists (avoids error on first commit)
          if git rev-parse HEAD^ >/dev/null 2>&1; then
            diff=$(git diff --name-only HEAD^ HEAD)
          else
            diff=$(git diff --name-only HEAD)
          fi

          # Write outputs properly with delimiters
          {
            echo "message<<EOF"
            echo "$message"
            echo "EOF"
            echo "diff<<EOF"
            echo "$diff"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      # 3Ô∏è‚É£ Generate AI-written summary via OpenAI (ChatGPT)
      - name: Generate summary with ChatGPT
        id: chatgpt
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # Build JSON payload safely with jq to avoid quote escaping issues
          payload=$(jq -n \
            --arg message "${{ steps.commits.outputs.message }}" \
            --arg diff "${{ steps.commits.outputs.diff }}" \
            '{
              model: "gpt-4o-mini",
              messages: [
                {
                  "role": "system",
                  "content": "You are the GraceChords Bot, a friendly but concise technical writer. Summarize GitHub updates for a public Telegram channel, focusing on new features, improvements, and bug fixes relevant to users."
                },
                {
                  "role": "user",
                  "content": ("Commit message:\\n" + $message + "\\n\\nChanged files:\\n" + $diff + "\\n\\nWrite a short, engaging update summary for Telegram. Include emojis if appropriate, use plain Markdown, and keep it under 100 words.")
                }
              ],
              max_tokens: 300,
              temperature: 0.7
            }')

          # Call OpenAI API
          response=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$payload")

          # Extract message content from API response
          summary=$(echo "$response" | jq -r '.choices[0].message.content')

          # Export for next step
          echo "summary<<EOF" >> "$GITHUB_OUTPUT"
          echo "$summary" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      # 4Ô∏è‚É£ Send the formatted summary to Telegram (with robust quoting)
      - name: Send update to Telegram
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          summary="${{ steps.chatgpt.outputs.summary }}"
          if [ -z "$summary" ] || [ "$summary" = "null" ]; then
            summary="(No summary generated ‚Äî possibly empty commit message)"
          fi

          # Encode safely for Telegram (handles emojis, newlines, quotes)
          text=$(printf "üé∏ *GraceChords Update*\n\n%s\n\n[View Commit](%s/%s/commit/%s)" \
            "$
