name: Share Updates to Telegram

on:
  push:
    branches:
      - main
  workflow_dispatch: # allows manual run from Actions tab

jobs:
  announce:
    name: Post Update Summary to Telegram
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # needed for diff comparisons

      # 2ï¸âƒ£ Determine if update should be announced
      - name: Determine if update should be announced
        id: announce_check
        shell: bash
        run: |
          set -euo pipefail

          COMMIT_MSG="$(git log -1 --pretty=%B)"
          SHOULD_ANNOUNCE="false"

          echo "ðŸ” Checking commit message and changed files..."

          # 1ï¸âƒ£ Manual flags (case-insensitive)
          if echo "$COMMIT_MSG" | grep -Ei '\#post|\#announce|\[major\]|\[release\]' >/dev/null; then
            echo "âœ… Detected manual post flag in commit message."
            SHOULD_ANNOUNCE="true"
          fi

          # 2ï¸âƒ£ Auto-trigger for song/resource updates
          if git diff --name-only HEAD^ HEAD | grep -E '^public/(songs|resources)/' >/dev/null 2>&1; then
            echo "âœ… Detected song or resource changes."
            SHOULD_ANNOUNCE="true"
          fi

          # 3ï¸âƒ£ Default: skip posting
          echo "should_announce=$SHOULD_ANNOUNCE" >> "$GITHUB_OUTPUT"
          echo "Announcement flag set to: $SHOULD_ANNOUNCE"

      # 3ï¸âƒ£ Get commit and diff info (only if posting)
      - name: Get recent commit info
        if: steps.announce_check.outputs.should_announce == 'true'
        id: commits
        run: |
          set -euo pipefail
          message_file="$RUNNER_TEMP/commit_message.txt"
          diff_file="$RUNNER_TEMP/changed_files.txt"

          git log -1 --pretty=format:"%s%n%b" > "$message_file"
          if git rev-parse HEAD^ >/dev/null 2>&1; then
            git diff --name-only HEAD^ HEAD > "$diff_file"
          else
            git show --name-only --pretty="" HEAD > "$diff_file"
          fi

          echo "message_path=$message_file" >> "$GITHUB_OUTPUT"
          echo "diff_path=$diff_file" >> "$GITHUB_OUTPUT"

      # 4ï¸âƒ£ Generate AI-written summary via ChatGPT
      - name: Generate summary with ChatGPT
        if: steps.announce_check.outputs.should_announce == 'true'
        id: chatgpt
        shell: bash
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -euo pipefail

          message=$(cat "${{ steps.commits.outputs.message_path }}" 2>/dev/null || echo "")
          diff=$(cat "${{ steps.commits.outputs.diff_path }}" 2>/dev/null || echo "")

          payload=$(jq -n \
            --arg message "$message" \
            --arg diff "$diff" \
            '{
              model: "gpt-4o-mini",
              messages: [
                {
                  "role": "system",
                  "content": "You are the GraceChords Bot, a friendly technical writer. Write a concise Telegram post (1â€“3 sentences or short bullet list). Focus on user-facing changes (Added, Updated, Fixed). Use plain text and real newlines; avoid literal \\n. No hashtags or links."
                },
                {
                  "role": "user",
                  "content": ("Commit message:\\n" + $message + "\\n\\nChanged files:\\n" + $diff)
                }
              ],
              max_tokens: 300,
              temperature: 0.7
            }')

          response=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d "$payload")

          summary=$(echo "$response" | jq -r '.choices[0].message.content // empty')
          if [ -z "$summary" ] || [ "$summary" = "null" ]; then
            summary="(No summary generated â€” possibly empty commit message)"
          fi
          printf "%s" "$summary"
