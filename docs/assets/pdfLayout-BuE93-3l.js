function j(o=""){return/^(?:verse(?:\s*\d+)?|chorus|bridge|tag|pre[-\s]?chorus|intro|outro|ending|refrain)\s*\d*$/i.test(String(o).trim())}function W(o){const S=h=>{const s=[];let t=null;const i=()=>{t&&t.lines.length&&s.push(t),t=null};for(const u of h||[]){if(u.section){i(),s.push(u);continue}for(const r of u.lines||[]){const n=r.plain||r.text||"";!!!(r.chordPositions&&r.chordPositions.length)&&j(n)?(i(),t={section:n.trim(),lines:[]}):(t||(t={lines:[]}),t.lines.push(r))}}return i(),s.length?s:h||[]};if(o!=null&&o.lyricsBlocks)return{title:o.title||"Untitled",key:o.key||o.originalKey||"C",lyricsBlocks:S(o.lyricsBlocks)};if(Array.isArray(o==null?void 0:o.blocks)){const h=[];let s={lines:[]};for(const t of o.blocks)t.type==="section"?(s.lines.length&&h.push(s),s={section:t.header,lines:[]}):t.type==="line"&&s.lines.push({plain:t.lyrics||t.text||"",chordPositions:(t.chords||[]).map(i=>({index:i.index??0,sym:i.sym}))});return s.lines.length&&h.push(s),{title:o.title||"Untitled",key:o.key||o.originalKey||"C",lyricsBlocks:S(h)}}return{title:(o==null?void 0:o.title)||"Untitled",key:(o==null?void 0:o.key)||(o==null?void 0:o.originalKey)||"C",lyricsBlocks:[]}}const L={lyricSizePt:16,chordSizePt:16,margin:36,gutter:18,headerOffsetY:54,columns:1,pageWidth:612,pageHeight:792,lyricFamily:"Helvetica",chordFamily:"Courier",title:"Untitled",key:"C"},R=6;function $(o,S,h,s,t,i){const u=s.margin,r=s.pageWidth-u*2,y=(S===2?(r-s.gutter)/2:r)-R,k=t(h),d=i(h);for(const f of o.lyricsBlocks||[])for(const c of f.lines||[]){const a=c.plain||c.text||"";if(k(a)>y)return!0;for(const z of c.chordPositions||[]){const H=k(a.slice(0,z.index||0)),F=d(z.sym||"");if(H+F>y)return!0}}return!1}function q(o,S={},h=()=>()=>0,s=()=>()=>0){const t=W(o),i={...L,...S},u=12,r=i.lyricSizePt,n=[],y=(c,a)=>{const z=E(t,{...i,columns:c,lyricSizePt:a,chordSizePt:a},h(a)),H=!$(t,c,a,i,h,s);return{columns:c,lyricSizePt:a,chordSizePt:a,layout:z,widthOk:H}},k=i.columns===2?2:1;n.push(y(k,r));let d=n[n.length-1];if(k===1&&(d.layout.pages.length>1||!d.widthOk)){let c=r;for(n.push(y(2,c)),d=n[n.length-1];(d.layout.pages.length>1||!d.widthOk)&&c>u;)c--,d=y(2,c),n.push(d)}else{let c=r;for(;(d.layout.pages.length>1||!d.widthOk)&&c>u;)c--,d=y(k,c),n.push(d)}n.sort((c,a)=>c.layout.pages.length!==a.layout.pages.length?c.layout.pages.length-a.layout.pages.length:c.widthOk!==a.widthOk?c.widthOk?-1:1:c.columns!==a.columns?c.columns-a.columns:a.lyricSizePt-c.lyricSizePt);const f=n[0];return{plan:{...i,columns:f.columns,lyricSizePt:f.lyricSizePt,chordSizePt:f.chordSizePt,layout:f.layout},chosenOpts:{columns:f.columns,lyricSizePt:f.lyricSizePt,chordSizePt:f.chordSizePt}}}function E(o,S={},h=s=>0){const s=W(o),t={...L,...S},i=4,u=t.lyricSizePt,r=Math.round(t.lyricSizePt*.85),n=t.margin,y=t.pageHeight,k=t.pageWidth-n*2,d=t.columns===2?(k-t.gutter)/2:k,f=n+t.headerOffsetY,c=y-n,a=[];let z={columns:[]};a.push(z);function H(){const e={x:n,yStart:f,blocks:[]};if(z.columns.push(e),t.columns===2){const l={x:n+d+t.gutter,yStart:f,blocks:[]};z.columns.push(l)}}function F(){z={columns:[]},a.push(z)}z.columns.length===0&&H(),s.lyricsBlocks=(s.lyricsBlocks||[]).map(e=>{if(!(e!=null&&e.section)&&Array.isArray(e==null?void 0:e.lines)&&e.lines.length){const l=e.lines[0],P=(l==null?void 0:l.plain)||(l==null?void 0:l.text)||"";if(!(Array.isArray(l==null?void 0:l.chordPositions)&&l.chordPositions.length>0)&&j(P))return{section:P.trim(),lines:e.lines.slice(1)}}return e});let B=0,p=f;const U=()=>z.columns[B],A=()=>{t.columns===2&&B===0?(B=1,p=f):(F(),H(),B=0,p=f)},G=(e,l=0,P=(g=>(g=e.lines)==null?void 0:g.length)()??0)=>{var O;let x=0;!!e.section&&l===0&&(x+=r+u+4);for(let w=l;w<P;w++){const m=e.lines[w];(O=m==null?void 0:m.chordPositions)!=null&&O.length&&(x+=t.chordSizePt+i/2),x+=t.lyricSizePt+i}return x+4},v=e=>{var l;return((l=e==null?void 0:e.chordPositions)!=null&&l.length?t.chordSizePt+i/2:0)+t.lyricSizePt+i},I=(e,l)=>{e.blocks.push({type:"section",header:l})},K=(e,l,P)=>{e.blocks.push({type:"line",lyrics:l,chords:P.map(g=>({x:h(l.slice(0,g.index||0)),sym:g.sym}))})};for(const e of s.lyricsBlocks||[]){const l=G(e);if(p+l<=c){const x=U();e.section&&(p+=r,I(x,e.section),p+=u+4);for(const C of e.lines||[]){const O=C.plain||C.text||"",w=C.chordPositions||[];K(x,O,w),p+=v(C)}p+=4;continue}const P=(e.lines||[]).map(v);let g=0;for(;g<(e.lines||[]).length;){const x=(e.lines||[]).length-g,C=g===0&&e.section?r+u+4:0,O=P[g]||0;if(p+C+O>c){A();continue}const w=c-p-C;let m=0,T=0;for(;g+m<P.length&&T+P[g+m]<=w;)T+=P[g+m],m++;if(m===1&&x>1){A();continue}if(x-m===1)if(m>1)T-=P[g+m-1],m--;else{A();continue}const M=U();g===0&&e.section&&(p+=r,I(M,e.section),p+=u+4);for(let _=0;_<m;_++){const Y=e.lines[g],D=Y.plain||Y.text||"",N=Y.chordPositions||[];K(M,D,N),p+=P[g],g++}p+=4,g<(e.lines||[]).length&&A()}}return{pages:a}}function J(o,S){const h={...L,...S};h.pageWidth=612,h.pageHeight=792;const s=i=>i?i.length*(h.lyricSizePt*.6):0;return E(W(o),h,s).pages.map((i,u)=>({p:u,cols:i.columns.map((r,n)=>({c:n,blocks:r.blocks.map(y=>({t:y.type,h:y.type==="section"&&y.header||null,line:y.type==="line"?{text:y.lyrics,chords:(y.chords||[]).map(k=>({x:Number(k.x.toFixed(2)),s:k.sym}))}:null}))}))}))}function Q(o,S){const h=W(o),s={...L,...S};s.pageWidth=612,s.pageHeight=792;const t=r=>n=>n?n.length*(r*.6):0,i=r=>n=>n?n.length*(r*.6):0,{plan:u}=q(h,s,t,i);return{columns:u.columns,size:u.lyricSizePt,pages:u.layout.pages.length}}export{L as DEFAULT_LAYOUT_OPT,q as chooseBestLayout,J as getLayoutMetrics,W as normalizeSongInput,Q as planForTest,E as planSongLayout};
