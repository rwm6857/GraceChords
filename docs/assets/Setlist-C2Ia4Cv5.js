const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./jszip.min-C3rDzrTz.js","./index-CVYoEt3M.js","./index-BDqcYvTh.css","./index-61OuE0Mu.js"])))=>i.map(i=>d[i]);
import{_ as ye,j as n,u as it,a as at,b as ot,r as b,i as lt,d as ct,F as dt,B as E,c as ut,T as Ae,D as re,L as Me,e as Le,M as Ce,S as pt,C as mt,P as $e,f as ft,I as ht,g as Re,K as gt,A as yt,h as xt,k as wt,l as bt,m as Tt,p as St,s as Nt,t as Pt,n as jt,o as It,q as Y}from"./index-CVYoEt3M.js";import{P as Et}from"./PageContainer-KmY8kVtt.js";const Xe="gracechords.sets.v1";function he(){try{const e=localStorage.getItem(Xe);return e?JSON.parse(e):{sets:{}}}catch{return{sets:{}}}}function Ue(e){localStorage.setItem(Xe,JSON.stringify(e))}function vt(){return typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():"id-"+Math.random().toString(36).slice(2)+Date.now().toString(36)}function le(){const{sets:e}=he();return Object.values(e).sort((t,r)=>(r.updatedAt||0)-(t.updatedAt||0))}function At(e){const{sets:t}=he();return t[e]||null}function De(e){const t=Date.now(),r={id:e.id||vt(),name:e.name?.trim()||"Untitled Set",items:Array.isArray(e.items)?e.items:[],createdAt:e.createdAt||t,updatedAt:t},c=he();return c.sets[r.id]=r,Ue(c),r}function Mt(e){const t=he();return t.sets[e]?(delete t.sets[e],Ue(t),!0):!1}const Lt="application/vnd.openxmlformats-officedocument.presentationml.slide+xml",_e="application/vnd.openxmlformats-officedocument.presentationml.slideMaster+xml",Ct="application/vnd.openxmlformats-officedocument.presentationml.slideLayout+xml",$t="application/vnd.openxmlformats-officedocument.theme+xml",U="http://schemas.openxmlformats.org/presentationml/2006/main",xe="http://schemas.openxmlformats.org/officeDocument/2006/relationships",ke="application/vnd.openxmlformats-officedocument.presentationml.notesMaster+xml",Rt=new DOMParser,Dt=new XMLSerializer;function _t(e){const t="setlist",r=String(e).trim();return r&&r.replace(/\s+/g,"_").replace(/[^A-Za-z0-9_.-]/g,"_").replace(/_+/g,"_").replace(/^_+|_+$/g,"")||t}async function Be(e){const t=await fetch(e);if(!t.ok)throw new Error(`Failed to load PPTX: ${e}`);return t.arrayBuffer()}function J(e){const t=Rt.parseFromString(e,"application/xml"),r=t.getElementsByTagName("parsererror")[0];if(r)throw new Error(r.textContent||"Failed to parse XML");return t}function ce(e){return Dt.serializeToString(e)}function k(e){const t=String(e||"").match(/(\d+)$/);return t?Number(t[1]):0}function ne(e,t){let r=0;return e.filter(c=>t.test(c)).forEach(c=>{const i=c.name.match(t);if(!i)return;const d=Number(i[1]);Number.isNaN(d)||(r=Math.max(r,d))}),r}function Fe(e,t,r){if(Array.from(e.getElementsByTagName("Override")).some(d=>d.getAttribute("PartName")===t))return;const i=e.createElement("Override");i.setAttribute("PartName",t),i.setAttribute("ContentType",r),e.documentElement.appendChild(i)}function ie(e,t){if(!t)return null;if(t.startsWith("/"))return t.slice(1);const r=e.split("/");r.pop();const c=t.split("/");for(const i of c)if(i==="..")r.pop();else{if(i===".")continue;r.push(i)}return r.join("/")}function Z(e,t){const r=e.split("/");r.pop();const c=t.split("/");let i=0;for(;i<r.length&&i<c.length&&r[i]===c[i];)i++;const d=r.length-i,p=[];for(let m=0;m<d;m++)p.push("..");return p.push(...c.slice(i)),p.join("/")}function We(e){const t=e.match(/^(.*\/)([^/]*?)(\d+)(\.[^.]+)$/);return t?{dir:t[1],prefix:t[2],number:Number(t[3]),ext:t[4]}:null}function q(e,t,r){const c=Number(e[t]||0);r>c&&(e[t]=r)}function ze(e,t){const c=Number(e[t]||0)+1;return e[t]=c,c}function B(e,t){if(!e)return null;const r=e.file(t);return Array.isArray(r)?r.length?r[0]:null:r||null}function ae(e){const t=e.lastIndexOf("/"),r=t>=0?e.slice(0,t+1):"",c=t>=0?e.slice(t+1):e;return`${r}_rels/${c}.rels`}function kt(e,t){if(!e||!t)return{contentType:"",fromOverride:!1,extension:""};const r=`/${t}`,i=Array.from(e.getElementsByTagName("Override")).find(f=>f.getAttribute("PartName")===r);if(i)return{contentType:i.getAttribute("ContentType")||"",fromOverride:!0,extension:t.split(".").pop()||""};const d=Array.from(e.getElementsByTagName("Default")),p=t.split(".").pop()||"",m=d.find(f=>f.getAttribute("Extension")===p);return m?{contentType:m.getAttribute("ContentType")||"",fromOverride:!1,extension:p}:{contentType:"",fromOverride:!1,extension:p}}function Bt(e,t,r){if(!r||Array.from(e.getElementsByTagName("Default")).some(p=>p.getAttribute("Extension")===r))return;const i=Array.from(t?.getElementsByTagName?.("Default")||[]).find(p=>p.getAttribute("Extension")===r);if(!i)return;const d=e.createElement("Default");d.setAttribute("Extension",r),d.setAttribute("ContentType",i.getAttribute("ContentType")||""),e.documentElement.appendChild(d)}function Ot(e){return e?!/xml|text|application\/(.*\+xml)/i.test(e):!1}function Kt(e){const t=/(.*\D)(\d+)(\.\w+)$/,r=e&&e.match(t);if(r){const[,c,,i]=r;return d=>`${c}${d}${i}`}return c=>`slides/slide${c}.xml`}async function Xt(e){const t="ppt/presentation.xml",r=B(e,t);if(!r)throw new Error("Base PPTX missing ppt/presentation.xml");const c=await r.async("string"),i=J(c),d=i.getElementsByTagNameNS(U,"sldIdLst")[0]||i.getElementsByTagName("p:sldIdLst")[0],m=(d?Array.from(d.getElementsByTagNameNS(U,"sldId")).concat(Array.from(d.getElementsByTagName("p:sldId"))):[]).reduce((g,w)=>{const j=Number(w.getAttribute("id"));return Number.isNaN(j)?g:Math.max(g,j)},255),f="ppt/_rels/presentation.xml.rels",T=B(e,f);if(!T)throw new Error("Base PPTX missing ppt/_rels/presentation.xml.rels");const y=await T.async("string"),v=J(y),u=Array.from(v.getElementsByTagName("Relationship")),A=u.reduce((g,w)=>{const j=k(w.getAttribute("Id"));return Math.max(g,j)},0),D=u.filter(g=>(g.getAttribute("Type")||"").endsWith("/slide")),S=D.length&&D[0].getAttribute("Target")||"",N=Kt(S),M=i.getElementsByTagNameNS(U,"sldMasterIdLst")[0]||i.getElementsByTagName("p:sldMasterIdLst")[0]||null,$=(M?Array.from(M.getElementsByTagNameNS(U,"sldMasterId")).concat(Array.from(M.getElementsByTagName("p:sldMasterId"))):[]).reduce((g,w)=>{const j=Number(w.getAttribute("id"));return Number.isNaN(j)?g:Math.max(g,j)},2147483647),F=i.getElementsByTagNameNS(U,"notesMasterIdLst")[0]||i.getElementsByTagName("p:notesMasterIdLst")[0]||null;let O=null;const V=u.find(g=>(g.getAttribute("Type")||"").endsWith("/notesMaster"));if(V){const g=V.getAttribute("Target")||"";O=ie("ppt/presentation.xml",g)}let G=null;const oe=u.find(g=>(g.getAttribute("Type")||"").endsWith("/theme"));if(oe){const g=oe.getAttribute("Target")||"";G=ie("ppt/presentation.xml",g)}const W="[Content_Types].xml",Q=B(e,W);if(!Q)throw new Error("Base PPTX missing [Content_Types].xml");const ge=await Q.async("string"),de=J(ge),_={};e.filter(()=>!0).forEach(g=>{const w=We(g.name);if(!w)return;const j=`${w.dir}${w.prefix}`;q(_,j,w.number)}),q(_,"ppt/slides/slide",ne(e,/^ppt\/slides\/slide(\d+)\.xml$/)),q(_,"ppt/notesSlides/notesSlide",ne(e,/^ppt\/notesSlides\/notesSlide(\d+)\.xml$/)),q(_,"ppt/slideMasters/slideMaster",ne(e,/^ppt\/slideMasters\/slideMaster(\d+)\.xml$/)),q(_,"ppt/slideLayouts/slideLayout",ne(e,/^ppt\/slideLayouts\/slideLayout(\d+)\.xml$/)),q(_,"ppt/theme/theme",ne(e,/^ppt\/theme\/theme(\d+)\.xml$/)),q(_,"ppt/notesMasters/notesMaster",ne(e,/^ppt\/notesMasters\/notesMaster(\d+)\.xml$/)),q(_,"ppt/media/image",ne(e,/^ppt\/media\/image(\d+)\.[^.]+$/));const K=e.file(/^ppt\/slides\/slide\d+\.xml$/).sort((g,w)=>k(g.name)-k(w.name));let X="",L="",ee="";if(K.length){const g=K[0],w=B(e,ae(g.name));if(w){const j=J(await w.async("string")),z=Array.from(j.getElementsByTagName("Relationship")).find(R=>(R.getAttribute("Type")||"").endsWith("/slideLayout"));if(z){X=z.getAttribute("Target")||"";const R=ie(g.name,X);R&&B(e,R)&&(L=R)}}}if(L)!X&&K.length&&(X=Z(K[0].name,L));else{const g=e.file(/^ppt\/slideLayouts\/.*\.xml$/).sort((w,j)=>k(w.name)-k(j.name));g.length&&(L=g[0].name,X=K.length?Z(K[0].name,L):"../slideLayouts/slideLayout1.xml")}if(L){const g=B(e,ae(L));if(g){const w=J(await g.async("string")),H=Array.from(w.getElementsByTagName("Relationship")).find(z=>(z.getAttribute("Type")||"").endsWith("/slideMaster"));if(H){const z=H.getAttribute("Target")||"",R=ie(L,z);R&&B(e,R)&&(ee=R)}}}if(!ee){const g=e.file(/^ppt\/slideMasters\/.*\.xml$/).sort((w,j)=>k(w.name)-k(j.name));g.length&&(ee=g[0].name)}if(!O){const g=e.file(/^ppt\/notesMasters\/.*\.xml$/).sort((w,j)=>k(w.name)-k(j.name));g.length&&(O=g[0].name)}return{zip:e,presentationXmlPath:t,presentationDoc:i,sldIdList:d,sldMasterList:M,notesMasterList:F,presentationRelsPath:f,presentationRelsDoc:v,contentTypesPath:W,contentTypesDoc:de,nextSlideId:m,nextRelId:A,nextMasterId:$,counters:_,partMap:new Map,masterRelMap:new Map,notesMasterRelMap:new Map,getSlideTarget:N,defaultLayoutTarget:X,defaultLayoutPath:L,defaultMasterPath:ee,defaultNotesMasterPath:O,defaultThemePath:G}}function Ut(e,t,r){const c=e.presentationRelsDoc.documentElement,i=e.presentationRelsDoc.createElement("Relationship");i.setAttribute("Id",r),i.setAttribute("Type","http://schemas.openxmlformats.org/officeDocument/2006/relationships/slide");const d=e.getSlideTarget?e.getSlideTarget(t):`slides/slide${t}.xml`;i.setAttribute("Target",d),c.appendChild(i)}function Ft(e,t){const r=e.presentationDoc,c=e.sldIdList||(()=>{const d=r.createElementNS(U,"p:sldIdLst");return r.documentElement.appendChild(d),e.sldIdList=d,d})(),i=r.createElementNS(U,"p:sldId");e.nextSlideId+=1,i.setAttribute("id",String(e.nextSlideId)),i.setAttributeNS(xe,"r:id",t),c.appendChild(i)}function Wt(e,t){if(e.masterRelMap.has(t))return e.masterRelMap.get(t);const r=e.presentationDoc,c=e.presentationRelsDoc;let i=e.sldMasterList;if(!i){i=r.createElementNS(U,"p:sldMasterIdLst");const f=r.documentElement.firstChild;f?r.documentElement.insertBefore(i,f):r.documentElement.appendChild(i),e.sldMasterList=i}e.nextMasterId=Number(e.nextMasterId||2147483647),e.nextMasterId+=1,e.nextRelId+=1;const d=`rId${e.nextRelId}`,p=r.createElementNS(U,"p:sldMasterId");p.setAttribute("id",String(e.nextMasterId)),p.setAttributeNS(xe,"r:id",d),i.appendChild(p);const m=c.createElement("Relationship");return m.setAttribute("Id",d),m.setAttribute("Type","http://schemas.openxmlformats.org/officeDocument/2006/relationships/slideMaster"),m.setAttribute("Target",Z("ppt/presentation.xml",t)),c.documentElement.appendChild(m),e.masterRelMap.set(t,d),d}function zt(e,t){if(e.notesMasterRelMap.has(t))return e.notesMasterRelMap.get(t);const r=e.presentationDoc,c=e.presentationRelsDoc;let i=e.notesMasterList;if(!i){i=r.createElementNS(U,"p:notesMasterIdLst");const f=r.documentElement,T=e.sldIdList||f.firstChild;T?f.insertBefore(i,T):f.appendChild(i),e.notesMasterList=i}e.nextRelId+=1;const d=`rId${e.nextRelId}`,p=r.createElementNS(U,"p:notesMasterId");p.setAttributeNS(xe,"r:id",d),i.appendChild(p);const m=c.createElement("Relationship");return m.setAttribute("Id",d),m.setAttribute("Type","http://schemas.openxmlformats.org/officeDocument/2006/relationships/notesMaster"),m.setAttribute("Target",Z("ppt/presentation.xml",t)),c.documentElement.appendChild(m),e.notesMasterRelMap.set(t,d),d}async function fe(e,t,r,c,i,d={}){if(!i)return null;const p=`${c}:${i}`;if(e.partMap.has(p))return e.partMap.get(p);const m=kt(r,i),f=B(t,i);if(!f)return null;if(m.contentType===Ct&&e.defaultLayoutPath)return e.partMap.set(p,e.defaultLayoutPath),e.defaultLayoutPath;if(m.contentType===_e&&e.defaultMasterPath)return e.partMap.set(p,e.defaultMasterPath),e.defaultMasterPath;if(m.contentType===ke&&e.defaultNotesMasterPath)return e.partMap.set(p,e.defaultNotesMasterPath),e.defaultNotesMasterPath;if(m.contentType===$t&&e.defaultThemePath)return e.partMap.set(p,e.defaultThemePath),e.defaultThemePath;const T=We(i);let y;if(T){const D=`${T.dir}${T.prefix}`,S=ze(e.counters,D);y=`${T.dir}${T.prefix}${S}${T.ext}`}else{if(B(e.zip,i))return e.partMap.set(p,i),i;y=i}e.partMap.set(p,y),m.fromOverride?Fe(e.contentTypesDoc,`/${y}`,m.contentType):m.extension&&Bt(e.contentTypesDoc,r,m.extension);const v=await f.async(Ot(m.contentType)?"uint8array":"string");e.zip.file(y,v);const u=ae(i),A=B(t,u);if(A){const D=await A.async("string"),S=J(D),N=Array.from(S.getElementsByTagName("Relationship"));for(const P of N){if((P.getAttribute("TargetMode")||"").toLowerCase()==="external")continue;const F=P.getAttribute("Target")||"",O=ie(i,F);if(!O)continue;let V=null;if(typeof d.relationshipMutator=="function"){const W=await d.relationshipMutator({node:P,type:P.getAttribute("Type")||"",absolutePath:O,newPartPath:y,originalPartPath:i});if(W===!1)continue;W&&W.targetPath&&(V=W.targetPath)}const G=V||await fe(e,t,r,c,O);if(!G)continue;const oe=Z(y,G);P.setAttribute("Target",oe)}const M=ae(y);e.zip.file(M,ce(S))}return m.contentType===_e?Wt(e,y):m.contentType===ke&&zt(e,y),y}async function Yt(e,t,r,c,i,d){const p=ae(i),m=B(t,p);if(!m)return;const f=await m.async("string"),T=J(f),y=Array.from(T.getElementsByTagName("Relationship")),v=T.documentElement;let u=!1,A=y.reduce((S,N)=>{const M=N.getAttribute("Id")||"";return Math.max(S,k(M))},0);for(const S of y){const N=S.getAttribute("Type")||"",M=S.getAttribute("Target")||"";if(!M)continue;const P=ie(i,M);if(P){if(N.endsWith("/slideLayout")){e.defaultLayoutTarget?u?v.removeChild(S):(u=!0,S.setAttribute("Target",e.defaultLayoutTarget)):u?v.removeChild(S):u=!0;continue}if(N.endsWith("/notesSlide")){const $=await fe(e,t,r,c,P,{relationshipMutator:({type:F})=>F.endsWith("/slide")?{targetPath:d}:null});if(!$)continue;S.setAttribute("Target",Z(d,$))}else if(N.includes("/image")||N.includes("/audio")||N.includes("/video")){const $=await fe(e,t,r,c,P);if(!$)continue;S.setAttribute("Target",Z(d,$))}else{const $=await fe(e,t,r,c,P);if(!$)continue;S.setAttribute("Target",Z(d,$))}}}if(!u&&e.defaultLayoutTarget){const S=T.createElement("Relationship"),N=`rId${A+1||1}`;S.setAttribute("Id",N),S.setAttribute("Type","http://schemas.openxmlformats.org/officeDocument/2006/relationships/slideLayout"),S.setAttribute("Target",e.defaultLayoutTarget),v.appendChild(S)}const D=ae(d);e.zip.file(D,ce(T))}async function Ht(e,t,r){const c=t.file(/^ppt\/slides\/slide\d+\.xml$/).sort((p,m)=>{const f=k(p.name),T=k(m.name);return f-T});if(!c.length)return;const i=B(t,"[Content_Types].xml");if(!i)throw new Error("Source PPTX missing [Content_Types].xml");const d=J(await i.async("string"));for(const p of c){const m=ze(e.counters,"ppt/slides/slide"),f=`ppt/slides/slide${m}.xml`,T=await p.async("string");e.zip.file(f,T),Fe(e.contentTypesDoc,`/${f}`,Lt),e.nextRelId+=1;const y=`rId${e.nextRelId}`;Ut(e,m,y),Ft(e,y);const v=p.name;e.partMap.set(`${r}:${v}`,f),await Yt(e,t,d,r,v,f)}}function qt(e){e.zip.file(e.presentationXmlPath,ce(e.presentationDoc)),e.zip.file(e.presentationRelsPath,ce(e.presentationRelsDoc)),e.zip.file(e.contentTypesPath,ce(e.contentTypesDoc))}function Jt(e,t){const r=document.createElement("a");r.href=URL.createObjectURL(e),r.download=t,r.rel="noopener",r.click(),URL.revokeObjectURL(r.href)}async function Zt(e=[],t="Setlist"){if(!Array.isArray(e)||e.length===0)throw new Error("No PPTX files to merge");const r=(await ye(async()=>{const{default:y}=await import("./jszip.min-C3rDzrTz.js").then(v=>v.j);return{default:y}},__vite__mapDeps([0,1,2]),import.meta.url)).default,[c,...i]=e,d=await Be(c),p=await r.loadAsync(d),m=await Xt(p);for(let y=0;y<i.length;y++){const v=await Be(i[y]),u=await r.loadAsync(v);await Ht(m,u,`src${y+1}`)}qt(m);const f=await p.generateAsync({type:"blob"}),T=_t(t||"Setlist");Jt(f,`${T}.pptx`)}function Vt(e){const t=e||"/";return t.endsWith("/")?t:`${t}/`}function Gt(e){return e?e.slug?e.slug:e.filename?e.filename.replace(/\.chordpro$/i,""):e.title?e.title.trim().toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_.-]/g,""):"":""}async function Qt(e={},t={}){const{name:r="Setlist",songs:c=[]}=e||{},{availablePptxMap:i=null,baseUrl:d="./",onEmpty:p}=t,m=Vt(d),f=[];for(const T of c){const y=Gt(T);y&&(i&&!i[y]||f.push(`${m}pptx/${y}.pptx`))}if(!f.length){typeof p=="function"&&p();return}await Zt(f,r)}function en({label:e,id:t,children:r,className:c="",...i}){return n.jsxs("label",{className:"gc-field",htmlFor:t,children:[e?n.jsx("span",{className:"gc-label",children:e}):null,n.jsx("span",{className:"gc-select",children:n.jsx("select",{id:t,className:c,...i,children:r})})]})}let Oe;const Ke=()=>Oe||(Oe=ye(()=>import("./index-61OuE0Mu.js").then(e=>e.i),__vite__mapDeps([3,1,2]),import.meta.url));function tn(){try{if(typeof crypto<"u"&&crypto.randomUUID)return crypto.randomUUID()}catch{}return`sel-${Math.random().toString(36).slice(2)}${Date.now().toString(36)}`}function Ye(e){if(!e)return null;const{id:t,toKey:r=""}=e;return t==null?null:{uid:tn(),id:t,toKey:r}}function me(e=[]){return e.map(t=>Ye(t)).filter(Boolean)}function rn(){const{code:e,songIds:t}=it(),r=at(),c=ot(),[i,d]=b.useState("New Setlist"),[p,m]=b.useState(""),[f,T]=b.useState([]),[y,v]=b.useState(()=>{try{return localStorage.getItem("pref:icpOnly")==="1"}catch{return!1}});b.useEffect(()=>{try{localStorage.setItem("pref:icpOnly",y?"1":"0")}catch{}},[y]);const[u,A]=b.useState([]),[D,S]=b.useState({}),[N,M]=b.useState(""),[P,$]=b.useState("");Object.keys(D).length;const[F,O]=b.useState(!1),[V,G]=b.useState(()=>{try{return window.innerWidth<=640}catch{return!1}}),[oe,W]=b.useState(()=>{try{return window.innerWidth<=820}catch{return!1}}),[Q,ge]=b.useState(()=>{try{return window.innerWidth<=900}catch{return!1}}),de=b.useRef(""),_=b.useRef(""),[K,X]=b.useState(null),[L,ee]=b.useState(()=>le()),[g,w]=b.useState(""),[j,H]=b.useState(!1),[z,R]=b.useState("");b.useEffect(()=>{const s=lt?.items||[],a=new Set,l=[];for(const o of s)a.has(o.id)||(a.add(o.id),l.push(o));T(l)},[]),b.useEffect(()=>{let s=!1;async function a(){const l={};for(const o of u){const h=f.find(se=>se.id===o.id);if(!h)continue;const x=h.filename.replace(/\.chordpro$/i,""),I=`./pptx/${x}.pptx`;await bt(I,x)&&(l[x]=!0)}s||S(l)}return a(),()=>{s=!0}},[u,f]),b.useEffect(()=>{try{const s=document.documentElement,a=document.body;de.current=s.style.overflowY||"",_.current=a.style.overflowY||"",getComputedStyle(s).overflowY==="hidden"&&(s.style.overflowY=""),getComputedStyle(a).overflowY==="hidden"&&(a.style.overflowY="")}catch{}return()=>{try{document.documentElement.style.overflowY=de.current,document.body.style.overflowY=_.current}catch{}}},[]),b.useEffect(()=>{if(!e)return;const{entries:s,error:a}=ct(e);if(a){alert(a),c("/setlist",{replace:!0});return}const l=s.map(x=>({id:x.id,toKey:x.toKey}));A(me(l));const o=l.map(x=>x.id).join(","),h=l.map(x=>encodeURIComponent(x.toKey||"")).join(",");c(`/setlist/${o}?toKeys=${h}`,{replace:!0})},[e]),b.useEffect(()=>{if(!t)return;const s=(t||"").split(",").map(h=>h.trim()).filter(Boolean);if(!s.length)return;const l=(new URLSearchParams(r.search||"").get("toKeys")||"").split(",").map(h=>decodeURIComponent(h)).filter(Boolean),o=s.map((h,x)=>({id:h,toKey:l[x]||""}));A(me(o))},[t,r.search]),b.useEffect(()=>{try{if(!Array.isArray(u))return;if(u.length===0){(e||t)&&c("/setlist",{replace:!0});return}const s=u.map(h=>h.id).join(","),a=u.map(h=>encodeURIComponent(h.toKey||"")).join(","),l=t||"",o=new URLSearchParams(r.search||"").get("toKeys")||"";(s!==l||a!==o)&&c(`/setlist/${s}?toKeys=${a}`,{replace:!0})}catch{}},[u.map(s=>`${s.id}:${s.toKey}`).join("|"),t,r.search,e]),b.useEffect(()=>{try{const s=localStorage.getItem("setlist");if(!s||le().length>0)return;const a=JSON.parse(s);if(a?.name||(a?.list?.length||0)>0){const l=De({name:a.name||"Imported Set",items:a.list||[]});ee(le()),X(l.id),d(l.name),A(me(l.items||[])),w(l.id)}}catch{}},[]),b.useEffect(()=>{function s(){try{const a=window.innerWidth;G(a<=640),W(a<=820),ge(a<=900)}catch{}}return window.addEventListener("resize",s),()=>window.removeEventListener("resize",s)},[]);const ue=b.useMemo(()=>new dt(f,{keys:["title","tags"],threshold:.4}),[f]);function He(s){return!y||(Array.isArray(s.tags)?s.tags.includes("ICP"):s.tags==="ICP")}const qe=b.useMemo(()=>(p?ue.search(p).map(a=>a.item):f.slice().sort((a,l)=>a.title.localeCompare(l.title))).filter(He),[p,ue,f,y]);function we(s){if(!s)return;const a=Ye({id:s.id,toKey:s.originalKey||s.key||"C"});A(l=>[...l,a])}function Je(s){A(a=>a.filter(l=>l.uid!==s))}function be(s,a){A(l=>{const o=l.findIndex(C=>C.uid===s);if(o<0)return l;const h=o+(a==="up"?-1:1);if(h<0||h>=l.length)return l;const x=l.slice(),[I]=x.splice(o,1);return x.splice(h,0,I),x})}function Ze(s,a){A(l=>{if(a<0||a>=l.length)return l;const o=l.findIndex(I=>I.uid===s);if(o<0||o===a)return l;const h=l.slice(),[x]=h.splice(o,1);return h.splice(a,0,x),h})}function Ve(s,a){A(l=>l.map(o=>o.uid===s?{...o,toKey:a}:o))}function Te(s){ee(le()),w(s||"")}function Se(){X(null),d("New Setlist"),A([]),w("")}function Ge(){const s=i?.trim()||"New Setlist",a=window.prompt("Save set as:",s);if(a===null)return;const l=String(a).trim()||"New Setlist";let o=K;if(!o){const I=(le()||[]).find(C=>(C.name||"")===l);I&&(o=I.id)}const h=u.map(({id:I,toKey:C})=>({id:I,toKey:C})),x=De({id:o,name:l,items:h});d(x.name),X(x.id),Te(x.id)}function Qe(){const s=z||g||"";if(!s){H(!1);return}const a=At(s);a&&(X(a.id),d(a.name||"New Setlist"),A(me(a.items||[])),w(a.id)),H(!1)}function et(){const s=L[0]?.id||"";R(g||s),H(!0)}function tt(){K&&window.confirm(`Delete set "${i}"? This cannot be undone.`)&&(Mt(K),Se(),Te(""))}async function Ne(){O(!0);try{const{downloadMultiSongPdf:s}=await Ke(),a=[];for(const l of u){const o=f.find(h=>h.id===l.id);if(o)try{const h=`./songs/${o.filename}`,x=await Tt(h),I=St(x),C=I.meta?.key||I.meta?.originalkey||o.originalKey||"C",se=Nt(C,l.toKey||C),nt=(I.sections||[]).map(Ee=>({section:Ee.label,lines:(Ee.lines||[]).map(te=>te.instrumental?{instrumental:Pt(te.instrumental,se)}:te.comment?{plain:te.comment,chordPositions:[],comment:te.comment}:{plain:te.lyrics||"",chordPositions:(te.chords||[]).map(ve=>({sym:jt(ve.sym,se),index:ve.index}))})})),st=o.filename.replace(/\.chordpro$/i,""),rt=It({title:I.meta?.title||o.title||st,key:l.toKey||C,capo:I.meta?.capo,lyricsBlocks:nt});a.push(rt)}catch(h){console.error(h),Y(`Failed to process ${o.filename}`)}}a.length&&await s(a)}finally{O(!1)}}function pe(){Ke()}async function Pe(){try{const s=u.map(o=>o.id).join(","),a=u.map(o=>encodeURIComponent(o.toKey||"")).join(","),l=`${r.origin}${r.pathname}#/setlist/${s}?toKeys=${a}`;await navigator.clipboard.writeText(l);try{Y?.("Link copied!")}catch{}}catch{alert("Failed to copy link")}}async function je(){if(P)return;M(`Bundling 0/${u.length}…`);const s=(await ye(async()=>{const{default:o}=await import("./jszip.min-C3rDzrTz.js").then(h=>h.j);return{default:o}},__vite__mapDeps([0,1,2]),import.meta.url)).default,a=new s;let l=0;for(let o=0;o<u.length;o++){const h=u[o],x=f.find(C=>C.id===h.id);if(!x){M(`Bundling ${o+1}/${u.length}…`);continue}M(`Bundling ${o+1}/${u.length}…`);const I=x.filename.replace(/\.chordpro$/i,"");if(D[I])try{const C=await fetch(`./pptx/${I}.pptx`);if(!C.ok)continue;const se=await C.blob();l++,a.file(`${String(l).padStart(2,"0")}-${I}.pptx`,se)}catch{}}if(l>0){const o=await a.generateAsync({type:"blob"}),h=new Date().toISOString().slice(0,10).replace(/-/g,""),x=document.createElement("a");x.href=URL.createObjectURL(o),x.download=`setlist-pptx-${h}.zip`,x.click(),URL.revokeObjectURL(x.href)}else try{Y&&Y("No PPTX files found for selected songs")||alert("No PPTX files found for selected songs")}catch{}M("")}async function Ie(){if(!(N||P)){$("Combining…");try{const s=[],a=[];for(const l of u){const o=f.find(x=>x.id===l.id);if(!o)continue;const h=o.filename.replace(/\.chordpro$/i,"");if(!D[h]){a.push(o.title||h);continue}s.push(o)}if(!s.length){try{Y&&Y("No PPTX files found for selected songs")||alert("No PPTX files found for selected songs")}catch{}return}if(a.length){const l=a.length===1?`${a[0]} PPT file unavailable`:`${a.length} songs missing PPT files`;try{Y?.(l)}catch{}}await Qt({name:i||"Setlist",songs:s},{baseUrl:"./"})}catch(s){console.error(s);try{Y&&Y("Failed to combine PPTX files")||alert("Failed to combine PPTX files")}catch{}}finally{$("")}}}return n.jsxs(Et,{children:[j?n.jsx("div",{style:{position:"fixed",inset:0,display:"flex",alignItems:"center",justifyContent:"center",background:"rgba(0,0,0,.45)",zIndex:90},role:"dialog","aria-modal":"true",children:n.jsxs("div",{style:{background:"var(--card)",color:"var(--text)",border:"1px solid var(--line)",borderRadius:10,padding:16,width:"min(560px, 92vw)"},children:[n.jsx("h3",{style:{marginTop:0,marginBottom:8},children:"Load Set"}),L.length?n.jsxs("label",{style:{display:"block",margin:"8px 0"},children:["Select a saved set",n.jsx("select",{value:z,onChange:s=>R(s.target.value),style:{width:"100%"},children:L.map(s=>n.jsxs("option",{value:s.id,children:[s.name," · ",new Date(s.updatedAt).toLocaleString()]},s.id))})]}):n.jsx("div",{className:"meta",children:"No saved sets yet."}),n.jsxs("div",{className:"row",style:{justifyContent:"flex-end",gap:8,marginTop:12},children:[n.jsx(E,{onClick:()=>H(!1),children:"Cancel"}),n.jsx(E,{variant:"primary",onClick:Qe,disabled:!L.length,children:"Load"})]})]})}):null,n.jsx(ut,{busy:F}),n.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginTop:12,marginBottom:4},children:[n.jsx("div",{}),n.jsx("h1",{style:{margin:0},children:"Setlist Builder"}),n.jsx("div",{})]}),V?n.jsx(Ae,{className:"card",style:{marginTop:8,position:"static"},children:n.jsxs("div",{className:"setlist-actions--mobile",style:{width:"100%"},children:[n.jsx(E,{variant:"primary",onClick:Ne,onMouseEnter:pe,onFocus:pe,disabled:F||u.length===0,title:"Export set as a single PDF",iconLeft:n.jsx(re,{}),children:"PDF"}),n.jsx(E,{onClick:je,disabled:u.length===0||!!N||!!P,title:u.length===0?"Add songs to export PPTX bundle":"Export PPTX bundle (ZIP) for selected songs",iconLeft:n.jsx(re,{}),children:"PPT ZIP"}),n.jsx(E,{onClick:Ie,disabled:u.length===0||!!N||!!P,title:u.length===0?"Add songs to combine PPTX files":"Combine PPTX files into a single presentation",iconLeft:n.jsx(re,{}),children:P||"Export PPT"}),n.jsx(E,{onClick:Pe,title:"Copy shareable link",iconLeft:n.jsx(Me,{}),disabled:u.length===0,children:"Share"}),n.jsx(E,{as:Le,to:u.length?`/worship/${u.map(s=>s.id).join(",")}?toKeys=${u.map(s=>encodeURIComponent(s.toKey)).join(",")}`:"/worship",title:"Open Worship Mode",iconLeft:n.jsx(Ce,{}),children:"Worship"})]})}):n.jsxs(Ae,{className:"card",style:{marginTop:8,position:"static"},children:[n.jsx("div",{style:{width:"100%",marginBottom:6},children:n.jsx("strong",{title:"Current set name",children:i||"New Setlist"})}),n.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",flexWrap:"wrap",width:"100%"},children:[n.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"},children:[n.jsxs(E,{size:"sm",variant:"secondary",onClick:Ge,title:"Save set",iconLeft:n.jsx(pt,{}),children:[" ",n.jsx("span",{className:"text-when-wide",children:"Save"})]}),n.jsxs(E,{size:"sm",variant:"secondary",onClick:et,title:"Load saved set",iconLeft:n.jsx(mt,{}),disabled:!L.length,children:[" ",n.jsx("span",{className:"text-when-wide",children:"Load"})]}),n.jsxs(E,{size:"sm",variant:"secondary",onClick:Se,title:"New set",iconLeft:n.jsx($e,{}),children:[" ",n.jsx("span",{className:"text-when-wide",children:"New"})]}),n.jsxs(E,{size:"sm",variant:"secondary",onClick:tt,disabled:!K,title:"Delete set",iconLeft:n.jsx(ft,{}),children:[" ",n.jsx("span",{className:"text-when-wide",children:"Delete"})]})]}),n.jsxs("div",{style:{marginLeft:"auto",display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"},children:[n.jsx(E,{variant:"primary",size:"md",onClick:Ne,onMouseEnter:pe,onFocus:pe,disabled:F||u.length===0,title:"Export set as a single PDF",iconLeft:n.jsx(re,{}),children:F?"Exporting…":n.jsxs(n.Fragment,{children:[n.jsx("span",{className:"text-when-wide",children:"Export PDF"}),n.jsx("span",{className:"text-when-narrow",children:"PDF"})]})}),n.jsx(E,{variant:"primary",size:"md",onClick:je,disabled:u.length===0||!!N||!!P,title:u.length===0?"Add songs to export PPTX bundle":"Export PPTX bundle (ZIP) for selected songs",iconLeft:n.jsx(re,{}),children:N||n.jsxs(n.Fragment,{children:[n.jsx("span",{className:"text-when-wide",children:"PPT ZIP"}),n.jsx("span",{className:"text-when-narrow",children:"PPT ZIP"})]})}),n.jsx(E,{variant:"primary",size:"md",onClick:Ie,disabled:u.length===0||!!N||!!P,title:u.length===0?"Add songs to combine PPTX files":"Combine PPTX files into a single presentation",iconLeft:n.jsx(re,{}),children:P||n.jsxs(n.Fragment,{children:[n.jsx("span",{className:"text-when-wide",children:"Export PPT"}),n.jsx("span",{className:"text-when-narrow",children:"Export PPT"})]})}),n.jsx(E,{variant:"primary",size:"md",onClick:Pe,title:"Copy shareable link",iconLeft:n.jsx(Me,{}),disabled:u.length===0,children:"Share Set"}),n.jsxs(E,{variant:"primary",size:"md",as:Le,to:u.length?`/worship/${u.map(s=>s.id).join(",")}?toKeys=${u.map(s=>encodeURIComponent(s.toKey)).join(",")}`:"/worship",title:"Open Worship Mode",iconLeft:n.jsx(Ce,{}),children:[" ",n.jsx("span",{className:"text-when-wide",children:"Worship Mode"}),n.jsx("span",{className:"text-when-narrow",children:"Worship"})]})]})]})]}),n.jsxs("div",{className:"BuilderPage",style:{marginTop:8},children:[n.jsx("div",{className:"BuilderLeft",children:n.jsx("section",{className:"setlist-section setlist-add","data-role":"add",children:n.jsxs("div",{className:"card setlist-pane",children:[n.jsxs("div",{className:["BuilderHeader","section-header",Q?"no-sticky":""].filter(Boolean).join(" "),style:{display:"flex",alignItems:"center",gap:8},children:[n.jsx("strong",{style:{whiteSpace:"nowrap"},children:"Add songs"}),n.jsx(ht,{value:p,onChange:s=>m(s.target.value),placeholder:"Search...",style:{flex:1,minWidth:0}}),n.jsxs("label",{className:"row",style:{gap:6,alignItems:"center"},children:[n.jsx("input",{type:"checkbox",checked:y,onChange:s=>v(s.target.checked)}),n.jsx("span",{className:"meta",title:"Limit results to songs tagged ICP",children:"ICP only"})]})]}),n.jsx("div",{className:["BuilderScroll","setlist-scroll","setlist-list",Q?"no-pane-scroll":"pane-scroll","pane--addSongs"].join(" "),children:ue?n.jsx("div",{style:{display:"grid",gap:".5rem",gridTemplateColumns:"repeat(auto-fill, minmax(320px, 1fr))",marginTop:6},children:qe.map(s=>n.jsx(Re,{title:s.title,subtitle:`${s.originalKey||""}${s.tags?.length?` • ${s.tags.join(", ")}`:""}`,rightSlot:n.jsx(E,{"aria-label":"Add",title:"Add to set",variant:"primary",iconLeft:n.jsx($e,{}),iconOnly:!0,onClick:a=>{a.stopPropagation(),we(s)}}),onClick:()=>we(s)},s.id))}):n.jsx("div",{children:"Loading search…"})})]})})}),n.jsx("div",{className:"BuilderRight",style:{minHeight:0,display:"flex",flexDirection:"column"},children:n.jsxs("section",{className:"setlist-section setlist-current","data-role":"current",children:[n.jsxs("div",{className:"card setlist-pane",children:[n.jsx("div",{className:["BuilderHeader","section-header",Q?"no-sticky":""].filter(Boolean).join(" "),children:n.jsxs("strong",{children:["Current setlist (",u.length,")"]})}),n.jsx("div",{className:["BuilderScroll","setlist-scroll","setlist-list",Q?"no-pane-scroll":"pane-scroll","pane--currentSet"].join(" "),style:{marginTop:6},children:u.map((s,a)=>{const l=f.find(o=>o.id===s.id);return l?n.jsx(Re,{draggable:!0,onDragStart:o=>{o.dataTransfer.setData("text/plain",String(s.uid||s.id)),o.dataTransfer.effectAllowed="move"},onDragOver:o=>{o.preventDefault(),o.dataTransfer.dropEffect="move"},onDrop:o=>{o.preventDefault();const h=o.dataTransfer.getData("text/plain");Ze(h,a)},title:l.title,subtitle:`Original: ${l.originalKey||"—"}`,rightSlot:n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6},children:[n.jsx(en,{value:s.toKey,onChange:o=>Ve(s.uid,o.target.value),children:gt.map(o=>n.jsx("option",{value:o,children:o},o))}),n.jsx(E,{onClick:()=>be(s.uid,"up"),title:"Move up",iconLeft:n.jsx(yt,{})}),n.jsx(E,{onClick:()=>be(s.uid,"down"),title:"Move down",iconLeft:n.jsx(xt,{})}),n.jsx(E,{onClick:()=>Je(s.uid),title:"Remove",iconLeft:n.jsx(wt,{}),iconOnly:!0,style:{color:"#b91c1c"}})]})},s.uid||`${s.id}-${a}`):null})})]}),n.jsxs("div",{className:"print-only",style:{marginTop:16},children:[n.jsx("h2",{style:{fontSize:"20pt",margin:"0 0 8pt 0"},children:i}),n.jsx("ol",{style:{fontSize:"12pt",lineHeight:1.4,paddingLeft:"1.2em"},children:u.map((s,a)=>{const l=f.find(o=>o.id===s.id);return l?n.jsxs("li",{children:[l.title," — ",s.toKey||l.originalKey||"—"]},s.uid||`${s.id}-${a}`):null})})]})]})})]})]})}export{rn as default};
