function ot(t,i,e="normal"){return o=>n=>(t.setFont(i,e),t.setFontSize(o),t.getTextWidth(n||""))}function G(t,i=3){if(!Array.isArray(t)||t.length<2)return t;t.sort((n,s)=>n.x-s.x);let e=!0,o=0;for(;e&&o<10;){e=!1,o++;for(let n=1;n<t.length;n++){const s=t[n-1],a=t[n];if(s.x+s.w>a.x){const c=s.x+s.w-a.x,r=Math.min(i,Math.ceil(c/2));s.x-=r,a.x+=r,e=!0}}}return t.sort((n,s)=>n.x-s.x),t}const H=/^\{(start_of|end_of)_(verse|chorus|bridge|intro|tag|outro)(?::\s*([^}]+))?\}$/i,W=/^\{(sov|eov|soc|eoc|sob|eob)\}$/i,K={sov:{start:!0,kind:"verse"},eov:{start:!1,kind:"verse"},soc:{start:!0,kind:"chorus"},eoc:{start:!1,kind:"chorus"},sob:{start:!0,kind:"bridge"},eob:{start:!1,kind:"bridge"}},F=/^(verse|chorus|bridge|intro|tag|outro)(?:\s+(\d+))?$/i,N=/^\{\s*([^:}]+)\s*:\s*([^}]*)\s*\}$/,V=/\[([^\]]+)\]/g;function R(t){const i=[];let e="",o=0;return t.replace(V,(n,s,a)=>(e+=t.slice(o,a),i.push({sym:s,index:e.length}),o=a+n.length,n)),e+=t.slice(o),{lyrics:e,chords:i}}function M(t){return F.test(t.trim())}function Z(t){const i=F.exec(t.trim());if(!i)return{kind:"verse",label:""};const e=i[1].toLowerCase(),o=i[2]?`${L(e)} ${i[2]}`:L(e);return{kind:e,label:o}}function L(t){return t.charAt(0).toUpperCase()+t.slice(1).toLowerCase()}function q(t){const i=t.trim();let e=H.exec(i);if(e)return{start:e[1].toLowerCase()==="start_of",kind:e[2].toLowerCase(),label:(e[3]||"").trim()||void 0};if(e=W.exec(i),e){const o=K[e[1].toLowerCase()];if(o)return{start:o.start,kind:o.kind}}return null}function U(t){const i=t.split(/\r?\n/);let e=!1;for(const c of i){const r=c.trim();if(H.test(r)||W.test(r)){e=!0;break}}const o={meta:{},sections:[]};let n=null;const s=(c,r)=>{n&&o.sections.push(n);const u=r||L(c);n={kind:c,label:u,lines:[]}},a=()=>{n&&(o.sections.push(n),n=null)};for(const c of i){const r=c.trim();if(r===""){n&&n.lines.push({lyrics:"",chords:[]});continue}const u=N.exec(r);if(u&&!H.test(r)&&!W.test(r)){const l=u[1].trim().toLowerCase(),d=u[2].trim();l==="title"?o.meta.title=d:l==="key"?o.meta.key=d:(o.meta.meta||(o.meta.meta={}),o.meta.meta[l]=d);continue}if(e){const l=q(r);if(l){l.start?s(l.kind,l.label):a();continue}if(r.startsWith("{")&&r.endsWith("}"))continue;n||s("verse","Verse"),n.lines.push(R(c));continue}if(M(c)){const{kind:l,label:d}=Z(c);s(l,d);continue}r.startsWith("{")&&r.endsWith("}")||(n||s("verse","Verse"),n.lines.push(R(c)))}return n&&a(),o}function C(t){if(!t)return{meta:{title:"Untitled",key:"C"},sections:[]};if(t.meta&&Array.isArray(t.sections)){const i={title:t.meta.title||t.title||"Untitled",key:t.meta.key||t.key||"C",meta:t.meta.meta},e=(t.sections||[]).map(o=>({kind:o.kind||"verse",label:o.label,lines:(o.lines||[]).map(n=>({lyrics:n.lyrics||n.plain||n.text||"",chords:(n.chords||n.chordPositions||[]).map(s=>({index:s.index||0,sym:s.sym}))}))}));return{meta:i,sections:e}}if(t.lyricsBlocks){const i=(t.lyricsBlocks||[]).map(e=>({kind:"verse",label:e.section,lines:(e.lines||[]).map(o=>({lyrics:o.plain||o.text||"",chords:(o.chordPositions||[]).map(n=>({index:n.index||0,sym:n.sym}))}))}));return{meta:{title:t.title||"Untitled",key:t.key||t.originalKey||"C"},sections:i}}if(Array.isArray(t==null?void 0:t.blocks)){const i=[];let e={kind:"verse",label:"",lines:[]};for(const o of t.blocks)o.type==="section"?(e.lines.length&&i.push(e),e={kind:"verse",label:o.header,lines:[]}):o.type==="line"&&e.lines.push({lyrics:o.lyrics||o.text||"",chords:(o.chords||[]).map(n=>({index:n.index||0,sym:n.sym}))});return e.lines.length&&i.push(e),{meta:{title:t.title||"Untitled",key:t.key||t.originalKey||"C"},sections:i}}if(typeof t=="string")return U(t);if(t!=null&&t.body||t!=null&&t.lines){const i=(t.body||(Array.isArray(t.lines)?t.lines.join(`
`):""))+"";return U(i)}return{meta:{title:t.title||"Untitled",key:t.key||t.originalKey||"C"},sections:[]}}const p={lyricSizePt:16,chordSizePt:16,margin:36,gutter:24,headerOffsetY:40,columns:1,pageWidth:612,pageHeight:792,lyricFamily:"Helvetica",chordFamily:"Courier",title:"Untitled",key:"C"},J=6;function A(t,i,e,o,n,s){const a=o.margin,c=o.pageWidth-a*2,u=(i===2?(c-o.gutter)/2:c)-J,l=n(e),d=s(e);for(const k of t.sections||[])for(const f of k.lines||[]){const z=f.lyrics||"";if(l(z)>u)return!0;for(const _ of f.chords||[]){const b=l(z.slice(0,_.index||0)),g=d(_.sym||"");if(b+g>u)return!0}}return!1}function I(t,i={},e=()=>()=>0,o=()=>()=>0){const n=C(t),s={...p,...i,gutter:p.gutter},a=[16,15,14,13,12];for(const l of a){const d=x(n,{...s,columns:1,lyricSizePt:l,chordSizePt:l},e(l),o(l)),k=!A(n,1,l,s,e,o),f={...s,columns:1,lyricSizePt:l,chordSizePt:l,layout:d};if(E(f)&&k)return{plan:f}}for(const l of a){const d=x(n,{...s,columns:2,lyricSizePt:l,chordSizePt:l},e(l),o(l)),k=!A(n,2,l,s,e,o),f={...s,columns:2,lyricSizePt:l,chordSizePt:l,layout:d};if(!(!E(f)||!k)&&!tt(f))return{plan:f}}const c=12;let r=x(n,{...s,columns:1,lyricSizePt:c,chordSizePt:c},e(c),o(c)),u={...s,columns:1,lyricSizePt:c,chordSizePt:c,layout:r};return Q(u)||(r=x(n,{...s,columns:2,lyricSizePt:c,chordSizePt:c},e(c),o(c)),u={...s,columns:2,lyricSizePt:c,chordSizePt:c,layout:r}),{plan:u}}function E(t){var i,e;return((e=(i=t==null?void 0:t.layout)==null?void 0:i.pages)==null?void 0:e.length)===1}function Q(t){var i,e;return(((e=(i=t==null?void 0:t.layout)==null?void 0:i.pages)==null?void 0:e.length)||99)<=2}function tt(t){var a,c,r;const i=(c=(a=t==null?void 0:t.layout)==null?void 0:a.pages)==null?void 0:c[0];if(!i||((r=i.columns)==null?void 0:r.length)!==2)return!1;const e=i.columns[1];let o=0,n=0,s=0;for(const u of e.blocks||[])u.type==="section"?(s>0&&n++,s=0):u.type==="line"&&(s++,o++);return s>0&&n++,o<=5||n===1&&s<3}function x(t,i={},e=n=>0,o=n=>0){const n=C(t),s={...p,...i,gutter:p.gutter},a=4,c=s.lyricSizePt,r=Math.round(s.lyricSizePt*.85),u=s.margin,l=s.pageHeight,d=s.pageWidth-u*2,k=s.columns===2?(d-s.gutter)/2:d,f=u+s.headerOffsetY,z=l-u,_=z-f,b=[];let g={columns:[]};b.push(g);function O(){const m={x:u,yStart:f,blocks:[]};if(g.columns.push(m),s.columns===2){const y={x:u+k+s.gutter,yStart:f,blocks:[]};g.columns.push(y)}}function D(){g={columns:[]},b.push(g)}g.columns.length===0&&O();let v=0,S=f;const Y=()=>g.columns[v],T=()=>{s.columns===2&&v===0?(v=1,S=f):(D(),O(),v=0,S=f)},$=m=>{var P;let y=r+c+4;for(const h of m.lines||[])(P=h==null?void 0:h.chords)!=null&&P.length&&(y+=s.chordSizePt+a/2),y+=s.lyricSizePt+a;return y+4},X=m=>{var y;return((y=m==null?void 0:m.chords)!=null&&y.length?s.chordSizePt+a/2:0)+s.lyricSizePt+a},B=(m,y)=>{m.blocks.push({type:"section",header:y})},j=(m,y,P)=>{const h=P.map(w=>({x:e(y.slice(0,w.index||0)),w:o(w.sym||""),sym:w.sym}));G(h),m.blocks.push({type:"line",lyrics:y,chords:h})};for(const m of n.sections||[]){const y=$(m);y>_?(S!==f||s.columns===2&&v===1)&&T():S+y>z&&T();const P=Y();S+=r,B(P,m.label||m.kind),S+=c+4;for(const h of m.lines||[])j(P,h.lyrics||"",h.chords||[]),S+=X(h);S+=4}return{pages:b}}function et(t,i){const e={...p,...i};e.pageWidth=612,e.pageHeight=792;const o=s=>s?s.length*(e.lyricSizePt*.6):0;return x(C(t),e,o,o).pages.map((s,a)=>({p:a,cols:s.columns.map((c,r)=>({c:r,blocks:c.blocks.map(u=>({t:u.type,h:u.type==="section"&&u.header||null,line:u.type==="line"?{text:u.lyrics,chords:(u.chords||[]).map(l=>({x:Number(l.x.toFixed(2)),s:l.sym}))}:null}))}))}))}function st(t,i){const e=C(t),o={...p,...i};o.pageWidth=612,o.pageHeight=792;const n=c=>r=>r?r.length*(c*.6):0,s=c=>r=>r?r.length*(c*.6):0,{plan:a}=I(e,o,n,s);return{columns:a.columns,size:a.lyricSizePt,pages:a.layout.pages.length}}const nt=Object.freeze(Object.defineProperty({__proto__:null,DEFAULT_LAYOUT_OPT:p,chooseBestLayout:I,getLayoutMetrics:et,normalizeSongInput:C,planForTest:st,planSongLayout:x},Symbol.toStringTag,{value:"Module"}));export{p as D,nt as a,I as c,ot as m,C as n,x as p};
