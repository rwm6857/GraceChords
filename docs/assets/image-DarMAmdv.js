import{p as b,W as z,aA as T}from"./index-Cs553wRZ.js";let F=null;async function B(){if(F)return F;const t=b("fonts/"),n=[{family:"NotoSans",weight:"400",style:"normal",file:"NotoSans-Regular.ttf"},{family:"NotoSans",weight:"700",style:"normal",file:"NotoSans-Bold.ttf"},{family:"NotoSans",weight:"400",style:"italic",file:"NotoSans-Italic.ttf"},{family:"NotoSans",weight:"700",style:"italic",file:"NotoSans-BoldItalic.ttf"},{family:"NotoSansMono",weight:"400",style:"normal",file:"NotoSansMono-Regular.ttf"},{family:"NotoSansMono",weight:"700",style:"normal",file:"NotoSansMono-Bold.ttf"}];return F=Promise.all(n.map(async l=>{const h=await new FontFace(l.family,`url(${t}${l.file})`,{weight:l.weight,style:l.style}).load();document.fonts.add(h)})).then(()=>({lyricFamily:"NotoSans",chordFamily:"NotoSansMono"})).catch(()=>({lyricFamily:"Helvetica",chordFamily:"Courier"})),F}function E(t){return(t||"").toLowerCase().replace(/[^\w]+/g,"_").replace(/_+/g,"_").replace(/^_|_$/g,"")}function A(t,{pxWidth:n,pxHeight:l,dpi:w=150,createCanvas:h}={}){const r=h?h(n,l):typeof document<"u"?document.createElement("canvas"):null;if(!r)throw new Error("Canvas unavailable. Provide createCanvas in options.");r.width=n,r.height=l;const e=r.getContext("2d");e.fillStyle="#fff",e.fillRect(0,0,r.width,r.height);const g=w/72;e.scale(g,g);const m=t.margin,x=Math.max(22,t.lyricSizePt+6),$=Math.max(12,t.lyricSizePt-2);e.fillStyle="#000",e.font=`bold ${x}px ${t.lyricFamily}`,e.fillText(String(t.title||"Untitled"),m,m+24),e.font=`italic ${$}px ${t.lyricFamily}`;const p=String(t.key||"â€”");e.fillText(`Key of ${p}`,m,m+40);const u=4,s=t.lyricSizePt,d=Math.round(t.lyricSizePt*.85),v=m+(t.headerOffsetY||x*1.05+$*1.05+12);return(t.layout.pages||[])[0].columns.forEach(f=>{let i=f.x,o=v;f.blocks.forEach(a=>{if(a.type==="section")o+=d,e.font=`bold ${s}px ${t.lyricFamily}`,e.fillText(`[${a.header}]`,i,o),o+=s+4;else if(a.type==="instrumental"){const c=z(a.instrumental||{},{split:t.columns===2});c.length&&(e.font=`bold ${t.chordSizePt}px ${t.chordFamily}`,e.fillStyle="#000",c.forEach(y=>{e.fillText(y,i,o),o+=t.lyricSizePt+u}))}else if(a.type==="line"){if(a.comment){e.font=`italic ${t.lyricSizePt}px ${t.lyricFamily}`;const c=e.fillStyle;e.fillStyle="#6b7280",e.fillText(a.comment,i,o),e.fillStyle=c,o+=t.lyricSizePt+u;return}a.chords?.length&&(e.font=`bold ${t.chordSizePt}px ${t.chordFamily}`,a.chords.forEach(c=>e.fillText(c.sym,i+c.x,o)),o+=t.chordSizePt+u/2),e.font=`normal ${t.lyricSizePt}px ${t.lyricFamily}`,e.fillText(a.lyrics,i,o),o+=t.lyricSizePt+u}})}),r}async function U(t,n={}){const l=n.dpi||150,w=n.widthInches||8.5,h=n.heightInches||11,r=n.createCanvas,e=n.fonts,g=typeof n.quality=="number"?n.quality:.92,m=Math.round(w*l),x=Math.round(h*l),$=e||await B(),{lyricFamily:p,chordFamily:u}=$;let s=n.plan;if(!s){const f=r?r(1,1):typeof document<"u"?document.createElement("canvas"):null;if(!f)throw new Error("Canvas unavailable. Provide createCanvas in options.");const i=f.getContext("2d");s=T(t,{lyricFamily:p,chordFamily:u},y=>S=>(i.font=`${y}px ${p}`,i.measureText(S||"").width),y=>S=>(i.font=`bold ${y}px ${u}`,i.measureText(S||"").width)).plan}if(s.layout.pages.length>1)return{error:"MULTI_PAGE",plan:s};const d=A(s,{pxWidth:m,pxHeight:x,dpi:l,createCanvas:r}),C=`${E(String(n.slug||t.slug||t.title||"untitled"))}.jpg`,M=await new Promise((f,i)=>{if(typeof d.toBlob=="function"){d.toBlob(o=>{o?f(o):i(new Error("Failed to generate JPG blob"))},"image/jpeg",g);return}if(typeof d.toBuffer=="function"){try{const o=d.toBuffer("image/jpeg",{quality:g});f(new Blob([o],{type:"image/jpeg"}))}catch(o){i(o)}return}else try{const a=d.toDataURL("image/jpeg",g).split(","),c=a[0]?.match(/:(.*?);/),y=atob(a[1]||""),S=y.length,N=new Uint8Array(S);for(let P=0;P<S;P+=1)N[P]=y.charCodeAt(P);f(new Blob([N],{type:c?.[1]||"image/jpeg"}))}catch(o){i(o)}});return{plan:s,blob:M,filename:C}}export{U as downloadSingleSongJpg,B as ensureCanvasFonts,A as renderPlanToCanvas};
