function j(o=""){return/^(?:verse(?:\s*\d+)?|chorus|bridge|tag|pre[-\s]?chorus|intro|outro|ending|refrain)\s*\d*$/i.test(String(o).trim())}function W(o){const S=a=>{const s=[];let t=null;const c=()=>{t&&t.lines.length&&s.push(t),t=null};for(const h of a||[]){if(h.section){c(),s.push(h);continue}for(const r of h.lines||[]){const n=r.plain||r.text||"";!!!(r.chordPositions&&r.chordPositions.length)&&j(n)?(c(),t={section:n.trim(),lines:[]}):(t||(t={lines:[]}),t.lines.push(r))}}return c(),s.length?s:a||[]};if(o!=null&&o.lyricsBlocks)return{title:o.title||"Untitled",key:o.key||o.originalKey||"C",lyricsBlocks:S(o.lyricsBlocks)};if(Array.isArray(o==null?void 0:o.blocks)){const a=[];let s={lines:[]};for(const t of o.blocks)t.type==="section"?(s.lines.length&&a.push(s),s={section:t.header,lines:[]}):t.type==="line"&&s.lines.push({plain:t.lyrics||t.text||"",chordPositions:(t.chords||[]).map(c=>({index:c.index??0,sym:c.sym}))});return s.lines.length&&a.push(s),{title:o.title||"Untitled",key:o.key||o.originalKey||"C",lyricsBlocks:S(a)}}return{title:(o==null?void 0:o.title)||"Untitled",key:(o==null?void 0:o.key)||(o==null?void 0:o.originalKey)||"C",lyricsBlocks:[]}}const L={lyricSizePt:16,chordSizePt:16,margin:36,gutter:18,headerOffsetY:54,columns:1,pageWidth:612,pageHeight:792,lyricFamily:"Helvetica",chordFamily:"Courier",title:"Untitled",key:"C"},R=6;function $(o,S,a,s,t,c){const h=s.margin,r=s.pageWidth-h*2,y=(S===2?(r-s.gutter)/2:r)-R,k=t(a),d=c(a);for(const f of o.lyricsBlocks||[])for(const i of f.lines||[]){const u=i.plain||i.text||"";if(k(u)>y)return!0;for(const z of i.chordPositions||[]){const w=k(u.slice(0,z.index||0)),F=d(z.sym||"");if(w+F>y)return!0}}return!1}function q(o,S={},a=()=>()=>0,s=()=>()=>0){const t=W(o),c={...L,...S},h=14,r=c.lyricSizePt,n=[],y=(i,u)=>{const z=E(t,{...c,columns:i,lyricSizePt:u,chordSizePt:u},a(u)),w=!$(t,i,u,c,a,s);return{columns:i,lyricSizePt:u,chordSizePt:u,layout:z,widthOk:w}},k=c.columns===2?2:1;n.push(y(k,r));let d=n[n.length-1];if(k===1&&(d.layout.pages.length>1||!d.widthOk)){let i=r;for(n.push(y(2,i)),d=n[n.length-1];(d.layout.pages.length>1||!d.widthOk)&&i>h;)i--,d=y(2,i),n.push(d)}else{let i=r;for(;(d.layout.pages.length>1||!d.widthOk)&&i>h;)i--,d=y(k,i),n.push(d)}n.sort((i,u)=>i.layout.pages.length!==u.layout.pages.length?i.layout.pages.length-u.layout.pages.length:i.columns!==u.columns?i.columns-u.columns:u.lyricSizePt-i.lyricSizePt);const f=n[0];return{plan:{...c,columns:f.columns,lyricSizePt:f.lyricSizePt,chordSizePt:f.chordSizePt,layout:f.layout},chosenOpts:{columns:f.columns,lyricSizePt:f.lyricSizePt,chordSizePt:f.chordSizePt}}}function E(o,S={},a=s=>0){const s=W(o),t={...L,...S},c=4,h=t.lyricSizePt,r=Math.round(t.lyricSizePt*.85),n=t.margin,y=t.pageHeight,k=t.pageWidth-n*2,d=t.columns===2?(k-t.gutter)/2:k,f=n+t.headerOffsetY,i=y-n,u=[];let z={columns:[]};u.push(z);function w(){const e={x:n,yStart:f,blocks:[]};if(z.columns.push(e),t.columns===2){const l={x:n+d+t.gutter,yStart:f,blocks:[]};z.columns.push(l)}}function F(){z={columns:[]},u.push(z)}z.columns.length===0&&w(),s.lyricsBlocks=(s.lyricsBlocks||[]).map(e=>{if(!(e!=null&&e.section)&&Array.isArray(e==null?void 0:e.lines)&&e.lines.length){const l=e.lines[0],P=(l==null?void 0:l.plain)||(l==null?void 0:l.text)||"";if(!(Array.isArray(l==null?void 0:l.chordPositions)&&l.chordPositions.length>0)&&j(P))return{section:P.trim(),lines:e.lines.slice(1)}}return e});let O=0,p=f;const U=()=>z.columns[O],A=()=>{t.columns===2&&O===0?(O=1,p=f):(F(),w(),O=0,p=f)},G=(e,l=0,P=(g=>(g=e.lines)==null?void 0:g.length)()??0)=>{var B;let x=0;!!e.section&&l===0&&(x+=r+h+4);for(let H=l;H<P;H++){const m=e.lines[H];(B=m==null?void 0:m.chordPositions)!=null&&B.length&&(x+=t.chordSizePt+c/2),x+=t.lyricSizePt+c}return x+4},v=e=>{var l;return((l=e==null?void 0:e.chordPositions)!=null&&l.length?t.chordSizePt+c/2:0)+t.lyricSizePt+c},I=(e,l)=>{e.blocks.push({type:"section",header:l})},K=(e,l,P)=>{e.blocks.push({type:"line",lyrics:l,chords:P.map(g=>({x:a(l.slice(0,g.index||0)),sym:g.sym}))})};for(const e of s.lyricsBlocks||[]){const l=G(e);if(p+l<=i){const x=U();e.section&&(p+=r,I(x,e.section),p+=h+4);for(const C of e.lines||[]){const B=C.plain||C.text||"",H=C.chordPositions||[];K(x,B,H),p+=v(C)}p+=4;continue}const P=(e.lines||[]).map(v);let g=0;for(;g<(e.lines||[]).length;){const x=(e.lines||[]).length-g,C=g===0&&e.section?r+h+4:0,B=P[g]||0;if(p+C+B>i){A();continue}const H=i-p-C;let m=0,T=0;for(;g+m<P.length&&T+P[g+m]<=H;)T+=P[g+m],m++;if(m===1&&x>1){A();continue}if(x-m===1)if(m>1)T-=P[g+m-1],m--;else{A();continue}const M=U();g===0&&e.section&&(p+=r,I(M,e.section),p+=h+4);for(let _=0;_<m;_++){const Y=e.lines[g],D=Y.plain||Y.text||"",N=Y.chordPositions||[];K(M,D,N),p+=P[g],g++}p+=4,g<(e.lines||[]).length&&A()}}return{pages:u}}function J(o,S){const a={...L,...S};a.pageWidth=612,a.pageHeight=792;const s=c=>c?c.length*(a.lyricSizePt*.6):0;return E(W(o),a,s).pages.map((c,h)=>({p:h,cols:c.columns.map((r,n)=>({c:n,blocks:r.blocks.map(y=>({t:y.type,h:y.type==="section"&&y.header||null,line:y.type==="line"?{text:y.lyrics,chords:(y.chords||[]).map(k=>({x:Number(k.x.toFixed(2)),s:k.sym}))}:null}))}))}))}function Q(o,S){const a=W(o),s={...L,...S};s.pageWidth=612,s.pageHeight=792;const t=r=>n=>n?n.length*(r*.6):0,c=r=>n=>n?n.length*(r*.6):0,{plan:h}=q(a,s,t,c);return{columns:h.columns,size:h.lyricSizePt,pages:h.layout.pages.length}}export{L as DEFAULT_LAYOUT_OPT,q as chooseBestLayout,J as getLayoutMetrics,W as normalizeSongInput,Q as planForTest,E as planSongLayout};
