const E=[16,15,14,13,12],g=()=>{var e;try{return typeof window<"u"&&((e=window.localStorage)==null?void 0:e.getItem("pdfPlanTrace"))==="1"}catch{return!1}};function B(e){if(typeof(e==null?void 0:e.measureSectionsForPt)=="function")return e.measureSectionsForPt;if(Array.isArray(e==null?void 0:e.sections)&&typeof(e==null?void 0:e.measureSectionAtPt)=="function"){const n=e.sections,l=e.measureSectionAtPt;return f=>n.map((r,t)=>{const a=l(r,f);return{id:(a==null?void 0:a.id)??(r==null?void 0:r.id)??t+1,height:(a==null?void 0:a.height)??(a==null?void 0:a.h)??0,type:(a==null?void 0:a.type)??(r==null?void 0:r.type)}})}return null}const j=(e,n)=>{g()&&e.push(n)},z=(e,n)=>{g()&&n.length&&(console.groupCollapsed(`[pdfPlanTrace] ${e}`),console.table(n),console.groupEnd())};function I(e,n,l,f={}){const r=!!f.honorColumnBreaks,t=new Array(n).fill(0),a=Array.from({length:n},()=>[]);let i=0,y="";if(!Array.isArray(e))return{singlePage:!1,colHeights:t,occupancy:t.map(()=>0),balance:1,reasonRejected:"no_sections_provided",placed:a};const b=p=>{if(i+1>=n)return!1;const o=e[p];return o?o.height<=l-t[i+1]:!1};for(let p=0;p<e.length;p++){const o=e[p];if(r&&o.type==="column_break"){b(p+1)&&(i+=1);continue}const u=l-t[i];if(o.height<=u)a[i].push(o.id),t[i]+=o.height,g()&&console.log(`[pdfPlanTrace] sec ${o.id} h=${Math.ceil(o.height)} → col ${i+1} = ${Math.round(t[i])}`);else if(i+1<n){i+=1;const h=l-t[i];if(o.height<=h)a[i].push(o.id),t[i]+=o.height,g()&&console.log(`[pdfPlanTrace] sec ${o.id} h=${Math.ceil(o.height)} → col ${i+1} = ${Math.round(t[i])}`);else return y=`section ${o.id} needs ${Math.ceil(o.height)}pt > remaining ${Math.floor(h)}pt in col ${i+1}`,g()&&console.log(`[pdfPlanTrace] REJECT ${y}`),{singlePage:!1,colHeights:t,occupancy:t.map(s=>s/l),balance:n===2?1-Math.abs(t[0]-t[1])/l:1,reasonRejected:y,placed:a}}else return y=`section ${o.id} needs ${Math.ceil(o.height)}pt > remaining ${Math.floor(u)}pt in col ${i+1}`,g()&&console.log(`[pdfPlanTrace] REJECT ${y}`),{singlePage:!1,colHeights:t,occupancy:t.map(h=>h/l),balance:n===2?1-Math.abs(t[0]-t[1])/l:1,reasonRejected:y,placed:a}}return{singlePage:!0,colHeights:t,occupancy:t.map(p=>p/l),balance:n===2?1-Math.abs(t[0]-t[1])/l:1,reasonRejected:void 0,placed:a}}function G({pt:e,cols:n,balance:l,occupancy:f,hasColumnsHint:r}){let t=0;n===2&&Math.min(...f)<.18&&(t+=50),f.some(i=>i>.98)&&(t+=5),r&&n===2&&(t-=3);const a=e*100+l*10-t-(n===2?2:0);return{penalties:t,finalScore:a}}function L({measuredSections:e,measureSectionsForPt:n,sections:l,measureSectionAtPt:f,pageContentHeight:r,gutter:t=24,hasColumnsHint:a=!1,honorColumnBreaks:i=!0,ptWindow:y=E}){const b=[],p=[],o=n||B({measureSectionsForPt:n,sections:l,measureSectionAtPt:f});g()&&console.log(`[pdfPlanTrace] contentH=${r} gutter=${t}`);for(const u of y){const h=r;for(const s of[1,2]){const $=typeof o=="function"?o(u):e;if(!Array.isArray($)){j(b,{pt:u,cols:s,singlePage:!1,colHeights:[],occupancy:[],balance:1,penalties:"",finalScore:"",reasonRejected:"no_measurements_for_pt"});continue}const d=I($,s,h,{honorColumnBreaks:i}),x={pt:u,cols:s,singlePage:d.singlePage,colHeights:d.colHeights.map(P=>Math.round(P)),occupancy:d.occupancy.map(P=>Number(P.toFixed(2))),balance:Number(d.balance.toFixed(2))};if(!d.singlePage){j(b,{...x,penalties:"",finalScore:"",reasonRejected:d.reasonRejected});continue}const{penalties:O,finalScore:C}=G({pt:u,cols:s,balance:d.balance,occupancy:d.occupancy,hasColumnsHint:a});p.push({pt:u,cols:s,pack:d,penalties:O,finalScore:C}),j(b,{...x,penalties:O,finalScore:C,reasonRejected:""})}}if(p.length){p.sort((s,$)=>$.finalScore-s.finalScore);const u=p[0];z("Single‑page candidate scan (16→12pt, 1/2 columns)",b);const h=g()?`Plan: ${u.cols} col • ${u.pt}pt • singlePage=yes • occ=${JSON.stringify(u.pack.occupancy.map(s=>s.toFixed(2)))} • bal=${u.pack.balance.toFixed(2)}`:"";return{...u,debugFooter:h}}return z("No single‑page candidates; falling back to multi‑page 12pt",b),{multipage:!0,pt:12,reason:"no_single_page"}}const q=Object.freeze({honorColumnBreaks:!0,hasColumnsHint:!1,ptWindow:E.slice()});function K(e){return e}function Q(e,n,l,f={}){return I(e,n,l,f).colHeights}function D(e){const n=L(e);return n.multipage?n:{pt:n.pt,cols:n.cols,singlePage:!0,occupancy:n.pack.occupancy,balance:n.pack.balance,debugFooter:n.debugFooter,placed:n.pack.placed,colHeights:n.pack.colHeights}}function V(e){return D(e)}function X(e,n,l,f){var H,W,N,v;const r=n.margin??36,t=n.headerOffsetY??0,a=n.pageWidth??612,i=n.pageHeight??792,y=r+t,b=i-y-r,p=a-r*2,o=n.gutter??24,u=Array.isArray(e==null?void 0:e.blocks)?e.blocks:[],h=[];let s=null;for(const c of u)(c==null?void 0:c.type)==="section"?(s={header:c.header||c.name||"Section",blocks:[c]},h.push(s)):(s||(s={header:"Section",blocks:[]},h.push(s)),s.blocks.push(c));h.length||h.push({header:"Section",blocks:[]});const $=(c,S)=>{const m=l(c);try{return m(S||"")}catch{return 0}},d=(c,S)=>{const m=f(c);try{return m(S||"")}catch{return 0}},x=c=>{const m=Math.round(c*.85);return h.map((F,M)=>{let A=m;for(const k of F.blocks)if(k.type!=="section"&&k.type==="line"){if(k.comment){const T=Math.max(10,c-2);$(T,k.comment),A+=T+3;continue}Array.isArray(k.chords)&&k.chords.length&&(d(c,k.chords.map(T=>(T==null?void 0:T.sym)||"").join(" ")),A+=c+4/2),$(c,k.lyrics||""),A+=c+4}return A<m+c&&(A=m+c),{id:M+1,type:"section",height:A,header:F.header}})},O=((H=e==null?void 0:e.meta)==null?void 0:H.columns)===2||((W=e==null?void 0:e.hints)==null?void 0:W.columns)===2,C=L({measureSectionsForPt:x,pageContentHeight:b,hasColumnsHint:O,honorColumnBreaks:!0,gutter:o});if(C.multipage){const c={lyricFamily:n.lyricFamily||"Helvetica",chordFamily:n.chordFamily||"Courier",lyricSizePt:12,chordSizePt:12,columns:1,margin:r,headerOffsetY:t,gutter:o,layout:{pages:[]},debugFooter:g()?"Plan: 1 col • 12pt • singlePage=no":void 0};return c.layout.pages=[{columns:[{x:r,blocks:u}]},{columns:[{x:r,blocks:[]}]}],{plan:c}}const P=C,R=P.pt,_=P.cols,J=_===2?(p-o)/2:p,Y=h.map(c=>c.blocks),w={columns:[]};for(let c=0;c<_;c++){const S=P.pack.placed[c]||[],m=[];for(const F of S){const M=Y[F-1]||[];(!M.length||((N=M[0])==null?void 0:N.type)!=="section")&&m.push({type:"section",header:((v=h[F-1])==null?void 0:v.header)||`Section ${F}`}),m.push(...M)}w.columns.push({x:r+c*(J+(c?o:0)),blocks:m})}return{plan:{lyricFamily:n.lyricFamily||"Helvetica",chordFamily:n.chordFamily||"Courier",lyricSizePt:R,chordSizePt:R,columns:_,margin:r,headerOffsetY:t,gutter:o,layout:{pages:[w]},debugFooter:g()?`Plan: ${_} col • ${R}pt • singlePage=yes • occ=${JSON.stringify(P.pack.occupancy.map(c=>c.toFixed(2)))} • bal=${P.pack.balance.toFixed(2)}`:void 0}}}export{q as DEFAULT_LAYOUT_OPT,X as chooseBestLayout,D as chooseBestLayoutFromArgs,L as chooseBestPlan,Q as columnHeights,K as normalizeSongInput,V as planSongLayout};
