import{r,i as H,j as t,B as K,f as U,p as G,s as y,b as J,e as Q}from"./index-BAoIQLOh.js";function v(a,n){return((a==null?void 0:a.title)||"").localeCompare((n==null?void 0:n.title)||"",void 0,{sensitivity:"base"})}function b(a){return[...new Set(a.filter(Boolean))].sort((n,f)=>String(n).localeCompare(String(f),void 0,{sensitivity:"base"}))}function Y(){const a=r.useMemo(()=>{var e;return(((e=H)==null?void 0:e.items)||[]).slice().sort(v)},[]),[n,f]=r.useState(""),[u,F]=r.useState("All"),[m,B]=r.useState("All"),[h,k]=r.useState("All"),R=r.useMemo(()=>b(a.flatMap(e=>Array.isArray(e.tags)?e.tags:e.tags?[e.tags]:[])),[a]),T=r.useMemo(()=>b(a.map(e=>e.country).filter(Boolean)),[a]),L=r.useMemo(()=>b(a.flatMap(e=>Array.isArray(e.authors)?e.authors:e.authors?[e.authors]:[])),[a]),c=r.useMemo(()=>{const e=n.trim().toLowerCase();let s=a;return e&&(s=s.filter(l=>{const i=(l.title||"").toLowerCase(),o=(Array.isArray(l.authors)?l.authors.join(", "):l.authors||"").toLowerCase();return i.includes(e)||o.includes(e)})),u!=="All"&&(s=s.filter(l=>Array.isArray(l.tags)?l.tags.includes(u):l.tags===u)),m!=="All"&&(s=s.filter(l=>l.country===m)),h!=="All"&&(s=s.filter(l=>Array.isArray(l.authors)?l.authors.includes(h):l.authors===h)),s.slice().sort(v)},[a,n,u,m,h]),[g,j]=r.useState(()=>new Set),d=r.useMemo(()=>c.filter(e=>g.has(e.id)).slice().sort(v),[c,g]),S=c.length,N=g.size;function M(e,s){j(l=>{const i=new Set(l);return s?i.add(e):i.delete(e),i})}function P(){c.length&&j(e=>{const s=new Set(e);for(const l of c)s.add(l.id);return s})}function E(){j(new Set)}const[$,I]=r.useState(!0),[V,x]=r.useState(null),[p,C]=r.useState(!1);async function D(){if(d.length){C(!0);try{const e=[];for(const s of d)try{const l=`./songs/${s.filename}`,i=await U(l),o=G(i),O=(o.blocks||[]).map(w=>({type:w.section,lines:(w.lines||[]).map(z=>z.text)})),q=s.filename.replace(/\.chordpro$/,"");e.push({id:s.id,title:o.meta.title||s.title||q,originalKey:o.meta.key||o.meta.originalkey||s.originalKey||"C",sections:O})}catch(l){console.error(l),y(`Failed to process ${s.filename}`)}if(e.length){const s=J(e,{baseFontPt:12,showChords:!0,docTitle:"Songbook"});(await Q(s)).save("Songbook.pdf")}}finally{C(!1)}}}function A(){}function W(e){var i;const s=(i=e.target.files)==null?void 0:i[0];if(!s){x(null);return}if(s.size>2*1024*1024){y("Image must be under 2 MB"),e.target.value="",x(null);return}if(!s.type.startsWith("image/")){y("File must be an image"),e.target.value="",x(null);return}const l=new FileReader;l.onload=()=>x(String(l.result||"")),l.readAsDataURL(s)}return a.length===0?t.jsx("div",{className:"BuilderPage",children:t.jsx("section",{className:"BuilderLeft",children:t.jsxs("header",{className:"BuilderHeader",children:[t.jsx("h1",{children:"No songs found"}),t.jsx("p",{className:"Small",children:"The song index is empty or failed to load."})]})})}):t.jsxs("div",{className:"BuilderPage",children:[t.jsx(K,{busy:p}),t.jsxs("section",{className:"BuilderLeft",children:[t.jsxs("header",{className:"BuilderHeader",children:[t.jsx("h1",{style:{margin:0},children:"Songbook Builder"}),t.jsxs("div",{className:"Row",style:{gap:"1rem",alignItems:"flex-end",flexWrap:"wrap"},children:[t.jsxs("div",{className:"Field",style:{minWidth:220},children:[t.jsx("label",{htmlFor:"sb-search",children:"Search:"}),t.jsx("input",{id:"sb-search",type:"search",placeholder:"Title or author",value:n,onChange:e=>f(e.target.value),style:{width:"100%"}})]}),t.jsxs("div",{className:"Field",children:[t.jsx("label",{htmlFor:"sb-tag",children:"Tag:"}),t.jsxs("select",{id:"sb-tag",value:u,onChange:e=>F(e.target.value),children:[t.jsx("option",{children:"All"}),R.map(e=>t.jsx("option",{value:e,children:e},e))]})]}),t.jsxs("div",{className:"Field",children:[t.jsx("label",{htmlFor:"sb-country",children:"Country:"}),t.jsxs("select",{id:"sb-country",value:m,onChange:e=>B(e.target.value),children:[t.jsx("option",{children:"All"}),T.map(e=>t.jsx("option",{value:e,children:e},e))]})]}),t.jsxs("div",{className:"Field",children:[t.jsx("label",{htmlFor:"sb-author",children:"Author:"}),t.jsxs("select",{id:"sb-author",value:h,onChange:e=>k(e.target.value),children:[t.jsx("option",{children:"All"}),L.map(e=>t.jsx("option",{value:e,children:e},e))]})]}),t.jsxs("div",{className:"Field",style:{marginLeft:"auto",gap:".5rem"},children:[t.jsxs("button",{className:"btn",onClick:P,disabled:!S,children:["Select all (",S," filtered)"]}),t.jsx("button",{className:"btn",onClick:E,disabled:!N,children:"Clear"})]})]}),t.jsxs("div",{className:"Row Small",style:{marginTop:".5rem"},children:[t.jsx("strong",{children:N})," selected"]})]}),t.jsx("div",{className:"BuilderScroll",role:"region","aria-label":"Song list",children:t.jsx("ul",{className:"BuilderList",children:c.map(e=>{const s=g.has(e.id),l=Array.isArray(e.authors)?e.authors.join(", "):e.authors||"",i=Array.isArray(e.tags)?e.tags.join(", "):e.tags||"";return t.jsx("li",{className:"BuilderRow",children:t.jsxs("label",{className:"RowMain",children:[t.jsx("input",{type:"checkbox",checked:s,onChange:o=>M(e.id,o.target.checked),"aria-label":`Select ${e.title}`}),t.jsxs("div",{className:"RowText",children:[t.jsx("div",{className:"RowTitle",children:e.title}),t.jsxs("div",{className:"RowMeta",children:[l||"—",i?` • ${i}`:"",e.country?` • ${e.country}`:""]})]})]})},e.id)})})})]}),t.jsxs("aside",{className:"BuilderRight",children:[t.jsx("div",{className:"RightSection",children:t.jsxs("div",{className:"Row",style:{justifyContent:"space-between",flexWrap:"wrap"},children:[t.jsxs("div",{className:"Field",children:[t.jsx("input",{id:"sb-toc",type:"checkbox",checked:$,onChange:e=>I(e.target.checked)}),t.jsx("label",{htmlFor:"sb-toc",children:"Include table of contents"})]}),t.jsxs("div",{className:"Field",children:[t.jsx("label",{htmlFor:"sb-cover",children:"Cover page (image):"}),t.jsx("input",{id:"sb-cover",className:"CoverInput",type:"file",accept:"image/*",onChange:W})]}),t.jsx("div",{className:"Field",style:{marginLeft:"auto"},children:t.jsx("button",{className:"btn",onClick:D,onMouseEnter:A,onFocus:A,disabled:!d.length||p,title:d.length?"Export PDF":"Select some songs first",children:p?"Exporting…":`Export PDF (${d.length})`})})]})}),t.jsx("div",{className:"RightSection RightScroll",role:"region","aria-label":"Selected songs",children:t.jsx("ol",{className:"List",style:{listStyle:"decimal inside"},children:d.map(e=>t.jsxs("li",{children:[e.title,Array.isArray(e.authors)&&e.authors.length?t.jsxs("span",{className:"Small",children:[" — ",e.authors.join(", ")]}):null]},e.id))})})]})]})}export{Y as default};
