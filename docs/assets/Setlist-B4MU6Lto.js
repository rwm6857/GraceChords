const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-HCL8bYOQ.js","./index-DuR_A0kQ.js","./index-DAWVrhm9.css","./jszip.min-CKh5HcVB.js"])))=>i.map(i=>d[i]);
import{j as e,u as ye,a as je,r as c,i as Se,d as we,F as ve,B as be,T as Ne,b as f,P as F,S as Pe,c as Ce,D as R,C as Ie,L as ke,M as Le,e as De,I as Te,f as H,K as $e,A as Ae,g as Ee,h as Oe,k as Ke,_ as V,l as _e,p as Be,s as Me,t as ze,n as Ue,m as I,o as Fe}from"./index-DuR_A0kQ.js";import{P as Re}from"./PageContainer-BT_ZlaPl.js";const Y="gracechords.sets.v1";function k(){try{const o=localStorage.getItem(Y);return o?JSON.parse(o):{sets:{}}}catch{return{sets:{}}}}function G(o){localStorage.setItem(Y,JSON.stringify(o))}function He(){return typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():"id-"+Math.random().toString(36).slice(2)+Date.now().toString(36)}function v(){const{sets:o}=k();return Object.values(o).sort((d,p)=>(p.updatedAt||0)-(d.updatedAt||0))}function We(o){const{sets:d}=k();return d[o]||null}function W(o){const d=Date.now(),p={id:o.id||He(),name:o.name?.trim()||"Untitled Set",items:Array.isArray(o.items)?o.items:[],createdAt:o.createdAt||d,updatedAt:d},g=k();return g.sets[p.id]=p,G(g),p}function Xe(o){const d=k();return d.sets[o]?(delete d.sets[o],G(d),!0):!1}function X({label:o,id:d,children:p,className:g="",...y}){return e.jsxs("label",{className:"gc-field",htmlFor:d,children:[o?e.jsx("span",{className:"gc-label",children:o}):null,e.jsx("span",{className:"gc-select",children:e.jsx("select",{id:d,className:g,...y,children:p})})]})}let J;const q=()=>J||(J=V(()=>import("./index-HCL8bYOQ.js").then(o=>o.i),__vite__mapDeps([0,1,2]),import.meta.url));function Ve(){const{code:o}=ye(),d=je(),[p,g]=c.useState("New Setlist"),[y,Q]=c.useState(""),[m,Z]=c.useState([]),[S,ee]=c.useState(()=>{try{return localStorage.getItem("pref:icpOnly")==="1"}catch{return!1}});c.useEffect(()=>{try{localStorage.setItem("pref:icpOnly",S?"1":"0")}catch{}},[S]);const[a,h]=c.useState([]),[$,te]=c.useState({}),[L,b]=c.useState("");Object.keys($).length;const[D,A]=c.useState(!1),[N,P]=c.useState(null),[se,E]=c.useState(()=>v()),[ne,C]=c.useState("");c.useEffect(()=>{const t=Se?.items||[],s=new Set,i=[];for(const n of t)s.has(n.id)||(s.add(n.id),i.push(n));Z(i)},[]),c.useEffect(()=>{let t=!1;async function s(){const i={};for(const n of a){const r=m.find(w=>w.id===n.id);if(!r)continue;const l=r.filename.replace(/\.chordpro$/i,""),u=`./pptx/${l}.pptx`;await Ke(u,l)&&(i[l]=!0)}t||te(i)}return s(),()=>{t=!0}},[a,m]),c.useEffect(()=>{if(!o)return;const{entries:t,error:s}=we(o);if(s){alert(s),d("/setlist",{replace:!0});return}h(t.map(i=>({id:i.id,toKey:i.toKey})))},[o]),c.useEffect(()=>{try{const t=localStorage.getItem("setlist");if(!t||v().length>0)return;const s=JSON.parse(t);if(s?.name||(s?.list?.length||0)>0){const i=W({name:s.name||"Imported Set",items:s.list||[]});E(v()),P(i.id),g(i.name),h(i.items||[]),C(i.id)}}catch{}},[]);const T=c.useMemo(()=>new ve(m,{keys:["title","tags"],threshold:.4}),[m]);function ie(t){return!S||(Array.isArray(t.tags)?t.tags.includes("ICP"):t.tags==="ICP")}const ae=c.useMemo(()=>(y?T.search(y).map(s=>s.item):m.slice().sort((s,i)=>s.title.localeCompare(i.title))).filter(ie),[y,T,m,S]);function O(t){a.find(s=>s.id===t.id)||h([...a,{id:t.id,toKey:t.originalKey||"C"}])}function oe(t){h(a.filter(s=>s.id!==t))}function K(t,s){const i=a.findIndex(u=>u.id===t);if(i<0)return;const n=i+(s==="up"?-1:1);if(n<0||n>=a.length)return;const r=a.slice(),[l]=r.splice(i,1);r.splice(n,0,l),h(r)}function re(t,s){const i=a.findIndex(l=>l.id===t);if(i<0||s<0||s>=a.length||i===s)return;const n=a.slice(),[r]=n.splice(i,1);n.splice(s,0,r),h(n)}function le(t,s){h(a.map(i=>i.id===t?{...i,toKey:s}:i))}function _(t){E(v()),C(t||"")}function B(){P(null),g("New Setlist"),h([]),C("")}function ce(){const t=p?.trim()||"New Setlist",s=window.prompt("Save set as:",t);if(s===null)return;const i=String(s).trim()||"New Setlist";let n=N;if(!n){const l=(v()||[]).find(u=>(u.name||"")===i);l&&(n=l.id)}const r=W({id:n,name:i,items:a});g(r.name),P(r.id),_(r.id)}function de(t){const s=t.target.value;if(C(s),!s)return;const i=We(s);i&&(P(i.id),g(i.name||"Untitled Set"),h(i.items||[]))}function ue(){N&&window.confirm(`Delete set "${p}"? This cannot be undone.`)&&(Xe(N),B(),_(""))}async function pe(){A(!0);try{const{downloadMultiSongPdf:t}=await q(),s=[];for(const i of a){const n=m.find(r=>r.id===i.id);if(n)try{const r=`./songs/${n.filename}`,l=await _e(r),u=Be(l),x=u.meta?.key||u.meta?.originalkey||n.originalKey||"C",w=Me(x,i.toKey||x),he=(u.sections||[]).map(z=>({section:z.label,lines:(z.lines||[]).map(j=>({plain:j.comment?j.comment:j.lyrics||"",chordPositions:(j.chords||[]).map(U=>({sym:ze(U.sym,w),index:U.index})),comment:j.comment?j.comment:void 0}))})),ge=n.filename.replace(/\.chordpro$/i,""),xe=Ue({title:u.meta?.title||n.title||ge,key:i.toKey||x,capo:u.meta?.capo,lyricsBlocks:he});s.push(xe)}catch(r){console.error(r),I(`Failed to process ${n.filename}`)}}s.length&&await t(s)}finally{A(!1)}}function M(){q()}async function fe(){try{const t=Fe(a),s=`${location.origin}${location.pathname}#/set/${t}`;await navigator.clipboard.writeText(s);try{I?.("Link copied!")}catch{}}catch{alert("Failed to copy link")}}async function me(){b(`Bundling 0/${a.length}…`);const t=(await V(async()=>{const{default:n}=await import("./jszip.min-CKh5HcVB.js").then(r=>r.j);return{default:n}},__vite__mapDeps([3,1,2]),import.meta.url)).default,s=new t;let i=0;for(let n=0;n<a.length;n++){const r=a[n],l=m.find(x=>x.id===r.id);if(!l){b(`Bundling ${n+1}/${a.length}…`);continue}b(`Bundling ${n+1}/${a.length}…`);const u=l.filename.replace(/\.chordpro$/i,"");if($[u])try{const x=await fetch(`./pptx/${u}.pptx`);if(!x.ok)continue;const w=await x.blob();i++,s.file(`${String(i).padStart(2,"0")}-${u}.pptx`,w)}catch{}}if(i>0){const n=await s.generateAsync({type:"blob"}),r=new Date().toISOString().slice(0,10).replace(/-/g,""),l=document.createElement("a");l.href=URL.createObjectURL(n),l.download=`setlist-pptx-${r}.zip`,l.click(),URL.revokeObjectURL(l.href)}else try{I&&I("No PPTX files found for selected songs")||alert("No PPTX files found for selected songs")}catch{}b("")}return e.jsxs(Re,{children:[e.jsx(be,{busy:D}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx("div",{}),e.jsx("h1",{style:{margin:0},children:"Setlist Builder"}),e.jsx("div",{})]}),e.jsxs(Ne,{className:"card",style:{marginTop:8,position:"static"},children:[e.jsx("div",{style:{display:"flex",alignItems:"center",gap:8,minWidth:0},children:e.jsx("strong",{title:"Current set name",style:{whiteSpace:"nowrap"},children:p||"New Setlist"})}),e.jsxs(X,{"aria-label":"Saved sets",value:ne,onChange:de,children:[e.jsx("option",{value:"",children:"— Load saved set —"}),se.map(t=>e.jsxs("option",{value:t.id,children:[t.name," · ",new Date(t.updatedAt).toLocaleString()]},t.id))]}),e.jsxs(f,{size:"sm",onClick:B,title:"New set",iconLeft:e.jsx(F,{}),children:[" ",e.jsx("span",{className:"text-when-wide",children:"New"})]}),e.jsxs(f,{size:"sm",variant:"primary",onClick:ce,title:"Save set",iconLeft:e.jsx(Pe,{}),children:[" ",e.jsx("span",{className:"text-when-wide",children:"Save"})]}),e.jsxs(f,{size:"sm",onClick:ue,disabled:!N,title:"Delete set",iconLeft:e.jsx(Ce,{}),children:[" ",e.jsx("span",{className:"text-when-wide",children:"Delete"})]}),e.jsxs("div",{style:{marginLeft:"auto",display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"},children:[e.jsx(f,{size:"sm",variant:"primary",onClick:pe,onMouseEnter:M,onFocus:M,disabled:D,title:"Export set as a single PDF",iconLeft:e.jsx(R,{}),children:D?"Exporting…":e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-when-wide",children:"Export PDF"}),e.jsx("span",{className:"text-when-narrow",children:"PDF"})]})}),e.jsx(f,{size:"sm",onClick:me,disabled:a.length===0||!!L,title:a.length===0?"Add songs to export PPTX bundle":"Export PPTX bundle for selected songs",iconLeft:e.jsx(R,{}),children:L||e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-when-wide",children:"Export PPTX"}),e.jsx("span",{className:"text-when-narrow",children:"PPTX"})]})}),e.jsx(f,{size:"sm",onClick:()=>h([]),title:"Clear setlist",iconLeft:e.jsx(Ie,{}),children:e.jsx("span",{className:"text-when-wide",children:"Clear"})}),e.jsxs(f,{size:"sm",variant:"primary",as:ke,to:a.length?`/worship/${a.map(t=>t.id).join(",")}?toKeys=${a.map(t=>encodeURIComponent(t.toKey)).join(",")}`:"#",title:a.length?"Open Worship Mode with this set":"Add songs to open Worship Mode","aria-disabled":!a.length,onClick:t=>{a.length||t.preventDefault()},iconLeft:e.jsx(Le,{}),children:[e.jsx("span",{className:"text-when-wide",children:"Worship Mode"}),e.jsx("span",{className:"text-when-narrow",children:"Worship"})]}),e.jsx(f,{size:"sm",variant:"primary",onClick:fe,title:"Copy shareable link",iconLeft:e.jsx(De,{}),children:"Copy Set Link"})]})]}),e.jsxs("div",{className:"BuilderPage",style:{marginTop:8},children:[e.jsx("div",{className:"BuilderLeft",children:e.jsx("div",{className:"card",style:{display:"flex",flexDirection:"column",flex:"1 1 auto",minHeight:0},children:e.jsxs("div",{className:"BuilderScroll",style:{minHeight:0,flex:"1 1 auto",overflow:"auto",marginTop:8},children:[e.jsxs("div",{className:"BuilderHeader",style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx("strong",{style:{whiteSpace:"nowrap"},children:"Add songs"}),e.jsx(Te,{value:y,onChange:t=>Q(t.target.value),placeholder:"Search...",style:{flex:1,minWidth:0}}),e.jsxs("label",{className:"row",style:{gap:6,alignItems:"center"},children:[e.jsx("input",{type:"checkbox",checked:S,onChange:t=>ee(t.target.checked)}),e.jsx("span",{className:"meta",title:"Limit results to songs tagged ICP",children:"ICP only"})]})]}),T?e.jsx("div",{style:{display:"grid",gap:".5rem",gridTemplateColumns:"repeat(auto-fill, minmax(320px, 1fr))",marginTop:6},children:ae.map(t=>e.jsx(H,{title:t.title,subtitle:`${t.originalKey||""}${t.tags?.length?` • ${t.tags.join(", ")}`:""}`,rightSlot:e.jsx(f,{"aria-label":"Add",title:"Add to set",variant:"primary",iconLeft:e.jsx(F,{}),iconOnly:!0,onClick:s=>{s.stopPropagation(),O(t)}}),onClick:()=>O(t)},t.id))}):e.jsx("div",{children:"Loading search…"})]})})}),e.jsx("div",{className:"BuilderRight",style:{minHeight:0,display:"flex",flexDirection:"column"},children:e.jsxs("div",{className:"card",style:{display:"flex",flexDirection:"column",flex:"1 1 auto",minHeight:0},children:[e.jsxs("div",{className:"BuilderScroll",style:{minHeight:0,flex:"1 1 auto",overflow:"auto",marginTop:8},children:[e.jsx("div",{className:"BuilderHeader",children:e.jsxs("strong",{children:["Current setlist (",a.length,")"]})}),e.jsx("div",{style:{marginTop:6},children:a.map((t,s)=>{const i=m.find(n=>n.id===t.id);return i?e.jsx(H,{draggable:!0,onDragStart:n=>{n.dataTransfer.setData("text/plain",String(t.id)),n.dataTransfer.effectAllowed="move"},onDragOver:n=>{n.preventDefault(),n.dataTransfer.dropEffect="move"},onDrop:n=>{n.preventDefault();const r=n.dataTransfer.getData("text/plain");re(r,s)},title:i.title,subtitle:`Original: ${i.originalKey||"—"}`,rightSlot:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx(X,{value:t.toKey,onChange:n=>le(t.id,n.target.value),children:$e.map(n=>e.jsx("option",{value:n,children:n},n))}),e.jsx(f,{onClick:()=>K(t.id,"up"),title:"Move up",iconLeft:e.jsx(Ae,{})}),e.jsx(f,{onClick:()=>K(t.id,"down"),title:"Move down",iconLeft:e.jsx(Ee,{})}),e.jsx(f,{onClick:()=>oe(t.id),title:"Remove",iconLeft:e.jsx(Oe,{}),iconOnly:!0,style:{color:"#b91c1c"}})]})},t.id):null})})]}),e.jsxs("div",{className:"print-only",style:{marginTop:16},children:[e.jsx("h2",{style:{fontSize:"20pt",margin:"0 0 8pt 0"},children:p}),e.jsx("ol",{style:{fontSize:"12pt",lineHeight:1.4,paddingLeft:"1.2em"},children:a.map(t=>{const s=m.find(i=>i.id===t.id);return s?e.jsxs("li",{children:[s.title," — ",t.toKey||s.originalKey||"—"]},t.id):null})})]})]})})]})]})}export{Ve as default};
