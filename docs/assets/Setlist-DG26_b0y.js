const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-Do0Ae7SS.js","./index-CwGkKebm.js","./index-459icH9f.css","./jszip.min-D83bkuvk.js"])))=>i.map(i=>d[i]);
import{j as e,u as ke,a as Te,r as l,i as De,d as $e,F as Ee,B as d,b as Oe,T as G,D as $,L as Q,c as Z,M as ee,S as Ae,C as Ke,P as te,e as Be,I as _e,f as se,K as Me,A as ze,g as Fe,h as Re,k as Ue,_ as oe,l as We,p as Xe,s as He,t as Je,n as qe,m as E,o as Ve}from"./index-CwGkKebm.js";import{P as Ye}from"./PageContainer-CGzkVIYp.js";const re="gracechords.sets.v1";function O(){try{const o=localStorage.getItem(re);return o?JSON.parse(o):{sets:{}}}catch{return{sets:{}}}}function le(o){localStorage.setItem(re,JSON.stringify(o))}function Ge(){return typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():"id-"+Math.random().toString(36).slice(2)+Date.now().toString(36)}function b(){const{sets:o}=O();return Object.values(o).sort((p,m)=>(m.updatedAt||0)-(p.updatedAt||0))}function Qe(o){const{sets:p}=O();return p[o]||null}function ne(o){const p=Date.now(),m={id:o.id||Ge(),name:o.name?.trim()||"Untitled Set",items:Array.isArray(o.items)?o.items:[],createdAt:o.createdAt||p,updatedAt:p},h=O();return h.sets[m.id]=m,le(h),m}function Ze(o){const p=O();return p.sets[o]?(delete p.sets[o],le(p),!0):!1}function et({label:o,id:p,children:m,className:h="",...y}){return e.jsxs("label",{className:"gc-field",htmlFor:p,children:[o?e.jsx("span",{className:"gc-label",children:o}):null,e.jsx("span",{className:"gc-select",children:e.jsx("select",{id:p,className:h,...y,children:m})})]})}let ie;const ae=()=>ie||(ie=oe(()=>import("./index-Do0Ae7SS.js").then(o=>o.i),__vite__mapDeps([0,1,2]),import.meta.url));function it(){const{code:o}=ke(),p=Te(),[m,h]=l.useState("New Setlist"),[y,ce]=l.useState(""),[f,de]=l.useState([]),[w,pe]=l.useState(()=>{try{return localStorage.getItem("pref:icpOnly")==="1"}catch{return!1}});l.useEffect(()=>{try{localStorage.setItem("pref:icpOnly",w?"1":"0")}catch{}},[w]);const[a,g]=l.useState([]),[K,ue]=l.useState({}),[C,P]=l.useState("");Object.keys(K).length;const[N,B]=l.useState(!1),[me,fe]=l.useState(()=>{try{return window.innerWidth<=640}catch{return!1}}),[tt,he]=l.useState(()=>{try{return window.innerWidth<=820}catch{return!1}}),[I,L]=l.useState(null),[v,_]=l.useState(()=>b()),[M,k]=l.useState(""),[ge,T]=l.useState(!1),[z,F]=l.useState("");l.useEffect(()=>{const t=De?.items||[],s=new Set,i=[];for(const n of t)s.has(n.id)||(s.add(n.id),i.push(n));de(i)},[]),l.useEffect(()=>{let t=!1;async function s(){const i={};for(const n of a){const r=f.find(S=>S.id===n.id);if(!r)continue;const c=r.filename.replace(/\.chordpro$/i,""),u=`./pptx/${c}.pptx`;await Ue(u,c)&&(i[c]=!0)}t||ue(i)}return s(),()=>{t=!0}},[a,f]),l.useEffect(()=>{if(!o)return;const{entries:t,error:s}=$e(o);if(s){alert(s),p("/setlist",{replace:!0});return}g(t.map(i=>({id:i.id,toKey:i.toKey})))},[o]),l.useEffect(()=>{try{const t=localStorage.getItem("setlist");if(!t||b().length>0)return;const s=JSON.parse(t);if(s?.name||(s?.list?.length||0)>0){const i=ne({name:s.name||"Imported Set",items:s.list||[]});_(b()),L(i.id),h(i.name),g(i.items||[]),k(i.id)}}catch{}},[]),l.useEffect(()=>{function t(){try{const s=window.innerWidth;fe(s<=640),he(s<=820)}catch{}}return window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[]);const A=l.useMemo(()=>new Ee(f,{keys:["title","tags"],threshold:.4}),[f]);function xe(t){return!w||(Array.isArray(t.tags)?t.tags.includes("ICP"):t.tags==="ICP")}const ye=l.useMemo(()=>(y?A.search(y).map(s=>s.item):f.slice().sort((s,i)=>s.title.localeCompare(i.title))).filter(xe),[y,A,f,w]);function R(t){a.find(s=>s.id===t.id)||g([...a,{id:t.id,toKey:t.originalKey||"C"}])}function je(t){g(a.filter(s=>s.id!==t))}function U(t,s){const i=a.findIndex(u=>u.id===t);if(i<0)return;const n=i+(s==="up"?-1:1);if(n<0||n>=a.length)return;const r=a.slice(),[c]=r.splice(i,1);r.splice(n,0,c),g(r)}function we(t,s){const i=a.findIndex(c=>c.id===t);if(i<0||s<0||s>=a.length||i===s)return;const n=a.slice(),[r]=n.splice(i,1);n.splice(s,0,r),g(n)}function ve(t,s){g(a.map(i=>i.id===t?{...i,toKey:s}:i))}function W(t){_(b()),k(t||"")}function X(){L(null),h("New Setlist"),g([]),k("")}function Se(){const t=m?.trim()||"New Setlist",s=window.prompt("Save set as:",t);if(s===null)return;const i=String(s).trim()||"New Setlist";let n=I;if(!n){const c=(b()||[]).find(u=>(u.name||"")===i);c&&(n=c.id)}const r=ne({id:n,name:i,items:a});h(r.name),L(r.id),W(r.id)}function be(){const t=z||M||"";if(!t){T(!1);return}const s=Qe(t);s&&(L(s.id),h(s.name||"New Setlist"),g(s.items||[]),k(s.id)),T(!1)}function Ce(){const t=v[0]?.id||"";F(M||t),T(!0)}function Pe(){I&&window.confirm(`Delete set "${m}"? This cannot be undone.`)&&(Ze(I),X(),W(""))}async function H(){B(!0);try{const{downloadMultiSongPdf:t}=await ae(),s=[];for(const i of a){const n=f.find(r=>r.id===i.id);if(n)try{const r=`./songs/${n.filename}`,c=await We(r),u=Xe(c),x=u.meta?.key||u.meta?.originalkey||n.originalKey||"C",S=He(x,i.toKey||x),Ne=(u.sections||[]).map(V=>({section:V.label,lines:(V.lines||[]).map(j=>({plain:j.comment?j.comment:j.lyrics||"",chordPositions:(j.chords||[]).map(Y=>({sym:Je(Y.sym,S),index:Y.index})),comment:j.comment?j.comment:void 0}))})),Ie=n.filename.replace(/\.chordpro$/i,""),Le=qe({title:u.meta?.title||n.title||Ie,key:i.toKey||x,capo:u.meta?.capo,lyricsBlocks:Ne});s.push(Le)}catch(r){console.error(r),E(`Failed to process ${n.filename}`)}}s.length&&await t(s)}finally{B(!1)}}function D(){ae()}async function J(){try{const t=Ve(a),s=`${location.origin}${location.pathname}#/set/${t}`;await navigator.clipboard.writeText(s);try{E?.("Link copied!")}catch{}}catch{alert("Failed to copy link")}}async function q(){P(`Bundling 0/${a.length}…`);const t=(await oe(async()=>{const{default:n}=await import("./jszip.min-D83bkuvk.js").then(r=>r.j);return{default:n}},__vite__mapDeps([3,1,2]),import.meta.url)).default,s=new t;let i=0;for(let n=0;n<a.length;n++){const r=a[n],c=f.find(x=>x.id===r.id);if(!c){P(`Bundling ${n+1}/${a.length}…`);continue}P(`Bundling ${n+1}/${a.length}…`);const u=c.filename.replace(/\.chordpro$/i,"");if(K[u])try{const x=await fetch(`./pptx/${u}.pptx`);if(!x.ok)continue;const S=await x.blob();i++,s.file(`${String(i).padStart(2,"0")}-${u}.pptx`,S)}catch{}}if(i>0){const n=await s.generateAsync({type:"blob"}),r=new Date().toISOString().slice(0,10).replace(/-/g,""),c=document.createElement("a");c.href=URL.createObjectURL(n),c.download=`setlist-pptx-${r}.zip`,c.click(),URL.revokeObjectURL(c.href)}else try{E&&E("No PPTX files found for selected songs")||alert("No PPTX files found for selected songs")}catch{}P("")}return e.jsxs(Ye,{children:[ge?e.jsx("div",{style:{position:"fixed",inset:0,display:"flex",alignItems:"center",justifyContent:"center",background:"rgba(0,0,0,.45)",zIndex:90},role:"dialog","aria-modal":"true",children:e.jsxs("div",{style:{background:"var(--card)",color:"var(--text)",border:"1px solid var(--line)",borderRadius:10,padding:16,width:"min(560px, 92vw)"},children:[e.jsx("h3",{style:{marginTop:0,marginBottom:8},children:"Load Set"}),v.length?e.jsxs("label",{style:{display:"block",margin:"8px 0"},children:["Select a saved set",e.jsx("select",{value:z,onChange:t=>F(t.target.value),style:{width:"100%"},children:v.map(t=>e.jsxs("option",{value:t.id,children:[t.name," · ",new Date(t.updatedAt).toLocaleString()]},t.id))})]}):e.jsx("div",{className:"meta",children:"No saved sets yet."}),e.jsxs("div",{className:"row",style:{justifyContent:"flex-end",gap:8,marginTop:12},children:[e.jsx(d,{onClick:()=>T(!1),children:"Cancel"}),e.jsx(d,{variant:"primary",onClick:be,disabled:!v.length,children:"Load"})]})]})}):null,e.jsx(Oe,{busy:N}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginTop:12,marginBottom:4},children:[e.jsx("div",{}),e.jsx("h1",{style:{margin:0},children:"Setlist Builder"}),e.jsx("div",{})]}),me?e.jsx(G,{className:"card",style:{marginTop:8,position:"static"},children:e.jsxs("div",{className:"setlist-actions--mobile",style:{width:"100%"},children:[e.jsx(d,{variant:"primary",onClick:H,onMouseEnter:D,onFocus:D,disabled:N||a.length===0,title:"Export set as a single PDF",iconLeft:e.jsx($,{}),children:"PDF"}),e.jsx(d,{onClick:q,disabled:a.length===0||!!C,title:a.length===0?"Add songs to export PPTX bundle":"Export PPTX bundle for selected songs",iconLeft:e.jsx($,{}),children:"PPTX"}),e.jsx(d,{onClick:J,title:"Copy shareable link",iconLeft:e.jsx(Q,{}),disabled:a.length===0,children:"Share"}),e.jsx(d,{as:Z,to:a.length?`/worship/${a.map(t=>t.id).join(",")}?toKeys=${a.map(t=>encodeURIComponent(t.toKey)).join(",")}`:"/worship",title:"Open Worship Mode",iconLeft:e.jsx(ee,{}),children:"Worship"})]})}):e.jsxs(G,{className:"card",style:{marginTop:8,position:"static"},children:[e.jsx("div",{style:{width:"100%",marginBottom:6},children:e.jsx("strong",{title:"Current set name",children:m||"New Setlist"})}),e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",flexWrap:"wrap",width:"100%"},children:[e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"},children:[e.jsxs(d,{size:"sm",variant:"secondary",onClick:Se,title:"Save set",iconLeft:e.jsx(Ae,{}),children:[" ",e.jsx("span",{className:"text-when-wide",children:"Save"})]}),e.jsxs(d,{size:"sm",variant:"secondary",onClick:Ce,title:"Load saved set",iconLeft:e.jsx(Ke,{}),disabled:!v.length,children:[" ",e.jsx("span",{className:"text-when-wide",children:"Load"})]}),e.jsxs(d,{size:"sm",variant:"secondary",onClick:X,title:"New set",iconLeft:e.jsx(te,{}),children:[" ",e.jsx("span",{className:"text-when-wide",children:"New"})]}),e.jsxs(d,{size:"sm",variant:"secondary",onClick:Pe,disabled:!I,title:"Delete set",iconLeft:e.jsx(Be,{}),children:[" ",e.jsx("span",{className:"text-when-wide",children:"Delete"})]})]}),e.jsxs("div",{style:{marginLeft:"auto",display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"},children:[e.jsx(d,{variant:"primary",size:"md",onClick:H,onMouseEnter:D,onFocus:D,disabled:N||a.length===0,title:"Export set as a single PDF",iconLeft:e.jsx($,{}),children:N?"Exporting…":e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-when-wide",children:"Export PDF"}),e.jsx("span",{className:"text-when-narrow",children:"PDF"})]})}),e.jsx(d,{variant:"primary",size:"md",onClick:q,disabled:a.length===0||!!C,title:a.length===0?"Add songs to export PPTX bundle":"Export PPTX bundle for selected songs",iconLeft:e.jsx($,{}),children:C||e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-when-wide",children:"Export PPTX"}),e.jsx("span",{className:"text-when-narrow",children:"PPTX"})]})}),e.jsx(d,{variant:"primary",size:"md",onClick:J,title:"Copy shareable link",iconLeft:e.jsx(Q,{}),disabled:a.length===0,children:"Share Set"}),e.jsxs(d,{variant:"primary",size:"md",as:Z,to:a.length?`/worship/${a.map(t=>t.id).join(",")}?toKeys=${a.map(t=>encodeURIComponent(t.toKey)).join(",")}`:"/worship",title:"Open Worship Mode",iconLeft:e.jsx(ee,{}),children:[" ",e.jsx("span",{className:"text-when-wide",children:"Worship Mode"}),e.jsx("span",{className:"text-when-narrow",children:"Worship"})]})]})]})]}),e.jsxs("div",{className:"BuilderPage",style:{marginTop:8},children:[e.jsx("div",{className:"BuilderLeft",children:e.jsx("div",{className:"card",style:{display:"flex",flexDirection:"column",flex:"1 1 auto",minHeight:0},children:e.jsxs("div",{className:"BuilderScroll pane--addSongs",style:{minHeight:0,flex:"1 1 auto",overflow:"auto",marginTop:8},children:[e.jsxs("div",{className:"BuilderHeader",style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx("strong",{style:{whiteSpace:"nowrap"},children:"Add songs"}),e.jsx(_e,{value:y,onChange:t=>ce(t.target.value),placeholder:"Search...",style:{flex:1,minWidth:0}}),e.jsxs("label",{className:"row",style:{gap:6,alignItems:"center"},children:[e.jsx("input",{type:"checkbox",checked:w,onChange:t=>pe(t.target.checked)}),e.jsx("span",{className:"meta",title:"Limit results to songs tagged ICP",children:"ICP only"})]})]}),A?e.jsx("div",{style:{display:"grid",gap:".5rem",gridTemplateColumns:"repeat(auto-fill, minmax(320px, 1fr))",marginTop:6},children:ye.map(t=>e.jsx(se,{title:t.title,subtitle:`${t.originalKey||""}${t.tags?.length?` • ${t.tags.join(", ")}`:""}`,rightSlot:e.jsx(d,{"aria-label":"Add",title:"Add to set",variant:"primary",iconLeft:e.jsx(te,{}),iconOnly:!0,onClick:s=>{s.stopPropagation(),R(t)}}),onClick:()=>R(t)},t.id))}):e.jsx("div",{children:"Loading search…"})]})})}),e.jsx("div",{className:"BuilderRight",style:{minHeight:0,display:"flex",flexDirection:"column"},children:e.jsxs("div",{className:"card",style:{display:"flex",flexDirection:"column",flex:"1 1 auto",minHeight:0},children:[e.jsxs("div",{className:"BuilderScroll pane--currentSet",style:{minHeight:0,flex:"1 1 auto",overflow:"auto",marginTop:8},children:[e.jsx("div",{className:"BuilderHeader",children:e.jsxs("strong",{children:["Current setlist (",a.length,")"]})}),e.jsx("div",{style:{marginTop:6},children:a.map((t,s)=>{const i=f.find(n=>n.id===t.id);return i?e.jsx(se,{draggable:!0,onDragStart:n=>{n.dataTransfer.setData("text/plain",String(t.id)),n.dataTransfer.effectAllowed="move"},onDragOver:n=>{n.preventDefault(),n.dataTransfer.dropEffect="move"},onDrop:n=>{n.preventDefault();const r=n.dataTransfer.getData("text/plain");we(r,s)},title:i.title,subtitle:`Original: ${i.originalKey||"—"}`,rightSlot:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx(et,{value:t.toKey,onChange:n=>ve(t.id,n.target.value),children:Me.map(n=>e.jsx("option",{value:n,children:n},n))}),e.jsx(d,{onClick:()=>U(t.id,"up"),title:"Move up",iconLeft:e.jsx(ze,{})}),e.jsx(d,{onClick:()=>U(t.id,"down"),title:"Move down",iconLeft:e.jsx(Fe,{})}),e.jsx(d,{onClick:()=>je(t.id),title:"Remove",iconLeft:e.jsx(Re,{}),iconOnly:!0,style:{color:"#b91c1c"}})]})},t.id):null})})]}),e.jsxs("div",{className:"print-only",style:{marginTop:16},children:[e.jsx("h2",{style:{fontSize:"20pt",margin:"0 0 8pt 0"},children:m}),e.jsx("ol",{style:{fontSize:"12pt",lineHeight:1.4,paddingLeft:"1.2em"},children:a.map(t=>{const s=f.find(i=>i.id===t.id);return s?e.jsxs("li",{children:[s.title," — ",t.toKey||s.originalKey||"—"]},t.id):null})})]})]})})]})]})}export{it as default};
