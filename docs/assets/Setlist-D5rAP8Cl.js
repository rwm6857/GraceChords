const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./pdf-CWxZl5-C.js","./index-C5OcVrnI.js","./index-Druc7_JO.css","./fonts-OQpvcT7Z.js","./pdfLayout-BuE93-3l.js","./jszip.min-BXgF9nsB.js"])))=>i.map(i=>d[i]);
import{r as u,i as he,F as ge,j as t,B as xe,L as ye,K as je,A as Se,a as be,R as ve,D as M,h as we,t as F,_ as J,f as Ce,p as Ne,s as ke,b as Pe}from"./index-C5OcVrnI.js";const W="gracechords.sets.v1";function N(){try{const o=localStorage.getItem(W);return o?JSON.parse(o):{sets:{}}}catch{return{sets:{}}}}function V(o){localStorage.setItem(W,JSON.stringify(o))}function Ke(){return typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():"id-"+Math.random().toString(36).slice(2)+Date.now().toString(36)}function w(){const{sets:o}=N();return Object.values(o).sort((a,p)=>(p.updatedAt||0)-(a.updatedAt||0))}function X(o){const{sets:a}=N();return a[o]||null}function C(o){var d;const a=Date.now(),p={id:o.id||Ke(),name:((d=o.name)==null?void 0:d.trim())||"Untitled Set",items:Array.isArray(o.items)?o.items:[],createdAt:o.createdAt||a,updatedAt:a},y=N();return y.sets[p.id]=p,V(y),p}function Ie(o){const a=N();return a.sets[o]?(delete a.sets[o],V(a),!0):!1}function $e(o){const a=X(o);return a?C({name:`Copy of ${a.name}`,items:a.items.map(p=>({...p}))}):null}let z;const H=()=>z||(z=J(()=>import("./pdf-CWxZl5-C.js"),__vite__mapDeps([0,1,2,3,4]),import.meta.url));function _e(){const[o,a]=u.useState("Untitled Set"),[p,y]=u.useState(""),[d,Y]=u.useState([]),[l,f]=u.useState([]),[$,q]=u.useState({}),[k,j]=u.useState(""),T=Object.keys($).length,[P,_]=u.useState(!1),[g,x]=u.useState(null),[G,A]=u.useState(()=>w()),[Q,S]=u.useState("");u.useEffect(()=>{var e;Y(((e=he)==null?void 0:e.items)||[])},[]),u.useEffect(()=>{let e=!1;async function s(){const n={};for(const i of l){const r=d.find(h=>h.id===i.id);if(!r)continue;const c=`./pptx/${r.id}.pptx`;await we(c,r.id)&&(n[r.id]=!0)}e||q(n)}return s(),()=>{e=!0}},[l,d]),u.useEffect(()=>{var e;try{const s=localStorage.getItem("setlist");if(!s||w().length>0)return;const n=JSON.parse(s);if(n!=null&&n.name||(((e=n==null?void 0:n.list)==null?void 0:e.length)||0)>0){const i=C({name:n.name||"Imported Set",items:n.list||[]});A(w()),x(i.id),a(i.name),f(i.items||[]),S(i.id)}}catch{}},[]);const K=u.useMemo(()=>new ge(d,{keys:["title","tags"],threshold:.4}),[d]),Z=u.useMemo(()=>p?K.search(p).map(e=>e.item):d.slice().sort((e,s)=>e.title.localeCompare(s.title)),[p,K,d]);function ee(e){l.find(s=>s.id===e.id)||f([...l,{id:e.id,toKey:e.originalKey||"C"}])}function te(e){f(l.filter(s=>s.id!==e))}function D(e,s){const n=l.findIndex(m=>m.id===e);if(n<0)return;const i=n+(s==="up"?-1:1);if(i<0||i>=l.length)return;const r=l.slice(),[c]=r.splice(n,1);r.splice(i,0,c),f(r)}function ne(e,s){f(l.map(n=>n.id===e?{...n,toKey:s}:n))}function L(e){f(s=>s.map(n=>{const i=d.find(c=>c.id===n.id),r=n.toKey||(i==null?void 0:i.originalKey)||"C";return{...n,toKey:F(r,e)}}))}function se(){f(e=>e.map(s=>{const n=d.find(i=>i.id===s.id);return{...s,toKey:(n==null?void 0:n.originalKey)||"C"}}))}function b(e){A(w()),S(e||"")}function E(){x(null),a("Untitled Set"),f([]),S("")}function ie(){const e=(o==null?void 0:o.trim())||"Untitled Set",s=C({id:g,name:e,items:l});a(s.name),x(s.id),b(s.id)}function oe(e){const s=e.target.value;if(S(s),!s)return;const n=X(s);n&&(x(n.id),a(n.name||"Untitled Set"),f(n.items||[]))}function ae(){if(!g){const s=`Copy of ${o||"Untitled Set"}`,n=C({id:null,name:s,items:l});a(n.name),x(n.id),b(n.id);return}const e=$e(g);e&&(x(e.id),a(e.name),f(e.items||[]),b(e.id))}function le(){g&&window.confirm(`Delete set "${o}"? This cannot be undone.`)&&(Ie(g),E(),b(""))}async function re(){var e,s,n;_(!0);try{const{downloadMultiSongPdf:i}=await H(),r=[];for(const c of l){const m=d.find(h=>h.id===c.id);if(m)try{const h=`./songs/${m.filename}`,ue=await Ce(h),v=Ne(ue),I=((e=v.meta)==null?void 0:e.key)||((s=v.meta)==null?void 0:s.originalkey)||m.originalKey||"C",me=ke(I,c.toKey||I),pe=(v.blocks||[]).map(O=>({section:O.section,lines:(O.lines||[]).map(R=>({plain:R.text,chordPositions:(R.chords||[]).map(B=>({sym:F(B.sym,me),index:B.index}))}))})),fe=m.filename.replace(/\.chordpro$/i,"");r.push({title:((n=v.meta)==null?void 0:n.title)||m.title||fe,key:c.toKey||I,lyricsBlocks:pe})}catch(h){console.error(h),Pe(`Failed to process ${m.filename}`)}}r.length&&await i(r,{lyricSizePt:16,chordSizePt:16})}finally{_(!1)}}function U(){H()}async function ce(){j(`Bundling 0/${l.length}…`);const e=(await J(async()=>{const{default:i}=await import("./jszip.min-BXgF9nsB.js").then(r=>r.j);return{default:i}},__vite__mapDeps([5,1,2]),import.meta.url)).default,s=new e;let n=0;for(let i=0;i<l.length;i++){const r=l[i],c=d.find(m=>m.id===r.id);if(!c){j(`Bundling ${i+1}/${l.length}…`);continue}if(j(`Bundling ${i+1}/${l.length}…`),!!$[c.id])try{const m=await fetch(`./pptx/${c.id}.pptx`);if(!m.ok)continue;const h=await m.blob();n++,s.file(`${String(n).padStart(2,"0")}-${c.id}.pptx`,h)}catch{}}if(n>0){const i=await s.generateAsync({type:"blob"}),r=new Date().toISOString().slice(0,10).replace(/-/g,""),c=document.createElement("a");c.href=URL.createObjectURL(i),c.download=`setlist-pptx-${r}.zip`,c.click(),URL.revokeObjectURL(c.href)}j("")}function de(){window.print()}return t.jsxs("div",{className:"container",children:[t.jsx(xe,{busy:P}),t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[t.jsx("div",{children:t.jsx(ye,{to:"/",className:"back",children:"← Back"})}),t.jsx("h1",{style:{margin:0},children:"Setlist Builder"}),t.jsx("div",{})]}),t.jsxs("div",{className:"card toolbar",style:{marginTop:12},children:[t.jsxs("label",{style:{display:"flex",alignItems:"center",gap:6},children:[t.jsx("span",{children:"Set:"}),t.jsx("input",{"aria-label":"Set name",value:o,onChange:e=>a(e.target.value),style:{minWidth:220},placeholder:"Sunday AM"})]}),t.jsxs("select",{"aria-label":"Saved sets",value:Q,onChange:oe,children:[t.jsx("option",{value:"",children:"— Load saved set —"}),G.map(e=>t.jsxs("option",{value:e.id,children:[e.name," · ",new Date(e.updatedAt).toLocaleString()]},e.id))]}),t.jsx("button",{className:"btn",onClick:E,children:"New"}),t.jsx("button",{className:"btn primary",onClick:ie,children:"Save"}),t.jsx("button",{className:"btn",onClick:ae,disabled:!l.length,children:"Duplicate"}),t.jsx("button",{className:"btn",onClick:le,disabled:!g,children:"Delete"}),t.jsxs("div",{style:{marginLeft:"auto",display:"flex",alignItems:"center",gap:6},children:[t.jsx("span",{className:"meta",children:"Transpose:"}),t.jsx("button",{className:"btn",onClick:()=>L(-1),title:"Transpose set down 1 semitone",children:"–1"}),t.jsx("button",{className:"btn",onClick:se,title:"Reset all to originals",children:"Reset"}),t.jsx("button",{className:"btn",onClick:()=>L(1),title:"Transpose set up 1 semitone",children:"+1"})]})]}),t.jsxs("div",{className:"card",style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12},children:[t.jsx("div",{children:t.jsxs("div",{style:{marginTop:8},children:[t.jsx("strong",{children:"Add songs"}),t.jsx("input",{value:p,onChange:e=>y(e.target.value),placeholder:"Search...",style:{display:"block",width:"100%",marginTop:6}}),t.jsx("div",{style:{minHeight:0,maxHeight:300,overflow:"auto",marginTop:6},children:K?Z.map(e=>{var s;return t.jsxs("div",{className:"row",style:{padding:"6px 0"},children:[t.jsxs("div",{style:{flex:1},children:[t.jsx("div",{style:{fontWeight:600},children:e.title}),t.jsxs("div",{className:"meta",children:[e.originalKey||"",(s=e.tags)!=null&&s.length?` • ${e.tags.join(", ")}`:""]})]}),t.jsx("button",{className:"btn",onClick:()=>ee(e),children:"Add"})]},e.id)}):t.jsx("div",{children:"Loading search…"})})]})}),t.jsxs("div",{children:[t.jsxs("strong",{children:["Current setlist (",l.length,")"]}),t.jsx("div",{style:{minHeight:0,maxHeight:360,overflow:"auto",marginTop:6},children:l.map(e=>{const s=d.find(n=>n.id===e.id);return s?t.jsxs("div",{className:"row",style:{padding:"6px 0"},children:[t.jsxs("div",{style:{flex:1},children:[t.jsx("div",{style:{fontWeight:600},children:s.title}),t.jsxs("div",{className:"meta",children:["Original: ",s.originalKey||"—"]})]}),t.jsx("select",{value:e.toKey,onChange:n=>ne(e.id,n.target.value),children:je.map(n=>t.jsx("option",{value:n,children:n},n))}),t.jsx("button",{className:"btn",onClick:()=>D(e.id,"up"),title:"Move up",children:t.jsx(Se,{})}),t.jsx("button",{className:"btn",onClick:()=>D(e.id,"down"),title:"Move down",children:t.jsx(be,{})}),t.jsx("button",{className:"btn",onClick:()=>te(e.id),title:"Remove",children:t.jsx(ve,{})})]},e.id):null})}),t.jsxs("div",{style:{display:"flex",gap:8,marginTop:8},children:[t.jsx("button",{className:"btn primary iconbtn",onClick:re,onMouseEnter:U,onFocus:U,disabled:P,children:P?"Exporting…":t.jsxs(t.Fragment,{children:[t.jsx(M,{})," Export PDF"]})}),t.jsx("button",{className:"btn iconbtn",onClick:ce,disabled:T===0||!!k,title:T===0?"No PPTX files found for this set.":"",children:k||t.jsxs(t.Fragment,{children:[t.jsx(M,{})," Bundle PPTX"]})}),t.jsx("button",{className:"btn",onClick:de,children:"Print"}),t.jsx("button",{className:"btn",onClick:()=>f([]),children:"Clear"})]}),t.jsxs("div",{className:"print-only",style:{marginTop:16},children:[t.jsx("h2",{style:{fontSize:"20pt",margin:"0 0 8pt 0"},children:o}),t.jsx("ol",{style:{fontSize:"12pt",lineHeight:1.4,paddingLeft:"1.2em"},children:l.map(e=>{const s=d.find(n=>n.id===e.id);return s?t.jsxs("li",{children:[s.title," — ",e.toKey||s.originalKey||"—"]},e.id):null})})]})]})]})]})}export{_e as default};
