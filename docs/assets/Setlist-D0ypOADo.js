const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-Eu5fzyPJ.js","./index-BVo-Ho11.js","./index-DzN3YmhX.css","./jszip.min-DrRFyG8q.js"])))=>i.map(i=>d[i]);
import{j as t,u as Ae,a as Ue,b as Re,r as c,i as Me,d as _e,F as ze,B as p,c as Fe,T as ne,D as O,L as ie,e as oe,M as ae,S as We,C as Ye,P as re,f as Xe,I as qe,g as le,K as He,A as Je,h as Ve,k as Ge,l as Qe,_ as pe,m as Ze,p as et,s as tt,t as st,n as nt,o as it,q as B}from"./index-BVo-Ho11.js";import{P as ot}from"./PageContainer-CBppqG-G.js";const me="gracechords.sets.v1";function U(){try{const a=localStorage.getItem(me);return a?JSON.parse(a):{sets:{}}}catch{return{sets:{}}}}function fe(a){localStorage.setItem(me,JSON.stringify(a))}function at(){return typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():"id-"+Math.random().toString(36).slice(2)+Date.now().toString(36)}function b(){const{sets:a}=U();return Object.values(a).sort((d,m)=>(m.updatedAt||0)-(d.updatedAt||0))}function rt(a){const{sets:d}=U();return d[a]||null}function ce(a){const d=Date.now(),m={id:a.id||at(),name:a.name?.trim()||"Untitled Set",items:Array.isArray(a.items)?a.items:[],createdAt:a.createdAt||d,updatedAt:d},y=U();return y.sets[m.id]=m,fe(y),m}function lt(a){const d=U();return d.sets[a]?(delete d.sets[a],fe(d),!0):!1}function ct({label:a,id:d,children:m,className:y="",...j}){return t.jsxs("label",{className:"gc-field",htmlFor:d,children:[a?t.jsx("span",{className:"gc-label",children:a}):null,t.jsx("span",{className:"gc-select",children:t.jsx("select",{id:d,className:y,...j,children:m})})]})}let de;const ue=()=>de||(de=pe(()=>import("./index-Eu5fzyPJ.js").then(a=>a.i),__vite__mapDeps([0,1,2]),import.meta.url));function dt(){try{if(typeof crypto<"u"&&crypto.randomUUID)return crypto.randomUUID()}catch{}return`sel-${Math.random().toString(36).slice(2)}${Date.now().toString(36)}`}function he(a){if(!a)return null;const{id:d,toKey:m=""}=a;return d==null?null:{uid:dt(),id:d,toKey:m}}function A(a=[]){return a.map(d=>he(d)).filter(Boolean)}function ft(){const{code:a,songIds:d}=Ae(),m=Ue(),y=Re(),[j,I]=c.useState("New Setlist"),[C,ge]=c.useState(""),[h,ye]=c.useState([]),[S,xe]=c.useState(()=>{try{return localStorage.getItem("pref:icpOnly")==="1"}catch{return!1}});c.useEffect(()=>{try{localStorage.setItem("pref:icpOnly",S?"1":"0")}catch{}},[S]);const[r,g]=c.useState([]),[M,je]=c.useState({}),[P,k]=c.useState("");Object.keys(M).length;const[L,_]=c.useState(!1),[we,Se]=c.useState(()=>{try{return window.innerWidth<=640}catch{return!1}}),[ut,ve]=c.useState(()=>{try{return window.innerWidth<=820}catch{return!1}}),[N,be]=c.useState(()=>{try{return window.innerWidth<=900}catch{return!1}}),z=c.useRef(""),F=c.useRef(""),[$,T]=c.useState(null),[v,W]=c.useState(()=>b()),[Y,K]=c.useState(""),[Ie,D]=c.useState(!1),[X,q]=c.useState("");c.useEffect(()=>{const e=Me?.items||[],n=new Set,i=[];for(const s of e)n.has(s.id)||(n.add(s.id),i.push(s));ye(i)},[]),c.useEffect(()=>{let e=!1;async function n(){const i={};for(const s of r){const o=h.find(w=>w.id===s.id);if(!o)continue;const l=o.filename.replace(/\.chordpro$/i,""),u=`./pptx/${l}.pptx`;await Qe(u,l)&&(i[l]=!0)}e||je(i)}return n(),()=>{e=!0}},[r,h]),c.useEffect(()=>{try{const e=document.documentElement,n=document.body;z.current=e.style.overflowY||"",F.current=n.style.overflowY||"",getComputedStyle(e).overflowY==="hidden"&&(e.style.overflowY=""),getComputedStyle(n).overflowY==="hidden"&&(n.style.overflowY="")}catch{}return()=>{try{document.documentElement.style.overflowY=z.current,document.body.style.overflowY=F.current}catch{}}},[]),c.useEffect(()=>{if(!a)return;const{entries:e,error:n}=_e(a);if(n){alert(n),y("/setlist",{replace:!0});return}const i=e.map(l=>({id:l.id,toKey:l.toKey}));g(A(i));const s=i.map(l=>l.id).join(","),o=i.map(l=>encodeURIComponent(l.toKey||"")).join(",");y(`/setlist/${s}?toKeys=${o}`,{replace:!0})},[a]),c.useEffect(()=>{if(!d)return;const e=(d||"").split(",").map(o=>o.trim()).filter(Boolean);if(!e.length)return;const i=(new URLSearchParams(m.search||"").get("toKeys")||"").split(",").map(o=>decodeURIComponent(o)).filter(Boolean),s=e.map((o,l)=>({id:o,toKey:i[l]||""}));g(A(s))},[d,m.search]),c.useEffect(()=>{try{if(!Array.isArray(r))return;if(r.length===0){(a||d)&&y("/setlist",{replace:!0});return}const e=r.map(o=>o.id).join(","),n=r.map(o=>encodeURIComponent(o.toKey||"")).join(","),i=d||"",s=new URLSearchParams(m.search||"").get("toKeys")||"";(e!==i||n!==s)&&y(`/setlist/${e}?toKeys=${n}`,{replace:!0})}catch{}},[r.map(e=>`${e.id}:${e.toKey}`).join("|"),d,m.search,a]),c.useEffect(()=>{try{const e=localStorage.getItem("setlist");if(!e||b().length>0)return;const n=JSON.parse(e);if(n?.name||(n?.list?.length||0)>0){const i=ce({name:n.name||"Imported Set",items:n.list||[]});W(b()),T(i.id),I(i.name),g(A(i.items||[])),K(i.id)}}catch{}},[]),c.useEffect(()=>{function e(){try{const n=window.innerWidth;Se(n<=640),ve(n<=820),be(n<=900)}catch{}}return window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]);const R=c.useMemo(()=>new ze(h,{keys:["title","tags"],threshold:.4}),[h]);function Ce(e){return!S||(Array.isArray(e.tags)?e.tags.includes("ICP"):e.tags==="ICP")}const Pe=c.useMemo(()=>(C?R.search(C).map(n=>n.item):h.slice().sort((n,i)=>n.title.localeCompare(i.title))).filter(Ce),[C,R,h,S]);function H(e){if(!e)return;const n=he({id:e.id,toKey:e.originalKey||e.key||"C"});g(i=>[...i,n])}function ke(e){g(n=>n.filter(i=>i.uid!==e))}function J(e,n){g(i=>{const s=i.findIndex(f=>f.uid===e);if(s<0)return i;const o=s+(n==="up"?-1:1);if(o<0||o>=i.length)return i;const l=i.slice(),[u]=l.splice(s,1);return l.splice(o,0,u),l})}function Le(e,n){g(i=>{if(n<0||n>=i.length)return i;const s=i.findIndex(u=>u.uid===e);if(s<0||s===n)return i;const o=i.slice(),[l]=o.splice(s,1);return o.splice(n,0,l),o})}function Ne(e,n){g(i=>i.map(s=>s.uid===e?{...s,toKey:n}:s))}function V(e){W(b()),K(e||"")}function G(){T(null),I("New Setlist"),g([]),K("")}function $e(){const e=j?.trim()||"New Setlist",n=window.prompt("Save set as:",e);if(n===null)return;const i=String(n).trim()||"New Setlist";let s=$;if(!s){const u=(b()||[]).find(f=>(f.name||"")===i);u&&(s=u.id)}const o=r.map(({id:u,toKey:f})=>({id:u,toKey:f})),l=ce({id:s,name:i,items:o});I(l.name),T(l.id),V(l.id)}function Te(){const e=X||Y||"";if(!e){D(!1);return}const n=rt(e);n&&(T(n.id),I(n.name||"New Setlist"),g(A(n.items||[])),K(n.id)),D(!1)}function Ke(){const e=v[0]?.id||"";q(Y||e),D(!0)}function De(){$&&window.confirm(`Delete set "${j}"? This cannot be undone.`)&&(lt($),G(),V(""))}async function Q(){_(!0);try{const{downloadMultiSongPdf:e}=await ue(),n=[];for(const i of r){const s=h.find(o=>o.id===i.id);if(s)try{const o=`./songs/${s.filename}`,l=await Ze(o),u=et(l),f=u.meta?.key||u.meta?.originalkey||s.originalKey||"C",w=tt(f,i.toKey||f),Ee=(u.sections||[]).map(te=>({section:te.label,lines:(te.lines||[]).map(x=>x.instrumental?{instrumental:st(x.instrumental,w)}:x.comment?{plain:x.comment,chordPositions:[],comment:x.comment}:{plain:x.lyrics||"",chordPositions:(x.chords||[]).map(se=>({sym:nt(se.sym,w),index:se.index}))})})),Oe=s.filename.replace(/\.chordpro$/i,""),Be=it({title:u.meta?.title||s.title||Oe,key:i.toKey||f,capo:u.meta?.capo,lyricsBlocks:Ee});n.push(Be)}catch(o){console.error(o),B(`Failed to process ${s.filename}`)}}n.length&&await e(n)}finally{_(!1)}}function E(){ue()}async function Z(){try{const e=r.map(s=>s.id).join(","),n=r.map(s=>encodeURIComponent(s.toKey||"")).join(","),i=`${m.origin}${m.pathname}#/setlist/${e}?toKeys=${n}`;await navigator.clipboard.writeText(i);try{B?.("Link copied!")}catch{}}catch{alert("Failed to copy link")}}async function ee(){k(`Bundling 0/${r.length}…`);const e=(await pe(async()=>{const{default:s}=await import("./jszip.min-DrRFyG8q.js").then(o=>o.j);return{default:s}},__vite__mapDeps([3,1,2]),import.meta.url)).default,n=new e;let i=0;for(let s=0;s<r.length;s++){const o=r[s],l=h.find(f=>f.id===o.id);if(!l){k(`Bundling ${s+1}/${r.length}…`);continue}k(`Bundling ${s+1}/${r.length}…`);const u=l.filename.replace(/\.chordpro$/i,"");if(M[u])try{const f=await fetch(`./pptx/${u}.pptx`);if(!f.ok)continue;const w=await f.blob();i++,n.file(`${String(i).padStart(2,"0")}-${u}.pptx`,w)}catch{}}if(i>0){const s=await n.generateAsync({type:"blob"}),o=new Date().toISOString().slice(0,10).replace(/-/g,""),l=document.createElement("a");l.href=URL.createObjectURL(s),l.download=`setlist-pptx-${o}.zip`,l.click(),URL.revokeObjectURL(l.href)}else try{B&&B("No PPTX files found for selected songs")||alert("No PPTX files found for selected songs")}catch{}k("")}return t.jsxs(ot,{children:[Ie?t.jsx("div",{style:{position:"fixed",inset:0,display:"flex",alignItems:"center",justifyContent:"center",background:"rgba(0,0,0,.45)",zIndex:90},role:"dialog","aria-modal":"true",children:t.jsxs("div",{style:{background:"var(--card)",color:"var(--text)",border:"1px solid var(--line)",borderRadius:10,padding:16,width:"min(560px, 92vw)"},children:[t.jsx("h3",{style:{marginTop:0,marginBottom:8},children:"Load Set"}),v.length?t.jsxs("label",{style:{display:"block",margin:"8px 0"},children:["Select a saved set",t.jsx("select",{value:X,onChange:e=>q(e.target.value),style:{width:"100%"},children:v.map(e=>t.jsxs("option",{value:e.id,children:[e.name," · ",new Date(e.updatedAt).toLocaleString()]},e.id))})]}):t.jsx("div",{className:"meta",children:"No saved sets yet."}),t.jsxs("div",{className:"row",style:{justifyContent:"flex-end",gap:8,marginTop:12},children:[t.jsx(p,{onClick:()=>D(!1),children:"Cancel"}),t.jsx(p,{variant:"primary",onClick:Te,disabled:!v.length,children:"Load"})]})]})}):null,t.jsx(Fe,{busy:L}),t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginTop:12,marginBottom:4},children:[t.jsx("div",{}),t.jsx("h1",{style:{margin:0},children:"Setlist Builder"}),t.jsx("div",{})]}),we?t.jsx(ne,{className:"card",style:{marginTop:8,position:"static"},children:t.jsxs("div",{className:"setlist-actions--mobile",style:{width:"100%"},children:[t.jsx(p,{variant:"primary",onClick:Q,onMouseEnter:E,onFocus:E,disabled:L||r.length===0,title:"Export set as a single PDF",iconLeft:t.jsx(O,{}),children:"PDF"}),t.jsx(p,{onClick:ee,disabled:r.length===0||!!P,title:r.length===0?"Add songs to export PPTX bundle":"Export PPTX bundle for selected songs",iconLeft:t.jsx(O,{}),children:"PPTX"}),t.jsx(p,{onClick:Z,title:"Copy shareable link",iconLeft:t.jsx(ie,{}),disabled:r.length===0,children:"Share"}),t.jsx(p,{as:oe,to:r.length?`/worship/${r.map(e=>e.id).join(",")}?toKeys=${r.map(e=>encodeURIComponent(e.toKey)).join(",")}`:"/worship",title:"Open Worship Mode",iconLeft:t.jsx(ae,{}),children:"Worship"})]})}):t.jsxs(ne,{className:"card",style:{marginTop:8,position:"static"},children:[t.jsx("div",{style:{width:"100%",marginBottom:6},children:t.jsx("strong",{title:"Current set name",children:j||"New Setlist"})}),t.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",flexWrap:"wrap",width:"100%"},children:[t.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"},children:[t.jsxs(p,{size:"sm",variant:"secondary",onClick:$e,title:"Save set",iconLeft:t.jsx(We,{}),children:[" ",t.jsx("span",{className:"text-when-wide",children:"Save"})]}),t.jsxs(p,{size:"sm",variant:"secondary",onClick:Ke,title:"Load saved set",iconLeft:t.jsx(Ye,{}),disabled:!v.length,children:[" ",t.jsx("span",{className:"text-when-wide",children:"Load"})]}),t.jsxs(p,{size:"sm",variant:"secondary",onClick:G,title:"New set",iconLeft:t.jsx(re,{}),children:[" ",t.jsx("span",{className:"text-when-wide",children:"New"})]}),t.jsxs(p,{size:"sm",variant:"secondary",onClick:De,disabled:!$,title:"Delete set",iconLeft:t.jsx(Xe,{}),children:[" ",t.jsx("span",{className:"text-when-wide",children:"Delete"})]})]}),t.jsxs("div",{style:{marginLeft:"auto",display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"},children:[t.jsx(p,{variant:"primary",size:"md",onClick:Q,onMouseEnter:E,onFocus:E,disabled:L||r.length===0,title:"Export set as a single PDF",iconLeft:t.jsx(O,{}),children:L?"Exporting…":t.jsxs(t.Fragment,{children:[t.jsx("span",{className:"text-when-wide",children:"Export PDF"}),t.jsx("span",{className:"text-when-narrow",children:"PDF"})]})}),t.jsx(p,{variant:"primary",size:"md",onClick:ee,disabled:r.length===0||!!P,title:r.length===0?"Add songs to export PPTX bundle":"Export PPTX bundle for selected songs",iconLeft:t.jsx(O,{}),children:P||t.jsxs(t.Fragment,{children:[t.jsx("span",{className:"text-when-wide",children:"Export PPTX"}),t.jsx("span",{className:"text-when-narrow",children:"PPTX"})]})}),t.jsx(p,{variant:"primary",size:"md",onClick:Z,title:"Copy shareable link",iconLeft:t.jsx(ie,{}),disabled:r.length===0,children:"Share Set"}),t.jsxs(p,{variant:"primary",size:"md",as:oe,to:r.length?`/worship/${r.map(e=>e.id).join(",")}?toKeys=${r.map(e=>encodeURIComponent(e.toKey)).join(",")}`:"/worship",title:"Open Worship Mode",iconLeft:t.jsx(ae,{}),children:[" ",t.jsx("span",{className:"text-when-wide",children:"Worship Mode"}),t.jsx("span",{className:"text-when-narrow",children:"Worship"})]})]})]})]}),t.jsxs("div",{className:"BuilderPage",style:{marginTop:8},children:[t.jsx("div",{className:"BuilderLeft",children:t.jsx("section",{className:"setlist-section setlist-add","data-role":"add",children:t.jsxs("div",{className:"card setlist-pane",children:[t.jsxs("div",{className:["BuilderHeader","section-header",N?"no-sticky":""].filter(Boolean).join(" "),style:{display:"flex",alignItems:"center",gap:8},children:[t.jsx("strong",{style:{whiteSpace:"nowrap"},children:"Add songs"}),t.jsx(qe,{value:C,onChange:e=>ge(e.target.value),placeholder:"Search...",style:{flex:1,minWidth:0}}),t.jsxs("label",{className:"row",style:{gap:6,alignItems:"center"},children:[t.jsx("input",{type:"checkbox",checked:S,onChange:e=>xe(e.target.checked)}),t.jsx("span",{className:"meta",title:"Limit results to songs tagged ICP",children:"ICP only"})]})]}),t.jsx("div",{className:["BuilderScroll","setlist-scroll","setlist-list",N?"no-pane-scroll":"pane-scroll","pane--addSongs"].join(" "),children:R?t.jsx("div",{style:{display:"grid",gap:".5rem",gridTemplateColumns:"repeat(auto-fill, minmax(320px, 1fr))",marginTop:6},children:Pe.map(e=>t.jsx(le,{title:e.title,subtitle:`${e.originalKey||""}${e.tags?.length?` • ${e.tags.join(", ")}`:""}`,rightSlot:t.jsx(p,{"aria-label":"Add",title:"Add to set",variant:"primary",iconLeft:t.jsx(re,{}),iconOnly:!0,onClick:n=>{n.stopPropagation(),H(e)}}),onClick:()=>H(e)},e.id))}):t.jsx("div",{children:"Loading search…"})})]})})}),t.jsx("div",{className:"BuilderRight",style:{minHeight:0,display:"flex",flexDirection:"column"},children:t.jsxs("section",{className:"setlist-section setlist-current","data-role":"current",children:[t.jsxs("div",{className:"card setlist-pane",children:[t.jsx("div",{className:["BuilderHeader","section-header",N?"no-sticky":""].filter(Boolean).join(" "),children:t.jsxs("strong",{children:["Current setlist (",r.length,")"]})}),t.jsx("div",{className:["BuilderScroll","setlist-scroll","setlist-list",N?"no-pane-scroll":"pane-scroll","pane--currentSet"].join(" "),style:{marginTop:6},children:r.map((e,n)=>{const i=h.find(s=>s.id===e.id);return i?t.jsx(le,{draggable:!0,onDragStart:s=>{s.dataTransfer.setData("text/plain",String(e.uid||e.id)),s.dataTransfer.effectAllowed="move"},onDragOver:s=>{s.preventDefault(),s.dataTransfer.dropEffect="move"},onDrop:s=>{s.preventDefault();const o=s.dataTransfer.getData("text/plain");Le(o,n)},title:i.title,subtitle:`Original: ${i.originalKey||"—"}`,rightSlot:t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6},children:[t.jsx(ct,{value:e.toKey,onChange:s=>Ne(e.uid,s.target.value),children:He.map(s=>t.jsx("option",{value:s,children:s},s))}),t.jsx(p,{onClick:()=>J(e.uid,"up"),title:"Move up",iconLeft:t.jsx(Je,{})}),t.jsx(p,{onClick:()=>J(e.uid,"down"),title:"Move down",iconLeft:t.jsx(Ve,{})}),t.jsx(p,{onClick:()=>ke(e.uid),title:"Remove",iconLeft:t.jsx(Ge,{}),iconOnly:!0,style:{color:"#b91c1c"}})]})},e.uid||`${e.id}-${n}`):null})})]}),t.jsxs("div",{className:"print-only",style:{marginTop:16},children:[t.jsx("h2",{style:{fontSize:"20pt",margin:"0 0 8pt 0"},children:j}),t.jsx("ol",{style:{fontSize:"12pt",lineHeight:1.4,paddingLeft:"1.2em"},children:r.map((e,n)=>{const i=h.find(s=>s.id===e.id);return i?t.jsxs("li",{children:[i.title," — ",e.toKey||i.originalKey||"—"]},e.uid||`${e.id}-${n}`):null})})]})]})})]})]})}export{ft as default};
