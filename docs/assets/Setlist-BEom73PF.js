const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-D9X2fejC.js","./index-D2OXwQ8B.js","./index-t6zvXNxZ.css","./jszip.min-BBbBX3nS.js"])))=>i.map(i=>d[i]);
import{j as e,u as Oe,a as Ae,b as Be,r as c,i as Ue,d as Re,F as Me,B as p,c as _e,T as te,D as O,L as se,e as ne,M as ie,S as ze,C as Fe,P as ae,f as We,I as Xe,g as oe,K as qe,A as He,h as Je,k as Ve,l as Ye,_ as de,m as Ge,p as Qe,s as Ze,t as et,n as tt,o as A}from"./index-D2OXwQ8B.js";import{P as st}from"./PageContainer-BbF5WYja.js";const ue="gracechords.sets.v1";function U(){try{const o=localStorage.getItem(ue);return o?JSON.parse(o):{sets:{}}}catch{return{sets:{}}}}function pe(o){localStorage.setItem(ue,JSON.stringify(o))}function nt(){return typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():"id-"+Math.random().toString(36).slice(2)+Date.now().toString(36)}function b(){const{sets:o}=U();return Object.values(o).sort((d,m)=>(m.updatedAt||0)-(d.updatedAt||0))}function it(o){const{sets:d}=U();return d[o]||null}function re(o){const d=Date.now(),m={id:o.id||nt(),name:o.name?.trim()||"Untitled Set",items:Array.isArray(o.items)?o.items:[],createdAt:o.createdAt||d,updatedAt:d},x=U();return x.sets[m.id]=m,pe(x),m}function at(o){const d=U();return d.sets[o]?(delete d.sets[o],pe(d),!0):!1}function ot({label:o,id:d,children:m,className:x="",...y}){return e.jsxs("label",{className:"gc-field",htmlFor:d,children:[o?e.jsx("span",{className:"gc-label",children:o}):null,e.jsx("span",{className:"gc-select",children:e.jsx("select",{id:d,className:x,...y,children:m})})]})}let le;const ce=()=>le||(le=de(()=>import("./index-D9X2fejC.js").then(o=>o.i),__vite__mapDeps([0,1,2]),import.meta.url));function rt(){try{if(typeof crypto<"u"&&crypto.randomUUID)return crypto.randomUUID()}catch{}return`sel-${Math.random().toString(36).slice(2)}${Date.now().toString(36)}`}function me(o){if(!o)return null;const{id:d,toKey:m=""}=o;return d==null?null:{uid:rt(),id:d,toKey:m}}function B(o=[]){return o.map(d=>me(d)).filter(Boolean)}function ut(){const{code:o,songIds:d}=Oe(),m=Ae(),x=Be(),[y,I]=c.useState("New Setlist"),[C,fe]=c.useState(""),[h,he]=c.useState([]),[w,ge]=c.useState(()=>{try{return localStorage.getItem("pref:icpOnly")==="1"}catch{return!1}});c.useEffect(()=>{try{localStorage.setItem("pref:icpOnly",w?"1":"0")}catch{}},[w]);const[r,g]=c.useState([]),[M,xe]=c.useState({}),[k,P]=c.useState("");Object.keys(M).length;const[L,_]=c.useState(!1),[ye,je]=c.useState(()=>{try{return window.innerWidth<=640}catch{return!1}}),[lt,we]=c.useState(()=>{try{return window.innerWidth<=820}catch{return!1}}),[N,Se]=c.useState(()=>{try{return window.innerWidth<=900}catch{return!1}}),[$,T]=c.useState(null),[S,z]=c.useState(()=>b()),[F,K]=c.useState(""),[ve,D]=c.useState(!1),[W,X]=c.useState("");c.useEffect(()=>{const t=Ue?.items||[],n=new Set,i=[];for(const s of t)n.has(s.id)||(n.add(s.id),i.push(s));he(i)},[]),c.useEffect(()=>{let t=!1;async function n(){const i={};for(const s of r){const a=h.find(v=>v.id===s.id);if(!a)continue;const l=a.filename.replace(/\.chordpro$/i,""),u=`./pptx/${l}.pptx`;await Ye(u,l)&&(i[l]=!0)}t||xe(i)}return n(),()=>{t=!0}},[r,h]),c.useEffect(()=>{if(!o)return;const{entries:t,error:n}=Re(o);if(n){alert(n),x("/setlist",{replace:!0});return}const i=t.map(l=>({id:l.id,toKey:l.toKey}));g(B(i));const s=i.map(l=>l.id).join(","),a=i.map(l=>encodeURIComponent(l.toKey||"")).join(",");x(`/setlist/${s}?toKeys=${a}`,{replace:!0})},[o]),c.useEffect(()=>{if(!d)return;const t=(d||"").split(",").map(a=>a.trim()).filter(Boolean);if(!t.length)return;const i=(new URLSearchParams(m.search||"").get("toKeys")||"").split(",").map(a=>decodeURIComponent(a)).filter(Boolean),s=t.map((a,l)=>({id:a,toKey:i[l]||""}));g(B(s))},[d,m.search]),c.useEffect(()=>{try{if(!Array.isArray(r))return;if(r.length===0){(o||d)&&x("/setlist",{replace:!0});return}const t=r.map(a=>a.id).join(","),n=r.map(a=>encodeURIComponent(a.toKey||"")).join(","),i=d||"",s=new URLSearchParams(m.search||"").get("toKeys")||"";(t!==i||n!==s)&&x(`/setlist/${t}?toKeys=${n}`,{replace:!0})}catch{}},[r.map(t=>`${t.id}:${t.toKey}`).join("|"),d,m.search,o]),c.useEffect(()=>{try{const t=localStorage.getItem("setlist");if(!t||b().length>0)return;const n=JSON.parse(t);if(n?.name||(n?.list?.length||0)>0){const i=re({name:n.name||"Imported Set",items:n.list||[]});z(b()),T(i.id),I(i.name),g(B(i.items||[])),K(i.id)}}catch{}},[]),c.useEffect(()=>{function t(){try{const n=window.innerWidth;je(n<=640),we(n<=820),Se(n<=900)}catch{}}return window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[]);const R=c.useMemo(()=>new Me(h,{keys:["title","tags"],threshold:.4}),[h]);function be(t){return!w||(Array.isArray(t.tags)?t.tags.includes("ICP"):t.tags==="ICP")}const Ie=c.useMemo(()=>(C?R.search(C).map(n=>n.item):h.slice().sort((n,i)=>n.title.localeCompare(i.title))).filter(be),[C,R,h,w]);function q(t){if(!t)return;const n=me({id:t.id,toKey:t.originalKey||t.key||"C"});g(i=>[...i,n])}function Ce(t){g(n=>n.filter(i=>i.uid!==t))}function H(t,n){g(i=>{const s=i.findIndex(f=>f.uid===t);if(s<0)return i;const a=s+(n==="up"?-1:1);if(a<0||a>=i.length)return i;const l=i.slice(),[u]=l.splice(s,1);return l.splice(a,0,u),l})}function ke(t,n){g(i=>{if(n<0||n>=i.length)return i;const s=i.findIndex(u=>u.uid===t);if(s<0||s===n)return i;const a=i.slice(),[l]=a.splice(s,1);return a.splice(n,0,l),a})}function Pe(t,n){g(i=>i.map(s=>s.uid===t?{...s,toKey:n}:s))}function J(t){z(b()),K(t||"")}function V(){T(null),I("New Setlist"),g([]),K("")}function Le(){const t=y?.trim()||"New Setlist",n=window.prompt("Save set as:",t);if(n===null)return;const i=String(n).trim()||"New Setlist";let s=$;if(!s){const u=(b()||[]).find(f=>(f.name||"")===i);u&&(s=u.id)}const a=r.map(({id:u,toKey:f})=>({id:u,toKey:f})),l=re({id:s,name:i,items:a});I(l.name),T(l.id),J(l.id)}function Ne(){const t=W||F||"";if(!t){D(!1);return}const n=it(t);n&&(T(n.id),I(n.name||"New Setlist"),g(B(n.items||[])),K(n.id)),D(!1)}function $e(){const t=S[0]?.id||"";X(F||t),D(!0)}function Te(){$&&window.confirm(`Delete set "${y}"? This cannot be undone.`)&&(at($),V(),J(""))}async function Y(){_(!0);try{const{downloadMultiSongPdf:t}=await ce(),n=[];for(const i of r){const s=h.find(a=>a.id===i.id);if(s)try{const a=`./songs/${s.filename}`,l=await Ge(a),u=Qe(l),f=u.meta?.key||u.meta?.originalkey||s.originalKey||"C",v=Ze(f,i.toKey||f),Ke=(u.sections||[]).map(Z=>({section:Z.label,lines:(Z.lines||[]).map(j=>({plain:j.comment?j.comment:j.lyrics||"",chordPositions:(j.chords||[]).map(ee=>({sym:et(ee.sym,v),index:ee.index})),comment:j.comment?j.comment:void 0}))})),De=s.filename.replace(/\.chordpro$/i,""),Ee=tt({title:u.meta?.title||s.title||De,key:i.toKey||f,capo:u.meta?.capo,lyricsBlocks:Ke});n.push(Ee)}catch(a){console.error(a),A(`Failed to process ${s.filename}`)}}n.length&&await t(n)}finally{_(!1)}}function E(){ce()}async function G(){try{const t=r.map(s=>s.id).join(","),n=r.map(s=>encodeURIComponent(s.toKey||"")).join(","),i=`${m.origin}${m.pathname}#/setlist/${t}?toKeys=${n}`;await navigator.clipboard.writeText(i);try{A?.("Link copied!")}catch{}}catch{alert("Failed to copy link")}}async function Q(){P(`Bundling 0/${r.length}…`);const t=(await de(async()=>{const{default:s}=await import("./jszip.min-BBbBX3nS.js").then(a=>a.j);return{default:s}},__vite__mapDeps([3,1,2]),import.meta.url)).default,n=new t;let i=0;for(let s=0;s<r.length;s++){const a=r[s],l=h.find(f=>f.id===a.id);if(!l){P(`Bundling ${s+1}/${r.length}…`);continue}P(`Bundling ${s+1}/${r.length}…`);const u=l.filename.replace(/\.chordpro$/i,"");if(M[u])try{const f=await fetch(`./pptx/${u}.pptx`);if(!f.ok)continue;const v=await f.blob();i++,n.file(`${String(i).padStart(2,"0")}-${u}.pptx`,v)}catch{}}if(i>0){const s=await n.generateAsync({type:"blob"}),a=new Date().toISOString().slice(0,10).replace(/-/g,""),l=document.createElement("a");l.href=URL.createObjectURL(s),l.download=`setlist-pptx-${a}.zip`,l.click(),URL.revokeObjectURL(l.href)}else try{A&&A("No PPTX files found for selected songs")||alert("No PPTX files found for selected songs")}catch{}P("")}return e.jsxs(st,{children:[ve?e.jsx("div",{style:{position:"fixed",inset:0,display:"flex",alignItems:"center",justifyContent:"center",background:"rgba(0,0,0,.45)",zIndex:90},role:"dialog","aria-modal":"true",children:e.jsxs("div",{style:{background:"var(--card)",color:"var(--text)",border:"1px solid var(--line)",borderRadius:10,padding:16,width:"min(560px, 92vw)"},children:[e.jsx("h3",{style:{marginTop:0,marginBottom:8},children:"Load Set"}),S.length?e.jsxs("label",{style:{display:"block",margin:"8px 0"},children:["Select a saved set",e.jsx("select",{value:W,onChange:t=>X(t.target.value),style:{width:"100%"},children:S.map(t=>e.jsxs("option",{value:t.id,children:[t.name," · ",new Date(t.updatedAt).toLocaleString()]},t.id))})]}):e.jsx("div",{className:"meta",children:"No saved sets yet."}),e.jsxs("div",{className:"row",style:{justifyContent:"flex-end",gap:8,marginTop:12},children:[e.jsx(p,{onClick:()=>D(!1),children:"Cancel"}),e.jsx(p,{variant:"primary",onClick:Ne,disabled:!S.length,children:"Load"})]})]})}):null,e.jsx(_e,{busy:L}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginTop:12,marginBottom:4},children:[e.jsx("div",{}),e.jsx("h1",{style:{margin:0},children:"Setlist Builder"}),e.jsx("div",{})]}),ye?e.jsx(te,{className:"card",style:{marginTop:8,position:"static"},children:e.jsxs("div",{className:"setlist-actions--mobile",style:{width:"100%"},children:[e.jsx(p,{variant:"primary",onClick:Y,onMouseEnter:E,onFocus:E,disabled:L||r.length===0,title:"Export set as a single PDF",iconLeft:e.jsx(O,{}),children:"PDF"}),e.jsx(p,{onClick:Q,disabled:r.length===0||!!k,title:r.length===0?"Add songs to export PPTX bundle":"Export PPTX bundle for selected songs",iconLeft:e.jsx(O,{}),children:"PPTX"}),e.jsx(p,{onClick:G,title:"Copy shareable link",iconLeft:e.jsx(se,{}),disabled:r.length===0,children:"Share"}),e.jsx(p,{as:ne,to:r.length?`/worship/${r.map(t=>t.id).join(",")}?toKeys=${r.map(t=>encodeURIComponent(t.toKey)).join(",")}`:"/worship",title:"Open Worship Mode",iconLeft:e.jsx(ie,{}),children:"Worship"})]})}):e.jsxs(te,{className:"card",style:{marginTop:8,position:"static"},children:[e.jsx("div",{style:{width:"100%",marginBottom:6},children:e.jsx("strong",{title:"Current set name",children:y||"New Setlist"})}),e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",flexWrap:"wrap",width:"100%"},children:[e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"},children:[e.jsxs(p,{size:"sm",variant:"secondary",onClick:Le,title:"Save set",iconLeft:e.jsx(ze,{}),children:[" ",e.jsx("span",{className:"text-when-wide",children:"Save"})]}),e.jsxs(p,{size:"sm",variant:"secondary",onClick:$e,title:"Load saved set",iconLeft:e.jsx(Fe,{}),disabled:!S.length,children:[" ",e.jsx("span",{className:"text-when-wide",children:"Load"})]}),e.jsxs(p,{size:"sm",variant:"secondary",onClick:V,title:"New set",iconLeft:e.jsx(ae,{}),children:[" ",e.jsx("span",{className:"text-when-wide",children:"New"})]}),e.jsxs(p,{size:"sm",variant:"secondary",onClick:Te,disabled:!$,title:"Delete set",iconLeft:e.jsx(We,{}),children:[" ",e.jsx("span",{className:"text-when-wide",children:"Delete"})]})]}),e.jsxs("div",{style:{marginLeft:"auto",display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"},children:[e.jsx(p,{variant:"primary",size:"md",onClick:Y,onMouseEnter:E,onFocus:E,disabled:L||r.length===0,title:"Export set as a single PDF",iconLeft:e.jsx(O,{}),children:L?"Exporting…":e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-when-wide",children:"Export PDF"}),e.jsx("span",{className:"text-when-narrow",children:"PDF"})]})}),e.jsx(p,{variant:"primary",size:"md",onClick:Q,disabled:r.length===0||!!k,title:r.length===0?"Add songs to export PPTX bundle":"Export PPTX bundle for selected songs",iconLeft:e.jsx(O,{}),children:k||e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-when-wide",children:"Export PPTX"}),e.jsx("span",{className:"text-when-narrow",children:"PPTX"})]})}),e.jsx(p,{variant:"primary",size:"md",onClick:G,title:"Copy shareable link",iconLeft:e.jsx(se,{}),disabled:r.length===0,children:"Share Set"}),e.jsxs(p,{variant:"primary",size:"md",as:ne,to:r.length?`/worship/${r.map(t=>t.id).join(",")}?toKeys=${r.map(t=>encodeURIComponent(t.toKey)).join(",")}`:"/worship",title:"Open Worship Mode",iconLeft:e.jsx(ie,{}),children:[" ",e.jsx("span",{className:"text-when-wide",children:"Worship Mode"}),e.jsx("span",{className:"text-when-narrow",children:"Worship"})]})]})]})]}),e.jsxs("div",{className:"BuilderPage",style:{marginTop:8},children:[e.jsx("div",{className:"BuilderLeft",children:e.jsx("section",{className:"setlist-section setlist-add","data-role":"add",children:e.jsxs("div",{className:"card setlist-pane",children:[e.jsxs("div",{className:["BuilderHeader","section-header",N?"no-sticky":""].filter(Boolean).join(" "),style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx("strong",{style:{whiteSpace:"nowrap"},children:"Add songs"}),e.jsx(Xe,{value:C,onChange:t=>fe(t.target.value),placeholder:"Search...",style:{flex:1,minWidth:0}}),e.jsxs("label",{className:"row",style:{gap:6,alignItems:"center"},children:[e.jsx("input",{type:"checkbox",checked:w,onChange:t=>ge(t.target.checked)}),e.jsx("span",{className:"meta",title:"Limit results to songs tagged ICP",children:"ICP only"})]})]}),e.jsx("div",{className:["BuilderScroll","setlist-scroll","setlist-list",N?"no-pane-scroll":"pane-scroll","pane--addSongs"].join(" "),children:R?e.jsx("div",{style:{display:"grid",gap:".5rem",gridTemplateColumns:"repeat(auto-fill, minmax(320px, 1fr))",marginTop:6},children:Ie.map(t=>e.jsx(oe,{title:t.title,subtitle:`${t.originalKey||""}${t.tags?.length?` • ${t.tags.join(", ")}`:""}`,rightSlot:e.jsx(p,{"aria-label":"Add",title:"Add to set",variant:"primary",iconLeft:e.jsx(ae,{}),iconOnly:!0,onClick:n=>{n.stopPropagation(),q(t)}}),onClick:()=>q(t)},t.id))}):e.jsx("div",{children:"Loading search…"})})]})})}),e.jsx("div",{className:"BuilderRight",style:{minHeight:0,display:"flex",flexDirection:"column"},children:e.jsxs("section",{className:"setlist-section setlist-current","data-role":"current",children:[e.jsxs("div",{className:"card setlist-pane",children:[e.jsx("div",{className:["BuilderHeader","section-header",N?"no-sticky":""].filter(Boolean).join(" "),children:e.jsxs("strong",{children:["Current setlist (",r.length,")"]})}),e.jsx("div",{className:["BuilderScroll","setlist-scroll","setlist-list",N?"no-pane-scroll":"pane-scroll","pane--currentSet"].join(" "),style:{marginTop:6},children:r.map((t,n)=>{const i=h.find(s=>s.id===t.id);return i?e.jsx(oe,{draggable:!0,onDragStart:s=>{s.dataTransfer.setData("text/plain",String(t.uid||t.id)),s.dataTransfer.effectAllowed="move"},onDragOver:s=>{s.preventDefault(),s.dataTransfer.dropEffect="move"},onDrop:s=>{s.preventDefault();const a=s.dataTransfer.getData("text/plain");ke(a,n)},title:i.title,subtitle:`Original: ${i.originalKey||"—"}`,rightSlot:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx(ot,{value:t.toKey,onChange:s=>Pe(t.uid,s.target.value),children:qe.map(s=>e.jsx("option",{value:s,children:s},s))}),e.jsx(p,{onClick:()=>H(t.uid,"up"),title:"Move up",iconLeft:e.jsx(He,{})}),e.jsx(p,{onClick:()=>H(t.uid,"down"),title:"Move down",iconLeft:e.jsx(Je,{})}),e.jsx(p,{onClick:()=>Ce(t.uid),title:"Remove",iconLeft:e.jsx(Ve,{}),iconOnly:!0,style:{color:"#b91c1c"}})]})},t.uid||`${t.id}-${n}`):null})})]}),e.jsxs("div",{className:"print-only",style:{marginTop:16},children:[e.jsx("h2",{style:{fontSize:"20pt",margin:"0 0 8pt 0"},children:y}),e.jsx("ol",{style:{fontSize:"12pt",lineHeight:1.4,paddingLeft:"1.2em"},children:r.map((t,n)=>{const i=h.find(s=>s.id===t.id);return i?e.jsxs("li",{children:[i.title," — ",t.toKey||i.originalKey||"—"]},t.uid||`${t.id}-${n}`):null})})]})]})})]})]})}export{ut as default};
