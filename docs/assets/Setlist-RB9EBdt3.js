const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./jszip.min-CqEOunQu.js","./index-BAoIQLOh.js","./index-Druc7_JO.css"])))=>i.map(i=>d[i]);
import{r as u,i as le,F as re,j as t,B as ce,L as de,K as ue,A as me,a as pe,R as fe,D as R,h as he,f as ge,p as xe,s as ye,b as je,e as Se,_ as be}from"./index-BAoIQLOh.js";const O="gracechords.sets.v1";function N(){try{const a=localStorage.getItem(O);return a?JSON.parse(a):{sets:{}}}catch{return{sets:{}}}}function B(a){localStorage.setItem(O,JSON.stringify(a))}function ve(){return typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():"id-"+Math.random().toString(36).slice(2)+Date.now().toString(36)}function w(){const{sets:a}=N();return Object.values(a).sort((l,p)=>(p.updatedAt||0)-(l.updatedAt||0))}function F(a){const{sets:l}=N();return l[a]||null}function C(a){var d;const l=Date.now(),p={id:a.id||ve(),name:((d=a.name)==null?void 0:d.trim())||"Untitled Set",items:Array.isArray(a.items)?a.items:[],createdAt:a.createdAt||l,updatedAt:l},y=N();return y.sets[p.id]=p,B(y),p}function we(a){const l=N();return l.sets[a]?(delete l.sets[a],B(l),!0):!1}function Ce(a){const l=F(a);return l?C({name:`Copy of ${l.name}`,items:l.items.map(p=>({...p}))}):null}function ke(){const[a,l]=u.useState("Untitled Set"),[p,y]=u.useState(""),[d,M]=u.useState([]),[r,f]=u.useState([]),[I,H]=u.useState({}),[k,j]=u.useState(""),T=Object.keys(I).length,[K,$]=u.useState(!1),[h,g]=u.useState(null),[z,A]=u.useState(()=>w()),[J,S]=u.useState("");u.useEffect(()=>{var e;M(((e=le)==null?void 0:e.items)||[])},[]),u.useEffect(()=>{let e=!1;async function s(){const n={};for(const i of r){const c=d.find(x=>x.id===i.id);if(!c)continue;const o=`./pptx/${c.id}.pptx`;await he(o,c.id)&&(n[c.id]=!0)}e||H(n)}return s(),()=>{e=!0}},[r,d]),u.useEffect(()=>{var e;try{const s=localStorage.getItem("setlist");if(!s||w().length>0)return;const n=JSON.parse(s);if(n!=null&&n.name||(((e=n==null?void 0:n.list)==null?void 0:e.length)||0)>0){const i=C({name:n.name||"Imported Set",items:n.list||[]});A(w()),g(i.id),l(i.name),f(i.items||[]),S(i.id)}}catch{}},[]);const P=u.useMemo(()=>new re(d,{keys:["title","tags"],threshold:.4}),[d]),W=u.useMemo(()=>p?P.search(p).map(e=>e.item):d.slice().sort((e,s)=>e.title.localeCompare(s.title)),[p,P,d]);function X(e){r.find(s=>s.id===e.id)||f([...r,{id:e.id,toKey:e.originalKey||"C"}])}function Y(e){f(r.filter(s=>s.id!==e))}function D(e,s){const n=r.findIndex(m=>m.id===e);if(n<0)return;const i=n+(s==="up"?-1:1);if(i<0||i>=r.length)return;const c=r.slice(),[o]=c.splice(n,1);c.splice(i,0,o),f(c)}function q(e,s){f(r.map(n=>n.id===e?{...n,toKey:s}:n))}function U(e){f(s=>s.map(n=>{const i=d.find(o=>o.id===n.id),c=n.toKey||(i==null?void 0:i.originalKey)||"C";return{...n,toKey:transposeSym(c,e)}}))}function G(){f(e=>e.map(s=>{const n=d.find(i=>i.id===s.id);return{...s,toKey:(n==null?void 0:n.originalKey)||"C"}}))}function b(e){A(w()),S(e||"")}function E(){g(null),l("Untitled Set"),f([]),S("")}function Q(){const e=(a==null?void 0:a.trim())||"Untitled Set",s=C({id:h,name:e,items:r});l(s.name),g(s.id),b(s.id)}function V(e){const s=e.target.value;if(S(s),!s)return;const n=F(s);n&&(g(n.id),l(n.name||"Untitled Set"),f(n.items||[]))}function Z(){if(!h){const s=`Copy of ${a||"Untitled Set"}`,n=C({id:null,name:s,items:r});l(n.name),g(n.id),b(n.id);return}const e=Ce(h);e&&(g(e.id),l(e.name),f(e.items||[]),b(e.id))}function ee(){h&&window.confirm(`Delete set "${a}"? This cannot be undone.`)&&(we(h),E(),b(""))}async function te(){var e,s,n;$(!0);try{const i=[];for(const c of r){const o=d.find(m=>m.id===c.id);if(o)try{const m=`./songs/${o.filename}`,x=await ge(m),v=xe(x),ie=((e=v.meta)==null?void 0:e.key)||((s=v.meta)==null?void 0:s.originalkey)||o.originalKey||"C",ae=(v.blocks||[]).map(_=>({type:_.section,lines:(_.lines||[]).map(oe=>oe.text)}));i.push({id:o.id,title:((n=v.meta)==null?void 0:n.title)||o.title||o.id,originalKey:c.toKey||ie,sections:ae})}catch(m){console.error(m),ye(`Failed to process ${o.filename}`)}}if(i.length){const c=je(i,{baseFontPt:12,showChords:!0,docTitle:a});(await Se(c)).save("Setlist.pdf")}}finally{$(!1)}}function L(){}async function ne(){j(`Bundling 0/${r.length}…`);const e=(await be(async()=>{const{default:i}=await import("./jszip.min-CqEOunQu.js").then(c=>c.j);return{default:i}},__vite__mapDeps([0,1,2]),import.meta.url)).default,s=new e;let n=0;for(let i=0;i<r.length;i++){const c=r[i],o=d.find(m=>m.id===c.id);if(!o){j(`Bundling ${i+1}/${r.length}…`);continue}if(j(`Bundling ${i+1}/${r.length}…`),!!I[o.id])try{const m=await fetch(`./pptx/${o.id}.pptx`);if(!m.ok)continue;const x=await m.blob();n++,s.file(`${String(n).padStart(2,"0")}-${o.id}.pptx`,x)}catch{}}if(n>0){const i=await s.generateAsync({type:"blob"}),c=new Date().toISOString().slice(0,10).replace(/-/g,""),o=document.createElement("a");o.href=URL.createObjectURL(i),o.download=`setlist-pptx-${c}.zip`,o.click(),URL.revokeObjectURL(o.href)}j("")}function se(){window.print()}return t.jsxs("div",{className:"container",children:[t.jsx(ce,{busy:K}),t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[t.jsx("div",{children:t.jsx(de,{to:"/",className:"back",children:"← Back"})}),t.jsx("h1",{style:{margin:0},children:"Setlist Builder"}),t.jsx("div",{})]}),t.jsxs("div",{className:"card toolbar",style:{marginTop:12},children:[t.jsxs("label",{style:{display:"flex",alignItems:"center",gap:6},children:[t.jsx("span",{children:"Set:"}),t.jsx("input",{"aria-label":"Set name",value:a,onChange:e=>l(e.target.value),style:{minWidth:220},placeholder:"Sunday AM"})]}),t.jsxs("select",{"aria-label":"Saved sets",value:J,onChange:V,children:[t.jsx("option",{value:"",children:"— Load saved set —"}),z.map(e=>t.jsxs("option",{value:e.id,children:[e.name," · ",new Date(e.updatedAt).toLocaleString()]},e.id))]}),t.jsx("button",{className:"btn",onClick:E,children:"New"}),t.jsx("button",{className:"btn primary",onClick:Q,children:"Save"}),t.jsx("button",{className:"btn",onClick:Z,disabled:!r.length,children:"Duplicate"}),t.jsx("button",{className:"btn",onClick:ee,disabled:!h,children:"Delete"}),t.jsxs("div",{style:{marginLeft:"auto",display:"flex",alignItems:"center",gap:6},children:[t.jsx("span",{className:"meta",children:"Transpose:"}),t.jsx("button",{className:"btn",onClick:()=>U(-1),title:"Transpose set down 1 semitone",children:"–1"}),t.jsx("button",{className:"btn",onClick:G,title:"Reset all to originals",children:"Reset"}),t.jsx("button",{className:"btn",onClick:()=>U(1),title:"Transpose set up 1 semitone",children:"+1"})]})]}),t.jsxs("div",{className:"card",style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12},children:[t.jsx("div",{children:t.jsxs("div",{style:{marginTop:8},children:[t.jsx("strong",{children:"Add songs"}),t.jsx("input",{value:p,onChange:e=>y(e.target.value),placeholder:"Search...",style:{display:"block",width:"100%",marginTop:6}}),t.jsx("div",{style:{minHeight:0,maxHeight:300,overflow:"auto",marginTop:6},children:P?W.map(e=>{var s;return t.jsxs("div",{className:"row",style:{padding:"6px 0"},children:[t.jsxs("div",{style:{flex:1},children:[t.jsx("div",{style:{fontWeight:600},children:e.title}),t.jsxs("div",{className:"meta",children:[e.originalKey||"",(s=e.tags)!=null&&s.length?` • ${e.tags.join(", ")}`:""]})]}),t.jsx("button",{className:"btn",onClick:()=>X(e),children:"Add"})]},e.id)}):t.jsx("div",{children:"Loading search…"})})]})}),t.jsxs("div",{children:[t.jsxs("strong",{children:["Current setlist (",r.length,")"]}),t.jsx("div",{style:{minHeight:0,maxHeight:360,overflow:"auto",marginTop:6},children:r.map(e=>{const s=d.find(n=>n.id===e.id);return s?t.jsxs("div",{className:"row",style:{padding:"6px 0"},children:[t.jsxs("div",{style:{flex:1},children:[t.jsx("div",{style:{fontWeight:600},children:s.title}),t.jsxs("div",{className:"meta",children:["Original: ",s.originalKey||"—"]})]}),t.jsx("select",{value:e.toKey,onChange:n=>q(e.id,n.target.value),children:ue.map(n=>t.jsx("option",{value:n,children:n},n))}),t.jsx("button",{className:"btn",onClick:()=>D(e.id,"up"),title:"Move up",children:t.jsx(me,{})}),t.jsx("button",{className:"btn",onClick:()=>D(e.id,"down"),title:"Move down",children:t.jsx(pe,{})}),t.jsx("button",{className:"btn",onClick:()=>Y(e.id),title:"Remove",children:t.jsx(fe,{})})]},e.id):null})}),t.jsxs("div",{style:{display:"flex",gap:8,marginTop:8},children:[t.jsx("button",{className:"btn primary iconbtn",onClick:te,onMouseEnter:L,onFocus:L,disabled:K,children:K?"Exporting…":t.jsxs(t.Fragment,{children:[t.jsx(R,{})," Export PDF"]})}),t.jsx("button",{className:"btn iconbtn",onClick:ne,disabled:T===0||!!k,title:T===0?"No PPTX files found for this set.":"",children:k||t.jsxs(t.Fragment,{children:[t.jsx(R,{})," Bundle PPTX"]})}),t.jsx("button",{className:"btn",onClick:se,children:"Print"}),t.jsx("button",{className:"btn",onClick:()=>f([]),children:"Clear"})]}),t.jsxs("div",{className:"print-only",style:{marginTop:16},children:[t.jsx("h2",{style:{fontSize:"20pt",margin:"0 0 8pt 0"},children:a}),t.jsx("ol",{style:{fontSize:"12pt",lineHeight:1.4,paddingLeft:"1.2em"},children:r.map(e=>{const s=d.find(n=>n.id===e.id);return s?t.jsxs("li",{children:[s.title," — ",e.toKey||s.originalKey||"—"]},e.id):null})})]})]})]})]})}export{ke as default};
