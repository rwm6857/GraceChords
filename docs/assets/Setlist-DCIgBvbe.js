const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./jszip.min-C_Ifr0Rl.js","./index-r2m0KAVL.js","./index-B2k8NPcQ.css","./index-BuOQd_aF.js"])))=>i.map(i=>d[i]);
import{_ as Ee,G as mt,J as ht,N as gt,r as w,i as yt,O as xt,Q as wt,j as s,B as L,U as bt,V as De,W as de,X as _e,L as Oe,Y as Ke,Z as St,$ as Tt,P as Ue,T as Nt,I as Pt,a0 as Xe,a1 as jt,a2 as It,a3 as Et,a4 as vt,a5 as Mt,a6 as Se,a7 as ue,a8 as Fe,f as At,p as Lt,a9 as Ct,aa as $t,ab as Rt,ac as Bt,s as ee}from"./index-r2m0KAVL.js";import{P as kt}from"./PageContainer-Vw5MzzTn.js";const Ze="gracechords.sets.v1";function Ne(){try{const e=localStorage.getItem(Ze);return e?JSON.parse(e):{sets:{}}}catch{return{sets:{}}}}function Ge(e){localStorage.setItem(Ze,JSON.stringify(e))}function Dt(){return typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():"id-"+Math.random().toString(36).slice(2)+Date.now().toString(36)}function ge(){const{sets:e}=Ne();return Object.values(e).sort((n,i)=>(i.updatedAt||0)-(n.updatedAt||0))}function _t(e){const{sets:n}=Ne();return n[e]||null}function We(e){const n=Date.now(),i={id:e.id||Dt(),name:e.name?.trim()||"Untitled Set",items:Array.isArray(e.items)?e.items:[],createdAt:e.createdAt||n,updatedAt:n},c=Ne();return c.sets[i.id]=i,Ge(c),i}function Ot(e){const n=Ne();return n.sets[e]?(delete n.sets[e],Ge(n),!0):!1}const Kt="application/vnd.openxmlformats-officedocument.presentationml.slide+xml",ze="application/vnd.openxmlformats-officedocument.presentationml.slideMaster+xml",Ut="application/vnd.openxmlformats-officedocument.presentationml.slideLayout+xml",Xt="application/vnd.openxmlformats-officedocument.theme+xml",J="http://schemas.openxmlformats.org/presentationml/2006/main",ve="http://schemas.openxmlformats.org/officeDocument/2006/relationships",Ye="application/vnd.openxmlformats-officedocument.presentationml.notesMaster+xml",Ft=new DOMParser,Wt=new XMLSerializer;function zt(e){const n="setlist",i=String(e).trim();return i&&i.replace(/\s+/g,"_").replace(/[^A-Za-z0-9_.-]/g,"_").replace(/_+/g,"_").replace(/^_+|_+$/g,"")||n}async function qe(e){const n=await fetch(e);if(!n.ok)throw new Error(`Failed to load PPTX: ${e}`);return n.arrayBuffer()}function ie(e){const n=Ft.parseFromString(e,"application/xml"),i=n.getElementsByTagName("parsererror")[0];if(i)throw new Error(i.textContent||"Failed to parse XML");return n}function xe(e){return Wt.serializeToString(e)}function F(e){const n=String(e||"").match(/(\d+)$/);return n?Number(n[1]):0}function ce(e,n){let i=0;return e.filter(c=>n.test(c)).forEach(c=>{const r=c.name.match(n);if(!r)return;const d=Number(r[1]);Number.isNaN(d)||(i=Math.max(i,d))}),i}function Ve(e,n,i){if(Array.from(e.getElementsByTagName("Override")).some(d=>d.getAttribute("PartName")===n))return;const r=e.createElement("Override");r.setAttribute("PartName",n),r.setAttribute("ContentType",i),e.documentElement.appendChild(r)}function fe(e,n){if(!n)return null;if(n.startsWith("/"))return n.slice(1);const i=e.split("/");i.pop();const c=n.split("/");for(const r of c)if(r==="..")i.pop();else{if(r===".")continue;i.push(r)}return i.join("/")}function re(e,n){const i=e.split("/");i.pop();const c=n.split("/");let r=0;for(;r<i.length&&r<c.length&&i[r]===c[r];)r++;const d=i.length-r,p=[];for(let g=0;g<d;g++)p.push("..");return p.push(...c.slice(r)),p.join("/")}function Qe(e){const n=e.match(/^(.*\/)([^/]*?)(\d+)(\.[^.]+)$/);return n?{dir:n[1],prefix:n[2],number:Number(n[3]),ext:n[4]}:null}function se(e,n,i){const c=Number(e[n]||0);i>c&&(e[n]=i)}function et(e,n){const c=Number(e[n]||0)+1;return e[n]=c,c}function W(e,n){if(!e)return null;const i=e.file(n);return Array.isArray(i)?i.length?i[0]:null:i||null}function pe(e){const n=e.lastIndexOf("/"),i=n>=0?e.slice(0,n+1):"",c=n>=0?e.slice(n+1):e;return`${i}_rels/${c}.rels`}function Yt(e,n){if(!e||!n)return{contentType:"",fromOverride:!1,extension:""};const i=`/${n}`,r=Array.from(e.getElementsByTagName("Override")).find(m=>m.getAttribute("PartName")===i);if(r)return{contentType:r.getAttribute("ContentType")||"",fromOverride:!0,extension:n.split(".").pop()||""};const d=Array.from(e.getElementsByTagName("Default")),p=n.split(".").pop()||"",g=d.find(m=>m.getAttribute("Extension")===p);return g?{contentType:g.getAttribute("ContentType")||"",fromOverride:!1,extension:p}:{contentType:"",fromOverride:!1,extension:p}}function qt(e,n,i){if(!i||Array.from(e.getElementsByTagName("Default")).some(p=>p.getAttribute("Extension")===i))return;const r=Array.from(n?.getElementsByTagName?.("Default")||[]).find(p=>p.getAttribute("Extension")===i);if(!r)return;const d=e.createElement("Default");d.setAttribute("Extension",i),d.setAttribute("ContentType",r.getAttribute("ContentType")||""),e.documentElement.appendChild(d)}function Ht(e){return e?!/xml|text|application\/(.*\+xml)/i.test(e):!1}function Jt(e){const n=/(.*\D)(\d+)(\.\w+)$/,i=e&&e.match(n);if(i){const[,c,,r]=i;return d=>`${c}${d}${r}`}return c=>`slides/slide${c}.xml`}async function Zt(e){const n="ppt/presentation.xml",i=W(e,n);if(!i)throw new Error("Base PPTX missing ppt/presentation.xml");const c=await i.async("string"),r=ie(c),d=r.getElementsByTagNameNS(J,"sldIdLst")[0]||r.getElementsByTagName("p:sldIdLst")[0],g=(d?Array.from(d.getElementsByTagNameNS(J,"sldId")).concat(Array.from(d.getElementsByTagName("p:sldId"))):[]).reduce((y,b)=>{const P=Number(b.getAttribute("id"));return Number.isNaN(P)?y:Math.max(y,P)},255),m="ppt/_rels/presentation.xml.rels",T=W(e,m);if(!T)throw new Error("Base PPTX missing ppt/_rels/presentation.xml.rels");const x=await T.async("string"),C=ie(x),u=Array.from(C.getElementsByTagName("Relationship")),$=u.reduce((y,b)=>{const P=F(b.getAttribute("Id"));return Math.max(y,P)},0),O=u.filter(y=>(y.getAttribute("Type")||"").endsWith("/slide")),N=O.length&&O[0].getAttribute("Target")||"",v=Jt(N),B=r.getElementsByTagNameNS(J,"sldMasterIdLst")[0]||r.getElementsByTagName("p:sldMasterIdLst")[0]||null,k=(B?Array.from(B.getElementsByTagNameNS(J,"sldMasterId")).concat(Array.from(B.getElementsByTagName("p:sldMasterId"))):[]).reduce((y,b)=>{const P=Number(b.getAttribute("id"));return Number.isNaN(P)?y:Math.max(y,P)},2147483647),Z=r.getElementsByTagNameNS(J,"notesMasterIdLst")[0]||r.getElementsByTagName("p:notesMasterIdLst")[0]||null;let z=null;const ae=u.find(y=>(y.getAttribute("Type")||"").endsWith("/notesMaster"));if(ae){const y=ae.getAttribute("Target")||"";z=fe("ppt/presentation.xml",y)}let oe=null;const me=u.find(y=>(y.getAttribute("Type")||"").endsWith("/theme"));if(me){const y=me.getAttribute("Target")||"";oe=fe("ppt/presentation.xml",y)}const V="[Content_Types].xml",le=W(e,V);if(!le)throw new Error("Base PPTX missing [Content_Types].xml");const Pe=await le.async("string"),we=ie(Pe),K={};e.filter(()=>!0).forEach(y=>{const b=Qe(y.name);if(!b)return;const P=`${b.dir}${b.prefix}`;se(K,P,b.number)}),se(K,"ppt/slides/slide",ce(e,/^ppt\/slides\/slide(\d+)\.xml$/)),se(K,"ppt/notesSlides/notesSlide",ce(e,/^ppt\/notesSlides\/notesSlide(\d+)\.xml$/)),se(K,"ppt/slideMasters/slideMaster",ce(e,/^ppt\/slideMasters\/slideMaster(\d+)\.xml$/)),se(K,"ppt/slideLayouts/slideLayout",ce(e,/^ppt\/slideLayouts\/slideLayout(\d+)\.xml$/)),se(K,"ppt/theme/theme",ce(e,/^ppt\/theme\/theme(\d+)\.xml$/)),se(K,"ppt/notesMasters/notesMaster",ce(e,/^ppt\/notesMasters\/notesMaster(\d+)\.xml$/)),se(K,"ppt/media/image",ce(e,/^ppt\/media\/image(\d+)\.[^.]+$/));const Q=e.file(/^ppt\/slides\/slide\d+\.xml$/).sort((y,b)=>F(y.name)-F(b.name));let Y="",D="",G="";if(Q.length){const y=Q[0],b=W(e,pe(y.name));if(b){const P=ie(await b.async("string")),q=Array.from(P.getElementsByTagName("Relationship")).find(_=>(_.getAttribute("Type")||"").endsWith("/slideLayout"));if(q){Y=q.getAttribute("Target")||"";const _=fe(y.name,Y);_&&W(e,_)&&(D=_)}}}if(D)!Y&&Q.length&&(Y=re(Q[0].name,D));else{const y=e.file(/^ppt\/slideLayouts\/.*\.xml$/).sort((b,P)=>F(b.name)-F(P.name));y.length&&(D=y[0].name,Y=Q.length?re(Q[0].name,D):"../slideLayouts/slideLayout1.xml")}if(D){const y=W(e,pe(D));if(y){const b=ie(await y.async("string")),he=Array.from(b.getElementsByTagName("Relationship")).find(q=>(q.getAttribute("Type")||"").endsWith("/slideMaster"));if(he){const q=he.getAttribute("Target")||"",_=fe(D,q);_&&W(e,_)&&(G=_)}}}if(!G){const y=e.file(/^ppt\/slideMasters\/.*\.xml$/).sort((b,P)=>F(b.name)-F(P.name));y.length&&(G=y[0].name)}if(!z){const y=e.file(/^ppt\/notesMasters\/.*\.xml$/).sort((b,P)=>F(b.name)-F(P.name));y.length&&(z=y[0].name)}return{zip:e,presentationXmlPath:n,presentationDoc:r,sldIdList:d,sldMasterList:B,notesMasterList:Z,presentationRelsPath:m,presentationRelsDoc:C,contentTypesPath:V,contentTypesDoc:we,nextSlideId:g,nextRelId:$,nextMasterId:k,counters:K,partMap:new Map,masterRelMap:new Map,notesMasterRelMap:new Map,getSlideTarget:v,defaultLayoutTarget:Y,defaultLayoutPath:D,defaultMasterPath:G,defaultNotesMasterPath:z,defaultThemePath:oe}}function Gt(e,n,i){const c=e.presentationRelsDoc.documentElement,r=e.presentationRelsDoc.createElement("Relationship");r.setAttribute("Id",i),r.setAttribute("Type","http://schemas.openxmlformats.org/officeDocument/2006/relationships/slide");const d=e.getSlideTarget?e.getSlideTarget(n):`slides/slide${n}.xml`;r.setAttribute("Target",d),c.appendChild(r)}function Vt(e,n){const i=e.presentationDoc,c=e.sldIdList||(()=>{const d=i.createElementNS(J,"p:sldIdLst");return i.documentElement.appendChild(d),e.sldIdList=d,d})(),r=i.createElementNS(J,"p:sldId");e.nextSlideId+=1,r.setAttribute("id",String(e.nextSlideId)),r.setAttributeNS(ve,"r:id",n),c.appendChild(r)}function Qt(e,n){if(e.masterRelMap.has(n))return e.masterRelMap.get(n);const i=e.presentationDoc,c=e.presentationRelsDoc;let r=e.sldMasterList;if(!r){r=i.createElementNS(J,"p:sldMasterIdLst");const m=i.documentElement.firstChild;m?i.documentElement.insertBefore(r,m):i.documentElement.appendChild(r),e.sldMasterList=r}e.nextMasterId=Number(e.nextMasterId||2147483647),e.nextMasterId+=1,e.nextRelId+=1;const d=`rId${e.nextRelId}`,p=i.createElementNS(J,"p:sldMasterId");p.setAttribute("id",String(e.nextMasterId)),p.setAttributeNS(ve,"r:id",d),r.appendChild(p);const g=c.createElement("Relationship");return g.setAttribute("Id",d),g.setAttribute("Type","http://schemas.openxmlformats.org/officeDocument/2006/relationships/slideMaster"),g.setAttribute("Target",re("ppt/presentation.xml",n)),c.documentElement.appendChild(g),e.masterRelMap.set(n,d),d}function en(e,n){if(e.notesMasterRelMap.has(n))return e.notesMasterRelMap.get(n);const i=e.presentationDoc,c=e.presentationRelsDoc;let r=e.notesMasterList;if(!r){r=i.createElementNS(J,"p:notesMasterIdLst");const m=i.documentElement,T=e.sldIdList||m.firstChild;T?m.insertBefore(r,T):m.appendChild(r),e.notesMasterList=r}e.nextRelId+=1;const d=`rId${e.nextRelId}`,p=i.createElementNS(J,"p:notesMasterId");p.setAttributeNS(ve,"r:id",d),r.appendChild(p);const g=c.createElement("Relationship");return g.setAttribute("Id",d),g.setAttribute("Type","http://schemas.openxmlformats.org/officeDocument/2006/relationships/notesMaster"),g.setAttribute("Target",re("ppt/presentation.xml",n)),c.documentElement.appendChild(g),e.notesMasterRelMap.set(n,d),d}async function Te(e,n,i,c,r,d={}){if(!r)return null;const p=`${c}:${r}`;if(e.partMap.has(p))return e.partMap.get(p);const g=Yt(i,r),m=W(n,r);if(!m)return null;if(g.contentType===Ut&&e.defaultLayoutPath)return e.partMap.set(p,e.defaultLayoutPath),e.defaultLayoutPath;if(g.contentType===ze&&e.defaultMasterPath)return e.partMap.set(p,e.defaultMasterPath),e.defaultMasterPath;if(g.contentType===Ye&&e.defaultNotesMasterPath)return e.partMap.set(p,e.defaultNotesMasterPath),e.defaultNotesMasterPath;if(g.contentType===Xt&&e.defaultThemePath)return e.partMap.set(p,e.defaultThemePath),e.defaultThemePath;const T=Qe(r);let x;if(T){const O=`${T.dir}${T.prefix}`,N=et(e.counters,O);x=`${T.dir}${T.prefix}${N}${T.ext}`}else{if(W(e.zip,r))return e.partMap.set(p,r),r;x=r}e.partMap.set(p,x),g.fromOverride?Ve(e.contentTypesDoc,`/${x}`,g.contentType):g.extension&&qt(e.contentTypesDoc,i,g.extension);const C=await m.async(Ht(g.contentType)?"uint8array":"string");e.zip.file(x,C);const u=pe(r),$=W(n,u);if($){const O=await $.async("string"),N=ie(O),v=Array.from(N.getElementsByTagName("Relationship"));for(const M of v){if((M.getAttribute("TargetMode")||"").toLowerCase()==="external")continue;const Z=M.getAttribute("Target")||"",z=fe(r,Z);if(!z)continue;let ae=null;if(typeof d.relationshipMutator=="function"){const V=await d.relationshipMutator({node:M,type:M.getAttribute("Type")||"",absolutePath:z,newPartPath:x,originalPartPath:r});if(V===!1)continue;V&&V.targetPath&&(ae=V.targetPath)}const oe=ae||await Te(e,n,i,c,z);if(!oe)continue;const me=re(x,oe);M.setAttribute("Target",me)}const B=pe(x);e.zip.file(B,xe(N))}return g.contentType===ze?Qt(e,x):g.contentType===Ye&&en(e,x),x}async function tn(e,n,i,c,r,d){const p=pe(r),g=W(n,p);if(!g)return;const m=await g.async("string"),T=ie(m),x=Array.from(T.getElementsByTagName("Relationship")),C=T.documentElement;let u=!1,$=x.reduce((N,v)=>{const B=v.getAttribute("Id")||"";return Math.max(N,F(B))},0);for(const N of x){const v=N.getAttribute("Type")||"",B=N.getAttribute("Target")||"";if(!B)continue;const M=fe(r,B);if(M){if(v.endsWith("/slideLayout")){e.defaultLayoutTarget?u?C.removeChild(N):(u=!0,N.setAttribute("Target",e.defaultLayoutTarget)):u?C.removeChild(N):u=!0;continue}if(v.endsWith("/notesSlide")){const k=await Te(e,n,i,c,M,{relationshipMutator:({type:Z})=>Z.endsWith("/slide")?{targetPath:d}:null});if(!k)continue;N.setAttribute("Target",re(d,k))}else if(v.includes("/image")||v.includes("/audio")||v.includes("/video")){const k=await Te(e,n,i,c,M);if(!k)continue;N.setAttribute("Target",re(d,k))}else{const k=await Te(e,n,i,c,M);if(!k)continue;N.setAttribute("Target",re(d,k))}}}if(!u&&e.defaultLayoutTarget){const N=T.createElement("Relationship"),v=`rId${$+1||1}`;N.setAttribute("Id",v),N.setAttribute("Type","http://schemas.openxmlformats.org/officeDocument/2006/relationships/slideLayout"),N.setAttribute("Target",e.defaultLayoutTarget),C.appendChild(N)}const O=pe(d);e.zip.file(O,xe(T))}async function nn(e,n,i){const c=n.file(/^ppt\/slides\/slide\d+\.xml$/).sort((p,g)=>{const m=F(p.name),T=F(g.name);return m-T});if(!c.length)return;const r=W(n,"[Content_Types].xml");if(!r)throw new Error("Source PPTX missing [Content_Types].xml");const d=ie(await r.async("string"));for(const p of c){const g=et(e.counters,"ppt/slides/slide"),m=`ppt/slides/slide${g}.xml`,T=await p.async("string");e.zip.file(m,T),Ve(e.contentTypesDoc,`/${m}`,Kt),e.nextRelId+=1;const x=`rId${e.nextRelId}`;Gt(e,g,x),Vt(e,x);const C=p.name;e.partMap.set(`${i}:${C}`,m),await tn(e,n,d,i,C,m)}}function sn(e){e.zip.file(e.presentationXmlPath,xe(e.presentationDoc)),e.zip.file(e.presentationRelsPath,xe(e.presentationRelsDoc)),e.zip.file(e.contentTypesPath,xe(e.contentTypesDoc))}function rn(e,n){const i=document.createElement("a");i.href=URL.createObjectURL(e),i.download=n,i.rel="noopener",i.click(),URL.revokeObjectURL(i.href)}async function an(e=[],n="Setlist"){if(!Array.isArray(e)||e.length===0)throw new Error("No PPTX files to merge");const i=(await Ee(async()=>{const{default:x}=await import("./jszip.min-C_Ifr0Rl.js").then(C=>C.j);return{default:x}},__vite__mapDeps([0,1,2]),import.meta.url)).default,[c,...r]=e,d=await qe(c),p=await i.loadAsync(d),g=await Zt(p);for(let x=0;x<r.length;x++){const C=await qe(r[x]),u=await i.loadAsync(C);await nn(g,u,`src${x+1}`)}sn(g);const m=await p.generateAsync({type:"blob"}),T=zt(n||"Setlist");rn(m,`${T}.pptx`)}function on(e){const n=e||"/";return n.endsWith("/")?n:`${n}/`}function ln(e){return e?e.slug?e.slug:e.filename?e.filename.replace(/\.chordpro$/i,""):e.title?e.title.trim().toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_.-]/g,""):"":""}async function cn(e={},n={}){const{name:i="Setlist",songs:c=[]}=e||{},{availablePptxMap:r=null,baseUrl:d="./",onEmpty:p}=n,g=on(d),m=[];for(const T of c){const x=ln(T);x&&(r&&!r[x]||m.push(`${g}pptx/${x}.pptx`))}if(!m.length){typeof p=="function"&&p();return}await an(m,i)}let He;const Je=()=>He||(He=Ee(()=>import("./index-BuOQd_aF.js").then(e=>e.i),__vite__mapDeps([3,1,2]),import.meta.url));function dn(){try{if(typeof crypto<"u"&&crypto.randomUUID)return crypto.randomUUID()}catch{}return`sel-${Math.random().toString(36).slice(2)}${Date.now().toString(36)}`}function tt(e){if(!e)return null;const{id:n,toKey:i=""}=e;return n==null?null:{uid:dn(),id:n,toKey:i}}function ye(e=[]){return e.map(n=>tt(n)).filter(Boolean)}function pn(){const{code:e,songIds:n}=mt(),i=ht(),c=gt(),[r,d]=w.useState("New Setlist"),[p,g]=w.useState(""),[m,T]=w.useState([]),[x,C]=w.useState(()=>{try{return localStorage.getItem("pref:icpOnly")==="1"}catch{return!1}});w.useEffect(()=>{try{localStorage.setItem("pref:icpOnly",x?"1":"0")}catch{}},[x]);const[u,$]=w.useState([]),[O,N]=w.useState({}),[v,B]=w.useState(""),[M,k]=w.useState("");Object.keys(O).length;const[Z,z]=w.useState(!1),[ae,oe]=w.useState(()=>{try{return window.innerWidth<=640}catch{return!1}}),[me,V]=w.useState(()=>{try{return window.innerWidth<=820}catch{return!1}}),[le,Pe]=w.useState(()=>{try{return window.innerWidth<=900}catch{return!1}}),we=w.useRef(""),K=w.useRef(""),Q=w.useRef(!1),[Y,D]=w.useState(null),[G,y]=w.useState(()=>ge()),[b,P]=w.useState(""),[he,q]=w.useState(!1),[_,je]=w.useState("");w.useEffect(()=>{const t=yt?.items||[],a=new Set,l=[];for(const o of t)a.has(o.id)||(a.add(o.id),l.push(o));T(l)},[]),w.useEffect(()=>{let t=!1;async function a(){const l={};for(const o of u){const f=m.find(te=>te.id===o.id);if(!f)continue;const h=f.filename.replace(/\.chordpro$/i,""),I=`./pptx/${h}.pptx`;await Mt(I,h)&&(l[h]=!0)}t||N(l)}return a(),()=>{t=!0}},[u,m]),w.useEffect(()=>{try{const t=document.documentElement,a=document.body;we.current=t.style.overflowY||"",K.current=a.style.overflowY||"",getComputedStyle(t).overflowY==="hidden"&&(t.style.overflowY=""),getComputedStyle(a).overflowY==="hidden"&&(a.style.overflowY="")}catch{}return()=>{try{document.documentElement.style.overflowY=we.current,document.body.style.overflowY=K.current}catch{}}},[]),w.useEffect(()=>{if(!e)return;const{entries:t,error:a}=xt(e);if(a){alert(a),c("/setlist",{replace:!0});return}const l=t.map(h=>({id:h.id,toKey:h.toKey}));$(ye(l));const o=l.map(h=>h.id).join(","),f=l.map(h=>encodeURIComponent(h.toKey||"")).join(",");c(`/setlist/${o}?toKeys=${f}`,{replace:!0})},[e]),w.useEffect(()=>{if(!n)return;const t=(n||"").split(",").map(f=>f.trim()).filter(Boolean);if(!t.length)return;const l=(new URLSearchParams(i.search||"").get("toKeys")||"").split(",").map(f=>decodeURIComponent(f)).filter(Boolean),o=t.map((f,h)=>({id:f,toKey:l[h]||""}));$(ye(o))},[n,i.search]),w.useEffect(()=>{try{if(!Array.isArray(u))return;if(u.length===0){(e||n)&&c("/setlist",{replace:!0});return}const t=u.map(f=>f.id).join(","),a=u.map(f=>encodeURIComponent(f.toKey||"")).join(","),l=n||"",o=new URLSearchParams(i.search||"").get("toKeys")||"";(t!==l||a!==o)&&c(`/setlist/${t}?toKeys=${a}`,{replace:!0})}catch{}},[u.map(t=>`${t.id}:${t.toKey}`).join("|"),n,i.search,e]),w.useEffect(()=>{try{const t=localStorage.getItem("setlist");if(!t||ge().length>0)return;const a=JSON.parse(t);if(a?.name||(a?.list?.length||0)>0){const l=We({name:a.name||"Imported Set",items:a.list||[]});y(ge()),D(l.id),d(l.name),$(ye(l.items||[])),P(l.id)}}catch{}},[]),w.useEffect(()=>{function t(){try{const a=window.innerWidth;oe(a<=640),V(a<=820),Pe(a<=900)}catch{}}return window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[]),w.useEffect(()=>{new URLSearchParams(i.search||"").get("icp")==="1"&&C(!0)},[i.search]),w.useEffect(()=>{if(Q.current)return;const t=i.state?.quickAction;t&&m.length&&(at(t,m),Q.current=!0,c(i.pathname+(i.search||""),{replace:!0,state:null}))},[i.state,m.map(t=>t.id).join("|")]);const Ie=w.useMemo(()=>new wt(m,{keys:["title","tags"],threshold:.4}),[m]);function nt(t){return!x||(Array.isArray(t.tags)?t.tags.includes("ICP"):t.tags==="ICP")}const st=w.useMemo(()=>(p?Ie.search(p).map(a=>a.item):m.slice().sort((a,l)=>a.title.localeCompare(l.title))).filter(nt),[p,Ie,m,x]);function Me(t){if(!t)return;const a=tt({id:t.id,toKey:t.originalKey||t.key||"C"});$(l=>[...l,a])}function it(t){$(a=>a.filter(l=>l.uid!==t))}function Ae(t,a){$(l=>{const o=l.findIndex(R=>R.uid===t);if(o<0)return l;const f=o+(a==="up"?-1:1);if(f<0||f>=l.length)return l;const h=l.slice(),[I]=h.splice(o,1);return h.splice(f,0,I),h})}function rt(t,a){$(l=>{if(a<0||a>=l.length)return l;const o=l.findIndex(I=>I.uid===t);if(o<0||o===a)return l;const f=l.slice(),[h]=f.splice(o,1);return f.splice(a,0,h),f})}function at(t,a){if(!t)return;function l(S){!S||!S.length||$(ye(S.map(E=>({id:E.id,toKey:E.toKey}))))}function o(S){return S?{id:S.id,toKey:S.originalKey||S.key||"C"}:null}function f(S,E){return S.filter(A=>A&&!E.has(A.id))}function h(S,E){const A=f(S,E),U=A.length?Fe(A):null;return U&&E.add(U.id),U}function I(){const S=Se(a,"FAST"),E=[],A=new Set;if((S.length>=4?ue(S,4):S.slice()).forEach(j=>{j&&A.add(j.id),E.push(j)}),E.length<4){const j=ue(f(a,A),Math.min(4-E.length,Math.max(0,a.length-E.length)));E.push(...j)}return E.filter(Boolean).map(o).filter(Boolean).slice(0,4)}function R(){const S=new Set,E=Se(a,"SLOW"),A=ft=>E.filter(pt=>(pt?.originalKey||"").toUpperCase()===ft.toUpperCase()),U=Se(a,"FAST"),j=h(A("G"),S)||h(E,S)||h(a,S),X=h(U,S)||h(a,S),H=h(A("A"),S)||h(E,S)||h(a,S);return[j,X,H].filter(Boolean).map(o).filter(Boolean)}function te(){const E=Fe(["CROSS","COMMITMENT","MISSION","MISSIONS","PRAISE","HYMN"]),A=Se(a,E),U=new Set,j=[];A.length>=4?j.push(...ue(A,4)):A.length>=2?j.push(...ue(A,Math.min(4,A.length))):A.length&&j.push(...A),j.forEach(H=>H&&U.add(H.id));const X=Math.max(0,2-j.length);if(X>0){const H=ue(f(a,U),Math.min(X,a.length-j.length));j.push(...H)}if(j.length<4){const H=ue(f(a,U),Math.min(4-j.length,a.length-j.length));j.push(...H)}return j.filter(Boolean).map(o).filter(Boolean).slice(0,4)}let ne=[];t==="celebrationSet"?ne=I():t==="threeSongFlow"?ne=R():t==="randomThemeSet"&&(ne=te()),ne.length&&l(ne)}function ot(t,a){$(l=>l.map(o=>o.uid===t?{...o,toKey:a}:o))}function Le(t){y(ge()),P(t||"")}function Ce(){D(null),d("New Setlist"),$([]),P("")}function lt(){const t=r?.trim()||"New Setlist",a=window.prompt("Save set as:",t);if(a===null)return;const l=String(a).trim()||"New Setlist";let o=Y;if(!o){const I=(ge()||[]).find(R=>(R.name||"")===l);I&&(o=I.id)}const f=u.map(({id:I,toKey:R})=>({id:I,toKey:R})),h=We({id:o,name:l,items:f});d(h.name),D(h.id),Le(h.id)}function ct(){const t=_||b||"";if(!t){q(!1);return}const a=_t(t);a&&(D(a.id),d(a.name||"New Setlist"),$(ye(a.items||[])),P(a.id)),q(!1)}function dt(){const t=G[0]?.id||"";je(b||t),q(!0)}function ut(){Y&&window.confirm(`Delete set "${r}"? This cannot be undone.`)&&(Ot(Y),Ce(),Le(""))}async function $e(){z(!0);try{const{downloadMultiSongPdf:t}=await Je(),a=[];for(const l of u){const o=m.find(f=>f.id===l.id);if(o)try{const f=`./songs/${o.filename}`,h=await At(f),I=Lt(h),R=I.meta?.key||I.meta?.originalkey||o.originalKey||"C",te=Ct(R,l.toKey||R),ne=(String(R).match(/^([A-G][#b]?)/)||[,""])[1],S=!!(ne&&/b$/.test(ne)),E=(I.sections||[]).map(j=>({section:j.label,lines:(j.lines||[]).map(X=>X.instrumental?{instrumental:$t(X.instrumental,te,S)}:X.comment?{plain:X.comment,chordPositions:[],comment:X.comment}:{plain:X.lyrics||"",chordPositions:(X.chords||[]).map(H=>({sym:Rt(H.sym,te,S),index:H.index}))})})),A=o.filename.replace(/\.chordpro$/i,""),U=Bt({title:I.meta?.title||o.title||A,key:l.toKey||R,capo:I.meta?.capo,lyricsBlocks:E});a.push(U)}catch(f){console.error(f),ee(`Failed to process ${o.filename}`)}}a.length&&await t(a)}finally{z(!1)}}function be(){Je()}async function Re(){try{const t=u.map(f=>f.id).join(","),a=u.map(f=>encodeURIComponent(f.toKey||"")).join(","),o=`${(()=>{try{if(typeof window<"u"&&window.location){const f=window.location.origin||"",h="./".replace(/^\./,"");return`${f}${h}`.replace(/\/+$/,"/")}}catch{}return""})()}#/setlist/${t}?toKeys=${a}`;await navigator.clipboard.writeText(o);try{ee?.("Link copied!")}catch{}}catch{alert("Failed to copy link")}}async function Be(){if(M)return;B(`Bundling 0/${u.length}…`);const t=(await Ee(async()=>{const{default:o}=await import("./jszip.min-C_Ifr0Rl.js").then(f=>f.j);return{default:o}},__vite__mapDeps([0,1,2]),import.meta.url)).default,a=new t;let l=0;for(let o=0;o<u.length;o++){const f=u[o],h=m.find(R=>R.id===f.id);if(!h){B(`Bundling ${o+1}/${u.length}…`);continue}B(`Bundling ${o+1}/${u.length}…`);const I=h.filename.replace(/\.chordpro$/i,"");if(O[I])try{const R=await fetch(`./pptx/${I}.pptx`);if(!R.ok)continue;const te=await R.blob();l++,a.file(`${String(l).padStart(2,"0")}-${I}.pptx`,te)}catch{}}if(l>0){const o=await a.generateAsync({type:"blob"}),f=new Date().toISOString().slice(0,10).replace(/-/g,""),h=document.createElement("a");h.href=URL.createObjectURL(o),h.download=`setlist-pptx-${f}.zip`,h.click(),URL.revokeObjectURL(h.href)}else try{ee&&ee("No PPTX files found for selected songs")||alert("No PPTX files found for selected songs")}catch{}B("")}async function ke(){if(!(v||M)){k("Combining…");try{const t=[],a=[];for(const l of u){const o=m.find(h=>h.id===l.id);if(!o)continue;const f=o.filename.replace(/\.chordpro$/i,"");if(!O[f]){a.push(o.title||f);continue}t.push(o)}if(!t.length){try{ee&&ee("No PPTX files found for selected songs")||alert("No PPTX files found for selected songs")}catch{}return}if(a.length){const l=a.length===1?`${a[0]} PPT file unavailable`:`${a.length} songs missing PPT files`;try{ee?.(l)}catch{}}await cn({name:r||"Setlist",songs:t},{baseUrl:"./"})}catch(t){console.error(t);try{ee&&ee("Failed to combine PPTX files")||alert("Failed to combine PPTX files")}catch{}}finally{k("")}}}return s.jsxs(kt,{className:"is-setlist",children:[he?s.jsx("div",{style:{position:"fixed",inset:0,display:"flex",alignItems:"center",justifyContent:"center",background:"rgba(0,0,0,.45)",zIndex:90},role:"dialog","aria-modal":"true",children:s.jsxs("div",{style:{background:"var(--card)",color:"var(--text)",border:"1px solid var(--line)",borderRadius:10,padding:16,width:"min(560px, 92vw)"},children:[s.jsx("h3",{style:{marginTop:0,marginBottom:8},children:"Load Set"}),G.length?s.jsxs("label",{style:{display:"block",margin:"8px 0"},children:["Select a saved set",s.jsx("select",{value:_,onChange:t=>je(t.target.value),style:{width:"100%"},children:G.map(t=>s.jsxs("option",{value:t.id,children:[t.name," · ",new Date(t.updatedAt).toLocaleString()]},t.id))})]}):s.jsx("div",{className:"meta",children:"No saved sets yet."}),s.jsxs("div",{className:"row",style:{justifyContent:"flex-end",gap:8,marginTop:12},children:[s.jsx(L,{onClick:()=>q(!1),children:"Cancel"}),s.jsx(L,{variant:"primary",onClick:ct,disabled:!G.length,children:"Load"})]})]})}):null,s.jsx(bt,{busy:Z}),s.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginTop:12,marginBottom:4},children:[s.jsx("div",{}),s.jsx("h1",{style:{margin:0},children:"Setlist Builder"}),s.jsx("div",{})]}),ae?s.jsx(De,{className:"card",style:{marginTop:8,position:"static"},children:s.jsxs("div",{className:"setlist-actions--mobile",style:{width:"100%"},children:[s.jsx(L,{variant:"primary",onClick:$e,onMouseEnter:be,onFocus:be,disabled:Z||u.length===0,title:"Export set as a single PDF",iconLeft:s.jsx(de,{}),children:"PDF"}),s.jsx(L,{onClick:ke,disabled:u.length===0||!!v||!!M,title:u.length===0?"Add songs to combine PPTX files":"Combine PPTX files into a single presentation",iconLeft:s.jsx(de,{}),children:M||"Export PPT"}),s.jsx(L,{onClick:Be,disabled:u.length===0||!!v||!!M,title:u.length===0?"Add songs to export PPTX bundle":"Export PPTX bundle (ZIP) for selected songs",iconLeft:s.jsx(de,{}),children:"PPT ZIP"}),s.jsx(L,{onClick:Re,title:"Copy shareable link",iconLeft:s.jsx(_e,{}),disabled:u.length===0,children:"Share"}),s.jsx(L,{as:Oe,to:u.length?`/worship/${u.map(t=>t.id).join(",")}?toKeys=${u.map(t=>encodeURIComponent(t.toKey)).join(",")}`:"/worship",title:"Open Worship Mode",iconLeft:s.jsx(Ke,{}),children:"Worship"})]})}):s.jsxs(De,{className:"card",style:{marginTop:8,position:"static"},children:[s.jsx("div",{style:{width:"100%",marginBottom:6},children:s.jsx("strong",{title:"Current set name",children:r||"New Setlist"})}),s.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",flexWrap:"wrap",width:"100%"},children:[s.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"},children:[s.jsxs(L,{size:"sm",variant:"secondary",onClick:lt,title:"Save set",iconLeft:s.jsx(St,{}),children:[" ",s.jsx("span",{className:"text-when-wide",children:"Save"})]}),s.jsxs(L,{size:"sm",variant:"secondary",onClick:dt,title:"Load saved set",iconLeft:s.jsx(Tt,{}),disabled:!G.length,children:[" ",s.jsx("span",{className:"text-when-wide",children:"Load"})]}),s.jsxs(L,{size:"sm",variant:"secondary",onClick:Ce,title:"New set",iconLeft:s.jsx(Ue,{}),children:[" ",s.jsx("span",{className:"text-when-wide",children:"New"})]}),s.jsxs(L,{size:"sm",variant:"secondary",onClick:ut,disabled:!Y,title:"Delete set",iconLeft:s.jsx(Nt,{}),children:[" ",s.jsx("span",{className:"text-when-wide",children:"Delete"})]}),s.jsxs(L,{size:"sm",variant:"secondary",onClick:Re,title:"Copy shareable link",iconLeft:s.jsx(_e,{}),disabled:u.length===0,children:[" ",s.jsx("span",{className:"text-when-wide",children:"Share Set"})]})]}),s.jsxs("div",{style:{marginLeft:"auto",display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"},children:[s.jsx(L,{variant:"primary",size:"md",onClick:$e,onMouseEnter:be,onFocus:be,disabled:Z||u.length===0,title:"Export set as a single PDF",iconLeft:s.jsx(de,{}),children:Z?"Exporting…":s.jsxs(s.Fragment,{children:[s.jsx("span",{className:"text-when-wide",children:"Export PDF"}),s.jsx("span",{className:"text-when-narrow",children:"PDF"})]})}),s.jsx(L,{variant:"primary",size:"md",onClick:ke,disabled:u.length===0||!!v||!!M,title:u.length===0?"Add songs to combine PPTX files":"Combine PPTX files into a single presentation",iconLeft:s.jsx(de,{}),children:M||s.jsxs(s.Fragment,{children:[s.jsx("span",{className:"text-when-wide",children:"Export PPT"}),s.jsx("span",{className:"text-when-narrow",children:"Export PPT"})]})}),s.jsx(L,{variant:"primary",size:"md",onClick:Be,disabled:u.length===0||!!v||!!M,title:u.length===0?"Add songs to export PPTX bundle":"Export PPTX bundle (ZIP) for selected songs",iconLeft:s.jsx(de,{}),children:v||s.jsxs(s.Fragment,{children:[s.jsx("span",{className:"text-when-wide",children:"PPT ZIP"}),s.jsx("span",{className:"text-when-narrow",children:"PPT ZIP"})]})}),s.jsxs(L,{variant:"primary",size:"md",as:Oe,to:u.length?`/worship/${u.map(t=>t.id).join(",")}?toKeys=${u.map(t=>encodeURIComponent(t.toKey)).join(",")}`:"/worship",title:"Open Worship Mode",iconLeft:s.jsx(Ke,{}),children:[" ",s.jsx("span",{className:"text-when-wide",children:"Worship Mode"}),s.jsx("span",{className:"text-when-narrow",children:"Worship"})]})]})]})]}),s.jsxs("div",{className:"BuilderPage",style:{marginTop:8},children:[s.jsx("div",{className:"BuilderLeft",children:s.jsx("section",{className:"setlist-section setlist-add","data-role":"add",children:s.jsxs("div",{className:"card setlist-pane",children:[s.jsxs("div",{className:["BuilderHeader","section-header",le?"no-sticky":""].filter(Boolean).join(" "),style:{display:"flex",alignItems:"center",gap:8},children:[s.jsx("strong",{style:{whiteSpace:"nowrap"},children:"Add songs"}),s.jsx(Pt,{value:p,onChange:t=>g(t.target.value),placeholder:"Search...",style:{flex:1,minWidth:0}}),s.jsxs("label",{className:"row",style:{gap:6,alignItems:"center"},children:[s.jsx("input",{type:"checkbox",checked:x,onChange:t=>C(t.target.checked)}),s.jsx("span",{className:"meta",title:"Limit results to songs tagged ICP",children:"ICP only"})]})]}),s.jsx("div",{className:["BuilderScroll","setlist-scroll","setlist-list",le?"no-pane-scroll":"pane-scroll","pane--addSongs"].join(" "),children:Ie?s.jsx("div",{style:{display:"grid",gap:".5rem",gridTemplateColumns:"repeat(auto-fill, minmax(320px, 1fr))",marginTop:6},children:st.map(t=>s.jsx(Xe,{title:t.title,subtitle:`${t.originalKey||""}${t.tags?.length?` • ${t.tags.join(", ")}`:""}`,rightSlot:s.jsx(L,{"aria-label":"Add",title:"Add to set",variant:"primary",iconLeft:s.jsx(Ue,{}),iconOnly:!0,onClick:a=>{a.stopPropagation(),Me(t)}}),onClick:()=>Me(t)},t.id))}):s.jsx("div",{children:"Loading search…"})})]})})}),s.jsx("div",{className:"BuilderRight",style:{minHeight:0,display:"flex",flexDirection:"column"},children:s.jsxs("section",{className:"setlist-section setlist-current","data-role":"current",children:[s.jsxs("div",{className:"card setlist-pane",children:[s.jsx("div",{className:["BuilderHeader","section-header",le?"no-sticky":""].filter(Boolean).join(" "),children:s.jsxs("strong",{children:["Current setlist (",u.length,")"]})}),s.jsx("div",{className:["BuilderScroll","setlist-scroll","setlist-list",le?"no-pane-scroll":"pane-scroll","pane--currentSet"].join(" "),style:{marginTop:6},children:u.map((t,a)=>{const l=m.find(o=>o.id===t.id);return l?s.jsx(Xe,{draggable:!0,onDragStart:o=>{o.dataTransfer.setData("text/plain",String(t.uid||t.id)),o.dataTransfer.effectAllowed="move"},onDragOver:o=>{o.preventDefault(),o.dataTransfer.dropEffect="move"},onDrop:o=>{o.preventDefault();const f=o.dataTransfer.getData("text/plain");rt(f,a)},title:l.title,subtitle:`Original: ${l.originalKey||"—"}`,rightSlot:s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6},children:[s.jsx(jt,{variant:"ui",baseKey:l.originalKey||"C",valueKey:t.toKey||l.originalKey||"C",onChange:o=>ot(t.uid,o)}),s.jsx(L,{onClick:()=>Ae(t.uid,"up"),title:"Move up",iconLeft:s.jsx(It,{})}),s.jsx(L,{onClick:()=>Ae(t.uid,"down"),title:"Move down",iconLeft:s.jsx(Et,{})}),s.jsx(L,{onClick:()=>it(t.uid),title:"Remove",iconLeft:s.jsx(vt,{}),iconOnly:!0,style:{color:"#b91c1c"}})]})},t.uid||`${t.id}-${a}`):null})})]}),s.jsxs("div",{className:"print-only",style:{marginTop:16},children:[s.jsx("h2",{style:{fontSize:"20pt",margin:"0 0 8pt 0"},children:r}),s.jsx("ol",{style:{fontSize:"12pt",lineHeight:1.4,paddingLeft:"1.2em"},children:u.map((t,a)=>{const l=m.find(o=>o.id===t.id);return l?s.jsxs("li",{children:[l.title," — ",t.toKey||l.originalKey||"—"]},t.uid||`${t.id}-${a}`):null})})]})]})})]})]})}export{pn as default};
