const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-DOk6jJ3u.js","./index-enbORtnO.js","./index-HhIrnoYH.css","./jszip.min-DX7zM4II.js"])))=>i.map(i=>d[i]);
import{r as u,i as ye,F as be,j as e,B as Se,L as we,P as F,S as ve,C as Ne,T as Ce,a as z,K as Pe,A as ke,b as Ie,R as Te,D as H,c as $e,d as De,h as Ke,t as J,_ as W,f as Ae,p as _e,s as Le,n as Ee,e as Be}from"./index-enbORtnO.js";const Y="gracechords.sets.v1";function P(){try{const i=localStorage.getItem(Y);return i?JSON.parse(i):{sets:{}}}catch{return{sets:{}}}}function q(i){localStorage.setItem(Y,JSON.stringify(i))}function Ue(){return typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():"id-"+Math.random().toString(36).slice(2)+Date.now().toString(36)}function N(){const{sets:i}=P();return Object.values(i).sort((o,m)=>(m.updatedAt||0)-(o.updatedAt||0))}function G(i){const{sets:o}=P();return o[i]||null}function C(i){var d;const o=Date.now(),m={id:i.id||Ue(),name:((d=i.name)==null?void 0:d.trim())||"Untitled Set",items:Array.isArray(i.items)?i.items:[],createdAt:i.createdAt||o,updatedAt:o},b=P();return b.sets[m.id]=m,q(b),m}function Re(i){const o=P();return o.sets[i]?(delete o.sets[i],q(o),!0):!1}function Oe(i){const o=G(i);return o?C({name:`Copy of ${o.name}`,items:o.items.map(m=>({...m}))}):null}let X;const V=()=>X||(X=W(()=>import("./index-DOk6jJ3u.js").then(i=>i.i),__vite__mapDeps([0,1,2]),import.meta.url));function Fe(){const[i,o]=u.useState("Untitled Set"),[m,b]=u.useState(""),[d,Q]=u.useState([]),[l,p]=u.useState([]),[D,Z]=u.useState({}),[k,S]=u.useState(""),K=Object.keys(D).length,[I,A]=u.useState(!1),[x,g]=u.useState(null),[ee,_]=u.useState(()=>N()),[te,w]=u.useState("");u.useEffect(()=>{var t;Q(((t=ye)==null?void 0:t.items)||[])},[]),u.useEffect(()=>{let t=!1;async function s(){const n={};for(const a of l){const r=d.find(f=>f.id===a.id);if(!r)continue;const c=`./pptx/${r.id}.pptx`;await Ke(c,r.id)&&(n[r.id]=!0)}t||Z(n)}return s(),()=>{t=!0}},[l,d]),u.useEffect(()=>{var t;try{const s=localStorage.getItem("setlist");if(!s||N().length>0)return;const n=JSON.parse(s);if(n!=null&&n.name||(((t=n==null?void 0:n.list)==null?void 0:t.length)||0)>0){const a=C({name:n.name||"Imported Set",items:n.list||[]});_(N()),g(a.id),o(a.name),p(a.items||[]),w(a.id)}}catch{}},[]);const T=u.useMemo(()=>new be(d,{keys:["title","tags"],threshold:.4}),[d]),ne=u.useMemo(()=>m?T.search(m).map(t=>t.item):d.slice().sort((t,s)=>t.title.localeCompare(s.title)),[m,T,d]);function se(t){l.find(s=>s.id===t.id)||p([...l,{id:t.id,toKey:t.originalKey||"C"}])}function ie(t){p(l.filter(s=>s.id!==t))}function L(t,s){const n=l.findIndex(h=>h.id===t);if(n<0)return;const a=n+(s==="up"?-1:1);if(a<0||a>=l.length)return;const r=l.slice(),[c]=r.splice(n,1);r.splice(a,0,c),p(r)}function ae(t,s){p(l.map(n=>n.id===t?{...n,toKey:s}:n))}function E(t){p(s=>s.map(n=>{const a=d.find(c=>c.id===n.id),r=n.toKey||(a==null?void 0:a.originalKey)||"C";return{...n,toKey:J(r,t)}}))}function oe(){p(t=>t.map(s=>{const n=d.find(a=>a.id===s.id);return{...s,toKey:(n==null?void 0:n.originalKey)||"C"}}))}function v(t){_(N()),w(t||"")}function B(){g(null),o("Untitled Set"),p([]),w("")}function le(){const t=(i==null?void 0:i.trim())||"Untitled Set",s=C({id:x,name:t,items:l});o(s.name),g(s.id),v(s.id)}function ce(t){const s=t.target.value;if(w(s),!s)return;const n=G(s);n&&(g(n.id),o(n.name||"Untitled Set"),p(n.items||[]))}function re(){if(!x){const s=`Copy of ${i||"Untitled Set"}`,n=C({id:null,name:s,items:l});o(n.name),g(n.id),v(n.id);return}const t=Oe(x);t&&(g(t.id),o(t.name),p(t.items||[]),v(t.id))}function de(){x&&window.confirm(`Delete set "${i}"? This cannot be undone.`)&&(Re(x),B(),v(""))}async function ue(){var t,s,n,a;A(!0);try{const{downloadMultiSongPdf:r}=await V(),c=[];for(const h of l){const f=d.find(j=>j.id===h.id);if(f)try{const j=`./songs/${f.filename}`,he=await Ae(j),y=_e(he),$=((t=y.meta)==null?void 0:t.key)||((s=y.meta)==null?void 0:s.originalkey)||f.originalKey||"C",fe=Le($,h.toKey||$),xe=(y.blocks||[]).map(R=>({section:R.section,lines:(R.lines||[]).map(O=>({plain:O.text,chordPositions:(O.chords||[]).map(M=>({sym:J(M.sym,fe),index:M.index}))}))})),ge=f.filename.replace(/\.chordpro$/i,""),je=Ee({title:((n=y.meta)==null?void 0:n.title)||f.title||ge,key:h.toKey||$,capo:(a=y.meta)==null?void 0:a.capo,lyricsBlocks:xe});c.push(je)}catch(j){console.error(j),Be(`Failed to process ${f.filename}`)}}c.length&&await r(c)}finally{A(!1)}}function U(){V()}async function me(){S(`Bundling 0/${l.length}…`);const t=(await W(async()=>{const{default:a}=await import("./jszip.min-DX7zM4II.js").then(r=>r.j);return{default:a}},__vite__mapDeps([3,1,2]),import.meta.url)).default,s=new t;let n=0;for(let a=0;a<l.length;a++){const r=l[a],c=d.find(h=>h.id===r.id);if(!c){S(`Bundling ${a+1}/${l.length}…`);continue}if(S(`Bundling ${a+1}/${l.length}…`),!!D[c.id])try{const h=await fetch(`./pptx/${c.id}.pptx`);if(!h.ok)continue;const f=await h.blob();n++,s.file(`${String(n).padStart(2,"0")}-${c.id}.pptx`,f)}catch{}}if(n>0){const a=await s.generateAsync({type:"blob"}),r=new Date().toISOString().slice(0,10).replace(/-/g,""),c=document.createElement("a");c.href=URL.createObjectURL(a),c.download=`setlist-pptx-${r}.zip`,c.click(),URL.revokeObjectURL(c.href)}S("")}function pe(){window.print()}return e.jsxs("div",{className:"container",children:[e.jsx(Se,{busy:I}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx("div",{children:e.jsx(we,{to:"/",className:"back",children:"← Back"})}),e.jsx("h1",{style:{margin:0},children:"Setlist Builder"}),e.jsx("div",{})]}),e.jsxs("div",{className:"card toolbar",style:{marginTop:12},children:[e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx("span",{children:"Set:"}),e.jsx("input",{"aria-label":"Set name",value:i,onChange:t=>o(t.target.value),style:{minWidth:220},placeholder:"Sunday AM"})]}),e.jsxs("select",{"aria-label":"Saved sets",value:te,onChange:ce,children:[e.jsx("option",{value:"",children:"— Load saved set —"}),ee.map(t=>e.jsxs("option",{value:t.id,children:[t.name," · ",new Date(t.updatedAt).toLocaleString()]},t.id))]}),e.jsxs("button",{className:"btn iconbtn",onClick:B,title:"New set",children:[e.jsx(F,{}),e.jsx("span",{className:"text-when-wide",children:"New"})]}),e.jsxs("button",{className:"btn primary iconbtn",onClick:le,title:"Save set",children:[e.jsx(ve,{}),e.jsx("span",{className:"text-when-wide",children:"Save"})]}),e.jsxs("button",{className:"btn iconbtn",onClick:re,disabled:!l.length,title:"Duplicate set",children:[e.jsx(Ne,{}),e.jsx("span",{className:"text-when-wide",children:"Duplicate"})]}),e.jsxs("button",{className:"btn iconbtn",onClick:de,disabled:!x,title:"Delete set",children:[e.jsx(Ce,{}),e.jsx("span",{className:"text-when-wide",children:"Delete"})]}),e.jsxs("div",{style:{marginLeft:"auto",display:"flex",alignItems:"center",gap:6},children:[e.jsx("span",{className:"meta",children:"Transpose:"}),e.jsx("button",{className:"btn",onClick:()=>E(-1),title:"Transpose set down 1 semitone",children:"–1"}),e.jsx("button",{className:"btn",onClick:oe,title:"Reset all to originals",children:"Reset"}),e.jsx("button",{className:"btn",onClick:()=>E(1),title:"Transpose set up 1 semitone",children:"+1"})]})]}),e.jsxs("div",{className:"BuilderPage",style:{marginTop:12},children:[e.jsx("div",{className:"BuilderLeft",children:e.jsx("div",{className:"card",children:e.jsxs("div",{style:{marginTop:8},children:[e.jsx("strong",{children:"Add songs"}),e.jsx("input",{value:m,onChange:t=>b(t.target.value),placeholder:"Search...",style:{display:"block",width:"100%",marginTop:6}}),e.jsx("div",{style:{minHeight:0,maxHeight:300,overflow:"auto",marginTop:6},children:T?ne.map(t=>{var s;return e.jsx(z,{title:t.title,subtitle:`${t.originalKey||""}${(s=t.tags)!=null&&s.length?` • ${t.tags.join(", ")}`:""}`,rightSlot:e.jsxs("button",{className:"btn iconbtn",onClick:()=>se(t),title:"Add to set",children:[e.jsx(F,{}),e.jsx("span",{className:"text-when-wide",children:"Add"})]})},t.id)}):e.jsx("div",{children:"Loading search…"})})]})})}),e.jsx("div",{className:"BuilderRight",children:e.jsxs("div",{className:"card",children:[e.jsxs("strong",{children:["Current setlist (",l.length,")"]}),e.jsx("div",{style:{minHeight:0,maxHeight:360,overflow:"auto",marginTop:6},children:l.map(t=>{const s=d.find(n=>n.id===t.id);return s?e.jsx(z,{title:s.title,subtitle:`Original: ${s.originalKey||"—"}`,rightSlot:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx("select",{value:t.toKey,onChange:n=>ae(t.id,n.target.value),children:Pe.map(n=>e.jsx("option",{value:n,children:n},n))}),e.jsx("button",{className:"btn",onClick:()=>L(t.id,"up"),title:"Move up",children:e.jsx(ke,{})}),e.jsx("button",{className:"btn",onClick:()=>L(t.id,"down"),title:"Move down",children:e.jsx(Ie,{})}),e.jsx("button",{className:"btn",onClick:()=>ie(t.id),title:"Remove",children:e.jsx(Te,{})})]})},t.id):null})}),e.jsxs("div",{style:{display:"flex",gap:8,marginTop:8,flexWrap:"wrap"},children:[e.jsx("button",{className:"btn primary iconbtn",onClick:ue,onMouseEnter:U,onFocus:U,disabled:I,title:"Export set as a single PDF",children:I?"Exporting…":e.jsxs(e.Fragment,{children:[e.jsx(H,{})," ",e.jsx("span",{className:"text-when-wide",children:"Export PDF"}),e.jsx("span",{className:"text-when-narrow",children:"PDF"})]})}),e.jsx("button",{className:"btn iconbtn",onClick:me,disabled:K===0||!!k,title:K===0?"No PPTX files found for this set.":"Bundle PPTX files for selected songs",children:k||e.jsxs(e.Fragment,{children:[e.jsx(H,{})," ",e.jsx("span",{className:"text-when-wide",children:"Bundle PPTX"}),e.jsx("span",{className:"text-when-narrow",children:"PPTX"})]})}),e.jsxs("button",{className:"btn iconbtn",onClick:pe,title:"Print setlist",children:[e.jsx($e,{}),e.jsx("span",{className:"text-when-wide",children:"Print"})]}),e.jsxs("button",{className:"btn iconbtn",onClick:()=>p([]),title:"Clear setlist",children:[e.jsx(De,{}),e.jsx("span",{className:"text-when-wide",children:"Clear"})]})]}),e.jsxs("div",{className:"print-only",style:{marginTop:16},children:[e.jsx("h2",{style:{fontSize:"20pt",margin:"0 0 8pt 0"},children:i}),e.jsx("ol",{style:{fontSize:"12pt",lineHeight:1.4,paddingLeft:"1.2em"},children:l.map(t=>{const s=d.find(n=>n.id===t.id);return s?e.jsxs("li",{children:[s.title," — ",t.toKey||s.originalKey||"—"]},t.id):null})})]})]})})]})]})}export{Fe as default};
