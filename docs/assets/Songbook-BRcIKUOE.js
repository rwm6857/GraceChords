const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-Bqq7wFw3.js","./index-C3UFnFGO.js","./index-BrHym0IO.css"])))=>i.map(i=>d[i]);
import{r as l,i as K,a as V,b as G,F as J,j as t,c as X,T as Y,B as g,y as Z,D as ee,I as te,P as B,g as se,k as ne,p as E,m as ie,_ as ae,o as re,q as oe,w as le,x as b,z as ce}from"./index-C3UFnFGO.js";import{P as de}from"./PageContainer-B8XjO9er.js";let F;const M=()=>F||(F=ae(()=>import("./index-Bqq7wFw3.js").then(o=>o.i),__vite__mapDeps([0,1,2]),import.meta.url));function p(o,u){return ce(o,u)}function he(){const o=l.useMemo(()=>{const e=K?.items||[],n=new Set,s=[];for(const i of e)n.has(i.id)||(n.add(i.id),s.push(i));return s.slice().sort(p)},[]),u=V(),D=G(),C=l.useRef(!1),[x,R]=l.useState(""),N=l.useMemo(()=>new J(o,{keys:["title","tags","authors"],threshold:.4}),[o]),h=l.useMemo(()=>x?N.search(x).map(e=>e.item):o.slice().sort(p),[o,N,x]),[y,m]=l.useState(()=>new Set),f=l.useMemo(()=>h.filter(e=>y.has(e.id)).slice().sort(p),[h,y]),I=h.length,O=y.size;function v(e,n){m(s=>{const i=new Set(s);return n?i.add(e):i.delete(e),i})}function _(){h.length&&m(e=>{const n=new Set(e);for(const s of h)n.add(s.id);return n})}function z(){m(new Set)}function H(e,n){if(!e)return;const s=n||[],i=a=>new Set(a.map(r=>r.id));if(e==="random10SongCollection"){const a=Math.min(10,s.length),r=a===s.length?s:E(s,a);m(i(r));return}if(e==="sendMeSongbook"){const a=["NATION","NATIONS","MISSION","MISSIONS","ICP"],r=s.filter(c=>a.some(S=>ie([c],S).length));if(r.length)r.sort(p),m(i(r));else{const c=E(s,Math.min(5,s.length));m(i(c))}return}if(e==="graceChordsSongbook"){const a=s.slice().sort(p);m(i(a))}}const[q,j]=l.useState(null),[w,L]=l.useState(!1),[P,W]=l.useState(()=>{try{return window.innerWidth<=640}catch{return!1}});l.useEffect(()=>{function e(){try{W(window.innerWidth<=640)}catch{}}return window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),l.useEffect(()=>{const n=new URLSearchParams(u.search||"").get("tags");if(!n)return;const s=n.split(",").map(a=>a.trim().toLowerCase()).filter(Boolean);if(!s.length)return;const i=o.filter(a=>(Array.isArray(a.tags)?a.tags.map(c=>String(c).toLowerCase()):[]).some(c=>s.includes(c)));i.length&&m(a=>{const r=new Set(a);return i.forEach(c=>r.add(c.id)),r})},[u.search,o]),l.useEffect(()=>{if(C.current)return;const e=u.state?.quickAction;e&&o.length&&(H(e,o),C.current=!0,D(u.pathname+(u.search||""),{replace:!0,state:null}))},[u.state,o.map(e=>e.id).join("|")]);async function U(){if(f.length){L(!0);try{const{downloadSongbookPdf:e}=await M(),n=[];for(const s of f)try{const i=`./songs/${s.filename}`,a=await re(i),r=oe(a),c=(r.sections||[]).map(A=>({section:A.label,lines:(A.lines||[]).map(d=>d.instrumental?{instrumental:{chords:Array.isArray(d.instrumental?.chords)?d.instrumental.chords.slice():[],repeat:typeof d.instrumental?.repeat=="number"?d.instrumental.repeat:void 0}}:d.comment?{plain:d.comment,chordPositions:[],comment:d.comment}:{plain:d.lyrics||"",chordPositions:(d.chords||[]).map(T=>({sym:T.sym,index:T.index}))})})),S=s.filename.replace(/\.chordpro$/,""),Q=le({title:r.meta.title||s.title||S,key:r.meta.key||r.meta.originalkey||s.originalKey||"C",capo:r.meta?.capo,lyricsBlocks:c});n.push(Q)}catch(i){console.error(i),b(`Failed to process ${s.filename}`)}n.length&&await e(n,{includeTOC:!0,coverImageDataUrl:q})}finally{L(!1)}}}function k(){M()}function $(e){const n=e.target.files?.[0];if(!n){j(null);return}if(n.size>2*1024*1024){b("Image must be under 2 MB"),e.target.value="",j(null);return}if(!n.type.startsWith("image/")){b("File must be an image"),e.target.value="",j(null);return}const s=new FileReader;s.onload=()=>j(String(s.result||"")),s.readAsDataURL(n)}return o.length===0?t.jsxs("div",{className:"container",children:[t.jsx("h1",{children:"No songs found"}),t.jsx("p",{className:"Small",children:"The song index is empty or failed to load."})]}):t.jsxs(de,{children:[t.jsx(X,{busy:w}),t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginTop:12,marginBottom:4},children:[t.jsx("div",{}),t.jsx("h1",{style:{margin:0},children:"Songbook Builder"}),t.jsx("div",{})]}),t.jsxs(Y,{className:"card",style:{marginTop:8},children:[t.jsxs("div",{className:"Field",style:{minWidth:0},children:[t.jsx("label",{htmlFor:"sb-cover",children:"Upload Cover Image:"}),t.jsx("input",{id:"sb-cover",className:"CoverInput",type:"file",accept:"image/*",onChange:$,style:P?{maxWidth:"50vw",textOverflow:"ellipsis",overflow:"hidden",whiteSpace:"nowrap"}:void 0})]}),t.jsxs("div",{style:{marginLeft:"auto",display:"flex",gap:6},children:[t.jsx(g,{onClick:z,disabled:!O,title:"Clear selection",iconLeft:t.jsx(Z,{}),children:t.jsx("span",{className:"text-when-wide",children:"Clear"})}),t.jsx(g,{variant:"primary",onClick:U,onMouseEnter:k,onFocus:k,disabled:!f.length||w,title:f.length?"Export PDF":"Select some songs first",iconLeft:t.jsx(ee,{}),children:w?"Exporting…":P?"PDF":t.jsxs(t.Fragment,{children:[t.jsx("span",{className:"text-when-wide",children:"Export PDF"}),t.jsx("span",{className:"text-when-narrow",children:"PDF"})]})})]})]}),t.jsxs("div",{className:"BuilderPage",style:{marginTop:8},children:[t.jsx("div",{className:"BuilderLeft",children:t.jsx("div",{className:"card",style:{display:"flex",flexDirection:"column",flex:"1 1 auto",minHeight:0},children:t.jsxs("div",{className:"BuilderScroll pane--addSongs",style:{minHeight:0,flex:"1 1 auto",overflow:"auto",marginTop:8},children:[t.jsxs("div",{className:"BuilderHeader",style:{display:"flex",alignItems:"center",gap:8},children:[t.jsx("strong",{style:{whiteSpace:"nowrap"},children:"Add songs"}),t.jsx(te,{value:x,onChange:e=>R(e.target.value),placeholder:"Search...",style:{flex:1,minWidth:0}}),t.jsxs(g,{onClick:_,disabled:!I,title:"Add all filtered",iconLeft:t.jsx(B,{}),variant:"primary",style:{marginLeft:"auto"},children:[t.jsxs("span",{className:"text-when-wide",children:["Add all (",I,")"]}),t.jsx("span",{className:"text-when-narrow",children:"All"})]})]}),t.jsx("div",{className:"SongList",role:"region","aria-label":"Song list",style:{display:"flex",flexDirection:"column",minHeight:0,flex:"1 1 auto",marginTop:6},children:t.jsx("div",{className:"gc-list",style:{display:"grid",gap:".5rem",gridTemplateColumns:"repeat(auto-fill, minmax(320px, 1fr))"},children:h.map(e=>{const n=y.has(e.id),i=[(Array.isArray(e.authors)?e.authors.join(", "):e.authors||"")||"—",e.country].filter(Boolean).join(" • ");return t.jsx(se,{title:e.title,subtitle:i,rightSlot:n?t.jsx(g,{"aria-label":"Remove",title:"Remove",onClick:a=>{a.stopPropagation(),v(e.id,!1)},iconLeft:t.jsx(ne,{}),iconOnly:!0,style:{color:"#b91c1c"}}):t.jsx(g,{"aria-label":"Add",title:"Add",variant:"primary",onClick:a=>{a.stopPropagation(),v(e.id,!0)},iconLeft:t.jsx(B,{}),iconOnly:!0}),onClick:()=>v(e.id,!n)},e.id)})})})]})})}),t.jsx("div",{className:"BuilderRight",style:{minHeight:0,display:"flex",flexDirection:"column"},children:t.jsxs("div",{className:"card",style:{display:"flex",flexDirection:"column",flex:"1 1 auto",minHeight:0},children:[t.jsxs("strong",{children:["Current selection (",f.length,")"]}),t.jsx("div",{className:"PreviewList pane--currentSet",role:"region","aria-label":"Selected songs",style:{minHeight:0,flex:"1 1 auto",overflow:"auto",marginTop:6},children:t.jsx("ol",{className:"List",style:{listStyle:"decimal inside",margin:0,padding:0},children:f.map(e=>t.jsxs("li",{children:[e.title,Array.isArray(e.authors)&&e.authors.length?t.jsxs("span",{className:"Small",children:[" — ",e.authors.join(", ")]}):null]},e.id))})})]})})]})]})}export{he as default};
