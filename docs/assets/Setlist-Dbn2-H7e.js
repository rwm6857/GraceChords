const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-CN5WZqp1.js","./index-6e1UIAnr.js","./index-CymyriFs.css","./jszip.min-BgVwGCeo.js"])))=>i.map(i=>d[i]);
import{r as d,i as ve,F as we,j as e,B as Ce,T as be,I as F,a as p,P as W,S as Ie,C as Pe,b as Ne,c as z,K as ke,A as Le,d as De,R as Te,D as H,L as $e,e as Ke,h as Ae,t as J,_ as q,f as Oe,p as Ee,s as _e,n as Ue,g as Be}from"./index-6e1UIAnr.js";import{S as X}from"./Select-D5EI4Xu4.js";const G="gracechords.sets.v1";function k(){try{const o=localStorage.getItem(G);return o?JSON.parse(o):{sets:{}}}catch{return{sets:{}}}}function Q(o){localStorage.setItem(G,JSON.stringify(o))}function Re(){return typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():"id-"+Math.random().toString(36).slice(2)+Date.now().toString(36)}function P(){const{sets:o}=k();return Object.values(o).sort((l,f)=>(f.updatedAt||0)-(l.updatedAt||0))}function Z(o){const{sets:l}=k();return l[o]||null}function N(o){const l=Date.now(),f={id:o.id||Re(),name:o.name?.trim()||"Untitled Set",items:Array.isArray(o.items)?o.items:[],createdAt:o.createdAt||l,updatedAt:l},w=k();return w.sets[f.id]=f,Q(w),f}function Me(o){const l=k();return l.sets[o]?(delete l.sets[o],Q(l),!0):!1}function Fe(o){const l=Z(o);return l?N({name:`Copy of ${l.name}`,items:l.items.map(f=>({...f}))}):null}let V;const Y=()=>V||(V=q(()=>import("./index-CN5WZqp1.js").then(o=>o.i),__vite__mapDeps([0,1,2]),import.meta.url));function He(){const[o,l]=d.useState("Untitled Set"),[f,w]=d.useState(""),[m,ee]=d.useState([]),[S,te]=d.useState(()=>{try{return localStorage.getItem("pref:icpOnly")==="1"}catch{return!1}});d.useEffect(()=>{try{localStorage.setItem("pref:icpOnly",S?"1":"0")}catch{}},[S]);const[a,h]=d.useState([]),[$,ne]=d.useState({}),[L,C]=d.useState(""),K=Object.keys($).length,[D,A]=d.useState(!1),[x,y]=d.useState(null),[se,O]=d.useState(()=>P()),[ie,b]=d.useState("");d.useEffect(()=>{ee(ve?.items||[])},[]),d.useEffect(()=>{let t=!1;async function n(){const s={};for(const i of a){const r=m.find(v=>v.id===i.id);if(!r)continue;const c=r.filename.replace(/\.chordpro$/i,""),u=`./pptx/${c}.pptx`;await Ae(u,c)&&(s[c]=!0)}t||ne(s)}return n(),()=>{t=!0}},[a,m]),d.useEffect(()=>{try{const t=localStorage.getItem("setlist");if(!t||P().length>0)return;const n=JSON.parse(t);if(n?.name||(n?.list?.length||0)>0){const s=N({name:n.name||"Imported Set",items:n.list||[]});O(P()),y(s.id),l(s.name),h(s.items||[]),b(s.id)}}catch{}},[]);const T=d.useMemo(()=>new we(m,{keys:["title","tags"],threshold:.4}),[m]);function ae(t){return!S||(Array.isArray(t.tags)?t.tags.includes("ICP"):t.tags==="ICP")}const oe=d.useMemo(()=>(f?T.search(f).map(n=>n.item):m.slice().sort((n,s)=>n.title.localeCompare(s.title))).filter(ae),[f,T,m,S]);function re(t){a.find(n=>n.id===t.id)||h([...a,{id:t.id,toKey:t.originalKey||"C"}])}function le(t){h(a.filter(n=>n.id!==t))}function E(t,n){const s=a.findIndex(u=>u.id===t);if(s<0)return;const i=s+(n==="up"?-1:1);if(i<0||i>=a.length)return;const r=a.slice(),[c]=r.splice(s,1);r.splice(i,0,c),h(r)}function ce(t,n){const s=a.findIndex(c=>c.id===t);if(s<0||n<0||n>=a.length||s===n)return;const i=a.slice(),[r]=i.splice(s,1);i.splice(n,0,r),h(i)}function de(t,n){h(a.map(s=>s.id===t?{...s,toKey:n}:s))}function _(t){h(n=>n.map(s=>{const i=m.find(c=>c.id===s.id),r=s.toKey||i?.originalKey||"C";return{...s,toKey:J(r,t)}}))}function pe(){h(t=>t.map(n=>{const s=m.find(i=>i.id===n.id);return{...n,toKey:s?.originalKey||"C"}}))}function I(t){O(P()),b(t||"")}function U(){y(null),l("Untitled Set"),h([]),b("")}function ue(){const t=o?.trim()||"Untitled Set",n=N({id:x,name:t,items:a});l(n.name),y(n.id),I(n.id)}function fe(t){const n=t.target.value;if(b(n),!n)return;const s=Z(n);s&&(y(s.id),l(s.name||"Untitled Set"),h(s.items||[]))}function me(){if(!x){const n=`Copy of ${o||"Untitled Set"}`,s=N({id:null,name:n,items:a});l(s.name),y(s.id),I(s.id);return}const t=Fe(x);t&&(y(t.id),l(t.name),h(t.items||[]),I(t.id))}function he(){x&&window.confirm(`Delete set "${o}"? This cannot be undone.`)&&(Me(x),U(),I(""))}async function ge(){A(!0);try{const{downloadMultiSongPdf:t}=await Y(),n=[];for(const s of a){const i=m.find(r=>r.id===s.id);if(i)try{const r=`./songs/${i.filename}`,c=await Oe(r),u=Ee(c),g=u.meta?.key||u.meta?.originalkey||i.originalKey||"C",v=_e(g,s.toKey||g),ye=(u.sections||[]).map(R=>({section:R.label,lines:(R.lines||[]).map(j=>({plain:j.comment?j.comment:j.lyrics||"",chordPositions:(j.chords||[]).map(M=>({sym:J(M.sym,v),index:M.index})),comment:j.comment?j.comment:void 0}))})),je=i.filename.replace(/\.chordpro$/i,""),Se=Ue({title:u.meta?.title||i.title||je,key:s.toKey||g,capo:u.meta?.capo,lyricsBlocks:ye});n.push(Se)}catch(r){console.error(r),Be(`Failed to process ${i.filename}`)}}n.length&&await t(n)}finally{A(!1)}}function B(){Y()}async function xe(){C(`Bundling 0/${a.length}…`);const t=(await q(async()=>{const{default:i}=await import("./jszip.min-BgVwGCeo.js").then(r=>r.j);return{default:i}},__vite__mapDeps([3,1,2]),import.meta.url)).default,n=new t;let s=0;for(let i=0;i<a.length;i++){const r=a[i],c=m.find(g=>g.id===r.id);if(!c){C(`Bundling ${i+1}/${a.length}…`);continue}C(`Bundling ${i+1}/${a.length}…`);const u=c.filename.replace(/\.chordpro$/i,"");if($[u])try{const g=await fetch(`./pptx/${u}.pptx`);if(!g.ok)continue;const v=await g.blob();s++,n.file(`${String(s).padStart(2,"0")}-${u}.pptx`,v)}catch{}}if(s>0){const i=await n.generateAsync({type:"blob"}),r=new Date().toISOString().slice(0,10).replace(/-/g,""),c=document.createElement("a");c.href=URL.createObjectURL(i),c.download=`setlist-pptx-${r}.zip`,c.click(),URL.revokeObjectURL(c.href)}C("")}return e.jsxs("div",{className:"container",children:[e.jsx(Ce,{busy:D}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx("div",{}),e.jsx("h1",{style:{margin:0},children:"Setlist Builder"}),e.jsx("div",{})]}),e.jsxs(be,{className:"card",style:{marginTop:12},children:[e.jsx(F,{label:"Set","aria-label":"Set name",value:o,onChange:t=>l(t.target.value),style:{minWidth:220},placeholder:"Sunday AM"}),e.jsxs(X,{"aria-label":"Saved sets",value:ie,onChange:fe,children:[e.jsx("option",{value:"",children:"— Load saved set —"}),se.map(t=>e.jsxs("option",{value:t.id,children:[t.name," · ",new Date(t.updatedAt).toLocaleString()]},t.id))]}),e.jsxs(p,{onClick:U,title:"New set",iconLeft:e.jsx(W,{}),children:[" ",e.jsx("span",{className:"text-when-wide",children:"New"})]}),e.jsxs(p,{variant:"primary",onClick:ue,title:"Save set",iconLeft:e.jsx(Ie,{}),children:[" ",e.jsx("span",{className:"text-when-wide",children:"Save"})]}),e.jsxs(p,{onClick:me,disabled:!a.length,title:"Duplicate set",iconLeft:e.jsx(Pe,{}),children:[" ",e.jsx("span",{className:"text-when-wide",children:"Duplicate"})]}),e.jsxs(p,{onClick:he,disabled:!x,title:"Delete set",iconLeft:e.jsx(Ne,{}),children:[" ",e.jsx("span",{className:"text-when-wide",children:"Delete"})]}),e.jsxs("div",{style:{marginLeft:"auto",display:"flex",alignItems:"center",gap:6},children:[e.jsx("span",{className:"meta",children:"Transpose:"}),e.jsx(p,{onClick:()=>_(-1),title:"Transpose set down 1 semitone",children:"–1"}),e.jsx(p,{onClick:pe,title:"Reset all to originals",children:"Reset"}),e.jsx(p,{onClick:()=>_(1),title:"Transpose set up 1 semitone",children:"+1"})]})]}),e.jsxs("div",{className:"BuilderPage",style:{marginTop:12},children:[e.jsx("div",{className:"BuilderLeft",children:e.jsx("div",{className:"card",children:e.jsxs("div",{style:{marginTop:8},children:[e.jsx("strong",{children:"Add songs"}),e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",marginTop:6},children:[e.jsx(F,{value:f,onChange:t=>w(t.target.value),placeholder:"Search...",style:{flex:1}}),e.jsxs("label",{className:"row",style:{gap:6,alignItems:"center"},children:[e.jsx("input",{type:"checkbox",checked:S,onChange:t=>te(t.target.checked)}),e.jsx("span",{className:"meta",title:"Limit results to songs tagged ICP",children:"ICP only"})]})]}),e.jsx("div",{style:{minHeight:0,maxHeight:300,overflow:"auto",marginTop:6},children:T?oe.map(t=>e.jsx(z,{title:t.title,subtitle:`${t.originalKey||""}${t.tags?.length?` • ${t.tags.join(", ")}`:""}`,rightSlot:e.jsx(p,{onClick:()=>re(t),title:"Add to set",iconLeft:e.jsx(W,{}),children:e.jsx("span",{className:"text-when-wide",children:"Add"})})},t.id)):e.jsx("div",{children:"Loading search…"})})]})})}),e.jsx("div",{className:"BuilderRight",children:e.jsxs("div",{className:"card",children:[e.jsxs("strong",{children:["Current setlist (",a.length,")"]}),e.jsx("div",{style:{minHeight:0,maxHeight:360,overflow:"auto",marginTop:6},children:a.map((t,n)=>{const s=m.find(i=>i.id===t.id);return s?e.jsx(z,{draggable:!0,onDragStart:i=>{i.dataTransfer.setData("text/plain",String(t.id)),i.dataTransfer.effectAllowed="move"},onDragOver:i=>{i.preventDefault(),i.dataTransfer.dropEffect="move"},onDrop:i=>{i.preventDefault();const r=i.dataTransfer.getData("text/plain");ce(r,n)},title:s.title,subtitle:`Original: ${s.originalKey||"—"}`,rightSlot:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx(X,{value:t.toKey,onChange:i=>de(t.id,i.target.value),children:ke.map(i=>e.jsx("option",{value:i,children:i},i))}),e.jsx(p,{onClick:()=>E(t.id,"up"),title:"Move up",iconLeft:e.jsx(Le,{})}),e.jsx(p,{onClick:()=>E(t.id,"down"),title:"Move down",iconLeft:e.jsx(De,{})}),e.jsx(p,{onClick:()=>le(t.id),title:"Remove",iconLeft:e.jsx(Te,{})})]})},t.id):null})}),e.jsxs("div",{style:{display:"flex",gap:8,marginTop:8,flexWrap:"wrap"},children:[e.jsx(p,{variant:"primary",onClick:ge,onMouseEnter:B,onFocus:B,disabled:D,title:"Export set as a single PDF",iconLeft:e.jsx(H,{}),children:D?"Exporting…":e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-when-wide",children:"Export PDF"}),e.jsx("span",{className:"text-when-narrow",children:"PDF"})]})}),e.jsxs($e,{className:"btn iconbtn",to:a.length?`/worship/${a.map(t=>t.id).join(",")}?toKeys=${a.map(t=>encodeURIComponent(t.toKey)).join(",")}`:"#",title:a.length?"Open Worship Mode with this set":"Add songs to open Worship Mode","aria-disabled":!a.length,onClick:t=>{a.length||t.preventDefault()},children:[e.jsx("span",{className:"text-when-wide",children:"Open in Worship Mode"}),e.jsx("span",{className:"text-when-narrow",children:"Worship"})]}),e.jsx(p,{onClick:xe,disabled:K===0||!!L,title:K===0?"No PPTX files found for this set.":"Bundle PPTX files for selected songs",iconLeft:e.jsx(H,{}),children:L||e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-when-wide",children:"Bundle PPTX"}),e.jsx("span",{className:"text-when-narrow",children:"PPTX"})]})}),e.jsx(p,{onClick:()=>h([]),title:"Clear setlist",iconLeft:e.jsx(Ke,{}),children:e.jsx("span",{className:"text-when-wide",children:"Clear"})})]}),e.jsxs("div",{className:"print-only",style:{marginTop:16},children:[e.jsx("h2",{style:{fontSize:"20pt",margin:"0 0 8pt 0"},children:o}),e.jsx("ol",{style:{fontSize:"12pt",lineHeight:1.4,paddingLeft:"1.2em"},children:a.map(t=>{const n=m.find(s=>s.id===t.id);return n?e.jsxs("li",{children:[n.title," — ",t.toKey||n.originalKey||"—"]},t.id):null})})]})]})})]})]})}export{He as default};
