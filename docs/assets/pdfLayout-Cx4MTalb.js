import{c as O}from"./index-Dlh__b2r.js";function q(t,c,o="normal"){return s=>n=>(t.setFont(c,o),t.setFontSize(s),t.getTextWidth(n||""))}function A(t,c=3){if(!Array.isArray(t)||t.length<2)return t;t.sort((n,e)=>n.x-e.x);let o=!0,s=0;for(;o&&s<10;){o=!1,s++;for(let n=1;n<t.length;n++){const e=t[n-1],r=t[n];if(e.x+e.w>r.x){const i=e.x+e.w-r.x,y=Math.min(c,Math.ceil(i/2));e.x-=y,r.x+=y,o=!0}}}return t.sort((n,e)=>n.x-e.x),t}function T(t){if(!t)return{meta:{title:"Untitled",key:"C"},sections:[]};if(t.meta&&Array.isArray(t.sections)){const c={title:t.meta.title||t.title||"Untitled",key:t.meta.key||t.key||"C",meta:t.meta.meta},o=(t.sections||[]).map(s=>({kind:s.kind||"verse",label:s.label,lines:(s.lines||[]).map(n=>({lyrics:n.lyrics||n.plain||n.text||"",chords:(n.chords||n.chordPositions||[]).map(e=>({index:e.index||0,sym:e.sym}))}))}));return{meta:c,sections:o}}if(t.lyricsBlocks){const c=(t.lyricsBlocks||[]).map(o=>({kind:"verse",label:o.section,lines:(o.lines||[]).map(s=>({lyrics:s.plain||s.text||"",chords:(s.chordPositions||[]).map(n=>({index:n.index||0,sym:n.sym}))}))}));return{meta:{title:t.title||"Untitled",key:t.key||t.originalKey||"C"},sections:c}}if(Array.isArray(t==null?void 0:t.blocks)){const c=[];let o={kind:"verse",label:"",lines:[]};for(const s of t.blocks)s.type==="section"?(o.lines.length&&c.push(o),o={kind:"verse",label:s.header,lines:[]}):s.type==="line"&&o.lines.push({lyrics:s.lyrics||s.text||"",chords:(s.chords||[]).map(n=>({index:n.index||0,sym:n.sym}))});return o.lines.length&&c.push(o),{meta:{title:t.title||"Untitled",key:t.key||t.originalKey||"C"},sections:c}}if(typeof t=="string")return O(t);if(t!=null&&t.body||t!=null&&t.lines){const c=(t.body||(Array.isArray(t.lines)?t.lines.join(`
`):""))+"";return O(c)}return{meta:{title:t.title||"Untitled",key:t.key||t.originalKey||"C"},sections:[]}}const x={lyricSizePt:16,chordSizePt:16,margin:36,gutter:24,headerOffsetY:40,columns:1,pageWidth:612,pageHeight:792,lyricFamily:"Helvetica",chordFamily:"Courier",title:"Untitled",key:"C"},K=6;function F(t,c,o,s,n,e){const r=s.margin,i=s.pageWidth-r*2,a=(c===2?(i-s.gutter)/2:i)-K,l=n(o),d=e(o);for(const P of t.sections||[])for(const f of P.lines||[]){const p=f.lyrics||"";if(l(p)>a)return!0;for(const W of f.chords||[]){const b=l(p.slice(0,W.index||0)),h=d(W.sym||"");if(b+h>a)return!0}}return!1}function _(t,c={},o=()=>()=>0,s=()=>()=>0){const n=T(t),e={...x,...c,gutter:x.gutter},r=[16,15,14,13,12];for(const l of r){const d=k(n,{...e,columns:1,lyricSizePt:l,chordSizePt:l},o(l),s(l)),P=!F(n,1,l,e,o,s),f={...e,columns:1,lyricSizePt:l,chordSizePt:l,layout:d};if(U(f)&&P)return{plan:f}}for(const l of r){const d=k(n,{...e,columns:2,lyricSizePt:l,chordSizePt:l},o(l),s(l)),P=!F(n,2,l,e,o,s),f={...e,columns:2,lyricSizePt:l,chordSizePt:l,layout:d};if(!(!U(f)||!P)&&!G(f))return{plan:f}}const i=12;let y=k(n,{...e,columns:1,lyricSizePt:i,chordSizePt:i},o(i),s(i)),a={...e,columns:1,lyricSizePt:i,chordSizePt:i,layout:y};return D(a)||(y=k(n,{...e,columns:2,lyricSizePt:i,chordSizePt:i},o(i),s(i)),a={...e,columns:2,lyricSizePt:i,chordSizePt:i,layout:y}),{plan:a}}function U(t){var c,o;return((o=(c=t==null?void 0:t.layout)==null?void 0:c.pages)==null?void 0:o.length)===1}function D(t){var c,o;return(((o=(c=t==null?void 0:t.layout)==null?void 0:c.pages)==null?void 0:o.length)||99)<=2}function G(t){var r,i,y;const c=(i=(r=t==null?void 0:t.layout)==null?void 0:r.pages)==null?void 0:i[0];if(!c||((y=c.columns)==null?void 0:y.length)!==2)return!1;const o=c.columns[1];let s=0,n=0,e=0;for(const a of o.blocks||[])a.type==="section"?(e>0&&n++,e=0):a.type==="line"&&(e++,s++);return e>0&&n++,s<=5||n===1&&e<3}function k(t,c={},o=n=>0,s=n=>0){const n=T(t),e={...x,...c,gutter:x.gutter},r=4,i=e.lyricSizePt,y=Math.round(e.lyricSizePt*.85),a=e.margin,l=e.pageHeight,d=e.pageWidth-a*2,P=e.columns===2?(d-e.gutter)/2:d,f=a+e.headerOffsetY,p=l-a,W=p-f,b=[];let h={columns:[]};b.push(h);function w(){const u={x:a,yStart:f,blocks:[]};if(h.columns.push(u),e.columns===2){const m={x:a+P+e.gutter,yStart:f,blocks:[]};h.columns.push(m)}}function Y(){h={columns:[]},b.push(h)}h.columns.length===0&&w();let C=0,S=f;const L=()=>h.columns[C],H=()=>{e.columns===2&&C===0?(C=1,S=f):(Y(),w(),C=0,S=f)},B=u=>{var z;let m=y+i+4;for(const g of u.lines||[])(z=g==null?void 0:g.chords)!=null&&z.length&&(m+=e.chordSizePt+r/2),m+=e.lyricSizePt+r;return m+4},E=u=>{var m;return((m=u==null?void 0:u.chords)!=null&&m.length?e.chordSizePt+r/2:0)+e.lyricSizePt+r},I=(u,m)=>{u.blocks.push({type:"section",header:m})},j=(u,m,z)=>{const g=z.map(v=>({x:o(m.slice(0,v.index||0)),w:s(v.sym||""),sym:v.sym}));A(g),u.blocks.push({type:"line",lyrics:m,chords:g})};for(const u of n.sections||[]){const m=B(u);m>W?(S!==f||e.columns===2&&C===1)&&H():S+m>p&&H();const z=L();S+=y,I(z,u.label||u.kind),S+=i+4;for(const g of u.lines||[])j(z,g.lyrics||"",g.chords||[]),S+=E(g);S+=4}return{pages:b}}function N(t,c){const o={...x,...c};o.pageWidth=612,o.pageHeight=792;const s=e=>e?e.length*(o.lyricSizePt*.6):0;return k(T(t),o,s,s).pages.map((e,r)=>({p:r,cols:e.columns.map((i,y)=>({c:y,blocks:i.blocks.map(a=>({t:a.type,h:a.type==="section"&&a.header||null,line:a.type==="line"?{text:a.lyrics,chords:(a.chords||[]).map(l=>({x:Number(l.x.toFixed(2)),s:l.sym}))}:null}))}))}))}function R(t,c){const o=T(t),s={...x,...c};s.pageWidth=612,s.pageHeight=792;const n=i=>y=>y?y.length*(i*.6):0,e=i=>y=>y?y.length*(i*.6):0,{plan:r}=_(o,s,n,e);return{columns:r.columns,size:r.lyricSizePt,pages:r.layout.pages.length}}const J=Object.freeze(Object.defineProperty({__proto__:null,DEFAULT_LAYOUT_OPT:x,chooseBestLayout:_,getLayoutMetrics:N,normalizeSongInput:T,planForTest:R,planSongLayout:k},Symbol.toStringTag,{value:"Module"}));export{x as D,J as a,_ as c,q as m,T as n,k as p};
