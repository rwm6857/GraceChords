const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-ChTOfGxm.js","./index-QoT307yy.js","./index-BPe2cOfG.css","./jszip.min-CWaVoyjO.js"])))=>i.map(i=>d[i]);
import{j as e,u as De,a as Ee,b as Oe,r as d,i as Ae,d as Be,F as Ue,B as p,c as Re,T as ee,D as E,L as te,e as se,M as ne,S as Me,C as _e,P as ie,f as ze,I as Fe,g as ae,K as We,A as Xe,h as qe,k as He,l as Je,_ as ce,m as Ve,p as Ye,s as Ge,t as Qe,n as Ze,o as O}from"./index-QoT307yy.js";import{P as et}from"./PageContainer-Bo_Wkn_B.js";const de="gracechords.sets.v1";function B(){try{const o=localStorage.getItem(de);return o?JSON.parse(o):{sets:{}}}catch{return{sets:{}}}}function ue(o){localStorage.setItem(de,JSON.stringify(o))}function tt(){return typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():"id-"+Math.random().toString(36).slice(2)+Date.now().toString(36)}function b(){const{sets:o}=B();return Object.values(o).sort((c,m)=>(m.updatedAt||0)-(c.updatedAt||0))}function st(o){const{sets:c}=B();return c[o]||null}function oe(o){const c=Date.now(),m={id:o.id||tt(),name:o.name?.trim()||"Untitled Set",items:Array.isArray(o.items)?o.items:[],createdAt:o.createdAt||c,updatedAt:c},x=B();return x.sets[m.id]=m,ue(x),m}function nt(o){const c=B();return c.sets[o]?(delete c.sets[o],ue(c),!0):!1}function it({label:o,id:c,children:m,className:x="",...y}){return e.jsxs("label",{className:"gc-field",htmlFor:c,children:[o?e.jsx("span",{className:"gc-label",children:o}):null,e.jsx("span",{className:"gc-select",children:e.jsx("select",{id:c,className:x,...y,children:m})})]})}let re;const le=()=>re||(re=ce(()=>import("./index-ChTOfGxm.js").then(o=>o.i),__vite__mapDeps([0,1,2]),import.meta.url));function at(){try{if(typeof crypto<"u"&&crypto.randomUUID)return crypto.randomUUID()}catch{}return`sel-${Math.random().toString(36).slice(2)}${Date.now().toString(36)}`}function pe(o){if(!o)return null;const{id:c,toKey:m=""}=o;return c==null?null:{uid:at(),id:c,toKey:m}}function A(o=[]){return o.map(c=>pe(c)).filter(Boolean)}function ct(){const{code:o,songIds:c}=De(),m=Ee(),x=Oe(),[y,I]=d.useState("New Setlist"),[C,me]=d.useState(""),[h,fe]=d.useState([]),[w,he]=d.useState(()=>{try{return localStorage.getItem("pref:icpOnly")==="1"}catch{return!1}});d.useEffect(()=>{try{localStorage.setItem("pref:icpOnly",w?"1":"0")}catch{}},[w]);const[r,g]=d.useState([]),[R,ge]=d.useState({}),[P,L]=d.useState("");Object.keys(R).length;const[k,M]=d.useState(!1),[xe,ye]=d.useState(()=>{try{return window.innerWidth<=640}catch{return!1}}),[ot,je]=d.useState(()=>{try{return window.innerWidth<=820}catch{return!1}}),[N,$]=d.useState(null),[S,_]=d.useState(()=>b()),[z,T]=d.useState(""),[we,K]=d.useState(!1),[F,W]=d.useState("");d.useEffect(()=>{const t=Ae?.items||[],n=new Set,i=[];for(const s of t)n.has(s.id)||(n.add(s.id),i.push(s));fe(i)},[]),d.useEffect(()=>{let t=!1;async function n(){const i={};for(const s of r){const a=h.find(v=>v.id===s.id);if(!a)continue;const l=a.filename.replace(/\.chordpro$/i,""),u=`./pptx/${l}.pptx`;await Je(u,l)&&(i[l]=!0)}t||ge(i)}return n(),()=>{t=!0}},[r,h]),d.useEffect(()=>{if(!o)return;const{entries:t,error:n}=Be(o);if(n){alert(n),x("/setlist",{replace:!0});return}const i=t.map(l=>({id:l.id,toKey:l.toKey}));g(A(i));const s=i.map(l=>l.id).join(","),a=i.map(l=>encodeURIComponent(l.toKey||"")).join(",");x(`/setlist/${s}?toKeys=${a}`,{replace:!0})},[o]),d.useEffect(()=>{if(!c)return;const t=(c||"").split(",").map(a=>a.trim()).filter(Boolean);if(!t.length)return;const i=(new URLSearchParams(m.search||"").get("toKeys")||"").split(",").map(a=>decodeURIComponent(a)).filter(Boolean),s=t.map((a,l)=>({id:a,toKey:i[l]||""}));g(A(s))},[c,m.search]),d.useEffect(()=>{try{if(!Array.isArray(r))return;if(r.length===0){(o||c)&&x("/setlist",{replace:!0});return}const t=r.map(a=>a.id).join(","),n=r.map(a=>encodeURIComponent(a.toKey||"")).join(","),i=c||"",s=new URLSearchParams(m.search||"").get("toKeys")||"";(t!==i||n!==s)&&x(`/setlist/${t}?toKeys=${n}`,{replace:!0})}catch{}},[r.map(t=>`${t.id}:${t.toKey}`).join("|"),c,m.search,o]),d.useEffect(()=>{try{const t=localStorage.getItem("setlist");if(!t||b().length>0)return;const n=JSON.parse(t);if(n?.name||(n?.list?.length||0)>0){const i=oe({name:n.name||"Imported Set",items:n.list||[]});_(b()),$(i.id),I(i.name),g(A(i.items||[])),T(i.id)}}catch{}},[]),d.useEffect(()=>{function t(){try{const n=window.innerWidth;ye(n<=640),je(n<=820)}catch{}}return window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[]);const U=d.useMemo(()=>new Ue(h,{keys:["title","tags"],threshold:.4}),[h]);function Se(t){return!w||(Array.isArray(t.tags)?t.tags.includes("ICP"):t.tags==="ICP")}const ve=d.useMemo(()=>(C?U.search(C).map(n=>n.item):h.slice().sort((n,i)=>n.title.localeCompare(i.title))).filter(Se),[C,U,h,w]);function X(t){if(!t)return;const n=pe({id:t.id,toKey:t.originalKey||t.key||"C"});g(i=>[...i,n])}function be(t){g(n=>n.filter(i=>i.uid!==t))}function q(t,n){g(i=>{const s=i.findIndex(f=>f.uid===t);if(s<0)return i;const a=s+(n==="up"?-1:1);if(a<0||a>=i.length)return i;const l=i.slice(),[u]=l.splice(s,1);return l.splice(a,0,u),l})}function Ie(t,n){g(i=>{if(n<0||n>=i.length)return i;const s=i.findIndex(u=>u.uid===t);if(s<0||s===n)return i;const a=i.slice(),[l]=a.splice(s,1);return a.splice(n,0,l),a})}function Ce(t,n){g(i=>i.map(s=>s.uid===t?{...s,toKey:n}:s))}function H(t){_(b()),T(t||"")}function J(){$(null),I("New Setlist"),g([]),T("")}function Pe(){const t=y?.trim()||"New Setlist",n=window.prompt("Save set as:",t);if(n===null)return;const i=String(n).trim()||"New Setlist";let s=N;if(!s){const u=(b()||[]).find(f=>(f.name||"")===i);u&&(s=u.id)}const a=r.map(({id:u,toKey:f})=>({id:u,toKey:f})),l=oe({id:s,name:i,items:a});I(l.name),$(l.id),H(l.id)}function Le(){const t=F||z||"";if(!t){K(!1);return}const n=st(t);n&&($(n.id),I(n.name||"New Setlist"),g(A(n.items||[])),T(n.id)),K(!1)}function ke(){const t=S[0]?.id||"";W(z||t),K(!0)}function Ne(){N&&window.confirm(`Delete set "${y}"? This cannot be undone.`)&&(nt(N),J(),H(""))}async function V(){M(!0);try{const{downloadMultiSongPdf:t}=await le(),n=[];for(const i of r){const s=h.find(a=>a.id===i.id);if(s)try{const a=`./songs/${s.filename}`,l=await Ve(a),u=Ye(l),f=u.meta?.key||u.meta?.originalkey||s.originalKey||"C",v=Ge(f,i.toKey||f),$e=(u.sections||[]).map(Q=>({section:Q.label,lines:(Q.lines||[]).map(j=>({plain:j.comment?j.comment:j.lyrics||"",chordPositions:(j.chords||[]).map(Z=>({sym:Qe(Z.sym,v),index:Z.index})),comment:j.comment?j.comment:void 0}))})),Te=s.filename.replace(/\.chordpro$/i,""),Ke=Ze({title:u.meta?.title||s.title||Te,key:i.toKey||f,capo:u.meta?.capo,lyricsBlocks:$e});n.push(Ke)}catch(a){console.error(a),O(`Failed to process ${s.filename}`)}}n.length&&await t(n)}finally{M(!1)}}function D(){le()}async function Y(){try{const t=r.map(s=>s.id).join(","),n=r.map(s=>encodeURIComponent(s.toKey||"")).join(","),i=`${m.origin}${m.pathname}#/setlist/${t}?toKeys=${n}`;await navigator.clipboard.writeText(i);try{O?.("Link copied!")}catch{}}catch{alert("Failed to copy link")}}async function G(){L(`Bundling 0/${r.length}…`);const t=(await ce(async()=>{const{default:s}=await import("./jszip.min-CWaVoyjO.js").then(a=>a.j);return{default:s}},__vite__mapDeps([3,1,2]),import.meta.url)).default,n=new t;let i=0;for(let s=0;s<r.length;s++){const a=r[s],l=h.find(f=>f.id===a.id);if(!l){L(`Bundling ${s+1}/${r.length}…`);continue}L(`Bundling ${s+1}/${r.length}…`);const u=l.filename.replace(/\.chordpro$/i,"");if(R[u])try{const f=await fetch(`./pptx/${u}.pptx`);if(!f.ok)continue;const v=await f.blob();i++,n.file(`${String(i).padStart(2,"0")}-${u}.pptx`,v)}catch{}}if(i>0){const s=await n.generateAsync({type:"blob"}),a=new Date().toISOString().slice(0,10).replace(/-/g,""),l=document.createElement("a");l.href=URL.createObjectURL(s),l.download=`setlist-pptx-${a}.zip`,l.click(),URL.revokeObjectURL(l.href)}else try{O&&O("No PPTX files found for selected songs")||alert("No PPTX files found for selected songs")}catch{}L("")}return e.jsxs(et,{children:[we?e.jsx("div",{style:{position:"fixed",inset:0,display:"flex",alignItems:"center",justifyContent:"center",background:"rgba(0,0,0,.45)",zIndex:90},role:"dialog","aria-modal":"true",children:e.jsxs("div",{style:{background:"var(--card)",color:"var(--text)",border:"1px solid var(--line)",borderRadius:10,padding:16,width:"min(560px, 92vw)"},children:[e.jsx("h3",{style:{marginTop:0,marginBottom:8},children:"Load Set"}),S.length?e.jsxs("label",{style:{display:"block",margin:"8px 0"},children:["Select a saved set",e.jsx("select",{value:F,onChange:t=>W(t.target.value),style:{width:"100%"},children:S.map(t=>e.jsxs("option",{value:t.id,children:[t.name," · ",new Date(t.updatedAt).toLocaleString()]},t.id))})]}):e.jsx("div",{className:"meta",children:"No saved sets yet."}),e.jsxs("div",{className:"row",style:{justifyContent:"flex-end",gap:8,marginTop:12},children:[e.jsx(p,{onClick:()=>K(!1),children:"Cancel"}),e.jsx(p,{variant:"primary",onClick:Le,disabled:!S.length,children:"Load"})]})]})}):null,e.jsx(Re,{busy:k}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginTop:12,marginBottom:4},children:[e.jsx("div",{}),e.jsx("h1",{style:{margin:0},children:"Setlist Builder"}),e.jsx("div",{})]}),xe?e.jsx(ee,{className:"card",style:{marginTop:8,position:"static"},children:e.jsxs("div",{className:"setlist-actions--mobile",style:{width:"100%"},children:[e.jsx(p,{variant:"primary",onClick:V,onMouseEnter:D,onFocus:D,disabled:k||r.length===0,title:"Export set as a single PDF",iconLeft:e.jsx(E,{}),children:"PDF"}),e.jsx(p,{onClick:G,disabled:r.length===0||!!P,title:r.length===0?"Add songs to export PPTX bundle":"Export PPTX bundle for selected songs",iconLeft:e.jsx(E,{}),children:"PPTX"}),e.jsx(p,{onClick:Y,title:"Copy shareable link",iconLeft:e.jsx(te,{}),disabled:r.length===0,children:"Share"}),e.jsx(p,{as:se,to:r.length?`/worship/${r.map(t=>t.id).join(",")}?toKeys=${r.map(t=>encodeURIComponent(t.toKey)).join(",")}`:"/worship",title:"Open Worship Mode",iconLeft:e.jsx(ne,{}),children:"Worship"})]})}):e.jsxs(ee,{className:"card",style:{marginTop:8,position:"static"},children:[e.jsx("div",{style:{width:"100%",marginBottom:6},children:e.jsx("strong",{title:"Current set name",children:y||"New Setlist"})}),e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",flexWrap:"wrap",width:"100%"},children:[e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"},children:[e.jsxs(p,{size:"sm",variant:"secondary",onClick:Pe,title:"Save set",iconLeft:e.jsx(Me,{}),children:[" ",e.jsx("span",{className:"text-when-wide",children:"Save"})]}),e.jsxs(p,{size:"sm",variant:"secondary",onClick:ke,title:"Load saved set",iconLeft:e.jsx(_e,{}),disabled:!S.length,children:[" ",e.jsx("span",{className:"text-when-wide",children:"Load"})]}),e.jsxs(p,{size:"sm",variant:"secondary",onClick:J,title:"New set",iconLeft:e.jsx(ie,{}),children:[" ",e.jsx("span",{className:"text-when-wide",children:"New"})]}),e.jsxs(p,{size:"sm",variant:"secondary",onClick:Ne,disabled:!N,title:"Delete set",iconLeft:e.jsx(ze,{}),children:[" ",e.jsx("span",{className:"text-when-wide",children:"Delete"})]})]}),e.jsxs("div",{style:{marginLeft:"auto",display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"},children:[e.jsx(p,{variant:"primary",size:"md",onClick:V,onMouseEnter:D,onFocus:D,disabled:k||r.length===0,title:"Export set as a single PDF",iconLeft:e.jsx(E,{}),children:k?"Exporting…":e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-when-wide",children:"Export PDF"}),e.jsx("span",{className:"text-when-narrow",children:"PDF"})]})}),e.jsx(p,{variant:"primary",size:"md",onClick:G,disabled:r.length===0||!!P,title:r.length===0?"Add songs to export PPTX bundle":"Export PPTX bundle for selected songs",iconLeft:e.jsx(E,{}),children:P||e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-when-wide",children:"Export PPTX"}),e.jsx("span",{className:"text-when-narrow",children:"PPTX"})]})}),e.jsx(p,{variant:"primary",size:"md",onClick:Y,title:"Copy shareable link",iconLeft:e.jsx(te,{}),disabled:r.length===0,children:"Share Set"}),e.jsxs(p,{variant:"primary",size:"md",as:se,to:r.length?`/worship/${r.map(t=>t.id).join(",")}?toKeys=${r.map(t=>encodeURIComponent(t.toKey)).join(",")}`:"/worship",title:"Open Worship Mode",iconLeft:e.jsx(ne,{}),children:[" ",e.jsx("span",{className:"text-when-wide",children:"Worship Mode"}),e.jsx("span",{className:"text-when-narrow",children:"Worship"})]})]})]})]}),e.jsxs("div",{className:"BuilderPage",style:{marginTop:8},children:[e.jsx("div",{className:"BuilderLeft",children:e.jsx("div",{className:"card setlist-pane",children:e.jsxs("div",{className:"BuilderScroll setlist-scroll pane--addSongs",children:[e.jsxs("div",{className:"BuilderHeader",style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx("strong",{style:{whiteSpace:"nowrap"},children:"Add songs"}),e.jsx(Fe,{value:C,onChange:t=>me(t.target.value),placeholder:"Search...",style:{flex:1,minWidth:0}}),e.jsxs("label",{className:"row",style:{gap:6,alignItems:"center"},children:[e.jsx("input",{type:"checkbox",checked:w,onChange:t=>he(t.target.checked)}),e.jsx("span",{className:"meta",title:"Limit results to songs tagged ICP",children:"ICP only"})]})]}),U?e.jsx("div",{style:{display:"grid",gap:".5rem",gridTemplateColumns:"repeat(auto-fill, minmax(320px, 1fr))",marginTop:6},children:ve.map(t=>e.jsx(ae,{title:t.title,subtitle:`${t.originalKey||""}${t.tags?.length?` • ${t.tags.join(", ")}`:""}`,rightSlot:e.jsx(p,{"aria-label":"Add",title:"Add to set",variant:"primary",iconLeft:e.jsx(ie,{}),iconOnly:!0,onClick:n=>{n.stopPropagation(),X(t)}}),onClick:()=>X(t)},t.id))}):e.jsx("div",{children:"Loading search…"})]})})}),e.jsx("div",{className:"BuilderRight",style:{minHeight:0,display:"flex",flexDirection:"column"},children:e.jsxs("div",{className:"card setlist-pane",children:[e.jsxs("div",{className:"BuilderScroll setlist-scroll pane--currentSet",children:[e.jsx("div",{className:"BuilderHeader",children:e.jsxs("strong",{children:["Current setlist (",r.length,")"]})}),e.jsx("div",{style:{marginTop:6},children:r.map((t,n)=>{const i=h.find(s=>s.id===t.id);return i?e.jsx(ae,{draggable:!0,onDragStart:s=>{s.dataTransfer.setData("text/plain",String(t.uid||t.id)),s.dataTransfer.effectAllowed="move"},onDragOver:s=>{s.preventDefault(),s.dataTransfer.dropEffect="move"},onDrop:s=>{s.preventDefault();const a=s.dataTransfer.getData("text/plain");Ie(a,n)},title:i.title,subtitle:`Original: ${i.originalKey||"—"}`,rightSlot:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx(it,{value:t.toKey,onChange:s=>Ce(t.uid,s.target.value),children:We.map(s=>e.jsx("option",{value:s,children:s},s))}),e.jsx(p,{onClick:()=>q(t.uid,"up"),title:"Move up",iconLeft:e.jsx(Xe,{})}),e.jsx(p,{onClick:()=>q(t.uid,"down"),title:"Move down",iconLeft:e.jsx(qe,{})}),e.jsx(p,{onClick:()=>be(t.uid),title:"Remove",iconLeft:e.jsx(He,{}),iconOnly:!0,style:{color:"#b91c1c"}})]})},t.uid||`${t.id}-${n}`):null})})]}),e.jsxs("div",{className:"print-only",style:{marginTop:16},children:[e.jsx("h2",{style:{fontSize:"20pt",margin:"0 0 8pt 0"},children:y}),e.jsx("ol",{style:{fontSize:"12pt",lineHeight:1.4,paddingLeft:"1.2em"},children:r.map((t,n)=>{const i=h.find(s=>s.id===t.id);return i?e.jsxs("li",{children:[i.title," — ",t.toKey||i.originalKey||"—"]},t.uid||`${t.id}-${n}`):null})})]})]})})]})]})}export{ct as default};
