import{p as q}from"./index-Dni1_X47.js";const D=[16,15,14,13,12],v={pageWidth:612,pageHeight:792,margin:36,headerOffsetY:0,gutter:18,lyricFamily:"Helvetica",chordFamily:"Courier",lyricSizePt:16,chordSizePt:16,columns:1,ptWindow:D},Y=()=>{var i;try{return typeof window<"u"&&((i=window.localStorage)==null?void 0:i.getItem("pdfPlanTrace"))==="1"}catch{return!1}};function J(i,o,c,y={}){const s=!!y.honorColumnBreaks,e=new Array(o).fill(0),a=Array.from({length:o},()=>[]);let r=0,F="";if(!Array.isArray(i))return{singlePage:!1,colHeights:e,occupancy:e.map(()=>0),balance:1,reasonRejected:"no_sections_provided",placed:a};const d=b=>{if(r+1>=o)return!1;const l=i[b];return l?l.height<=c-e[r+1]:!1};for(let b=0;b<i.length;b++){const l=i[b];if(s&&l.type==="column_break"){d(b+1)&&(r+=1);continue}const C=c-e[r];if(l.height<=C)a[r].push(l.id),e[r]+=l.height;else if(r+1<o){r+=1;const m=c-e[r];if(l.height<=m)a[r].push(l.id),e[r]+=l.height;else return F=`section ${l.id} needs ${Math.ceil(l.height)}pt > remaining ${Math.floor(m)}pt in col ${r+1}`,{singlePage:!1,colHeights:e,occupancy:e.map(u=>u/c),balance:o===2?1-Math.abs(e[0]-e[1])/c:1,reasonRejected:F,placed:a}}else return F=`section ${l.id} needs ${Math.ceil(l.height)}pt > remaining ${Math.floor(C)}pt in col ${r+1}`,{singlePage:!1,colHeights:e,occupancy:e.map(m=>m/c),balance:o===2?1-Math.abs(e[0]-e[1])/c:1,reasonRejected:F,placed:a}}return{singlePage:!0,colHeights:e,occupancy:e.map(b=>b/c),balance:o===2?1-Math.abs(e[0]-e[1])/c:1,reasonRejected:void 0,placed:a}}function L({pt:i,cols:o,balance:c,occupancy:y,hasColumnsHint:s}){let e=0;o===2&&Math.min(...y)<.18&&(e+=50),y.some(r=>r>.98)&&(e+=5),s&&o===2&&(e-=3);const a=i*100+c*10-e-(o===2?2:0);return{penalties:e,finalScore:a}}const G=typeof window<"u"&&(()=>{try{return localStorage.getItem("pdfPlanTrace")==="1"}catch{return!1}})();function H(i){if(!i)return{sections:[],meta:{}};if(typeof i=="string")try{const o=q(i),c=o.blocks.map(y=>({header:y.section,blocks:[{type:"section",header:y.section},...y.lines.map(s=>({type:"line",lyrics:s.text,chords:s.chords}))]}));return{...o.meta,sections:c}}catch{return{sections:[],meta:{}}}return typeof i=="object"?i:{sections:[],meta:{}}}function Z(i,o,c,{honorColumnBreaks:y}={}){const s=Array.from({length:o},()=>[]),e=Array(o).fill(0);let a=0;for(let d=0;d<i.length;d++){const b=i[d],l=b.h,C=b.hNoPad;if(l>c)return{singlePage:!1,colHeights:e,occupancy:e.map(u=>u/c),balance:o===2?0:1,placed:s,reasonRejected:`section ${d} height ${l}pt > column ${c}pt`};y&&b.breakBefore&&a<o-1&&e[a]>0&&l<=c&&a++;let m=c-e[a];if(l<=m)s[a].push(d),e[a]+=l;else if(C<=m){if(s[a].push(d),e[a]+=C,a++,a>=o&&d<i.length-1)return{singlePage:!1,colHeights:e,occupancy:e.map(u=>u/c),balance:o===2?1-Math.abs(e[0]-e[1])/c:1,placed:s,reasonRejected:`section ${d+1} needs ${l}pt > remaining ${m}pt in col ${o}`}}else{if(a++,a>=o)return{singlePage:!1,colHeights:e,occupancy:e.map(u=>u/c),balance:o===2?1-Math.abs(e[0]-e[1])/c:1,placed:s,reasonRejected:`section ${d} needs ${l}pt > remaining ${m}pt in col ${a}`};d--;continue}if(a>=o)break}const r=e.map(d=>d/c),F=o===2?1-Math.abs(e[0]-e[1])/c:1;return{singlePage:!0,colHeights:e,occupancy:r,balance:F,placed:s}}function V(i,o={},c=()=>()=>0,y=()=>()=>0){var R,I;const s=H(i),e={...v,...o,gutter:v.gutter},a=[16,15,14,13,12],r=((R=s.layoutHints)==null?void 0:R.requestedColumns)===2,F=e.pageHeight-(e.margin+e.headerOffsetY)-e.margin,d={},b=((I=s.layoutHints)==null?void 0:I.columnBreakAfter)||[],l=n=>{if(d[n])return d[n];const P=4,W=Math.round(n*.85),h=Math.max(10,n-2),z=(s.sections||[]).map((S,t)=>{var p,g;let f=W+n;for(const $ of S.lines||[])$.comment?f+=h+3:((p=$==null?void 0:$.chords)!=null&&p.length&&(f+=n+P/2),f+=n+P);return(g=S.lines)!=null&&g.length||(f+=n),f+=4,{h:f,hNoPad:f-4,breakBefore:b.includes(t)}});return d[n]=z,G&&console.log("sectionHeights pt",n,z.map(S=>S.h)),z},C=[];for(const n of a)for(const P of[1,2]){const W=l(n),h=Z(W,P,F,{honorColumnBreaks:!0}),z=!widthOverflows(s,P,n,e,c,y);let S=0;P===2&&Math.min(...h.occupancy)<.18&&(S+=50),h.occupancy.some(f=>f>.98)&&(S+=5),r&&P===2&&(S-=3);const t=n*100+h.balance*10-S-(P===2?2:0);C.push({pt:n,cols:P,singlePage:h.singlePage&&z,colHeights:h.colHeights,occupancy:h.occupancy,balance:h.balance,penalties:S,finalScore:t,reasonRejected:z?h.reasonRejected:"width overflow",placed:h.placed})}G&&(console.table(C.map(n=>({pt:n.pt,cols:n.cols,singlePage:n.singlePage,colHeights:n.colHeights.map(P=>Number(P.toFixed(1))),occupancy:n.occupancy.map(P=>Number(P.toFixed(2))),balance:Number(n.balance.toFixed(2)),penalties:n.penalties,finalScore:Number(n.finalScore.toFixed(2)),reasonRejected:n.reasonRejected||""}))),console.log("contentH",F,"gutter",e.gutter));const m=C.filter(n=>n.singlePage);if(m.length){const n=m.sort((k,w)=>w.finalScore-k.finalScore)[0],P=n.occupancy.map(k=>k.toFixed(2)).join(","),W=`Plan: ${n.cols} col • ${n.pt}pt • singlePage=yes • occ=[${P}] • bal=${n.balance.toFixed(2)}`,h=e.margin,z=e.pageWidth-h*2,S=n.cols===2?(z-e.gutter)/2:z,t=c(n.pt),f=y(n.pt),p=(k,w)=>{const M=[];for(const E of w){const N=s.sections[E];M.push({type:"section",header:N.label||N.kind});for(const O of N.lines||[])if(O.comment)M.push({type:"line",comment:O.comment});else{const T=(O.chords||[]).map(A=>({x:t((O.lyrics||"").slice(0,A.index||0)),w:f(A.sym||""),sym:A.sym}));resolveChordCollisions(T),M.push({type:"line",lyrics:O.lyrics||"",chords:T})}}return{x:k,blocks:M}},g=[p(h,n.placed[0]||[])];n.cols===2&&g.push(p(h+S+e.gutter,n.placed[1]||[]));const $={pages:[{columns:g}]};return{plan:{lyricFamily:e.lyricFamily,chordFamily:e.chordFamily,lyricSizePt:n.pt,chordSizePt:n.pt,columns:n.cols,margin:e.margin,headerOffsetY:e.headerOffsetY,gutter:e.gutter,layout:$,debugFooter:W}}}const u=12;let j=_(s,{...e,columns:1,lyricSizePt:u,chordSizePt:u},c(u),y(u)),x={...e,columns:1,lyricSizePt:u,chordSizePt:u,layout:j};return K(x)||(j=_(s,{...e,columns:2,lyricSizePt:u,chordSizePt:u},c(u),y(u)),x={...e,columns:2,lyricSizePt:u,chordSizePt:u,layout:j}),x.debugFooter=`Plan: ${x.columns} col • ${x.lyricSizePt}pt • singlePage=${x.layout.pages.length===1?"yes":"no"}`,{plan:x}}function K(i){var o,c;return(((c=(o=i==null?void 0:i.layout)==null?void 0:o.pages)==null?void 0:c.length)||99)<=2}function _(i,o={},c=s=>0,y=s=>0){var W,h,z,S;const s=H(i),e=Array.isArray(s.sections)?s.sections:[],a={...v,...o,gutter:v.gutter},r=a.margin,F=a.pageWidth-r*2;e.length||e.push({header:"Section",blocks:[]});const d=(t,f)=>{const p=makeLyric(t);try{return p(f||"")}catch{return 0}},b=(t,f)=>{const p=makeChord(t);try{return p(f||"")}catch{return 0}},l=t=>{const p=Math.round(t*.85);return e.map((g,$)=>{let B=p;for(const k of g.blocks)if(k.type!=="section"&&k.type==="line"){if(k.comment){const w=Math.max(10,t-2);d(w,k.comment),B+=w;continue}Array.isArray(k.chords)&&k.chords.length&&(b(t,k.chords.map(w=>(w==null?void 0:w.sym)||"").join(" ")),B+=t+4/2),d(t,k.lyrics||""),B+=t+4}return B<p+t&&(B=p+t),{id:$+1,type:"section",height:B,header:g.header}})},C=((W=s==null?void 0:s.meta)==null?void 0:W.columns)===2||((h=s==null?void 0:s.hints)==null?void 0:h.columns)===2,m=[];for(const t of(v==null?void 0:v.ptWindow)||[16,15,14,13,12]){const f=l(t);for(const p of[1,2]){const g=J(f,p,contentHeight,{honorColumnBreaks:!0});if(!g.singlePage)continue;const{penalties:$,finalScore:B}=L({pt:t,cols:p,balance:g.balance,occupancy:g.occupancy,hasColumnsHint:C});m.push({pt:t,cols:p,pack:g,penalties:$,finalScore:B})}}if(!m.length){const t={lyricFamily:oBase.lyricFamily||"Helvetica",chordFamily:oBase.chordFamily||"Courier",lyricSizePt:12,chordSizePt:12,columns:1,margin:r,headerOffsetY,gutter,layout:{pages:[]},debugFooter:Y()?"Plan: 1 col • 12pt • singlePage=no":void 0};return t.layout.pages=[{columns:[{x:r,blocks}]},{columns:[{x:r,blocks:[]}]}],{plan:t}}m.sort((t,f)=>f.finalScore-t.finalScore);const u=m[0],j=u.pt,x=u.cols,R=x===2?(F-gutter)/2:F,I=e.map(t=>t.blocks),n={columns:[]};for(let t=0;t<x;t++){const f=u.pack.placed[t]||[],p=[];for(const g of f){const $=I[g-1]||[];(!$.length||((z=$[0])==null?void 0:z.type)!=="section")&&p.push({type:"section",header:((S=e[g-1])==null?void 0:S.header)||`Section ${g}`}),p.push(...$)}n.columns.push({x:r+t*(R+(t?gutter:0)),blocks:p})}return{plan:{lyricFamily:oBase.lyricFamily||"Helvetica",chordFamily:oBase.chordFamily||"Courier",lyricSizePt:j,chordSizePt:j,columns:x,margin:r,headerOffsetY,gutter,layout:{pages:[n]},debugFooter:Y()?`Plan: ${x} col • ${j}pt • singlePage=yes • occ=${JSON.stringify(u.pack.occupancy.map(t=>t.toFixed(2)))} • bal=${u.pack.balance.toFixed(2)}`:void 0}}}export{v as DEFAULT_LAYOUT_OPT,V as chooseBestLayout,H as normalizeSongInput,Z as packIntoColumns,_ as planSongLayout};
