const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-CiO-00pG.js","./index-BGrBQ2j9.js","./index-BrHym0IO.css"])))=>i.map(i=>d[i]);
import{r as l,i as U,a as $,F as q,j as e,c as K,T as Q,B as h,v as V,D as G,I as J,P as k,g as X,k as Y,_ as Z,m as ee,p as te,o as se,q as w,w as ne}from"./index-BGrBQ2j9.js";import{P as ie}from"./PageContainer-TnYwADAC.js";let I;const B=()=>I||(I=Z(()=>import("./index-CiO-00pG.js").then(r=>r.i),__vite__mapDeps([0,1,2]),import.meta.url));function S(r,g){return ne(r,g)}function le(){const r=l.useMemo(()=>{const t=U?.items||[],s=new Set,n=[];for(const i of t)s.has(i.id)||(s.add(i.id),n.push(i));return n.slice().sort(S)},[]),g=$(),[f,E]=l.useState(""),b=l.useMemo(()=>new q(r,{keys:["title","tags","authors"],threshold:.4}),[r]),u=l.useMemo(()=>f?b.search(f).map(t=>t.item):r.slice().sort(S),[r,b,f]),[p,x]=l.useState(()=>new Set),m=l.useMemo(()=>u.filter(t=>p.has(t.id)).slice().sort(S),[u,p]),C=u.length,F=p.size;function j(t,s){x(n=>{const i=new Set(n);return s?i.add(t):i.delete(t),i})}function D(){u.length&&x(t=>{const s=new Set(t);for(const n of u)s.add(n.id);return s})}function M(){x(new Set)}const[R,y]=l.useState(null),[v,L]=l.useState(!1),[N,_]=l.useState(()=>{try{return window.innerWidth<=640}catch{return!1}});l.useEffect(()=>{function t(){try{_(window.innerWidth<=640)}catch{}}return window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[]),l.useEffect(()=>{const s=new URLSearchParams(g.search||"").get("tags");if(!s)return;const n=s.split(",").map(a=>a.trim().toLowerCase()).filter(Boolean);if(!n.length)return;const i=r.filter(a=>(Array.isArray(a.tags)?a.tags.map(d=>String(d).toLowerCase()):[]).some(d=>n.includes(d)));i.length&&x(a=>{const c=new Set(a);return i.forEach(d=>c.add(d.id)),c})},[g.search,r]);async function H(){if(m.length){L(!0);try{const{downloadSongbookPdf:t}=await B(),s=[];for(const n of m)try{const i=`./songs/${n.filename}`,a=await ee(i),c=te(a),d=(c.sections||[]).map(A=>({section:A.label,lines:(A.lines||[]).map(o=>o.instrumental?{instrumental:{chords:Array.isArray(o.instrumental?.chords)?o.instrumental.chords.slice():[],repeat:typeof o.instrumental?.repeat=="number"?o.instrumental.repeat:void 0}}:o.comment?{plain:o.comment,chordPositions:[],comment:o.comment}:{plain:o.lyrics||"",chordPositions:(o.chords||[]).map(T=>({sym:T.sym,index:T.index}))})})),z=n.filename.replace(/\.chordpro$/,""),W=se({title:c.meta.title||n.title||z,key:c.meta.key||c.meta.originalkey||n.originalKey||"C",capo:c.meta?.capo,lyricsBlocks:d});s.push(W)}catch(i){console.error(i),w(`Failed to process ${n.filename}`)}s.length&&await t(s,{includeTOC:!0,coverImageDataUrl:R})}finally{L(!1)}}}function P(){B()}function O(t){const s=t.target.files?.[0];if(!s){y(null);return}if(s.size>2*1024*1024){w("Image must be under 2 MB"),t.target.value="",y(null);return}if(!s.type.startsWith("image/")){w("File must be an image"),t.target.value="",y(null);return}const n=new FileReader;n.onload=()=>y(String(n.result||"")),n.readAsDataURL(s)}return r.length===0?e.jsxs("div",{className:"container",children:[e.jsx("h1",{children:"No songs found"}),e.jsx("p",{className:"Small",children:"The song index is empty or failed to load."})]}):e.jsxs(ie,{children:[e.jsx(K,{busy:v}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginTop:12,marginBottom:4},children:[e.jsx("div",{}),e.jsx("h1",{style:{margin:0},children:"Songbook Builder"}),e.jsx("div",{})]}),e.jsxs(Q,{className:"card",style:{marginTop:8},children:[e.jsxs("div",{className:"Field",style:{minWidth:0},children:[e.jsx("label",{htmlFor:"sb-cover",children:"Upload Cover Image:"}),e.jsx("input",{id:"sb-cover",className:"CoverInput",type:"file",accept:"image/*",onChange:O,style:N?{maxWidth:"50vw",textOverflow:"ellipsis",overflow:"hidden",whiteSpace:"nowrap"}:void 0})]}),e.jsxs("div",{style:{marginLeft:"auto",display:"flex",gap:6},children:[e.jsx(h,{onClick:M,disabled:!F,title:"Clear selection",iconLeft:e.jsx(V,{}),children:e.jsx("span",{className:"text-when-wide",children:"Clear"})}),e.jsx(h,{variant:"primary",onClick:H,onMouseEnter:P,onFocus:P,disabled:!m.length||v,title:m.length?"Export PDF":"Select some songs first",iconLeft:e.jsx(G,{}),children:v?"Exporting…":N?"PDF":e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-when-wide",children:"Export PDF"}),e.jsx("span",{className:"text-when-narrow",children:"PDF"})]})})]})]}),e.jsxs("div",{className:"BuilderPage",style:{marginTop:8},children:[e.jsx("div",{className:"BuilderLeft",children:e.jsx("div",{className:"card",style:{display:"flex",flexDirection:"column",flex:"1 1 auto",minHeight:0},children:e.jsxs("div",{className:"BuilderScroll pane--addSongs",style:{minHeight:0,flex:"1 1 auto",overflow:"auto",marginTop:8},children:[e.jsxs("div",{className:"BuilderHeader",style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx("strong",{style:{whiteSpace:"nowrap"},children:"Add songs"}),e.jsx(J,{value:f,onChange:t=>E(t.target.value),placeholder:"Search...",style:{flex:1,minWidth:0}}),e.jsxs(h,{onClick:D,disabled:!C,title:"Add all filtered",iconLeft:e.jsx(k,{}),variant:"primary",style:{marginLeft:"auto"},children:[e.jsxs("span",{className:"text-when-wide",children:["Add all (",C,")"]}),e.jsx("span",{className:"text-when-narrow",children:"All"})]})]}),e.jsx("div",{className:"SongList",role:"region","aria-label":"Song list",style:{display:"flex",flexDirection:"column",minHeight:0,flex:"1 1 auto",marginTop:6},children:e.jsx("div",{className:"gc-list",style:{display:"grid",gap:".5rem",gridTemplateColumns:"repeat(auto-fill, minmax(320px, 1fr))"},children:u.map(t=>{const s=p.has(t.id),i=[(Array.isArray(t.authors)?t.authors.join(", "):t.authors||"")||"—",t.country].filter(Boolean).join(" • ");return e.jsx(X,{title:t.title,subtitle:i,rightSlot:s?e.jsx(h,{"aria-label":"Remove",title:"Remove",onClick:a=>{a.stopPropagation(),j(t.id,!1)},iconLeft:e.jsx(Y,{}),iconOnly:!0,style:{color:"#b91c1c"}}):e.jsx(h,{"aria-label":"Add",title:"Add",variant:"primary",onClick:a=>{a.stopPropagation(),j(t.id,!0)},iconLeft:e.jsx(k,{}),iconOnly:!0}),onClick:()=>j(t.id,!s)},t.id)})})})]})})}),e.jsx("div",{className:"BuilderRight",style:{minHeight:0,display:"flex",flexDirection:"column"},children:e.jsxs("div",{className:"card",style:{display:"flex",flexDirection:"column",flex:"1 1 auto",minHeight:0},children:[e.jsxs("strong",{children:["Current selection (",m.length,")"]}),e.jsx("div",{className:"PreviewList pane--currentSet",role:"region","aria-label":"Selected songs",style:{minHeight:0,flex:"1 1 auto",overflow:"auto",marginTop:6},children:e.jsx("ol",{className:"List",style:{listStyle:"decimal inside",margin:0,padding:0},children:m.map(t=>e.jsxs("li",{children:[t.title,Array.isArray(t.authors)&&t.authors.length?e.jsxs("span",{className:"Small",children:[" — ",t.authors.join(", ")]}):null]},t.id))})})]})})]})]})}export{le as default};
