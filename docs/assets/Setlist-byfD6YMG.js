const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-C9IIQibT.js","./index-CtmEiByH.js","./index-Bxr6V5-_.css","./jszip.min-DrC-d5hA.js"])))=>i.map(i=>d[i]);
import{j as e,r as d,i as Se,F as ve,B as we,T as Ce,I as F,a as f,P as H,S as be,C as Ie,b as Ne,c as W,K as Pe,A as De,d as Le,R as ke,D as z,L as Te,e as $e,h as Ae,t as J,_ as q,f as Ke,p as Oe,s as Ee,n as _e,g as Ue}from"./index-CtmEiByH.js";const G="gracechords.sets.v1";function D(){try{const a=localStorage.getItem(G);return a?JSON.parse(a):{sets:{}}}catch{return{sets:{}}}}function Q(a){localStorage.setItem(G,JSON.stringify(a))}function Be(){return typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():"id-"+Math.random().toString(36).slice(2)+Date.now().toString(36)}function N(){const{sets:a}=D();return Object.values(a).sort((l,p)=>(p.updatedAt||0)-(l.updatedAt||0))}function Z(a){const{sets:l}=D();return l[a]||null}function P(a){const l=Date.now(),p={id:a.id||Be(),name:a.name?.trim()||"Untitled Set",items:Array.isArray(a.items)?a.items:[],createdAt:a.createdAt||l,updatedAt:l},g=D();return g.sets[p.id]=p,Q(g),p}function Re(a){const l=D();return l.sets[a]?(delete l.sets[a],Q(l),!0):!1}function Me(a){const l=Z(a);return l?P({name:`Copy of ${l.name}`,items:l.items.map(p=>({...p}))}):null}function X({label:a,id:l,children:p,className:g="",...u}){return e.jsxs("label",{className:"gc-field",htmlFor:l,children:[a?e.jsx("span",{className:"gc-label",children:a}):null,e.jsx("span",{className:"gc-select",children:e.jsx("select",{id:l,className:g,...u,children:p})})]})}let V;const Y=()=>V||(V=q(()=>import("./index-C9IIQibT.js").then(a=>a.i),__vite__mapDeps([0,1,2]),import.meta.url));function He(){const[a,l]=d.useState("Untitled Set"),[p,g]=d.useState(""),[u,ee]=d.useState([]),[v,te]=d.useState(()=>{try{return localStorage.getItem("pref:icpOnly")==="1"}catch{return!1}});d.useEffect(()=>{try{localStorage.setItem("pref:icpOnly",v?"1":"0")}catch{}},[v]);const[o,h]=d.useState([]),[$,ne]=d.useState({}),[L,C]=d.useState(""),A=Object.keys($).length,[k,K]=d.useState(!1),[y,j]=d.useState(null),[se,O]=d.useState(()=>N()),[ie,b]=d.useState("");d.useEffect(()=>{ee(Se?.items||[])},[]),d.useEffect(()=>{let t=!1;async function s(){const n={};for(const i of o){const r=u.find(w=>w.id===i.id);if(!r)continue;const c=r.filename.replace(/\.chordpro$/i,""),m=`./pptx/${c}.pptx`;await Ae(m,c)&&(n[c]=!0)}t||ne(n)}return s(),()=>{t=!0}},[o,u]),d.useEffect(()=>{try{const t=localStorage.getItem("setlist");if(!t||N().length>0)return;const s=JSON.parse(t);if(s?.name||(s?.list?.length||0)>0){const n=P({name:s.name||"Imported Set",items:s.list||[]});O(N()),j(n.id),l(n.name),h(n.items||[]),b(n.id)}}catch{}},[]);const T=d.useMemo(()=>new ve(u,{keys:["title","tags"],threshold:.4}),[u]);function ae(t){return!v||(Array.isArray(t.tags)?t.tags.includes("ICP"):t.tags==="ICP")}const oe=d.useMemo(()=>(p?T.search(p).map(s=>s.item):u.slice().sort((s,n)=>s.title.localeCompare(n.title))).filter(ae),[p,T,u,v]);function le(t){h(o.filter(s=>s.id!==t))}function E(t,s){const n=o.findIndex(m=>m.id===t);if(n<0)return;const i=n+(s==="up"?-1:1);if(i<0||i>=o.length)return;const r=o.slice(),[c]=r.splice(n,1);r.splice(i,0,c),h(r)}function re(t,s){const n=o.findIndex(c=>c.id===t);if(n<0||s<0||s>=o.length||n===s)return;const i=o.slice(),[r]=i.splice(n,1);i.splice(s,0,r),h(i)}function ce(t,s){h(o.map(n=>n.id===t?{...n,toKey:s}:n))}function _(t){h(s=>s.map(n=>{const i=u.find(c=>c.id===n.id),r=n.toKey||i?.originalKey||"C";return{...n,toKey:J(r,t)}}))}function de(){h(t=>t.map(s=>{const n=u.find(i=>i.id===s.id);return{...s,toKey:n?.originalKey||"C"}}))}function I(t){O(N()),b(t||"")}function U(){j(null),l("Untitled Set"),h([]),b("")}function pe(){const t=a?.trim()||"Untitled Set",s=P({id:y,name:t,items:o});l(s.name),j(s.id),I(s.id)}function ue(t){const s=t.target.value;if(b(s),!s)return;const n=Z(s);n&&(j(n.id),l(n.name||"Untitled Set"),h(n.items||[]))}function fe(){if(!y){const s=`Copy of ${a||"Untitled Set"}`,n=P({id:null,name:s,items:o});l(n.name),j(n.id),I(n.id);return}const t=Me(y);t&&(j(t.id),l(t.name),h(t.items||[]),I(t.id))}function me(){y&&window.confirm(`Delete set "${a}"? This cannot be undone.`)&&(Re(y),U(),I(""))}async function he(){K(!0);try{const{downloadMultiSongPdf:t}=await Y(),s=[];for(const n of o){const i=u.find(r=>r.id===n.id);if(i)try{const r=`./songs/${i.filename}`,c=await Ke(r),m=Oe(c),x=m.meta?.key||m.meta?.originalkey||i.originalKey||"C",w=Ee(x,n.toKey||x),ge=(m.sections||[]).map(R=>({section:R.label,lines:(R.lines||[]).map(S=>({plain:S.comment?S.comment:S.lyrics||"",chordPositions:(S.chords||[]).map(M=>({sym:J(M.sym,w),index:M.index})),comment:S.comment?S.comment:void 0}))})),ye=i.filename.replace(/\.chordpro$/i,""),je=_e({title:m.meta?.title||i.title||ye,key:n.toKey||x,capo:m.meta?.capo,lyricsBlocks:ge});s.push(je)}catch(r){console.error(r),Ue(`Failed to process ${i.filename}`)}}s.length&&await t(s)}finally{K(!1)}}function B(){Y()}async function xe(){C(`Bundling 0/${o.length}…`);const t=(await q(async()=>{const{default:i}=await import("./jszip.min-DrC-d5hA.js").then(r=>r.j);return{default:i}},__vite__mapDeps([3,1,2]),import.meta.url)).default,s=new t;let n=0;for(let i=0;i<o.length;i++){const r=o[i],c=u.find(x=>x.id===r.id);if(!c){C(`Bundling ${i+1}/${o.length}…`);continue}C(`Bundling ${i+1}/${o.length}…`);const m=c.filename.replace(/\.chordpro$/i,"");if($[m])try{const x=await fetch(`./pptx/${m}.pptx`);if(!x.ok)continue;const w=await x.blob();n++,s.file(`${String(n).padStart(2,"0")}-${m}.pptx`,w)}catch{}}if(n>0){const i=await s.generateAsync({type:"blob"}),r=new Date().toISOString().slice(0,10).replace(/-/g,""),c=document.createElement("a");c.href=URL.createObjectURL(i),c.download=`setlist-pptx-${r}.zip`,c.click(),URL.revokeObjectURL(c.href)}C("")}return e.jsxs("div",{className:"container",children:[e.jsx(we,{busy:k}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx("div",{}),e.jsx("h1",{style:{margin:0},children:"Setlist Builder"}),e.jsx("div",{})]}),e.jsxs(Ce,{className:"card",style:{marginTop:12},children:[e.jsx(F,{label:"Set","aria-label":"Set name",value:a,onChange:t=>l(t.target.value),style:{minWidth:220},placeholder:"Sunday AM"}),e.jsxs(X,{"aria-label":"Saved sets",value:ie,onChange:ue,children:[e.jsx("option",{value:"",children:"— Load saved set —"}),se.map(t=>e.jsxs("option",{value:t.id,children:[t.name," · ",new Date(t.updatedAt).toLocaleString()]},t.id))]}),e.jsxs(f,{onClick:U,title:"New set",iconLeft:e.jsx(H,{}),children:[" ",e.jsx("span",{className:"text-when-wide",children:"New"})]}),e.jsxs(f,{variant:"primary",onClick:pe,title:"Save set",iconLeft:e.jsx(be,{}),children:[" ",e.jsx("span",{className:"text-when-wide",children:"Save"})]}),e.jsxs(f,{onClick:fe,disabled:!o.length,title:"Duplicate set",iconLeft:e.jsx(Ie,{}),children:[" ",e.jsx("span",{className:"text-when-wide",children:"Duplicate"})]}),e.jsxs(f,{onClick:me,disabled:!y,title:"Delete set",iconLeft:e.jsx(Ne,{}),children:[" ",e.jsx("span",{className:"text-when-wide",children:"Delete"})]}),e.jsxs("div",{style:{marginLeft:"auto",display:"flex",alignItems:"center",gap:6},children:[e.jsx("span",{className:"meta",children:"Transpose:"}),e.jsx(f,{onClick:()=>_(-1),title:"Transpose set down 1 semitone",children:"–1"}),e.jsx(f,{onClick:de,title:"Reset all to originals",children:"Reset"}),e.jsx(f,{onClick:()=>_(1),title:"Transpose set up 1 semitone",children:"+1"})]})]}),e.jsxs("div",{className:"BuilderPage",style:{marginTop:12},children:[e.jsx("div",{className:"BuilderLeft",children:e.jsx("div",{className:"card",style:{display:"flex",flexDirection:"column",flex:"1 1 auto",minHeight:0},children:e.jsxs("div",{style:{marginTop:8},children:[e.jsx("strong",{children:"Add songs"}),e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",marginTop:6},children:[e.jsx(F,{value:p,onChange:t=>g(t.target.value),placeholder:"Search...",style:{flex:1}}),e.jsxs("label",{className:"row",style:{gap:6,alignItems:"center"},children:[e.jsx("input",{type:"checkbox",checked:v,onChange:t=>te(t.target.checked)}),e.jsx("span",{className:"meta",title:"Limit results to songs tagged ICP",children:"ICP only"})]})]}),e.jsx("div",{style:{minHeight:0,flex:"1 1 auto",overflow:"auto",marginTop:6},children:T?e.jsx("div",{style:{display:"grid",gap:".5rem",gridTemplateColumns:"repeat(auto-fill, minmax(320px, 1fr))"},children:oe.map(t=>e.jsx(W,{title:t.title,subtitle:`${t.originalKey||""}${t.tags?.length?` • ${t.tags.join(", ")}`:""}`,rightSlot:e.jsx(f,{"aria-label":"Add",title:"Add to set",iconLeft:e.jsx(H,{}),iconOnly:!0})},t.id))}):e.jsx("div",{children:"Loading search…"})})]})})}),e.jsx("div",{className:"BuilderRight",style:{minHeight:0,display:"flex",flexDirection:"column"},children:e.jsxs("div",{className:"card",style:{display:"flex",flexDirection:"column",flex:"1 1 auto",minHeight:0},children:[e.jsxs("strong",{children:["Current setlist (",o.length,")"]}),e.jsx("div",{style:{minHeight:0,flex:"1 1 auto",overflow:"auto",marginTop:6},children:o.map((t,s)=>{const n=u.find(i=>i.id===t.id);return n?e.jsx(W,{draggable:!0,onDragStart:i=>{i.dataTransfer.setData("text/plain",String(t.id)),i.dataTransfer.effectAllowed="move"},onDragOver:i=>{i.preventDefault(),i.dataTransfer.dropEffect="move"},onDrop:i=>{i.preventDefault();const r=i.dataTransfer.getData("text/plain");re(r,s)},title:n.title,subtitle:`Original: ${n.originalKey||"—"}`,rightSlot:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx(X,{value:t.toKey,onChange:i=>ce(t.id,i.target.value),children:Pe.map(i=>e.jsx("option",{value:i,children:i},i))}),e.jsx(f,{onClick:()=>E(t.id,"up"),title:"Move up",iconLeft:e.jsx(De,{})}),e.jsx(f,{onClick:()=>E(t.id,"down"),title:"Move down",iconLeft:e.jsx(Le,{})}),e.jsx(f,{onClick:()=>le(t.id),title:"Remove",iconLeft:e.jsx(ke,{})})]})},t.id):null})}),e.jsxs("div",{style:{display:"flex",gap:8,marginTop:8,flexWrap:"wrap"},children:[e.jsx(f,{variant:"primary",onClick:he,onMouseEnter:B,onFocus:B,disabled:k,title:"Export set as a single PDF",iconLeft:e.jsx(z,{}),children:k?"Exporting…":e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-when-wide",children:"Export PDF"}),e.jsx("span",{className:"text-when-narrow",children:"PDF"})]})}),e.jsxs(Te,{className:"btn iconbtn",to:o.length?`/worship/${o.map(t=>t.id).join(",")}?toKeys=${o.map(t=>encodeURIComponent(t.toKey)).join(",")}`:"#",title:o.length?"Open Worship Mode with this set":"Add songs to open Worship Mode","aria-disabled":!o.length,onClick:t=>{o.length||t.preventDefault()},children:[e.jsx("span",{className:"text-when-wide",children:"Open in Worship Mode"}),e.jsx("span",{className:"text-when-narrow",children:"Worship"})]}),e.jsx(f,{onClick:xe,disabled:A===0||!!L,title:A===0?"No PPTX files found for this set.":"Bundle PPTX files for selected songs",iconLeft:e.jsx(z,{}),children:L||e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-when-wide",children:"Bundle PPTX"}),e.jsx("span",{className:"text-when-narrow",children:"PPTX"})]})}),e.jsx(f,{onClick:()=>h([]),title:"Clear setlist",iconLeft:e.jsx($e,{}),children:e.jsx("span",{className:"text-when-wide",children:"Clear"})})]}),e.jsxs("div",{className:"print-only",style:{marginTop:16},children:[e.jsx("h2",{style:{fontSize:"20pt",margin:"0 0 8pt 0"},children:a}),e.jsx("ol",{style:{fontSize:"12pt",lineHeight:1.4,paddingLeft:"1.2em"},children:o.map(t=>{const s=u.find(n=>n.id===t.id);return s?e.jsxs("li",{children:[s.title," — ",t.toKey||s.originalKey||"—"]},t.id):null})})]})]})})]})]})}export{He as default};
