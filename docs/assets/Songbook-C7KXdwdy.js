import{r,i as K,j as t,B as U,S as G,f as J,p as Q,b,c as V,e as X}from"./index-Cg57-isj.js";function v(a,i){return((a==null?void 0:a.title)||"").localeCompare((i==null?void 0:i.title)||"",void 0,{sensitivity:"base"})}function S(a){return[...new Set(a.filter(Boolean))].sort((i,p)=>String(i).localeCompare(String(p),void 0,{sensitivity:"base"}))}function _(){const a=r.useMemo(()=>{var e;return(((e=K)==null?void 0:e.items)||[]).slice().sort(v)},[]),[i,p]=r.useState(""),[u,R]=r.useState("All"),[g,T]=r.useState("All"),[h,$]=r.useState("All"),M=r.useMemo(()=>S(a.flatMap(e=>Array.isArray(e.tags)?e.tags:e.tags?[e.tags]:[])),[a]),P=r.useMemo(()=>S(a.map(e=>e.country).filter(Boolean)),[a]),E=r.useMemo(()=>S(a.flatMap(e=>Array.isArray(e.authors)?e.authors:e.authors?[e.authors]:[])),[a]),c=r.useMemo(()=>{const e=i.trim().toLowerCase();let s=a;return e&&(s=s.filter(l=>{const n=(l.title||"").toLowerCase(),o=(Array.isArray(l.authors)?l.authors.join(", "):l.authors||"").toLowerCase();return n.includes(e)||o.includes(e)})),u!=="All"&&(s=s.filter(l=>Array.isArray(l.tags)?l.tags.includes(u):l.tags===u)),g!=="All"&&(s=s.filter(l=>l.country===g)),h!=="All"&&(s=s.filter(l=>Array.isArray(l.authors)?l.authors.includes(h):l.authors===h)),s.slice().sort(v)},[a,i,u,g,h]),[x,j]=r.useState(()=>new Set),d=r.useMemo(()=>c.filter(e=>x.has(e.id)).slice().sort(v),[c,x]),C=c.length,A=x.size;function N(e,s){j(l=>{const n=new Set(l);return s?n.add(e):n.delete(e),n})}function I(){c.length&&j(e=>{const s=new Set(e);for(const l of c)s.add(l.id);return s})}function D(){j(new Set)}const[W,O]=r.useState(!0),[Y,f]=r.useState(null),[y,F]=r.useState(!1);async function q(){if(d.length){F(!0);try{const e=[];for(const s of d)try{const l=`./songs/${s.filename}`,n=await J(l),o=Q(n),m=o.blocks.map(w=>({section:w.section,lines:(w.lines||[]).map(B=>({plain:B.text,chordPositions:(B.chords||[]).map(L=>({sym:L.sym,index:L.index}))}))})),H=s.filename.replace(/\.chordpro$/,"");e.push({title:o.meta.title||s.title||H,key:o.meta.key||o.meta.originalkey||s.originalKey||"C",lyricsBlocks:m})}catch(l){console.error(l),b(`Failed to process ${s.filename}`)}if(e.length){const s=V(e,{docTitle:"Songbook",showChords:!0});(await X(s)).save("Songbook.pdf")}}finally{F(!1)}}}function k(){}function z(e){var n;const s=(n=e.target.files)==null?void 0:n[0];if(!s){f(null);return}if(s.size>2*1024*1024){b("Image must be under 2 MB"),e.target.value="",f(null);return}if(!s.type.startsWith("image/")){b("File must be an image"),e.target.value="",f(null);return}const l=new FileReader;l.onload=()=>f(String(l.result||"")),l.readAsDataURL(s)}return a.length===0?t.jsx("div",{className:"BuilderPage",children:t.jsx("section",{className:"BuilderLeft",children:t.jsxs("header",{className:"BuilderHeader",children:[t.jsx("h1",{children:"No songs found"}),t.jsx("p",{className:"Small",children:"The song index is empty or failed to load."})]})})}):t.jsxs("div",{className:"BuilderPage",children:[t.jsx(U,{busy:y}),t.jsxs("section",{className:"BuilderLeft",children:[t.jsxs("header",{className:"BuilderHeader",children:[t.jsx("h1",{style:{margin:0},children:"Songbook Builder"}),t.jsxs("div",{className:"Row",style:{gap:"1rem",alignItems:"flex-end",flexWrap:"wrap"},children:[t.jsxs("div",{className:"Field",style:{minWidth:220},children:[t.jsx("label",{htmlFor:"sb-search",children:"Search:"}),t.jsx("input",{id:"sb-search",type:"search",placeholder:"Title or author",value:i,onChange:e=>p(e.target.value),style:{width:"100%"}})]}),t.jsxs("div",{className:"Field",children:[t.jsx("label",{htmlFor:"sb-tag",children:"Tag:"}),t.jsxs("select",{id:"sb-tag",value:u,onChange:e=>R(e.target.value),children:[t.jsx("option",{children:"All"}),M.map(e=>t.jsx("option",{value:e,children:e},e))]})]}),t.jsxs("div",{className:"Field",children:[t.jsx("label",{htmlFor:"sb-country",children:"Country:"}),t.jsxs("select",{id:"sb-country",value:g,onChange:e=>T(e.target.value),children:[t.jsx("option",{children:"All"}),P.map(e=>t.jsx("option",{value:e,children:e},e))]})]}),t.jsxs("div",{className:"Field",children:[t.jsx("label",{htmlFor:"sb-author",children:"Author:"}),t.jsxs("select",{id:"sb-author",value:h,onChange:e=>$(e.target.value),children:[t.jsx("option",{children:"All"}),E.map(e=>t.jsx("option",{value:e,children:e},e))]})]}),t.jsxs("div",{className:"Field",style:{marginLeft:"auto",gap:".5rem"},children:[t.jsxs("button",{className:"btn",onClick:I,disabled:!C,children:["Select all (",C," filtered)"]}),t.jsx("button",{className:"btn",onClick:D,disabled:!A,children:"Clear"})]})]}),t.jsxs("div",{className:"Row Small",style:{marginTop:".5rem"},children:[t.jsx("strong",{children:A})," selected"]})]}),t.jsx("div",{className:"BuilderScroll",role:"region","aria-label":"Song list",children:t.jsx("ul",{className:"BuilderList",children:c.map(e=>{const s=x.has(e.id),l=Array.isArray(e.authors)?e.authors.join(", "):e.authors||"",n=Array.isArray(e.tags)?e.tags.join(", "):e.tags||"",o=`${l||"—"}${n?` • ${n}`:""}${e.country?` • ${e.country}`:""}`;return t.jsx("li",{children:t.jsx(G,{leftSlot:t.jsx("input",{type:"checkbox",checked:s,onChange:m=>N(e.id,m.target.checked),onClick:m=>m.stopPropagation(),"aria-label":`Select ${e.title}`}),title:e.title,subtitle:o,onClick:()=>N(e.id,!s)})},e.id)})})})]}),t.jsxs("aside",{className:"BuilderRight",children:[t.jsx("div",{className:"RightSection",children:t.jsxs("div",{className:"Row",style:{justifyContent:"space-between",flexWrap:"wrap"},children:[t.jsxs("div",{className:"Field",children:[t.jsx("input",{id:"sb-toc",type:"checkbox",checked:W,onChange:e=>O(e.target.checked)}),t.jsx("label",{htmlFor:"sb-toc",children:"Include table of contents"})]}),t.jsxs("div",{className:"Field",children:[t.jsx("label",{htmlFor:"sb-cover",children:"Cover page (image):"}),t.jsx("input",{id:"sb-cover",className:"CoverInput",type:"file",accept:"image/*",onChange:z})]}),t.jsx("div",{className:"Field",style:{marginLeft:"auto"},children:t.jsx("button",{className:"btn",onClick:q,onMouseEnter:k,onFocus:k,disabled:!d.length||y,title:d.length?"Export PDF":"Select some songs first",children:y?"Exporting…":`Export PDF (${d.length})`})})]})}),t.jsx("div",{className:"RightSection RightScroll",role:"region","aria-label":"Selected songs",children:t.jsx("ol",{className:"List",style:{listStyle:"decimal inside"},children:d.map(e=>t.jsxs("li",{children:[e.title,Array.isArray(e.authors)&&e.authors.length?t.jsxs("span",{className:"Small",children:[" — ",e.authors.join(", ")]}):null]},e.id))})})]})]})}export{_ as default};
