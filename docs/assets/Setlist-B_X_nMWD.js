const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./jszip.min-DHYCM0E7.js","./index-CcIk5Zx8.js","./index-B-kUmedf.css"])))=>i.map(i=>d[i]);
import{r as u,i as pe,F as me,j as t,B as fe,L as he,S as M,K as ge,A as xe,a as ye,R as je,D as F,h as Se,t as H,f as be,p as ve,s as we,b as Ce,c as ke,e as Ne,_ as $e}from"./index-CcIk5Zx8.js";const z="gracechords.sets.v1";function k(){try{const o=localStorage.getItem(z);return o?JSON.parse(o):{sets:{}}}catch{return{sets:{}}}}function J(o){localStorage.setItem(z,JSON.stringify(o))}function Ke(){return typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():"id-"+Math.random().toString(36).slice(2)+Date.now().toString(36)}function w(){const{sets:o}=k();return Object.values(o).sort((l,m)=>(m.updatedAt||0)-(l.updatedAt||0))}function X(o){const{sets:l}=k();return l[o]||null}function C(o){var d;const l=Date.now(),m={id:o.id||Ke(),name:((d=o.name)==null?void 0:d.trim())||"Untitled Set",items:Array.isArray(o.items)?o.items:[],createdAt:o.createdAt||l,updatedAt:l},y=k();return y.sets[m.id]=m,J(y),m}function Ie(o){const l=k();return l.sets[o]?(delete l.sets[o],J(l),!0):!1}function Pe(o){const l=X(o);return l?C({name:`Copy of ${l.name}`,items:l.items.map(m=>({...m}))}):null}function Ae(){const[o,l]=u.useState("Untitled Set"),[m,y]=u.useState(""),[d,Y]=u.useState([]),[c,f]=u.useState([]),[P,q]=u.useState({}),[N,j]=u.useState(""),T=Object.keys(P).length,[$,A]=u.useState(!1),[h,g]=u.useState(null),[G,D]=u.useState(()=>w()),[Q,S]=u.useState("");u.useEffect(()=>{var e;Y(((e=pe)==null?void 0:e.items)||[])},[]),u.useEffect(()=>{let e=!1;async function s(){const n={};for(const i of c){const r=d.find(x=>x.id===i.id);if(!r)continue;const a=`./pptx/${r.id}.pptx`;await Se(a,r.id)&&(n[r.id]=!0)}e||q(n)}return s(),()=>{e=!0}},[c,d]),u.useEffect(()=>{var e;try{const s=localStorage.getItem("setlist");if(!s||w().length>0)return;const n=JSON.parse(s);if(n!=null&&n.name||(((e=n==null?void 0:n.list)==null?void 0:e.length)||0)>0){const i=C({name:n.name||"Imported Set",items:n.list||[]});D(w()),g(i.id),l(i.name),f(i.items||[]),S(i.id)}}catch{}},[]);const K=u.useMemo(()=>new me(d,{keys:["title","tags"],threshold:.4}),[d]),V=u.useMemo(()=>m?K.search(m).map(e=>e.item):d.slice().sort((e,s)=>e.title.localeCompare(s.title)),[m,K,d]);function W(e){c.find(s=>s.id===e.id)||f([...c,{id:e.id,toKey:e.originalKey||"C"}])}function Z(e){f(c.filter(s=>s.id!==e))}function U(e,s){const n=c.findIndex(p=>p.id===e);if(n<0)return;const i=n+(s==="up"?-1:1);if(i<0||i>=c.length)return;const r=c.slice(),[a]=r.splice(n,1);r.splice(i,0,a),f(r)}function ee(e,s){f(c.map(n=>n.id===e?{...n,toKey:s}:n))}function _(e){f(s=>s.map(n=>{const i=d.find(a=>a.id===n.id),r=n.toKey||(i==null?void 0:i.originalKey)||"C";return{...n,toKey:H(r,e)}}))}function te(){f(e=>e.map(s=>{const n=d.find(i=>i.id===s.id);return{...s,toKey:(n==null?void 0:n.originalKey)||"C"}}))}function b(e){D(w()),S(e||"")}function E(){g(null),l("Untitled Set"),f([]),S("")}function ne(){const e=(o==null?void 0:o.trim())||"Untitled Set",s=C({id:h,name:e,items:c});l(s.name),g(s.id),b(s.id)}function se(e){const s=e.target.value;if(S(s),!s)return;const n=X(s);n&&(g(n.id),l(n.name||"Untitled Set"),f(n.items||[]))}function ie(){if(!h){const s=`Copy of ${o||"Untitled Set"}`,n=C({id:null,name:s,items:c});l(n.name),g(n.id),b(n.id);return}const e=Pe(h);e&&(g(e.id),l(e.name),f(e.items||[]),b(e.id))}function oe(){h&&window.confirm(`Delete set "${o}"? This cannot be undone.`)&&(Ie(h),E(),b(""))}async function ae(){var e,s,n;A(!0);try{const i=[];for(const r of c){const a=d.find(p=>p.id===r.id);if(a)try{const p=`./songs/${a.filename}`,x=await be(p),v=ve(x),I=((e=v.meta)==null?void 0:e.key)||((s=v.meta)==null?void 0:s.originalkey)||a.originalKey||"C",ce=we(I,r.toKey||I),de=(v.blocks||[]).map(R=>({section:R.section,lines:(R.lines||[]).map(O=>({plain:O.text,chordPositions:(O.chords||[]).map(B=>({sym:H(B.sym,ce),index:B.index}))}))})),ue=a.filename.replace(/\.chordpro$/i,"");i.push({title:((n=v.meta)==null?void 0:n.title)||a.title||ue,key:r.toKey||I,lyricsBlocks:de})}catch(p){console.error(p),Ce(`Failed to process ${a.filename}`)}}if(i.length){const r=ke(i,{docTitle:o||"Setlist",showChords:!0});(await Ne(r)).save(`${(o||"Setlist").replace(/\s+/g,"_")}.pdf`)}}finally{A(!1)}}function L(){}async function le(){j(`Bundling 0/${c.length}…`);const e=(await $e(async()=>{const{default:i}=await import("./jszip.min-DHYCM0E7.js").then(r=>r.j);return{default:i}},__vite__mapDeps([0,1,2]),import.meta.url)).default,s=new e;let n=0;for(let i=0;i<c.length;i++){const r=c[i],a=d.find(p=>p.id===r.id);if(!a){j(`Bundling ${i+1}/${c.length}…`);continue}if(j(`Bundling ${i+1}/${c.length}…`),!!P[a.id])try{const p=await fetch(`./pptx/${a.id}.pptx`);if(!p.ok)continue;const x=await p.blob();n++,s.file(`${String(n).padStart(2,"0")}-${a.id}.pptx`,x)}catch{}}if(n>0){const i=await s.generateAsync({type:"blob"}),r=new Date().toISOString().slice(0,10).replace(/-/g,""),a=document.createElement("a");a.href=URL.createObjectURL(i),a.download=`setlist-pptx-${r}.zip`,a.click(),URL.revokeObjectURL(a.href)}j("")}function re(){window.print()}return t.jsxs("div",{className:"container",children:[t.jsx(fe,{busy:$}),t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[t.jsx("div",{children:t.jsx(he,{to:"/",className:"back",children:"← Back"})}),t.jsx("h1",{style:{margin:0},children:"Setlist Builder"}),t.jsx("div",{})]}),t.jsxs("div",{className:"card toolbar",style:{marginTop:12},children:[t.jsxs("label",{style:{display:"flex",alignItems:"center",gap:6},children:[t.jsx("span",{children:"Set:"}),t.jsx("input",{"aria-label":"Set name",value:o,onChange:e=>l(e.target.value),style:{minWidth:220},placeholder:"Sunday AM"})]}),t.jsxs("select",{"aria-label":"Saved sets",value:Q,onChange:se,children:[t.jsx("option",{value:"",children:"— Load saved set —"}),G.map(e=>t.jsxs("option",{value:e.id,children:[e.name," · ",new Date(e.updatedAt).toLocaleString()]},e.id))]}),t.jsx("button",{className:"btn",onClick:E,children:"New"}),t.jsx("button",{className:"btn primary",onClick:ne,children:"Save"}),t.jsx("button",{className:"btn",onClick:ie,disabled:!c.length,children:"Duplicate"}),t.jsx("button",{className:"btn",onClick:oe,disabled:!h,children:"Delete"}),t.jsxs("div",{style:{marginLeft:"auto",display:"flex",alignItems:"center",gap:6},children:[t.jsx("span",{className:"meta",children:"Transpose:"}),t.jsx("button",{className:"btn",onClick:()=>_(-1),title:"Transpose set down 1 semitone",children:"–1"}),t.jsx("button",{className:"btn",onClick:te,title:"Reset all to originals",children:"Reset"}),t.jsx("button",{className:"btn",onClick:()=>_(1),title:"Transpose set up 1 semitone",children:"+1"})]})]}),t.jsxs("div",{className:"card",style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12},children:[t.jsx("div",{children:t.jsxs("div",{style:{marginTop:8},children:[t.jsx("strong",{children:"Add songs"}),t.jsx("input",{value:m,onChange:e=>y(e.target.value),placeholder:"Search...",style:{display:"block",width:"100%",marginTop:6}}),t.jsx("div",{style:{minHeight:0,maxHeight:300,overflow:"auto",marginTop:6},children:K?V.map(e=>{var s;return t.jsx(M,{title:e.title,subtitle:`${e.originalKey||""}${(s=e.tags)!=null&&s.length?` • ${e.tags.join(", ")}`:""}`,rightSlot:t.jsx("button",{className:"btn",onClick:()=>W(e),children:"Add"})},e.id)}):t.jsx("div",{children:"Loading search…"})})]})}),t.jsxs("div",{children:[t.jsxs("strong",{children:["Current setlist (",c.length,")"]}),t.jsx("div",{style:{minHeight:0,maxHeight:360,overflow:"auto",marginTop:6},children:c.map(e=>{const s=d.find(n=>n.id===e.id);return s?t.jsx(M,{title:s.title,subtitle:`Original: ${s.originalKey||"—"}`,rightSlot:t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6},children:[t.jsx("select",{value:e.toKey,onChange:n=>ee(e.id,n.target.value),children:ge.map(n=>t.jsx("option",{value:n,children:n},n))}),t.jsx("button",{className:"btn",onClick:()=>U(e.id,"up"),title:"Move up",children:t.jsx(xe,{})}),t.jsx("button",{className:"btn",onClick:()=>U(e.id,"down"),title:"Move down",children:t.jsx(ye,{})}),t.jsx("button",{className:"btn",onClick:()=>Z(e.id),title:"Remove",children:t.jsx(je,{})})]})},e.id):null})}),t.jsxs("div",{style:{display:"flex",gap:8,marginTop:8},children:[t.jsx("button",{className:"btn primary iconbtn",onClick:ae,onMouseEnter:L,onFocus:L,disabled:$,children:$?"Exporting…":t.jsxs(t.Fragment,{children:[t.jsx(F,{})," Export PDF"]})}),t.jsx("button",{className:"btn iconbtn",onClick:le,disabled:T===0||!!N,title:T===0?"No PPTX files found for this set.":"",children:N||t.jsxs(t.Fragment,{children:[t.jsx(F,{})," Bundle PPTX"]})}),t.jsx("button",{className:"btn",onClick:re,children:"Print"}),t.jsx("button",{className:"btn",onClick:()=>f([]),children:"Clear"})]}),t.jsxs("div",{className:"print-only",style:{marginTop:16},children:[t.jsx("h2",{style:{fontSize:"20pt",margin:"0 0 8pt 0"},children:o}),t.jsx("ol",{style:{fontSize:"12pt",lineHeight:1.4,paddingLeft:"1.2em"},children:c.map(e=>{const s=d.find(n=>n.id===e.id);return s?t.jsxs("li",{children:[s.title," — ",e.toKey||s.originalKey||"—"]},e.id):null})})]})]})]})]})}export{Ae as default};
