import{c as _}from"./index-SGpQcByy.js";function V(e,c,n="normal"){return s=>o=>(e.setFont(c,n),e.setFontSize(s),e.getTextWidth(o||""))}function M(e,c=3){if(!Array.isArray(e)||e.length<2)return e;e.sort((o,t)=>o.x-t.x);let n=!0,s=0;for(;n&&s<10;){n=!1,s++;for(let o=1;o<e.length;o++){const t=e[o-1],r=e[o];if(t.x+t.w>r.x){const m=t.x+t.w-r.x,l=Math.min(c,Math.ceil(m/2));t.x-=l,r.x+=l,n=!0}}}return e.sort((o,t)=>o.x-t.x),e}function w(e){if(!e)return{meta:{title:"Untitled",key:"C"},sections:[]};if(e.meta&&Array.isArray(e.sections)){const c={title:e.meta.title||e.title||"Untitled",key:e.meta.key||e.key||"C",capo:e.meta.capo,meta:e.meta.meta},n=(e.sections||[]).map(s=>({kind:s.kind||"verse",label:s.label,lines:(s.lines||[]).map(o=>({lyrics:o.comment?o.comment:o.lyrics||o.plain||o.text||"",chords:(o.chords||o.chordPositions||[]).map(t=>({index:t.index||0,sym:t.sym})),comment:o.comment}))}));return{meta:c,sections:n,layoutHints:e.layoutHints}}if(e.lyricsBlocks){const c=(e.lyricsBlocks||[]).map(n=>({kind:"verse",label:n.section,lines:(n.lines||[]).map(s=>({lyrics:s.comment?s.comment:s.plain||s.text||"",chords:(s.chordPositions||[]).map(o=>({index:o.index||0,sym:o.sym})),comment:s.comment}))}));return{meta:{title:e.title||"Untitled",key:e.key||e.originalKey||"C",capo:e.capo},sections:c}}if(Array.isArray(e==null?void 0:e.blocks)){const c=[];let n={kind:"verse",label:"",lines:[]};for(const s of e.blocks)s.type==="section"?(n.lines.length&&c.push(n),n={kind:"verse",label:s.header,lines:[]}):s.type==="line"&&n.lines.push({lyrics:s.lyrics||s.text||"",chords:(s.chords||[]).map(o=>({index:o.index||0,sym:o.sym}))});return n.lines.length&&c.push(n),{meta:{title:e.title||"Untitled",key:e.key||e.originalKey||"C"},sections:c}}if(typeof e=="string")return _(e);if(e!=null&&e.body||e!=null&&e.lines){const c=(e.body||(Array.isArray(e.lines)?e.lines.join(`
`):""))+"";return _(c)}return{meta:{title:e.title||"Untitled",key:e.key||e.originalKey||"C"},sections:[]}}const C={lyricSizePt:16,chordSizePt:16,margin:36,gutter:24,headerOffsetY:40,columns:1,pageWidth:612,pageHeight:792,lyricFamily:"Helvetica",chordFamily:"Courier",title:"Untitled",key:"C"},D=6;function G(e,c,n,s,o,t){const r=s.margin,m=s.pageWidth-r*2,y=(c===2?(m-s.gutter)/2:m)-D,i=o(n),z=t(n);for(const x of e.sections||[])for(const p of x.lines||[]){const f=p.lyrics||"";if(i(f)>y)return!0;for(const g of p.chords||[]){const H=i(f.slice(0,g.index||0)),h=z(g.sym||"");if(H+h>y)return!0}}return!1}function Y(e,c={},n=()=>()=>0,s=()=>()=>0){var p;const o=w(e),t={...C,...c,gutter:C.gutter},r=[16,15,14,13,12],m=((p=o.layoutHints)==null?void 0:p.requestedColumns)===2,l=f=>{for(const g of r){const H=f===2?[2,1]:[1,2];for(const h of H){const S=v(o,{...t,columns:h,lyricSizePt:g,chordSizePt:g},n(g),s(g)),O=!G(o,h,g,t,n,s),T={...t,columns:h,lyricSizePt:g,chordSizePt:g,layout:S};if(!(!q(T)||!O)&&!(h===2&&R(T)))return{plan:T}}}return null},y=l(m?2:1);if(y)return y;const i=12;let z=v(o,{...t,columns:1,lyricSizePt:i,chordSizePt:i},n(i),s(i)),x={...t,columns:1,lyricSizePt:i,chordSizePt:i,layout:z};return N(x)||(z=v(o,{...t,columns:2,lyricSizePt:i,chordSizePt:i},n(i),s(i)),x={...t,columns:2,lyricSizePt:i,chordSizePt:i,layout:z}),{plan:x}}function q(e){var c,n;return((n=(c=e==null?void 0:e.layout)==null?void 0:c.pages)==null?void 0:n.length)===1}function N(e){var c,n;return(((n=(c=e==null?void 0:e.layout)==null?void 0:c.pages)==null?void 0:n.length)||99)<=2}function R(e){var r,m,l;const c=(m=(r=e==null?void 0:e.layout)==null?void 0:r.pages)==null?void 0:m[0];if(!c||((l=c.columns)==null?void 0:l.length)!==2)return!1;const n=c.columns[1];let s=0,o=0,t=0;for(const y of n.blocks||[])y.type==="section"?(t>0&&o++,t=0):y.type==="line"&&(t++,s++);return t>0&&o++,s<=5||o===1&&t<3}function v(e,c={},n=o=>0,s=o=>0){var F,U;const o=w(e),t={...C,...c,gutter:C.gutter},r=4,m=t.lyricSizePt,l=Math.round(t.lyricSizePt*.85),y=Math.max(10,t.lyricSizePt-2),i=t.margin,z=t.pageHeight,x=t.pageWidth-i*2,p=t.columns===2?(x-t.gutter)/2:x,f=i+t.headerOffsetY,g=z-i,H=g-f,h=[];let S={columns:[]};h.push(S);function O(){const u={x:i,yStart:f,blocks:[]};if(S.columns.push(u),t.columns===2){const a={x:i+p+t.gutter,yStart:f,blocks:[]};S.columns.push(a)}}function T(){S={columns:[]},h.push(S)}S.columns.length===0&&O();let W=0,P=f;const B=()=>S.columns[W],L=()=>{t.columns===2&&W===0?(W=1,P=f):(T(),O(),W=0,P=f)},E=u=>{var k;let a=l+m+4;for(const d of u.lines||[])d.comment?a+=y+3:((k=d==null?void 0:d.chords)!=null&&k.length&&(a+=t.chordSizePt+r/2),a+=t.lyricSizePt+r);return a+4},I=u=>{var a;return u.comment?y+3:((a=u==null?void 0:u.chords)!=null&&a.length?t.chordSizePt+r/2:0)+t.lyricSizePt+r},j=(u,a)=>{u.blocks.push({type:"section",header:a})},K=(u,a,k,d)=>{if(d){u.blocks.push({type:"line",comment:d});return}const b=k.map(A=>({x:n(a.slice(0,A.index||0)),w:s(A.sym||""),sym:A.sym}));M(b),u.blocks.push({type:"line",lyrics:a,chords:b})};for(let u=0;u<(o.sections||[]).length;u++){const a=o.sections[u],k=E(a);(U=(F=o.layoutHints)==null?void 0:F.columnBreakAfter)!=null&&U.includes(u)&&k<=H&&P!==f?L():k>H?(P!==f||t.columns===2&&W===1)&&L():P+k>g&&L();const d=B();P+=l,j(d,a.label||a.kind),P+=m+4;for(const b of a.lines||[])K(d,b.lyrics||"",b.chords||[],b.comment),P+=I(b);P+=4}return{pages:h}}function Z(e,c){const n={...C,...c};n.pageWidth=612,n.pageHeight=792;const s=t=>t?t.length*(n.lyricSizePt*.6):0;return v(w(e),n,s,s).pages.map((t,r)=>({p:r,cols:t.columns.map((m,l)=>({c:l,blocks:m.blocks.map(y=>({t:y.type,h:y.type==="section"&&y.header||null,line:y.type==="line"?{text:y.lyrics,chords:(y.chords||[]).map(i=>({x:Number(i.x.toFixed(2)),s:i.sym}))}:null}))}))}))}function J(e,c){const n=w(e),s={...C,...c};s.pageWidth=612,s.pageHeight=792;const o=m=>l=>l?l.length*(m*.6):0,t=m=>l=>l?l.length*(m*.6):0,{plan:r}=Y(n,s,o,t);return{columns:r.columns,size:r.lyricSizePt,pages:r.layout.pages.length}}const X=Object.freeze(Object.defineProperty({__proto__:null,DEFAULT_LAYOUT_OPT:C,chooseBestLayout:Y,getLayoutMetrics:Z,normalizeSongInput:w,planForTest:J,planSongLayout:v},Symbol.toStringTag,{value:"Module"}));export{C as D,X as a,Y as c,V as m,w as n,v as p};
