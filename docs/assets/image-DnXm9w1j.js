import{V as N,W as z,X as T}from"./index-8d6dgUSU.js";let P=null;async function C(){if(P)return P;const t="./".replace(/\/+$/,"/"),c=[{family:"NotoSans",weight:"400",style:"normal",file:"NotoSans-Regular.ttf"},{family:"NotoSans",weight:"700",style:"normal",file:"NotoSans-Bold.ttf"},{family:"NotoSans",weight:"400",style:"italic",file:"NotoSans-Italic.ttf"},{family:"NotoSans",weight:"700",style:"italic",file:"NotoSans-BoldItalic.ttf"},{family:"NotoSansMono",weight:"400",style:"normal",file:"NotoSansMono-Regular.ttf"},{family:"NotoSansMono",weight:"700",style:"normal",file:"NotoSansMono-Bold.ttf"}];return P=Promise.all(c.map(async l=>{const n=await new FontFace(l.family,`url(${t}fonts/${l.file})`,{weight:l.weight,style:l.style}).load();document.fonts.add(n)})).then(()=>({lyricFamily:"NotoSans",chordFamily:"NotoSansMono"})).catch(()=>({lyricFamily:"Helvetica",chordFamily:"Courier"})),P}function v(t,{pxWidth:c,pxHeight:l,dpi:u=150}){const n=document.createElement("canvas");n.width=c,n.height=l;const e=n.getContext("2d");e.fillStyle="#fff",e.fillRect(0,0,n.width,n.height);const S=u/72;e.scale(S,S);const h=t.margin,d=Math.max(22,t.lyricSizePt+6),g=Math.max(12,t.lyricSizePt-2);e.fillStyle="#000",e.font=`bold ${d}px ${t.lyricFamily}`,e.fillText(String(t.title||"Untitled"),h,h+24),e.font=`italic ${g}px ${t.lyricFamily}`;const f=String(t.key||"â€”");e.fillText(`Key of ${f}`,h,h+40);const y=4,F=t.lyricSizePt,M=Math.round(t.lyricSizePt*.85),p=h+(t.headerOffsetY||d*1.05+g*1.05+12);return(t.layout.pages||[])[0].columns.forEach(s=>{let r=s.x,o=p;s.blocks.forEach(i=>{if(i.type==="section")o+=M,e.font=`bold ${F}px ${t.lyricFamily}`,e.fillText(`[${i.header}]`,r,o),o+=F+4;else if(i.type==="instrumental"){const a=N(i.instrumental||{},{split:t.columns===2});a.length&&(e.font=`bold ${t.chordSizePt}px ${t.chordFamily}`,e.fillStyle="#000",a.forEach(w=>{e.fillText(w,r,o),o+=t.lyricSizePt+y}))}else if(i.type==="line"){if(i.comment){e.font=`italic ${t.lyricSizePt}px ${t.lyricFamily}`;const a=e.fillStyle;e.fillStyle="#6b7280",e.fillText(i.comment,r,o),e.fillStyle=a,o+=t.lyricSizePt+y;return}i.chords?.length&&(e.font=`bold ${t.chordSizePt}px ${t.chordFamily}`,i.chords.forEach(a=>e.fillText(a.sym,r+a.x,o)),o+=t.chordSizePt+y/2),e.font=`normal ${t.lyricSizePt}px ${t.lyricFamily}`,e.fillText(i.lyrics,r,o),o+=t.lyricSizePt+y}})}),n}async function I(t,c={}){const l=c.dpi||150,u=c.widthInches||8.5,n=c.heightInches||11,e=Math.round(u*l),S=Math.round(n*l),h=await C(),{lyricFamily:d,chordFamily:g}=h;let f=c.plan;if(!f){const m=document.createElement("canvas").getContext("2d");f=z(t,{lyricFamily:d,chordFamily:g},o=>i=>(m.font=`${o}px ${d}`,m.measureText(i||"").width),o=>i=>(m.font=`bold ${o}px ${g}`,m.measureText(i||"").width)).plan}if(f.layout.pages.length>1)return{error:"MULTI_PAGE",plan:f};const y=v(f,{pxWidth:e,pxHeight:S,dpi:l}),M=`${T(String(c.slug||t.slug||t.title||"untitled"))}.jpg`,p=await new Promise((m,x)=>{if(typeof y.toBlob=="function")y.toBlob(s=>{s?m(s):x(new Error("Failed to generate JPG blob"))},"image/jpeg",.92);else try{const r=y.toDataURL("image/jpeg",.92).split(","),o=r[0]?.match(/:(.*?);/),i=atob(r[1]||""),a=i.length,w=new Uint8Array(a);for(let $=0;$<a;$+=1)w[$]=i.charCodeAt($);m(new Blob([w],{type:o?.[1]||"image/jpeg"}))}catch(s){x(s)}});return{plan:f,blob:p,filename:M}}export{I as downloadSingleSongJpg,C as ensureCanvasFonts,v as renderPlanToCanvas};
