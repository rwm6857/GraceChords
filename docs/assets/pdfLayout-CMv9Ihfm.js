import{p as q}from"./index-BzQzGhIP.js";function ee(t,s,o="normal"){return f=>n=>(t.setFont(s,o),t.setFontSize(f),t.getTextWidth(n||""))}function L(t,s=3){if(!Array.isArray(t)||t.length<2)return t;t.sort((n,e)=>n.x-e.x);let o=!0,f=0;for(;o&&f<10;){o=!1,f++;for(let n=1;n<t.length;n++){const e=t[n-1],r=t[n];if(e.x+e.w>r.x){const i=e.x+e.w-r.x,d=Math.min(s,Math.ceil(i/2));e.x-=d,r.x+=d,o=!0}}}return t.sort((n,e)=>n.x-e.x),t}const J=[16,15,14,13,12],v={pageWidth:612,pageHeight:792,margin:36,headerOffsetY:0,gutter:18,lyricFamily:"Helvetica",chordFamily:"Courier",lyricSizePt:16,chordSizePt:16,columns:1,ptWindow:J},G=()=>{var t;try{return typeof window<"u"&&((t=window.localStorage)==null?void 0:t.getItem("pdfPlanTrace"))==="1"}catch{return!1}};function Z(t,s,o,f={}){const n=!!f.honorColumnBreaks,e=new Array(s).fill(0),r=Array.from({length:s},()=>[]);let i=0,d="";if(!Array.isArray(t))return{singlePage:!1,colHeights:e,occupancy:e.map(()=>0),balance:1,reasonRejected:"no_sections_provided",placed:r};const m=g=>{if(i+1>=s)return!1;const l=t[g];return l?l.height<=o-e[i+1]:!1};for(let g=0;g<t.length;g++){const l=t[g];if(n&&l.type==="column_break"){m(g+1)&&(i+=1);continue}const $=o-e[i];if(l.height<=$)r[i].push(l.id),e[i]+=l.height;else if(i+1<s){i+=1;const p=o-e[i];if(l.height<=p)r[i].push(l.id),e[i]+=l.height;else return d=`section ${l.id} needs ${Math.ceil(l.height)}pt > remaining ${Math.floor(p)}pt in col ${i+1}`,{singlePage:!1,colHeights:e,occupancy:e.map(u=>u/o),balance:s===2?1-Math.abs(e[0]-e[1])/o:1,reasonRejected:d,placed:r}}else return d=`section ${l.id} needs ${Math.ceil(l.height)}pt > remaining ${Math.floor($)}pt in col ${i+1}`,{singlePage:!1,colHeights:e,occupancy:e.map(p=>p/o),balance:s===2?1-Math.abs(e[0]-e[1])/o:1,reasonRejected:d,placed:r}}return{singlePage:!0,colHeights:e,occupancy:e.map(g=>g/o),balance:s===2?1-Math.abs(e[0]-e[1])/o:1,reasonRejected:void 0,placed:r}}function K({pt:t,cols:s,balance:o,occupancy:f,hasColumnsHint:n}){let e=0;s===2&&Math.min(...f)<.18&&(e+=50),f.some(i=>i>.98)&&(e+=5),n&&s===2&&(e-=3);const r=t*100+o*10-e-(s===2?2:0);return{penalties:e,finalScore:r}}const H=typeof window<"u"&&(()=>{try{return localStorage.getItem("pdfPlanTrace")==="1"}catch{return!1}})();function _(t){if(!t)return{sections:[],meta:{}};if(typeof t=="string")try{const s=q(t),o=s.blocks.map(f=>({header:f.section,blocks:[{type:"section",header:f.section},...f.lines.map(n=>({type:"line",lyrics:n.text,chords:n.chords}))]}));return{...s.meta,sections:o}}catch{return{sections:[],meta:{}}}if(typeof t=="object"){if(Array.isArray(t==null?void 0:t.lyricsBlocks)){const{title:s,key:o,capo:f,layoutHints:n,meta:e,lyricsBlocks:r}=t,i=r.map(d=>({label:d.section,lines:(d.lines||[]).map(m=>({lyrics:m.plain,chords:m.chordPositions,comment:m.comment}))}));return{title:s,key:o,capo:f,layoutHints:n,...e||{},sections:i}}return t}return{sections:[],meta:{}}}function D(t,s,o,{honorColumnBreaks:f}={}){const n=Array.from({length:s},()=>[]),e=Array(s).fill(0);let r=0;for(let m=0;m<t.length;m++){const g=t[m],l=g.h,$=g.hNoPad;if(l>o)return{singlePage:!1,colHeights:e,occupancy:e.map(u=>u/o),balance:s===2?0:1,placed:n,reasonRejected:`section ${m} height ${l}pt > column ${o}pt`};f&&g.breakBefore&&r<s-1&&e[r]>0&&l<=o&&r++;let p=o-e[r];if(l<=p)n[r].push(m),e[r]+=l;else if($<=p){if(n[r].push(m),e[r]+=$,r++,r>=s&&m<t.length-1)return{singlePage:!1,colHeights:e,occupancy:e.map(u=>u/o),balance:s===2?1-Math.abs(e[0]-e[1])/o:1,placed:n,reasonRejected:`section ${m+1} needs ${l}pt > remaining ${p}pt in col ${s}`}}else{if(r++,r>=s)return{singlePage:!1,colHeights:e,occupancy:e.map(u=>u/o),balance:s===2?1-Math.abs(e[0]-e[1])/o:1,placed:n,reasonRejected:`section ${m} needs ${l}pt > remaining ${p}pt in col ${r}`};m--;continue}if(r>=s)break}const i=e.map(m=>m/o),d=s===2?1-Math.abs(e[0]-e[1])/o:1;return{singlePage:!0,colHeights:e,occupancy:i,balance:d,placed:n}}function Q(t,s,o,f,n,e){if(!(t!=null&&t.sections))return!1;const r=f.pageWidth-f.margin*2,i=s===2?(r-f.gutter)/2:r,d=n(o),m=e(o);for(const g of t.sections)for(const l of g.lines||[]){if(l.comment){if(d(l.comment)>i)return!0;continue}const $=l.lyrics||"";let p=d($);const u=(l.chords||[]).map(x=>({x:d($.slice(0,x.index||0)),w:m(x.sym||"")}));L(u);for(const x of u)x.x+x.w>p&&(p=x.x+x.w);if(p>i)return!0}return!1}function V(t,s={},o=()=>()=>0,f=()=>()=>0){var A,O;const n=_(t),e={...v,...s,gutter:v.gutter},r=[16,15,14,13,12],i=((A=n.layoutHints)==null?void 0:A.requestedColumns)===2,d=e.pageHeight-(e.margin+e.headerOffsetY)-e.margin,m={},g=((O=n.layoutHints)==null?void 0:O.columnBreakAfter)||[],l=c=>{if(m[c])return m[c];const S=4,j=Math.round(c*.85),b=Math.max(10,c-2),C=(n.sections||[]).map((k,a)=>{var y,P;let h=j+c;for(const F of k.lines||[])F.comment?h+=b+3:((y=F==null?void 0:F.chords)!=null&&y.length&&(h+=c+S/2),h+=c+S);return(P=k.lines)!=null&&P.length||(h+=c),h+=4,{h,hNoPad:h-4,breakBefore:g.includes(a)}});return m[c]=C,H&&console.log("sectionHeights pt",c,C.map(k=>k.h)),C},$=[];for(const c of r)for(const S of[1,2]){const j=l(c),b=D(j,S,d,{honorColumnBreaks:!0}),C=!Q(n,S,c,e,o,f);let k=0;S===2&&Math.min(...b.occupancy)<.18&&(k+=50),b.occupancy.some(h=>h>.98)&&(k+=5),i&&S===2&&(k-=3);const a=c*100+b.balance*10-k-(S===2?2:0);$.push({pt:c,cols:S,singlePage:b.singlePage&&C,colHeights:b.colHeights,occupancy:b.occupancy,balance:b.balance,penalties:k,finalScore:a,reasonRejected:C?b.reasonRejected:"width overflow",placed:b.placed})}H&&(console.table($.map(c=>({pt:c.pt,cols:c.cols,singlePage:c.singlePage,colHeights:c.colHeights.map(S=>Number(S.toFixed(1))),occupancy:c.occupancy.map(S=>Number(S.toFixed(2))),balance:Number(c.balance.toFixed(2)),penalties:c.penalties,finalScore:Number(c.finalScore.toFixed(2)),reasonRejected:c.reasonRejected||""}))),console.log("contentH",d,"gutter",e.gutter));const p=$.filter(c=>c.singlePage);if(p.length){const c=p.sort((w,W)=>W.finalScore-w.finalScore)[0],S=c.occupancy.map(w=>w.toFixed(2)).join(","),j=`Plan: ${c.cols} col • ${c.pt}pt • singlePage=yes • occ=[${S}] • bal=${c.balance.toFixed(2)}`,b=e.margin,C=e.pageWidth-b*2,k=c.cols===2?(C-e.gutter)/2:C,a=o(c.pt),h=f(c.pt),y=(w,W)=>{const R=[];for(const E of W){const I=n.sections[E];R.push({type:"section",header:I.label||I.kind});for(const M of I.lines||[])if(M.comment)R.push({type:"line",comment:M.comment});else{const Y=(M.chords||[]).map(N=>({x:a((M.lyrics||"").slice(0,N.index||0)),w:h(N.sym||""),sym:N.sym}));L(Y),R.push({type:"line",lyrics:M.lyrics||"",chords:Y})}}return{x:w,blocks:R}},P=[y(b,c.placed[0]||[])];c.cols===2&&P.push(y(b+k+e.gutter,c.placed[1]||[]));const F={pages:[{columns:P}]};return{plan:{lyricFamily:e.lyricFamily,chordFamily:e.chordFamily,lyricSizePt:c.pt,chordSizePt:c.pt,columns:c.cols,margin:e.margin,headerOffsetY:e.headerOffsetY,gutter:e.gutter,layout:F,debugFooter:j}}}const u=12;let x=T(n,{...e,columns:1,lyricSizePt:u,chordSizePt:u},o(u),f(u)),z={...e,columns:1,lyricSizePt:u,chordSizePt:u,layout:x};return X(z)||(x=T(n,{...e,columns:2,lyricSizePt:u,chordSizePt:u},o(u),f(u)),z={...e,columns:2,lyricSizePt:u,chordSizePt:u,layout:x}),z.debugFooter=`Plan: ${z.columns} col • ${z.lyricSizePt}pt • singlePage=${z.layout.pages.length===1?"yes":"no"}`,{plan:z}}function X(t){var s,o;return(((o=(s=t==null?void 0:t.layout)==null?void 0:s.pages)==null?void 0:o.length)||99)<=2}function T(t,s={},o=n=>0,f=n=>0){var j,b,C,k;const n=_(t),e=Array.isArray(n.sections)?n.sections:[],r={...v,...s,gutter:v.gutter},i=r.margin,d=r.pageWidth-i*2;e.length||e.push({header:"Section",blocks:[]});const m=(a,h)=>{const y=makeLyric(a);try{return y(h||"")}catch{return 0}},g=(a,h)=>{const y=makeChord(a);try{return y(h||"")}catch{return 0}},l=a=>{const y=Math.round(a*.85);return e.map((P,F)=>{let B=y;for(const w of P.blocks)if(w.type!=="section"&&w.type==="line"){if(w.comment){const W=Math.max(10,a-2);m(W,w.comment),B+=W;continue}Array.isArray(w.chords)&&w.chords.length&&(g(a,w.chords.map(W=>(W==null?void 0:W.sym)||"").join(" ")),B+=a+4/2),m(a,w.lyrics||""),B+=a+4}return B<y+a&&(B=y+a),{id:F+1,type:"section",height:B,header:P.header}})},$=((j=n==null?void 0:n.meta)==null?void 0:j.columns)===2||((b=n==null?void 0:n.hints)==null?void 0:b.columns)===2,p=[];for(const a of(v==null?void 0:v.ptWindow)||[16,15,14,13,12]){const h=l(a);for(const y of[1,2]){const P=Z(h,y,contentHeight,{honorColumnBreaks:!0});if(!P.singlePage)continue;const{penalties:F,finalScore:B}=K({pt:a,cols:y,balance:P.balance,occupancy:P.occupancy,hasColumnsHint:$});p.push({pt:a,cols:y,pack:P,penalties:F,finalScore:B})}}if(!p.length){const a={lyricFamily:oBase.lyricFamily||"Helvetica",chordFamily:oBase.chordFamily||"Courier",lyricSizePt:12,chordSizePt:12,columns:1,margin:i,headerOffsetY,gutter,layout:{pages:[]},debugFooter:G()?"Plan: 1 col • 12pt • singlePage=no":void 0};return a.layout.pages=[{columns:[{x:i,blocks}]},{columns:[{x:i,blocks:[]}]}],{plan:a}}p.sort((a,h)=>h.finalScore-a.finalScore);const u=p[0],x=u.pt,z=u.cols,A=z===2?(d-gutter)/2:d,O=e.map(a=>a.blocks),c={columns:[]};for(let a=0;a<z;a++){const h=u.pack.placed[a]||[],y=[];for(const P of h){const F=O[P-1]||[];(!F.length||((C=F[0])==null?void 0:C.type)!=="section")&&y.push({type:"section",header:((k=e[P-1])==null?void 0:k.header)||`Section ${P}`}),y.push(...F)}c.columns.push({x:i+a*(A+(a?gutter:0)),blocks:y})}return{plan:{lyricFamily:oBase.lyricFamily||"Helvetica",chordFamily:oBase.chordFamily||"Courier",lyricSizePt:x,chordSizePt:x,columns:z,margin:i,headerOffsetY,gutter,layout:{pages:[c]},debugFooter:G()?`Plan: ${z} col • ${x}pt • singlePage=yes • occ=${JSON.stringify(u.pack.occupancy.map(a=>a.toFixed(2)))} • bal=${u.pack.balance.toFixed(2)}`:void 0}}}const te=Object.freeze(Object.defineProperty({__proto__:null,DEFAULT_LAYOUT_OPT:v,chooseBestLayout:V,normalizeSongInput:_,packIntoColumns:D,planSongLayout:T},Symbol.toStringTag,{value:"Module"}));export{v as D,te as a,V as c,ee as m,_ as n,T as p};
