const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-Dx-f-6x9.js","./index-Dz36KVwe.js","./index-Dn9xl_Gr.css","./jszip.min-Dm8UVTpG.js"])))=>i.map(i=>d[i]);
import{r as d,i as ge,F as ye,j as e,B as je,P as M,S as be,C as Se,T as we,a as F,K as ve,A as Ne,b as Ce,R as Ie,D as W,L as Pe,c as ke,h as $e,t as z,_ as X,f as Ke,p as De,s as Te,n as Ae,d as Le}from"./index-Dz36KVwe.js";const V="gracechords.sets.v1";function P(){try{const i=localStorage.getItem(V);return i?JSON.parse(i):{sets:{}}}catch{return{sets:{}}}}function Y(i){localStorage.setItem(V,JSON.stringify(i))}function Oe(){return typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():"id-"+Math.random().toString(36).slice(2)+Date.now().toString(36)}function C(){const{sets:i}=P();return Object.values(i).sort((l,m)=>(m.updatedAt||0)-(l.updatedAt||0))}function q(i){const{sets:l}=P();return l[i]||null}function I(i){const l=Date.now(),m={id:i.id||Oe(),name:i.name?.trim()||"Untitled Set",items:Array.isArray(i.items)?i.items:[],createdAt:i.createdAt||l,updatedAt:l},S=P();return S.sets[m.id]=m,Y(S),m}function _e(i){const l=P();return l.sets[i]?(delete l.sets[i],Y(l),!0):!1}function Ee(i){const l=q(i);return l?I({name:`Copy of ${l.name}`,items:l.items.map(m=>({...m}))}):null}let H;const J=()=>H||(H=X(()=>import("./index-Dx-f-6x9.js").then(i=>i.i),__vite__mapDeps([0,1,2]),import.meta.url));function Re(){const[i,l]=d.useState("Untitled Set"),[m,S]=d.useState(""),[p,G]=d.useState([]),[j,Q]=d.useState(()=>{try{return localStorage.getItem("pref:icpOnly")==="1"}catch{return!1}});d.useEffect(()=>{try{localStorage.setItem("pref:icpOnly",j?"1":"0")}catch{}},[j]);const[a,h]=d.useState([]),[D,Z]=d.useState({}),[k,w]=d.useState(""),T=Object.keys(D).length,[$,A]=d.useState(!1),[x,g]=d.useState(null),[ee,L]=d.useState(()=>C()),[te,v]=d.useState("");d.useEffect(()=>{G(ge?.items||[])},[]),d.useEffect(()=>{let t=!1;async function s(){const n={};for(const o of a){const c=p.find(b=>b.id===o.id);if(!c)continue;const r=c.filename.replace(/\.chordpro$/i,""),u=`./pptx/${r}.pptx`;await $e(u,r)&&(n[r]=!0)}t||Z(n)}return s(),()=>{t=!0}},[a,p]),d.useEffect(()=>{try{const t=localStorage.getItem("setlist");if(!t||C().length>0)return;const s=JSON.parse(t);if(s?.name||(s?.list?.length||0)>0){const n=I({name:s.name||"Imported Set",items:s.list||[]});L(C()),g(n.id),l(n.name),h(n.items||[]),v(n.id)}}catch{}},[]);const K=d.useMemo(()=>new ye(p,{keys:["title","tags"],threshold:.4}),[p]);function ne(t){return!j||(Array.isArray(t.tags)?t.tags.includes("ICP"):t.tags==="ICP")}const se=d.useMemo(()=>(m?K.search(m).map(s=>s.item):p.slice().sort((s,n)=>s.title.localeCompare(n.title))).filter(ne),[m,K,p,j]);function ie(t){a.find(s=>s.id===t.id)||h([...a,{id:t.id,toKey:t.originalKey||"C"}])}function ae(t){h(a.filter(s=>s.id!==t))}function O(t,s){const n=a.findIndex(u=>u.id===t);if(n<0)return;const o=n+(s==="up"?-1:1);if(o<0||o>=a.length)return;const c=a.slice(),[r]=c.splice(n,1);c.splice(o,0,r),h(c)}function oe(t,s){h(a.map(n=>n.id===t?{...n,toKey:s}:n))}function _(t){h(s=>s.map(n=>{const o=p.find(r=>r.id===n.id),c=n.toKey||o?.originalKey||"C";return{...n,toKey:z(c,t)}}))}function le(){h(t=>t.map(s=>{const n=p.find(o=>o.id===s.id);return{...s,toKey:n?.originalKey||"C"}}))}function N(t){L(C()),v(t||"")}function E(){g(null),l("Untitled Set"),h([]),v("")}function ce(){const t=i?.trim()||"Untitled Set",s=I({id:x,name:t,items:a});l(s.name),g(s.id),N(s.id)}function re(t){const s=t.target.value;if(v(s),!s)return;const n=q(s);n&&(g(n.id),l(n.name||"Untitled Set"),h(n.items||[]))}function de(){if(!x){const s=`Copy of ${i||"Untitled Set"}`,n=I({id:null,name:s,items:a});l(n.name),g(n.id),N(n.id);return}const t=Ee(x);t&&(g(t.id),l(t.name),h(t.items||[]),N(t.id))}function ue(){x&&window.confirm(`Delete set "${i}"? This cannot be undone.`)&&(_e(x),E(),N(""))}async function me(){A(!0);try{const{downloadMultiSongPdf:t}=await J(),s=[];for(const n of a){const o=p.find(c=>c.id===n.id);if(o)try{const c=`./songs/${o.filename}`,r=await Ke(c),u=De(r),f=u.meta?.key||u.meta?.originalkey||o.originalKey||"C",b=Te(f,n.toKey||f),he=(u.sections||[]).map(R=>({section:R.label,lines:(R.lines||[]).map(y=>({plain:y.comment?y.comment:y.lyrics||"",chordPositions:(y.chords||[]).map(B=>({sym:z(B.sym,b),index:B.index})),comment:y.comment?y.comment:void 0}))})),fe=o.filename.replace(/\.chordpro$/i,""),xe=Ae({title:u.meta?.title||o.title||fe,key:n.toKey||f,capo:u.meta?.capo,lyricsBlocks:he});s.push(xe)}catch(c){console.error(c),Le(`Failed to process ${o.filename}`)}}s.length&&await t(s)}finally{A(!1)}}function U(){J()}async function pe(){w(`Bundling 0/${a.length}…`);const t=(await X(async()=>{const{default:o}=await import("./jszip.min-Dm8UVTpG.js").then(c=>c.j);return{default:o}},__vite__mapDeps([3,1,2]),import.meta.url)).default,s=new t;let n=0;for(let o=0;o<a.length;o++){const c=a[o],r=p.find(f=>f.id===c.id);if(!r){w(`Bundling ${o+1}/${a.length}…`);continue}w(`Bundling ${o+1}/${a.length}…`);const u=r.filename.replace(/\.chordpro$/i,"");if(D[u])try{const f=await fetch(`./pptx/${u}.pptx`);if(!f.ok)continue;const b=await f.blob();n++,s.file(`${String(n).padStart(2,"0")}-${u}.pptx`,b)}catch{}}if(n>0){const o=await s.generateAsync({type:"blob"}),c=new Date().toISOString().slice(0,10).replace(/-/g,""),r=document.createElement("a");r.href=URL.createObjectURL(o),r.download=`setlist-pptx-${c}.zip`,r.click(),URL.revokeObjectURL(r.href)}w("")}return e.jsxs("div",{className:"container",children:[e.jsx(je,{busy:$}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx("div",{}),e.jsx("h1",{style:{margin:0},children:"Setlist Builder"}),e.jsx("div",{})]}),e.jsxs("div",{className:"card toolbar",style:{marginTop:12},children:[e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx("span",{children:"Set:"}),e.jsx("input",{"aria-label":"Set name",value:i,onChange:t=>l(t.target.value),style:{minWidth:220},placeholder:"Sunday AM"})]}),e.jsxs("select",{"aria-label":"Saved sets",value:te,onChange:re,children:[e.jsx("option",{value:"",children:"— Load saved set —"}),ee.map(t=>e.jsxs("option",{value:t.id,children:[t.name," · ",new Date(t.updatedAt).toLocaleString()]},t.id))]}),e.jsxs("button",{className:"btn iconbtn",onClick:E,title:"New set",children:[e.jsx(M,{}),e.jsx("span",{className:"text-when-wide",children:"New"})]}),e.jsxs("button",{className:"btn primary iconbtn",onClick:ce,title:"Save set",children:[e.jsx(be,{}),e.jsx("span",{className:"text-when-wide",children:"Save"})]}),e.jsxs("button",{className:"btn iconbtn",onClick:de,disabled:!a.length,title:"Duplicate set",children:[e.jsx(Se,{}),e.jsx("span",{className:"text-when-wide",children:"Duplicate"})]}),e.jsxs("button",{className:"btn iconbtn",onClick:ue,disabled:!x,title:"Delete set",children:[e.jsx(we,{}),e.jsx("span",{className:"text-when-wide",children:"Delete"})]}),e.jsxs("div",{style:{marginLeft:"auto",display:"flex",alignItems:"center",gap:6},children:[e.jsx("span",{className:"meta",children:"Transpose:"}),e.jsx("button",{className:"btn",onClick:()=>_(-1),title:"Transpose set down 1 semitone",children:"–1"}),e.jsx("button",{className:"btn",onClick:le,title:"Reset all to originals",children:"Reset"}),e.jsx("button",{className:"btn",onClick:()=>_(1),title:"Transpose set up 1 semitone",children:"+1"})]})]}),e.jsxs("div",{className:"BuilderPage",style:{marginTop:12},children:[e.jsx("div",{className:"BuilderLeft",children:e.jsx("div",{className:"card",children:e.jsxs("div",{style:{marginTop:8},children:[e.jsx("strong",{children:"Add songs"}),e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",marginTop:6},children:[e.jsx("input",{value:m,onChange:t=>S(t.target.value),placeholder:"Search...",style:{flex:1}}),e.jsxs("label",{className:"row",style:{gap:6,alignItems:"center"},children:[e.jsx("input",{type:"checkbox",checked:j,onChange:t=>Q(t.target.checked)}),e.jsx("span",{className:"meta",title:"Limit results to songs tagged ICP",children:"ICP only"})]})]}),e.jsx("div",{style:{minHeight:0,maxHeight:300,overflow:"auto",marginTop:6},children:K?se.map(t=>e.jsx(F,{title:t.title,subtitle:`${t.originalKey||""}${t.tags?.length?` • ${t.tags.join(", ")}`:""}`,rightSlot:e.jsxs("button",{className:"btn iconbtn",onClick:()=>ie(t),title:"Add to set",children:[e.jsx(M,{}),e.jsx("span",{className:"text-when-wide",children:"Add"})]})},t.id)):e.jsx("div",{children:"Loading search…"})})]})})}),e.jsx("div",{className:"BuilderRight",children:e.jsxs("div",{className:"card",children:[e.jsxs("strong",{children:["Current setlist (",a.length,")"]}),e.jsx("div",{style:{minHeight:0,maxHeight:360,overflow:"auto",marginTop:6},children:a.map(t=>{const s=p.find(n=>n.id===t.id);return s?e.jsx(F,{title:s.title,subtitle:`Original: ${s.originalKey||"—"}`,rightSlot:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx("select",{value:t.toKey,onChange:n=>oe(t.id,n.target.value),children:ve.map(n=>e.jsx("option",{value:n,children:n},n))}),e.jsx("button",{className:"btn",onClick:()=>O(t.id,"up"),title:"Move up",children:e.jsx(Ne,{})}),e.jsx("button",{className:"btn",onClick:()=>O(t.id,"down"),title:"Move down",children:e.jsx(Ce,{})}),e.jsx("button",{className:"btn",onClick:()=>ae(t.id),title:"Remove",children:e.jsx(Ie,{})})]})},t.id):null})}),e.jsxs("div",{style:{display:"flex",gap:8,marginTop:8,flexWrap:"wrap"},children:[e.jsx("button",{className:"btn primary iconbtn",onClick:me,onMouseEnter:U,onFocus:U,disabled:$,title:"Export set as a single PDF",children:$?"Exporting…":e.jsxs(e.Fragment,{children:[e.jsx(W,{})," ",e.jsx("span",{className:"text-when-wide",children:"Export PDF"}),e.jsx("span",{className:"text-when-narrow",children:"PDF"})]})}),e.jsxs(Pe,{className:"btn iconbtn",to:a.length?`/worship/${a.map(t=>t.id).join(",")}?toKeys=${a.map(t=>encodeURIComponent(t.toKey)).join(",")}`:"#",title:a.length?"Open Worship Mode with this set":"Add songs to open Worship Mode","aria-disabled":!a.length,onClick:t=>{a.length||t.preventDefault()},children:[e.jsx("span",{className:"text-when-wide",children:"Open in Worship Mode"}),e.jsx("span",{className:"text-when-narrow",children:"Worship"})]}),e.jsx("button",{className:"btn iconbtn",onClick:pe,disabled:T===0||!!k,title:T===0?"No PPTX files found for this set.":"Bundle PPTX files for selected songs",children:k||e.jsxs(e.Fragment,{children:[e.jsx(W,{})," ",e.jsx("span",{className:"text-when-wide",children:"Bundle PPTX"}),e.jsx("span",{className:"text-when-narrow",children:"PPTX"})]})}),e.jsxs("button",{className:"btn iconbtn",onClick:()=>h([]),title:"Clear setlist",children:[e.jsx(ke,{}),e.jsx("span",{className:"text-when-wide",children:"Clear"})]})]}),e.jsxs("div",{className:"print-only",style:{marginTop:16},children:[e.jsx("h2",{style:{fontSize:"20pt",margin:"0 0 8pt 0"},children:i}),e.jsx("ol",{style:{fontSize:"12pt",lineHeight:1.4,paddingLeft:"1.2em"},children:a.map(t=>{const s=p.find(n=>n.id===t.id);return s?e.jsxs("li",{children:[s.title," — ",t.toKey||s.originalKey||"—"]},t.id):null})})]})]})})]})]})}export{Re as default};
