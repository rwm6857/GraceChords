import{p as X,ax as Z,W as z,aG as Q,X as tt}from"./index-BILHNeZE.js";let I=null;async function et(){if(I)return I;const e=X("fonts/"),n=[{family:"NotoSans",weight:"400",style:"normal",file:"NotoSans-Regular.ttf"},{family:"NotoSans",weight:"700",style:"normal",file:"NotoSans-Bold.ttf"},{family:"NotoSans",weight:"400",style:"italic",file:"NotoSans-Italic.ttf"},{family:"NotoSans",weight:"700",style:"italic",file:"NotoSans-BoldItalic.ttf"},{family:"NotoSansMono",weight:"400",style:"normal",file:"NotoSansMono-Regular.ttf"},{family:"NotoSansMono",weight:"700",style:"normal",file:"NotoSansMono-Bold.ttf"}];return I=Promise.all(n.map(async i=>{const l=await new FontFace(i.family,`url(${e}${i.file})`,{weight:i.weight,style:i.style}).load();document.fonts.add(l)})).then(()=>({lyricFamily:"NotoSans",chordFamily:"NotoSansMono"})).catch(()=>({lyricFamily:"Helvetica",chordFamily:"Courier"})),I}const H={w:612,h:792},nt={left:36},ot=24,L=26,it=16,R=[16,15,14,13,12],rt=1.04,st=1,v=1.2,G=.75,O=8,lt=.85,ct=1.125;function at(e){return(e||"").toLowerCase().replace(/[^\w]+/g,"_").replace(/_+/g,"_").replace(/^_|_$/g,"")}function ft(e){const n=[],i=Array.isArray(e?.sections)?e.sections:[];for(const s of i){const l=[];for(const o of s?.lines||[])l.push({plain:String(o?.plain??o?.lyrics??""),chords:(o?.chordPositions??o?.chords??[]).map(t=>({sym:String(t?.sym||""),index:Math.max(0,t?.index|0)})),comment:o?.comment?String(o.comment):"",instrumental:o?.instrumental});n.push({label:String(s?.label||s?.kind||""),lines:l})}return n}function ut(e){const n=e?e(1,1):typeof document<"u"?document.createElement("canvas"):null;if(!n)throw new Error("Canvas unavailable. Provide createCanvas in options.");const i=n.getContext("2d");if(!i||typeof i.measureText!="function")throw new Error("Canvas 2D context unavailable for JPG planning.");return i}function D(e="",n=0,i=()=>0){const s=String(e||"");if(!s.length)return[{text:"",start:0,end:0}];const l=[],o=Math.max(1,n);let t=0;for(;t<s.length;){for(;t<s.length&&s[t]===" ";)t+=1;if(t>=s.length)break;let a=t+1,y=s.length,m=t+1;for(;a<=y;){const h=Math.floor((a+y)/2),u=s.slice(t,h);i(u)<=o||h===t+1?(m=h,a=h+1):y=h-1}let f=m;if(f<s.length){const h=s.lastIndexOf(" ",f-1);h>t&&(f=h)}let x=s.slice(t,f).replace(/\s+$/g,"");x||(f=Math.min(s.length,t+1),x=s.slice(t,f)),l.push({text:x,start:t,end:f}),t=f}return l.length?l:[{text:"",start:0,end:0}]}function Y(e="",n=[],i=0,s=()=>0){const l=D(e,i,s),o=(n||[]).map(t=>({sym:String(t?.sym||""),index:Math.max(0,t?.index|0)})).sort((t,a)=>t.index-a.index);return l.map((t,a)=>{const y=a===l.length-1,m=o.filter(f=>f.index>=t.start&&(f.index<t.end||y&&f.index===t.end));return{lyric:t.text,chords:m,start:t.start,end:t.end}})}function ht(e,n,i,s){const l=D(String(e||""),s,i),o=Math.max(1,l.length),t=L+Math.max(0,o-1)*(L*rt),a=n?L*lt:0,y=n?it*st:0;return Math.ceil(t+a+y)}function b(e,n,i,s,l){return ht(e,n,s,l)+Math.ceil(i*v*ct)}function N(e,n,i,s,l){let o=0;const t=i*v;e?.label&&(o+=t);for(const a of e?.lines||[]){if(a.instrumental){const m=z(a.instrumental,{split:s===2});o+=Math.max(1,m.length)*t;continue}if(a.comment){o+=t;continue}const y=Y(a.plain||"",a.chords||[],n,l);for(const m of y)(m.chords||[]).length&&(o+=t*G),o+=t}return o+O}function W(e,{columns:n,bodyPt:i,pageW:s,pageH:l,margin:o,gutter:t,title:a,key:y,measureLyric:m}){const f=s-o*2,x=n===2?(f-t)/2:f,h=b(a,y,i,m,f),u=l-o-o-h;if(u<=0)return!1;const w=e.map(p=>N(p,x,i,n,m));if(n===1)return w.reduce((r,c)=>r+c,0)<=u;let g=u,C=u;for(const p of w){if(p<=g){g-=p;continue}if(p<=C){C-=p;continue}return!1}return!0}function B(e,{columns:n,bodyPt:i,pageW:s,pageH:l,margin:o,gutter:t,title:a,key:y,measureLyric:m}){const f=s-o*2,x=n===2?(f-t)/2:f,h=b(a,y,i,m,f),u=l-o-o-h;if(u<=0)return null;const w={columns:n,fontPt:i,lineH:i*v,pages:[{columns:n===2?[[],[]]:[[]]}]},g=w.pages[0].columns;if(n===1){let r=u;for(let c=0;c<e.length;c+=1){const d=N(e[c],x,i,n,m);if(d>r)return null;g[0].push(c),r-=d}return w}let C=u,p=u;for(let r=0;r<e.length;r+=1){const c=N(e[r],x,i,n,m);if(c<=C){g[0].push(r),C-=c;continue}if(c<=p){g[1].push(r),p-=c;continue}return null}return w}function mt(e,{bodyPt:n,pageW:i,pageH:s,margin:l,title:o,key:t,measureLyric:a}){const m=i-l*2,f=m,x=s-l-l-b(o,t,n,a,m),h=s-l-l,u={columns:1,fontPt:n,lineH:n*v,pages:[{columns:[[]]}]};let w=0,g=x;for(let C=0;C<e.length;C+=1){const p=N(e[C],f,n,1,a);if(p<=g){u.pages[w].columns[0].push(C),g-=p;continue}w+=1,u.pages.push({columns:[[]]}),g=h,u.pages[w].columns[0].push(C),g-=p}return u}function yt({song:e,sections:n,packed:i,pageW:s,margin:l,gutter:o,lyricFamily:t,chordFamily:a,makeMeasureLyricAt:y,makeMeasureChordAt:m}){const f=String(e?.title||e?.meta?.title||"Untitled"),x=String(e?.key||e?.meta?.key||""),h=i.fontPt,u=i.columns,w=i.lineH||h*v,g=s-l*2,C=u===2?(g-o)/2:g,p=y(h),r=m(h),c=b(f,x,h,p,g),d=(i.pages||[]).map(T=>{const S=[],P=Array.isArray(T?.columns)?T.columns:[[]];for(let E=0;E<u;E+=1){const M=P[E]||[],F=[];for(const K of M){const A=n[K];if(A){A.label&&F.push({type:"section",header:A.label});for(const $ of A.lines||[]){if($.instrumental){F.push({type:"instrumental",instrumental:{chords:Array.isArray($.instrumental?.chords)?$.instrumental.chords.slice():[],repeat:typeof $.instrumental?.repeat=="number"?$.instrumental.repeat:void 0}});continue}if($.comment){F.push({type:"line",comment:$.comment});continue}const j=Y($.plain||"",$.chords||[],C,p);for(const _ of j){const U=(_.chords||[]).map(k=>{const J=Math.min(Math.max(0,k.index-(_.start||0)),_.lyric.length),q=p(_.lyric.slice(0,J)),V=r(k.sym||"");return{sym:k.sym,x:q,w:V}});tt(U),F.push({type:"line",lyrics:_.lyric,chords:U})}}F.push({type:"spacer",height:O})}}S.push({x:l+E*(C+o),blocks:F})}return{columns:S}});return{engine:"pdf_mvp_like",lyricFamily:t,chordFamily:a,lyricSizePt:h,chordSizePt:h,columns:u,lineH:w,margin:l,headerOffsetY:c,gutter:o,layout:{pages:d},title:f,key:x}}function dt(e,n={}){const i=Z(e),s=n.lyricFamily||n.fonts?.lyricFamily||"Helvetica",l=n.chordFamily||n.fonts?.chordFamily||"Courier",o=Number(n.pageWidthPt)>0?Number(n.pageWidthPt):H.w,t=Number(n.pageHeightPt)>0?Number(n.pageHeightPt):H.h,a=Number(n.marginPt)>=0?Number(n.marginPt):nt.left,y=Number(n.gutterPt)>=0?Number(n.gutterPt):ot,m=ft(i),f=String(i?.title||i?.meta?.title||"Untitled"),x=String(i?.key||i?.meta?.key||""),h=ut(n.createCanvas),u=r=>c=>(h.font=`${r}px ${s}`,h.measureText(c||"").width),w=r=>c=>(h.font=`bold ${r}px ${l}`,h.measureText(c||"").width);let g=null;for(const r of R){const c=u(r);if(W(m,{columns:1,bodyPt:r,pageW:o,pageH:t,margin:a,gutter:y,title:f,key:x,measureLyric:c})){g=B(m,{columns:1,bodyPt:r,pageW:o,pageH:t,margin:a,gutter:y,title:f,key:x,measureLyric:c});break}}if(!g)for(const r of R){const c=u(r);if(W(m,{columns:2,bodyPt:r,pageW:o,pageH:t,margin:a,gutter:y,title:f,key:x,measureLyric:c})){g=B(m,{columns:2,bodyPt:r,pageW:o,pageH:t,margin:a,gutter:y,title:f,key:x,measureLyric:c});break}}g||(g=mt(m,{bodyPt:15,pageW:o,pageH:t,margin:a,title:f,key:x,measureLyric:u(15)}));const C=yt({song:i,sections:m,packed:g,pageW:o,margin:a,gutter:y,lyricFamily:s,chordFamily:l,makeMeasureLyricAt:u,makeMeasureChordAt:w}),p={pages:g?.pages?.length||0,columns:g?.columns||1,size:g?.fontPt||12};return p.pages>1?{error:"MULTI_PAGE",plan:C,summary:p}:{plan:C,summary:p}}function gt(e,{pxWidth:n,pxHeight:i,dpi:s=150,createCanvas:l}={}){const o=l?l(n,i):typeof document<"u"?document.createElement("canvas"):null;if(!o)throw new Error("Canvas unavailable. Provide createCanvas in options.");o.width=n,o.height=i;const t=o.getContext("2d");t.fillStyle="#fff",t.fillRect(0,0,o.width,o.height);const a=s/72;t.scale(a,a);const y=e.margin,m=Math.max(22,e.lyricSizePt+6),f=Math.max(12,e.lyricSizePt-2);t.fillStyle="#000",t.font=`bold ${m}px ${e.lyricFamily}`,t.fillText(String(e.title||"Untitled"),y,y+24),t.font=`italic ${f}px ${e.lyricFamily}`;const x=String(e.key||"â€”");t.fillText(`Key of ${x}`,y,y+40);const h=4,u=e.lyricSizePt,w=Math.round(e.lyricSizePt*.85),g=y+(e.headerOffsetY||m*1.05+f*1.05+12),p=(e.layout.pages||[])[0];if(e?.engine==="pdf_mvp_like"){const r=e.lineH||e.lyricSizePt*v,c=y+(e.headerOffsetY||0);return p.columns.forEach(d=>{const T=d.x;let S=c;d.blocks.forEach(P=>{if(P.type==="section"){P.header&&(t.font=`bold ${e.lyricSizePt}px ${e.lyricFamily}`,t.fillStyle="#000",t.fillText(`[${String(P.header).toUpperCase()}]`,T,S),S+=r);return}if(P.type==="spacer"){S+=typeof P.height=="number"?P.height:O;return}if(P.type==="instrumental"){const E=z(P.instrumental||{},{split:e.columns===2});E.length&&(t.font=`bold ${e.chordSizePt}px ${e.chordFamily}`,t.fillStyle="#000",E.forEach(M=>{t.fillText(M,T,S),S+=r}));return}if(P.type==="line"){if(P.comment){t.font=`italic ${e.lyricSizePt}px ${e.lyricFamily}`;const E=t.fillStyle;t.fillStyle="#6b7280",t.fillText(P.comment,T,S),t.fillStyle=E,S+=r;return}P.chords?.length&&(t.font=`bold ${e.chordSizePt}px ${e.chordFamily}`,P.chords.forEach(E=>t.fillText(E.sym,T+E.x,S)),S+=r*G),t.font=`normal ${e.lyricSizePt}px ${e.lyricFamily}`,t.fillStyle="#000",t.fillText(P.lyrics||"",T,S),S+=r}})}),o}return p.columns.forEach(r=>{let c=r.x,d=g;r.blocks.forEach(T=>{if(T.type==="section")d+=w,t.font=`bold ${u}px ${e.lyricFamily}`,t.fillText(`[${T.header}]`,c,d),d+=u+4;else if(T.type==="instrumental"){const S=z(T.instrumental||{},{split:e.columns===2});S.length&&(t.font=`bold ${e.chordSizePt}px ${e.chordFamily}`,t.fillStyle="#000",S.forEach(P=>{t.fillText(P,c,d),d+=e.lyricSizePt+h}))}else if(T.type==="line"){if(T.comment){t.font=`italic ${e.lyricSizePt}px ${e.lyricFamily}`;const S=t.fillStyle;t.fillStyle="#6b7280",t.fillText(T.comment,c,d),t.fillStyle=S,d+=e.lyricSizePt+h;return}T.chords?.length&&(t.font=`bold ${e.chordSizePt}px ${e.chordFamily}`,T.chords.forEach(S=>t.fillText(S.sym,c+S.x,d)),d+=e.chordSizePt+h/2),t.font=`normal ${e.lyricSizePt}px ${e.lyricFamily}`,t.fillText(T.lyrics,c,d),d+=e.lyricSizePt+h}})}),o}async function xt(e,n={}){const i=n.dpi||150,s=n.widthInches||8.5,l=n.heightInches||11,o=n.createCanvas,t=n.fonts,a=typeof n.quality=="number"?n.quality:.92,y=Math.round(s*i),m=Math.round(l*i),f=t||await et(),{lyricFamily:x,chordFamily:h}=f;let u=n.plan;if(!u)try{const r=dt(e,{createCanvas:o,fonts:f,lyricFamily:x,chordFamily:h,pageWidthPt:Math.round(s*72),pageHeightPt:Math.round(l*72)});if(u=r.plan,r.error==="MULTI_PAGE")return{error:"MULTI_PAGE",plan:u}}catch{const r=o?o(1,1):typeof document<"u"?document.createElement("canvas"):null;if(!r)throw new Error("Canvas unavailable. Provide createCanvas in options.");const c=r.getContext("2d");u=Q(e,{lyricFamily:x,chordFamily:h},P=>E=>(c.font=`${P}px ${x}`,c.measureText(E||"").width),P=>E=>(c.font=`bold ${P}px ${h}`,c.measureText(E||"").width)).plan}if(u.layout.pages.length>1)return{error:"MULTI_PAGE",plan:u};const w=gt(u,{pxWidth:y,pxHeight:m,dpi:i,createCanvas:o}),C=`${at(String(n.slug||e.slug||e.title||"untitled"))}.jpg`,p=await new Promise((r,c)=>{if(typeof w.toBlob=="function"){w.toBlob(d=>{d?r(d):c(new Error("Failed to generate JPG blob"))},"image/jpeg",a);return}if(typeof w.toBuffer=="function"){try{const d=w.toBuffer("image/jpeg",{quality:a});r(new Blob([d],{type:"image/jpeg"}))}catch(d){c(d)}return}else try{const T=w.toDataURL("image/jpeg",a).split(","),S=T[0]?.match(/:(.*?);/),P=atob(T[1]||""),E=P.length,M=new Uint8Array(E);for(let F=0;F<E;F+=1)M[F]=P.charCodeAt(F);r(new Blob([M],{type:S?.[1]||"image/jpeg"}))}catch(d){c(d)}});return{plan:u,blob:p,filename:C}}export{xt as downloadSingleSongJpg,et as ensureCanvasFonts,dt as planSongForJpg,gt as renderPlanToCanvas};
