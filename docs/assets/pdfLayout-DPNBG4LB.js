import{p as q}from"./index-jA15hBve.js";function ee(t,s,c="normal"){return f=>n=>(t.setFont(s,c),t.setFontSize(f),t.getTextWidth(n||""))}function L(t,s=3){if(!Array.isArray(t)||t.length<2)return t;t.sort((n,e)=>n.x-e.x);let c=!0,f=0;for(;c&&f<10;){c=!1,f++;for(let n=1;n<t.length;n++){const e=t[n-1],r=t[n];if(e.x+e.w>r.x){const i=e.x+e.w-r.x,g=Math.min(s,Math.ceil(i/2));e.x-=g,r.x+=g,c=!0}}}return t.sort((n,e)=>n.x-e.x),t}const J=[16,15,14,13,12],B={pageWidth:612,pageHeight:792,margin:36,headerOffsetY:0,gutter:18,lyricFamily:"Helvetica",chordFamily:"Courier",lyricSizePt:16,chordSizePt:16,columns:1,ptWindow:J},G=()=>{var t;try{return typeof window<"u"&&((t=window.localStorage)==null?void 0:t.getItem("pdfPlanTrace"))==="1"}catch{return!1}};function Z(t,s,c,f={}){const n=!!f.honorColumnBreaks,e=new Array(s).fill(0),r=Array.from({length:s},()=>[]);let i=0,g="";if(!Array.isArray(t))return{singlePage:!1,colHeights:e,occupancy:e.map(()=>0),balance:1,reasonRejected:"no_sections_provided",placed:r};const m=y=>{if(i+1>=s)return!1;const l=t[y];return l?l.height<=c-e[i+1]:!1};for(let y=0;y<t.length;y++){const l=t[y];if(n&&l.type==="column_break"){m(y+1)&&(i+=1);continue}const F=c-e[i];if(l.height<=F)r[i].push(l.id),e[i]+=l.height;else if(i+1<s){i+=1;const d=c-e[i];if(l.height<=d)r[i].push(l.id),e[i]+=l.height;else return g=`section ${l.id} needs ${Math.ceil(l.height)}pt > remaining ${Math.floor(d)}pt in col ${i+1}`,{singlePage:!1,colHeights:e,occupancy:e.map(u=>u/c),balance:s===2?1-Math.abs(e[0]-e[1])/c:1,reasonRejected:g,placed:r}}else return g=`section ${l.id} needs ${Math.ceil(l.height)}pt > remaining ${Math.floor(F)}pt in col ${i+1}`,{singlePage:!1,colHeights:e,occupancy:e.map(d=>d/c),balance:s===2?1-Math.abs(e[0]-e[1])/c:1,reasonRejected:g,placed:r}}return{singlePage:!0,colHeights:e,occupancy:e.map(y=>y/c),balance:s===2?1-Math.abs(e[0]-e[1])/c:1,reasonRejected:void 0,placed:r}}function K({pt:t,cols:s,balance:c,occupancy:f,hasColumnsHint:n}){let e=0;s===2&&Math.min(...f)<.18&&(e+=50),f.some(i=>i>.98)&&(e+=5),n&&s===2&&(e-=3);const r=t*100+c*10-e-(s===2?2:0);return{penalties:e,finalScore:r}}const H=typeof window<"u"&&(()=>{try{return localStorage.getItem("pdfPlanTrace")==="1"}catch{return!1}})();function _(t){if(!t)return{sections:[],meta:{}};if(typeof t=="string")try{const s=q(t),c=s.blocks.map(f=>({header:f.section,blocks:[{type:"section",header:f.section},...f.lines.map(n=>({type:"line",lyrics:n.text,chords:n.chords}))]}));return{...s.meta,sections:c}}catch{return{sections:[],meta:{}}}return typeof t=="object"?t:{sections:[],meta:{}}}function D(t,s,c,{honorColumnBreaks:f}={}){const n=Array.from({length:s},()=>[]),e=Array(s).fill(0);let r=0;for(let m=0;m<t.length;m++){const y=t[m],l=y.h,F=y.hNoPad;if(l>c)return{singlePage:!1,colHeights:e,occupancy:e.map(u=>u/c),balance:s===2?0:1,placed:n,reasonRejected:`section ${m} height ${l}pt > column ${c}pt`};f&&y.breakBefore&&r<s-1&&e[r]>0&&l<=c&&r++;let d=c-e[r];if(l<=d)n[r].push(m),e[r]+=l;else if(F<=d){if(n[r].push(m),e[r]+=F,r++,r>=s&&m<t.length-1)return{singlePage:!1,colHeights:e,occupancy:e.map(u=>u/c),balance:s===2?1-Math.abs(e[0]-e[1])/c:1,placed:n,reasonRejected:`section ${m+1} needs ${l}pt > remaining ${d}pt in col ${s}`}}else{if(r++,r>=s)return{singlePage:!1,colHeights:e,occupancy:e.map(u=>u/c),balance:s===2?1-Math.abs(e[0]-e[1])/c:1,placed:n,reasonRejected:`section ${m} needs ${l}pt > remaining ${d}pt in col ${r}`};m--;continue}if(r>=s)break}const i=e.map(m=>m/c),g=s===2?1-Math.abs(e[0]-e[1])/c:1;return{singlePage:!0,colHeights:e,occupancy:i,balance:g,placed:n}}function Q(t,s,c,f,n,e){if(!(t!=null&&t.sections))return!1;const r=f.pageWidth-f.margin*2,i=s===2?(r-f.gutter)/2:r,g=n(c),m=e(c);for(const y of t.sections)for(const l of y.lines||[]){if(l.comment){if(g(l.comment)>i)return!0;continue}const F=l.lyrics||"";let d=g(F);const u=(l.chords||[]).map(x=>({x:g(F.slice(0,x.index||0)),w:m(x.sym||"")}));L(u);for(const x of u)x.x+x.w>d&&(d=x.x+x.w);if(d>i)return!0}return!1}function V(t,s={},c=()=>()=>0,f=()=>()=>0){var O,A;const n=_(t),e={...B,...s,gutter:B.gutter},r=[16,15,14,13,12],i=((O=n.layoutHints)==null?void 0:O.requestedColumns)===2,g=e.pageHeight-(e.margin+e.headerOffsetY)-e.margin,m={},y=((A=n.layoutHints)==null?void 0:A.columnBreakAfter)||[],l=o=>{if(m[o])return m[o];const S=4,v=Math.round(o*.85),b=Math.max(10,o-2),C=(n.sections||[]).map(($,a)=>{var h,P;let p=v+o;for(const k of $.lines||[])k.comment?p+=b+3:((h=k==null?void 0:k.chords)!=null&&h.length&&(p+=o+S/2),p+=o+S);return(P=$.lines)!=null&&P.length||(p+=o),p+=4,{h:p,hNoPad:p-4,breakBefore:y.includes(a)}});return m[o]=C,H&&console.log("sectionHeights pt",o,C.map($=>$.h)),C},F=[];for(const o of r)for(const S of[1,2]){const v=l(o),b=D(v,S,g,{honorColumnBreaks:!0}),C=!Q(n,S,o,e,c,f);let $=0;S===2&&Math.min(...b.occupancy)<.18&&($+=50),b.occupancy.some(p=>p>.98)&&($+=5),i&&S===2&&($-=3);const a=o*100+b.balance*10-$-(S===2?2:0);F.push({pt:o,cols:S,singlePage:b.singlePage&&C,colHeights:b.colHeights,occupancy:b.occupancy,balance:b.balance,penalties:$,finalScore:a,reasonRejected:C?b.reasonRejected:"width overflow",placed:b.placed})}H&&(console.table(F.map(o=>({pt:o.pt,cols:o.cols,singlePage:o.singlePage,colHeights:o.colHeights.map(S=>Number(S.toFixed(1))),occupancy:o.occupancy.map(S=>Number(S.toFixed(2))),balance:Number(o.balance.toFixed(2)),penalties:o.penalties,finalScore:Number(o.finalScore.toFixed(2)),reasonRejected:o.reasonRejected||""}))),console.log("contentH",g,"gutter",e.gutter));const d=F.filter(o=>o.singlePage);if(d.length){const o=d.sort((w,W)=>W.finalScore-w.finalScore)[0],S=o.occupancy.map(w=>w.toFixed(2)).join(","),v=`Plan: ${o.cols} col • ${o.pt}pt • singlePage=yes • occ=[${S}] • bal=${o.balance.toFixed(2)}`,b=e.margin,C=e.pageWidth-b*2,$=o.cols===2?(C-e.gutter)/2:C,a=c(o.pt),p=f(o.pt),h=(w,W)=>{const R=[];for(const E of W){const I=n.sections[E];R.push({type:"section",header:I.label||I.kind});for(const M of I.lines||[])if(M.comment)R.push({type:"line",comment:M.comment});else{const Y=(M.chords||[]).map(N=>({x:a((M.lyrics||"").slice(0,N.index||0)),w:p(N.sym||""),sym:N.sym}));L(Y),R.push({type:"line",lyrics:M.lyrics||"",chords:Y})}}return{x:w,blocks:R}},P=[h(b,o.placed[0]||[])];o.cols===2&&P.push(h(b+$+e.gutter,o.placed[1]||[]));const k={pages:[{columns:P}]};return{plan:{lyricFamily:e.lyricFamily,chordFamily:e.chordFamily,lyricSizePt:o.pt,chordSizePt:o.pt,columns:o.cols,margin:e.margin,headerOffsetY:e.headerOffsetY,gutter:e.gutter,layout:k,debugFooter:v}}}const u=12;let x=T(n,{...e,columns:1,lyricSizePt:u,chordSizePt:u},c(u),f(u)),z={...e,columns:1,lyricSizePt:u,chordSizePt:u,layout:x};return X(z)||(x=T(n,{...e,columns:2,lyricSizePt:u,chordSizePt:u},c(u),f(u)),z={...e,columns:2,lyricSizePt:u,chordSizePt:u,layout:x}),z.debugFooter=`Plan: ${z.columns} col • ${z.lyricSizePt}pt • singlePage=${z.layout.pages.length===1?"yes":"no"}`,{plan:z}}function X(t){var s,c;return(((c=(s=t==null?void 0:t.layout)==null?void 0:s.pages)==null?void 0:c.length)||99)<=2}function T(t,s={},c=n=>0,f=n=>0){var v,b,C,$;const n=_(t),e=Array.isArray(n.sections)?n.sections:[],r={...B,...s,gutter:B.gutter},i=r.margin,g=r.pageWidth-i*2;e.length||e.push({header:"Section",blocks:[]});const m=(a,p)=>{const h=makeLyric(a);try{return h(p||"")}catch{return 0}},y=(a,p)=>{const h=makeChord(a);try{return h(p||"")}catch{return 0}},l=a=>{const h=Math.round(a*.85);return e.map((P,k)=>{let j=h;for(const w of P.blocks)if(w.type!=="section"&&w.type==="line"){if(w.comment){const W=Math.max(10,a-2);m(W,w.comment),j+=W;continue}Array.isArray(w.chords)&&w.chords.length&&(y(a,w.chords.map(W=>(W==null?void 0:W.sym)||"").join(" ")),j+=a+4/2),m(a,w.lyrics||""),j+=a+4}return j<h+a&&(j=h+a),{id:k+1,type:"section",height:j,header:P.header}})},F=((v=n==null?void 0:n.meta)==null?void 0:v.columns)===2||((b=n==null?void 0:n.hints)==null?void 0:b.columns)===2,d=[];for(const a of(B==null?void 0:B.ptWindow)||[16,15,14,13,12]){const p=l(a);for(const h of[1,2]){const P=Z(p,h,contentHeight,{honorColumnBreaks:!0});if(!P.singlePage)continue;const{penalties:k,finalScore:j}=K({pt:a,cols:h,balance:P.balance,occupancy:P.occupancy,hasColumnsHint:F});d.push({pt:a,cols:h,pack:P,penalties:k,finalScore:j})}}if(!d.length){const a={lyricFamily:oBase.lyricFamily||"Helvetica",chordFamily:oBase.chordFamily||"Courier",lyricSizePt:12,chordSizePt:12,columns:1,margin:i,headerOffsetY,gutter,layout:{pages:[]},debugFooter:G()?"Plan: 1 col • 12pt • singlePage=no":void 0};return a.layout.pages=[{columns:[{x:i,blocks}]},{columns:[{x:i,blocks:[]}]}],{plan:a}}d.sort((a,p)=>p.finalScore-a.finalScore);const u=d[0],x=u.pt,z=u.cols,O=z===2?(g-gutter)/2:g,A=e.map(a=>a.blocks),o={columns:[]};for(let a=0;a<z;a++){const p=u.pack.placed[a]||[],h=[];for(const P of p){const k=A[P-1]||[];(!k.length||((C=k[0])==null?void 0:C.type)!=="section")&&h.push({type:"section",header:(($=e[P-1])==null?void 0:$.header)||`Section ${P}`}),h.push(...k)}o.columns.push({x:i+a*(O+(a?gutter:0)),blocks:h})}return{plan:{lyricFamily:oBase.lyricFamily||"Helvetica",chordFamily:oBase.chordFamily||"Courier",lyricSizePt:x,chordSizePt:x,columns:z,margin:i,headerOffsetY,gutter,layout:{pages:[o]},debugFooter:G()?`Plan: ${z} col • ${x}pt • singlePage=yes • occ=${JSON.stringify(u.pack.occupancy.map(a=>a.toFixed(2)))} • bal=${u.pack.balance.toFixed(2)}`:void 0}}}const te=Object.freeze(Object.defineProperty({__proto__:null,DEFAULT_LAYOUT_OPT:B,chooseBestLayout:V,normalizeSongInput:_,packIntoColumns:D,planSongLayout:T},Symbol.toStringTag,{value:"Module"}));export{B as D,te as a,V as c,ee as m,_ as n,T as p};
