const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-C4spd6k8.js","./index-DWh8Kn7H.js","./index-DSeYQlXl.css","./jszip.min-CbBAYMJe.js"])))=>i.map(i=>d[i]);
import{j as t,u as ke,a as Ne,r,i as De,d as J,F as Te,B as $e,T as Ae,I as q,b as p,P as G,S as Oe,C as Ee,c as Ke,L as _e,D as V,e as Me,f as Ue,M as Be,g as Y,K as Fe,A as Re,h as We,k as He,l as Xe,_ as te,m as ze,p as Je,s as qe,t as Ge,n as Ve,o as P,q as Ye}from"./index-DWh8Kn7H.js";const ne="gracechords.sets.v1";function D(){try{const o=localStorage.getItem(ne);return o?JSON.parse(o):{sets:{}}}catch{return{sets:{}}}}function se(o){localStorage.setItem(ne,JSON.stringify(o))}function Qe(){return typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():"id-"+Math.random().toString(36).slice(2)+Date.now().toString(36)}function k(){const{sets:o}=D();return Object.values(o).sort((c,u)=>(u.updatedAt||0)-(c.updatedAt||0))}function ie(o){const{sets:c}=D();return c[o]||null}function N(o){const c=Date.now(),u={id:o.id||Qe(),name:o.name?.trim()||"Untitled Set",items:Array.isArray(o.items)?o.items:[],createdAt:o.createdAt||c,updatedAt:c},m=D();return m.sets[u.id]=u,se(m),u}function Ze(o){const c=D();return c.sets[o]?(delete c.sets[o],se(c),!0):!1}function et(o){const c=ie(o);return c?N({name:`Copy of ${c.name}`,items:c.items.map(u=>({...u}))}):null}function Q({label:o,id:c,children:u,className:m="",...y}){return t.jsxs("label",{className:"gc-field",htmlFor:c,children:[o?t.jsx("span",{className:"gc-label",children:o}):null,t.jsx("span",{className:"gc-select",children:t.jsx("select",{id:c,className:m,...y,children:u})})]})}let Z;const ee=()=>Z||(Z=te(()=>import("./index-C4spd6k8.js").then(o=>o.i),__vite__mapDeps([0,1,2]),import.meta.url));function nt(){const{code:o}=ke(),c=Ne(),[u,m]=r.useState("Untitled Set"),[y,ae]=r.useState(""),[g,oe]=r.useState([]),[w,le]=r.useState(()=>{try{return localStorage.getItem("pref:icpOnly")==="1"}catch{return!1}});r.useEffect(()=>{try{localStorage.setItem("pref:icpOnly",w?"1":"0")}catch{}},[w]);const[a,h]=r.useState([]),[K,re]=r.useState({}),[T,b]=r.useState("");Object.keys(K).length;const[$,_]=r.useState(!1),[j,S]=r.useState(null),[ce,M]=r.useState(()=>k()),[de,I]=r.useState("");r.useEffect(()=>{const e=De?.items||[],n=new Set,s=[];for(const i of e)n.has(i.id)||(n.add(i.id),s.push(i));oe(s)},[]),r.useEffect(()=>{let e=!1;async function n(){const s={};for(const i of a){const l=g.find(C=>C.id===i.id);if(!l)continue;const d=l.filename.replace(/\.chordpro$/i,""),f=`./pptx/${d}.pptx`;await Xe(f,d)&&(s[d]=!0)}e||re(s)}return n(),()=>{e=!0}},[a,g]),r.useEffect(()=>{if(!o)return;const{entries:e,error:n}=J(o);if(n){alert(n),c("/setlist",{replace:!0});return}h(e.map(s=>({id:s.id,toKey:s.toKey})))},[o]),r.useEffect(()=>{try{const e=localStorage.getItem("setlist");if(!e||k().length>0)return;const n=JSON.parse(e);if(n?.name||(n?.list?.length||0)>0){const s=N({name:n.name||"Imported Set",items:n.list||[]});M(k()),S(s.id),m(s.name),h(s.items||[]),I(s.id)}}catch{}},[]);const A=r.useMemo(()=>new Te(g,{keys:["title","tags"],threshold:.4}),[g]);function ue(e){return!w||(Array.isArray(e.tags)?e.tags.includes("ICP"):e.tags==="ICP")}const pe=r.useMemo(()=>(y?A.search(y).map(n=>n.item):g.slice().sort((n,s)=>n.title.localeCompare(s.title))).filter(ue),[y,A,g,w]);function U(e){a.find(n=>n.id===e.id)||h([...a,{id:e.id,toKey:e.originalKey||"C"}])}function fe(e){h(a.filter(n=>n.id!==e))}function B(e,n){const s=a.findIndex(f=>f.id===e);if(s<0)return;const i=s+(n==="up"?-1:1);if(i<0||i>=a.length)return;const l=a.slice(),[d]=l.splice(s,1);l.splice(i,0,d),h(l)}function me(e,n){const s=a.findIndex(d=>d.id===e);if(s<0||n<0||n>=a.length||s===n)return;const i=a.slice(),[l]=i.splice(s,1);i.splice(n,0,l),h(i)}function he(e,n){h(a.map(s=>s.id===e?{...s,toKey:n}:s))}function L(e){M(k()),I(e||"")}function F(){S(null),m("Untitled Set"),h([]),I("")}function ge(){const e=u?.trim()||"Untitled Set",n=N({id:j,name:e,items:a});m(n.name),S(n.id),L(n.id)}function xe(e){const n=e.target.value;if(I(n),!n)return;const s=ie(n);s&&(S(s.id),m(s.name||"Untitled Set"),h(s.items||[]))}function ye(){if(!j){const n=`Copy of ${u||"Untitled Set"}`,s=N({id:null,name:n,items:a});m(s.name),S(s.id),L(s.id);return}const e=et(j);e&&(S(e.id),m(e.name),h(e.items||[]),L(e.id))}function je(){j&&window.confirm(`Delete set "${u}"? This cannot be undone.`)&&(Ze(j),F(),L(""))}async function Se(){_(!0);try{const{downloadMultiSongPdf:e}=await ee(),n=[];for(const s of a){const i=g.find(l=>l.id===s.id);if(i)try{const l=`./songs/${i.filename}`,d=await ze(l),f=Je(d),x=f.meta?.key||f.meta?.originalkey||i.originalKey||"C",C=qe(x,s.toKey||x),Ie=(f.sections||[]).map(X=>({section:X.label,lines:(X.lines||[]).map(v=>({plain:v.comment?v.comment:v.lyrics||"",chordPositions:(v.chords||[]).map(z=>({sym:Ge(z.sym,C),index:z.index})),comment:v.comment?v.comment:void 0}))})),Le=i.filename.replace(/\.chordpro$/i,""),Pe=Ve({title:f.meta?.title||i.title||Le,key:s.toKey||x,capo:f.meta?.capo,lyricsBlocks:Ie});n.push(Pe)}catch(l){console.error(l),P(`Failed to process ${i.filename}`)}}n.length&&await e(n)}finally{_(!1)}}function R(){ee()}const[O,W]=r.useState(""),[E,H]=r.useState("");function ve(){const e=Ye(a);W(e)}async function we(){try{const e=`${location.origin}${location.pathname}#/set/${O}`;await navigator.clipboard.writeText(e);try{P?.("Link copied!")}catch{}}catch{alert("Failed to copy link")}}function Ce(){const e=String(E||"").trim(),{entries:n,error:s}=J(e);if(s){alert(s);return}h(n.map(i=>({id:i.id,toKey:i.toKey}))),H(""),W(e)}async function be(){b(`Bundling 0/${a.length}…`);const e=(await te(async()=>{const{default:i}=await import("./jszip.min-CbBAYMJe.js").then(l=>l.j);return{default:i}},__vite__mapDeps([3,1,2]),import.meta.url)).default,n=new e;let s=0;for(let i=0;i<a.length;i++){const l=a[i],d=g.find(x=>x.id===l.id);if(!d){b(`Bundling ${i+1}/${a.length}…`);continue}b(`Bundling ${i+1}/${a.length}…`);const f=d.filename.replace(/\.chordpro$/i,"");if(K[f])try{const x=await fetch(`./pptx/${f}.pptx`);if(!x.ok)continue;const C=await x.blob();s++,n.file(`${String(s).padStart(2,"0")}-${f}.pptx`,C)}catch{}}if(s>0){const i=await n.generateAsync({type:"blob"}),l=new Date().toISOString().slice(0,10).replace(/-/g,""),d=document.createElement("a");d.href=URL.createObjectURL(i),d.download=`setlist-pptx-${l}.zip`,d.click(),URL.revokeObjectURL(d.href)}else try{P&&P("No PPTX files found for selected songs")||alert("No PPTX files found for selected songs")}catch{}b("")}return t.jsxs("div",{className:"container",children:[t.jsx($e,{busy:$}),t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[t.jsx("div",{}),t.jsx("h1",{style:{margin:0},children:"Setlist Builder"}),t.jsx("div",{})]}),t.jsxs(Ae,{className:"card",style:{marginTop:12},children:[t.jsx(q,{label:"Set","aria-label":"Set name",value:u,onChange:e=>m(e.target.value),style:{minWidth:220},placeholder:"Sunday AM"}),t.jsxs(Q,{"aria-label":"Saved sets",value:de,onChange:xe,children:[t.jsx("option",{value:"",children:"— Load saved set —"}),ce.map(e=>t.jsxs("option",{value:e.id,children:[e.name," · ",new Date(e.updatedAt).toLocaleString()]},e.id))]}),t.jsxs(p,{onClick:F,title:"New set",iconLeft:t.jsx(G,{}),children:[" ",t.jsx("span",{className:"text-when-wide",children:"New"})]}),t.jsxs(p,{variant:"primary",onClick:ge,title:"Save set",iconLeft:t.jsx(Oe,{}),children:[" ",t.jsx("span",{className:"text-when-wide",children:"Save"})]}),t.jsxs(p,{onClick:ye,disabled:!a.length,title:"Duplicate set",iconLeft:t.jsx(Ee,{}),children:[" ",t.jsx("span",{className:"text-when-wide",children:"Duplicate"})]}),t.jsxs(p,{onClick:je,disabled:!j,title:"Delete set",iconLeft:t.jsx(Ke,{}),children:[" ",t.jsx("span",{className:"text-when-wide",children:"Delete"})]}),t.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"},children:[t.jsx(p,{onClick:ve,title:"Generate code for this set",children:"Generate Set Code"}),t.jsx("input",{readOnly:!0,placeholder:"(code)",value:O,onFocus:e=>e.currentTarget.select(),style:{width:200},"aria-label":"Set code"}),t.jsx(p,{onClick:we,disabled:!O,title:"Copy shareable link",iconLeft:t.jsx(_e,{}),children:"Copy Link"})]}),t.jsxs("div",{style:{marginLeft:"auto",display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"},children:[t.jsx(p,{variant:"primary",onClick:Se,onMouseEnter:R,onFocus:R,disabled:$,title:"Export set as a single PDF",iconLeft:t.jsx(V,{}),children:$?"Exporting…":t.jsxs(t.Fragment,{children:[t.jsx("span",{className:"text-when-wide",children:"Export PDF"}),t.jsx("span",{className:"text-when-narrow",children:"PDF"})]})}),t.jsx(p,{onClick:be,disabled:a.length===0||!!T,title:a.length===0?"Add songs to export PPTX bundle":"Export PPTX bundle for selected songs",iconLeft:t.jsx(V,{}),children:T||t.jsxs(t.Fragment,{children:[t.jsx("span",{className:"text-when-wide",children:"Export PPTX"}),t.jsx("span",{className:"text-when-narrow",children:"PPTX"})]})}),t.jsx(p,{onClick:()=>h([]),title:"Clear setlist",iconLeft:t.jsx(Me,{}),children:t.jsx("span",{className:"text-when-wide",children:"Clear"})}),t.jsxs(p,{as:Ue,to:a.length?`/worship/${a.map(e=>e.id).join(",")}?toKeys=${a.map(e=>encodeURIComponent(e.toKey)).join(",")}`:"#",title:a.length?"Open Worship Mode with this set":"Add songs to open Worship Mode","aria-disabled":!a.length,onClick:e=>{a.length||e.preventDefault()},iconLeft:t.jsx(Be,{}),children:[t.jsx("span",{className:"text-when-wide",children:"Worship Mode"}),t.jsx("span",{className:"text-when-narrow",children:"Worship"})]})]})]}),t.jsx("div",{className:"card",style:{marginTop:8},children:t.jsxs("div",{className:"Row",style:{alignItems:"center",gap:8,flexWrap:"wrap"},children:[t.jsx("strong",{children:"Load Set"}),t.jsx("input",{value:E,onChange:e=>H(e.target.value),placeholder:"Paste set code…",style:{width:240},"aria-label":"Load set code"}),t.jsx(p,{onClick:Ce,disabled:!E.trim(),title:"Load set from code",children:"Load"})]})}),t.jsxs("div",{className:"BuilderPage",style:{marginTop:12},children:[t.jsx("div",{className:"BuilderLeft",children:t.jsx("div",{className:"card",style:{display:"flex",flexDirection:"column",flex:"1 1 auto",minHeight:0},children:t.jsxs("div",{style:{marginTop:8},children:[t.jsx("strong",{children:"Add songs"}),t.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",marginTop:6},children:[t.jsx(q,{value:y,onChange:e=>ae(e.target.value),placeholder:"Search...",style:{flex:1}}),t.jsxs("label",{className:"row",style:{gap:6,alignItems:"center"},children:[t.jsx("input",{type:"checkbox",checked:w,onChange:e=>le(e.target.checked)}),t.jsx("span",{className:"meta",title:"Limit results to songs tagged ICP",children:"ICP only"})]})]}),t.jsx("div",{style:{minHeight:0,flex:"1 1 auto",overflow:"auto",marginTop:6},children:A?t.jsx("div",{style:{display:"grid",gap:".5rem",gridTemplateColumns:"repeat(auto-fill, minmax(320px, 1fr))"},children:pe.map(e=>t.jsx(Y,{title:e.title,subtitle:`${e.originalKey||""}${e.tags?.length?` • ${e.tags.join(", ")}`:""}`,rightSlot:t.jsx(p,{"aria-label":"Add",title:"Add to set",variant:"primary",iconLeft:t.jsx(G,{}),iconOnly:!0,onClick:n=>{n.stopPropagation(),U(e)}}),onClick:()=>U(e)},e.id))}):t.jsx("div",{children:"Loading search…"})})]})})}),t.jsx("div",{className:"BuilderRight",style:{minHeight:0,display:"flex",flexDirection:"column"},children:t.jsxs("div",{className:"card",style:{display:"flex",flexDirection:"column",flex:"1 1 auto",minHeight:0},children:[t.jsxs("strong",{children:["Current setlist (",a.length,")"]}),t.jsx("div",{style:{minHeight:0,flex:"1 1 auto",overflow:"auto",marginTop:6},children:a.map((e,n)=>{const s=g.find(i=>i.id===e.id);return s?t.jsx(Y,{draggable:!0,onDragStart:i=>{i.dataTransfer.setData("text/plain",String(e.id)),i.dataTransfer.effectAllowed="move"},onDragOver:i=>{i.preventDefault(),i.dataTransfer.dropEffect="move"},onDrop:i=>{i.preventDefault();const l=i.dataTransfer.getData("text/plain");me(l,n)},title:s.title,subtitle:`Original: ${s.originalKey||"—"}`,rightSlot:t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6},children:[t.jsx(Q,{value:e.toKey,onChange:i=>he(e.id,i.target.value),children:Fe.map(i=>t.jsx("option",{value:i,children:i},i))}),t.jsx(p,{onClick:()=>B(e.id,"up"),title:"Move up",iconLeft:t.jsx(Re,{})}),t.jsx(p,{onClick:()=>B(e.id,"down"),title:"Move down",iconLeft:t.jsx(We,{})}),t.jsx(p,{onClick:()=>fe(e.id),title:"Remove",iconLeft:t.jsx(He,{}),iconOnly:!0,style:{color:"#b91c1c"}})]})},e.id):null})}),t.jsxs("div",{className:"print-only",style:{marginTop:16},children:[t.jsx("h2",{style:{fontSize:"20pt",margin:"0 0 8pt 0"},children:u}),t.jsx("ol",{style:{fontSize:"12pt",lineHeight:1.4,paddingLeft:"1.2em"},children:a.map(e=>{const n=g.find(s=>s.id===e.id);return n?t.jsxs("li",{children:[n.title," — ",e.toKey||n.originalKey||"—"]},e.id):null})})]})]})})]})]})}export{nt as default};
