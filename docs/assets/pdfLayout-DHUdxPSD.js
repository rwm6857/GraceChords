function X(e,u,c="normal"){return s=>o=>(e.setFont(u,c),e.setFontSize(s),e.getTextWidth(o||""))}function $(e,u=3){if(!Array.isArray(e)||e.length<2)return e;e.sort((o,t)=>o.x-t.x);let c=!0,s=0;for(;c&&s<10;){c=!1,s++;for(let o=1;o<e.length;o++){const t=e[o-1],i=e[o];if(t.x+t.w>i.x){const a=t.x+t.w-i.x,l=Math.min(u,Math.ceil(a/2));t.x-=l,i.x+=l,c=!0}}}return e.sort((o,t)=>o.x-t.x),e}function K(e=""){return/^(?:verse(?:\s*\d+)?|chorus|bridge|tag|pre[-\s]?chorus|intro|outro|ending|refrain)\s*\d*$/i.test(String(e).trim())}function L(e){const u=c=>{const s=[];let o=null;const t=()=>{o&&o.lines.length&&s.push(o),o=null};for(const i of c||[]){if(i.section){t(),s.push(i);continue}for(const a of i.lines||[]){const l=a.plain||a.text||"";!!!(a.chordPositions&&a.chordPositions.length)&&K(l)?(t(),o={section:l.trim(),lines:[]}):(o||(o={lines:[]}),o.lines.push(a))}}return t(),s.length?s:c||[]};if(e!=null&&e.lyricsBlocks)return{title:e.title||"Untitled",key:e.key||e.originalKey||"C",lyricsBlocks:u(e.lyricsBlocks)};if(Array.isArray(e==null?void 0:e.blocks)){const c=[];let s={lines:[]};for(const o of e.blocks)o.type==="section"?(s.lines.length&&c.push(s),s={section:o.header,lines:[]}):o.type==="line"&&s.lines.push({plain:o.lyrics||o.text||"",chordPositions:(o.chords||[]).map(t=>({index:t.index??0,sym:t.sym}))});return s.lines.length&&c.push(s),{title:e.title||"Untitled",key:e.key||e.originalKey||"C",lyricsBlocks:u(c)}}return{title:(e==null?void 0:e.title)||"Untitled",key:(e==null?void 0:e.key)||(e==null?void 0:e.originalKey)||"C",lyricsBlocks:[]}}const H={lyricSizePt:16,chordSizePt:16,margin:36,gutter:24,headerOffsetY:54,columns:1,pageWidth:612,pageHeight:792,lyricFamily:"Helvetica",chordFamily:"Courier",title:"Untitled",key:"C"},b=6;function q(e,u,c,s,o,t){const i=s.margin,a=s.pageWidth-i*2,f=(u===2?(a-s.gutter)/2:a)-b,m=o(c),S=t(c);for(const w of e.lyricsBlocks||[])for(const P of w.lines||[]){const x=P.plain||P.text||"";if(m(x)>f)return!0;for(const B of P.chordPositions||[]){const k=m(x.slice(0,B.index||0)),T=S(B.sym||"");if(k+T>f)return!0}}return!1}function D(e,u={},c=()=>()=>0,s=()=>()=>0){const o=L(e),t={...H,...u,gutter:H.gutter},i=[16,15,14,13,12],a=[{cols:1,sizes:i},{cols:2,sizes:i}];for(const m of a)for(const S of m.sizes){const w=F(o,{...t,columns:m.cols,lyricSizePt:S,chordSizePt:S},c(S),s(S)),P=!q(o,m.cols,S,t,c,s),x={...t,columns:m.cols,lyricSizePt:S,chordSizePt:S,layout:w};if(w.pages.length===1&&P){if(m.cols===2&&J(x))continue;return{plan:x}}}const l=12,f=F(o,{...t,columns:1,lyricSizePt:l,chordSizePt:l},c(l),s(l));return{plan:{...t,columns:1,lyricSizePt:l,chordSizePt:l,layout:f}}}function J(e){if(e.columns!==2)return!1;const u=e.layout.pages[0];if(!u||u.columns.length<2)return!1;const c=u.columns[1];let s=0,o=0,t=0;for(const i of c.blocks)i.type==="section"?(t>0&&o++,t=0):i.type==="line"&&(t++,s++);return t>0&&o++,s<=5||o===1&&t<3}function F(e,u={},c=o=>0,s=o=>0){const o=L(e),t={...H,...u,gutter:H.gutter},i=4,a=t.lyricSizePt,l=Math.round(t.lyricSizePt*.85),f=t.margin,m=t.pageHeight,S=t.pageWidth-f*2,w=t.columns===2?(S-t.gutter)/2:S,P=f+t.headerOffsetY,x=m-f,B=[];let k={columns:[]};B.push(k);function T(){const n={x:f,yStart:P,blocks:[]};if(k.columns.push(n),t.columns===2){const r={x:f+w+t.gutter,yStart:P,blocks:[]};k.columns.push(r)}}function G(){k={columns:[]},B.push(k)}k.columns.length===0&&T(),o.lyricsBlocks=(o.lyricsBlocks||[]).map(n=>{if(!(n!=null&&n.section)&&Array.isArray(n==null?void 0:n.lines)&&n.lines.length){const r=n.lines[0],p=(r==null?void 0:r.plain)||(r==null?void 0:r.text)||"";if(!(Array.isArray(r==null?void 0:r.chordPositions)&&r.chordPositions.length>0)&&K(p))return{section:p.trim(),lines:n.lines.slice(1)}}return n});let v=0,d=P;const _=()=>k.columns[v],A=()=>{t.columns===2&&v===0?(v=1,d=P):(G(),T(),v=0,d=P)},R=(n,r=0,p=(h=>(h=n.lines)==null?void 0:h.length)()??0)=>{var W;let y=0;!!n.section&&r===0&&(y+=l+a+4);for(let C=r;C<p;C++){const g=n.lines[C];(W=g==null?void 0:g.chordPositions)!=null&&W.length&&(y+=t.chordSizePt+i/2),y+=t.lyricSizePt+i}return y+4},U=n=>{var r;return((r=n==null?void 0:n.chordPositions)!=null&&r.length?t.chordSizePt+i/2:0)+t.lyricSizePt+i},j=(n,r)=>{n.blocks.push({type:"section",header:r})},I=(n,r,p)=>{const h=p.map(y=>({x:c(r.slice(0,y.index||0)),w:s(y.sym||""),sym:y.sym}));$(h),n.blocks.push({type:"line",lyrics:r,chords:h})};for(const n of o.lyricsBlocks||[]){const r=R(n);if(d+r<=x){const y=_();n.section&&(d+=l,j(y,n.section),d+=a+4);for(const z of n.lines||[]){const W=z.plain||z.text||"",C=z.chordPositions||[];I(y,W,C),d+=U(z)}d+=4;continue}const p=(n.lines||[]).map(U);let h=0;for(;h<(n.lines||[]).length;){const y=(n.lines||[]).length-h,z=h===0&&n.section?l+a+4:0,W=p[h]||0;if(d+z+W>x){A();continue}const C=x-d-z;let g=0,O=0;for(;h+g<p.length&&O+p[h+g]<=C;)O+=p[h+g],g++;if(g<2&&y>g){A();continue}if(y-g<2&&y>g)if(g>2)O-=p[h+g-1],g--;else{A();continue}const M=_();h===0&&n.section&&(d+=l,j(M,n.section),d+=a+4);for(let E=0;E<g;E++){const Y=n.lines[h],N=Y.plain||Y.text||"",Z=Y.chordPositions||[];I(M,N,Z),d+=p[h],h++}d+=4,h<(n.lines||[]).length&&A()}}return{pages:B}}function Q(e,u){const c={...H,...u};c.pageWidth=612,c.pageHeight=792;const s=t=>t?t.length*(c.lyricSizePt*.6):0;return F(L(e),c,s,s).pages.map((t,i)=>({p:i,cols:t.columns.map((a,l)=>({c:l,blocks:a.blocks.map(f=>({t:f.type,h:f.type==="section"&&f.header||null,line:f.type==="line"?{text:f.lyrics,chords:(f.chords||[]).map(m=>({x:Number(m.x.toFixed(2)),s:m.sym}))}:null}))}))}))}function V(e,u){const c=L(e),s={...H,...u};s.pageWidth=612,s.pageHeight=792;const o=a=>l=>l?l.length*(a*.6):0,t=a=>l=>l?l.length*(a*.6):0,{plan:i}=D(c,s,o,t);return{columns:i.columns,size:i.lyricSizePt,pages:i.layout.pages.length}}const tt=Object.freeze(Object.defineProperty({__proto__:null,DEFAULT_LAYOUT_OPT:H,chooseBestLayout:D,getLayoutMetrics:Q,normalizeSongInput:L,planForTest:V,planSongLayout:F},Symbol.toStringTag,{value:"Module"}));export{H as D,tt as a,D as c,X as m,L as n,F as p};
