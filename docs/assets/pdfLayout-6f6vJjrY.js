function gt(t,r,n="normal"){return o=>s=>(t.setFont(r,n),t.setFontSize(o),t.getTextWidth(s||""))}function st(t,r=3){if(!Array.isArray(t)||t.length<2)return t;t.sort((s,e)=>s.x-e.x);let n=!0,o=0;for(;n&&o<10;){n=!1,o++;for(let s=1;s<t.length;s++){const e=t[s-1],a=t[s];if(e.x+e.w>a.x){const i=e.x+e.w-a.x,c=Math.min(r,Math.ceil(i/2));e.x-=c,a.x+=c,n=!0}}}return t.sort((s,e)=>s.x-e.x),t}const U=/^\{(start_of|end_of)_(verse|chorus|bridge|intro|tag|outro)(?::\s*([^}]+))?\}$/i,Y=/^\{(sov|eov|soc|eoc|sob|eob)\}$/i,ot={sov:{start:!0,kind:"verse"},eov:{start:!1,kind:"verse"},soc:{start:!0,kind:"chorus"},eoc:{start:!1,kind:"chorus"},sob:{start:!0,kind:"bridge"},eob:{start:!1,kind:"bridge"}},M=/^(verse|chorus|bridge|intro|tag|outro)(?:\s+(\d+))?$/i,nt=/^\{\s*([^:}]+)\s*:\s*([^}]*)\s*\}$/,it=/\[([^\]]+)\]/g;function G(t){const r=[];let n="",o=0;return t.replace(it,(s,e,a)=>(n+=t.slice(o,a),r.push({sym:e,index:n.length}),o=a+s.length,s)),n+=t.slice(o),{lyrics:n,chords:r}}function ct(t){return M.test(t.trim())}function rt(t){const r=M.exec(t.trim());if(!r)return{kind:"verse",label:""};const n=r[1].toLowerCase(),o=r[2]?`${$(n)} ${r[2]}`:$(n);return{kind:n,label:o}}function $(t){return t.charAt(0).toUpperCase()+t.slice(1).toLowerCase()}function lt(t){const r=t.trim();let n=U.exec(r);if(n)return{start:n[1].toLowerCase()==="start_of",kind:n[2].toLowerCase(),label:(n[3]||"").trim()||void 0};if(n=Y.exec(r),n){const o=ot[n[1].toLowerCase()];if(o)return{start:o.start,kind:o.kind}}return null}function K(t){const r=t.split(/\r?\n/);let n=!1;for(const i of r){const c=i.trim();if(U.test(c)||Y.test(c)){n=!0;break}}const o={meta:{},sections:[]};let s=null;const e=(i,c)=>{s&&o.sections.push(s);const u=c||$(i);s={kind:i,label:u,lines:[]}},a=()=>{s&&(o.sections.push(s),s=null)};for(const i of r){const c=i.trim();if(c===""){s&&s.lines.push({lyrics:"",chords:[]});continue}const u=nt.exec(c);if(u&&!U.test(c)&&!Y.test(c)){const f=u[1].trim().toLowerCase(),P=u[2].trim();f==="title"?o.meta.title=P:f==="key"?o.meta.key=P:(o.meta.meta||(o.meta.meta={}),o.meta.meta[f]=P);continue}if(n){const f=lt(c);if(f){f.start?e(f.kind,f.label):a();continue}if(c.startsWith("{")&&c.endsWith("}"))continue;s||e("verse","Verse"),s.lines.push(G(i));continue}if(ct(i)){const{kind:f,label:P}=rt(i);e(f,P);continue}c.startsWith("{")&&c.endsWith("}")||(s||e("verse","Verse"),s.lines.push(G(i)))}return s&&a(),o}function Z(t=""){return/^(?:verse(?:\s*\d+)?|chorus|bridge|tag|pre[-\s]?chorus|intro|outro|ending|refrain)\s*\d*$/i.test(String(t).trim())}function O(t){const r=o=>{const s=[];let e=null;const a=()=>{e&&e.lines.length&&s.push(e),e=null};for(const i of o||[]){if(i.section){a(),s.push(i);continue}for(const c of i.lines||[]){const u=c.plain||c.text||"";!!!(c.chordPositions&&c.chordPositions.length)&&Z(u)?(a(),e={section:u.trim(),lines:[]}):(e||(e={lines:[]}),e.lines.push(c))}}return a(),s.length?s:o||[]},n=o=>({title:o.meta.title||"Untitled",key:o.meta.key||"C",lyricsBlocks:(o.sections||[]).map(s=>({section:s.label,lines:(s.lines||[]).map(e=>({plain:e.lyrics,chordPositions:(e.chords||[]).map(a=>({index:a.index,sym:a.sym}))}))}))});if(t!=null&&t.lyricsBlocks)return{title:t.title||"Untitled",key:t.key||t.originalKey||"C",lyricsBlocks:r(t.lyricsBlocks)};if(t!=null&&t.sections&&Array.isArray(t.sections))return n(t);if(Array.isArray(t==null?void 0:t.blocks)){const o=[];let s={lines:[]};for(const e of t.blocks)e.type==="section"?(s.lines.length&&o.push(s),s={section:e.header,lines:[]}):e.type==="line"&&s.lines.push({plain:e.lyrics||e.text||"",chordPositions:(e.chords||[]).map(a=>({index:a.index??0,sym:a.sym}))});return s.lines.length&&o.push(s),{title:t.title||"Untitled",key:t.key||t.originalKey||"C",lyricsBlocks:r(o)}}if(typeof t=="string")return n(K(t));if(t!=null&&t.body||t!=null&&t.lines){const o=(t.body||(Array.isArray(t.lines)?t.lines.join(`
`):""))+"";return n(K(o))}return{title:(t==null?void 0:t.title)||"Untitled",key:(t==null?void 0:t.key)||(t==null?void 0:t.originalKey)||"C",lyricsBlocks:[]}}const w={lyricSizePt:16,chordSizePt:16,margin:36,gutter:24,headerOffsetY:54,columns:1,pageWidth:612,pageHeight:792,lyricFamily:"Helvetica",chordFamily:"Courier",title:"Untitled",key:"C"},at=6;function N(t,r,n,o,s,e){const a=o.margin,i=o.pageWidth-a*2,u=(r===2?(i-o.gutter)/2:i)-at,f=s(n),P=e(n);for(const H of t.lyricsBlocks||[])for(const g of H.lines||[]){const _=g.plain||g.text||"";if(f(_)>u)return!0;for(const b of g.chordPositions||[]){const p=f(_.slice(0,b.index||0)),T=P(b.sym||"");if(p+T>u)return!0}}return!1}function q(t,r={},n=()=>()=>0,o=()=>()=>0){const s=O(t),e={...w,...r,gutter:w.gutter},a=[16,15,14,13,12];for(const f of a){const P=L(s,{...e,columns:1,lyricSizePt:f,chordSizePt:f},n(f),o(f)),H=!N(s,1,f,e,n,o),g={...e,columns:1,lyricSizePt:f,chordSizePt:f,layout:P};if(V(g)&&H)return{plan:g}}for(const f of a){const P=L(s,{...e,columns:2,lyricSizePt:f,chordSizePt:f},n(f),o(f)),H=!N(s,2,f,e,n,o),g={...e,columns:2,lyricSizePt:f,chordSizePt:f,layout:P};if(!(!V(g)||!H)&&!ut(g))return{plan:g}}const i=12;let c=L(s,{...e,columns:1,lyricSizePt:i,chordSizePt:i},n(i),o(i)),u={...e,columns:1,lyricSizePt:i,chordSizePt:i,layout:c};return ft(u)||(c=L(s,{...e,columns:2,lyricSizePt:i,chordSizePt:i},n(i),o(i)),u={...e,columns:2,lyricSizePt:i,chordSizePt:i,layout:c}),{plan:u}}function V(t){var r,n;return((n=(r=t==null?void 0:t.layout)==null?void 0:r.pages)==null?void 0:n.length)===1}function ft(t){var r,n;return(((n=(r=t==null?void 0:t.layout)==null?void 0:r.pages)==null?void 0:n.length)||99)<=2}function ut(t){var a,i,c;const r=(i=(a=t==null?void 0:t.layout)==null?void 0:a.pages)==null?void 0:i[0];if(!r||((c=r.columns)==null?void 0:c.length)!==2)return!1;const n=r.columns[1];let o=0,s=0,e=0;for(const u of n.blocks||[])u.type==="section"?(e>0&&s++,e=0):u.type==="line"&&(e++,o++);return e>0&&s++,o<=5||s===1&&e<3}function L(t,r={},n=s=>0,o=s=>0){const s=O(t),e={...w,...r,gutter:w.gutter},a=4,i=e.lyricSizePt,c=Math.round(e.lyricSizePt*.85),u=e.margin,f=e.pageHeight,P=e.pageWidth-u*2,H=e.columns===2?(P-e.gutter)/2:P,g=u+e.headerOffsetY,_=f-u,b=[];let p={columns:[]};b.push(p);function T(){const l={x:u,yStart:g,blocks:[]};if(p.columns.push(l),e.columns===2){const h={x:u+H+e.gutter,yStart:g,blocks:[]};p.columns.push(h)}}function J(){p={columns:[]},b.push(p)}p.columns.length===0&&T(),s.lyricsBlocks=(s.lyricsBlocks||[]).map(l=>{if(!(l!=null&&l.section)&&Array.isArray(l==null?void 0:l.lines)&&l.lines.length){const h=l.lines[0],v=(h==null?void 0:h.plain)||(h==null?void 0:h.text)||"";if(!(Array.isArray(h==null?void 0:h.chordPositions)&&h.chordPositions.length>0)&&Z(v))return{section:v.trim(),lines:l.lines.slice(1)}}return l});let B=0,d=g;const A=()=>p.columns[B],W=()=>{e.columns===2&&B===0?(B=1,d=g):(J(),T(),B=0,d=g)},Q=(l,h=0,v=(S=>(S=l.lines)==null?void 0:S.length)()??0)=>{var m;let y=0;!!l.section&&h===0&&(y+=c+i+4);for(let z=h;z<v;z++){const C=l.lines[z];(m=C==null?void 0:C.chordPositions)!=null&&m.length&&(y+=e.chordSizePt+a/2),y+=e.lyricSizePt+a}return y+4},R=l=>{var h;return((h=l==null?void 0:l.chordPositions)!=null&&h.length?e.chordSizePt+a/2:0)+e.lyricSizePt+a},F=(l,h)=>{l.blocks.push({type:"section",header:h})},D=(l,h,v)=>{const S=v.map(y=>({x:n(h.slice(0,y.index||0)),w:o(y.sym||""),sym:y.sym}));st(S),l.blocks.push({type:"line",lyrics:h,chords:S})};for(const l of s.lyricsBlocks||[]){const h=Q(l);if(d+h<=_){const x=A();l.section&&(d+=c,F(x,l.section),d+=i+4);for(const m of l.lines||[]){const z=m.plain||m.text||"",C=m.chordPositions||[];D(x,z,C),d+=R(m)}d+=4;continue}const v=_-g;if(h<=v){W();const x=A();l.section&&(d+=c,F(x,l.section),d+=i+4);for(const m of l.lines||[]){const z=m.plain||m.text||"",C=m.chordPositions||[];D(x,z,C),d+=R(m)}d+=4;continue}const S=(l.lines||[]).map(R);let y=0;for(;y<(l.lines||[]).length;){const x=(l.lines||[]).length-y,m=y===0&&l.section?c+i+4:0,z=S[y]||0;if(d+m+z>_){W();continue}const C=_-d-m;let k=0,E=0;for(;y+k<S.length&&E+S[y+k]<=C;)E+=S[y+k],k++;if(k<2&&x>k){W();continue}if(x-k<2&&x>k)if(k>2)E-=S[y+k-1],k--;else{W();continue}const j=A();l.section&&d===g&&(d+=c,F(j,l.section),d+=i+4);for(let X=0;X<k;X++){const I=l.lines[y],tt=I.plain||I.text||"",et=I.chordPositions||[];D(j,tt,et),d+=S[y],y++}d+=4,y<(l.lines||[]).length&&W()}}return{pages:b}}function ht(t,r){const n={...w,...r};n.pageWidth=612,n.pageHeight=792;const o=e=>e?e.length*(n.lyricSizePt*.6):0;return L(O(t),n,o,o).pages.map((e,a)=>({p:a,cols:e.columns.map((i,c)=>({c,blocks:i.blocks.map(u=>({t:u.type,h:u.type==="section"&&u.header||null,line:u.type==="line"?{text:u.lyrics,chords:(u.chords||[]).map(f=>({x:Number(f.x.toFixed(2)),s:f.sym}))}:null}))}))}))}function yt(t,r){const n=O(t),o={...w,...r};o.pageWidth=612,o.pageHeight=792;const s=i=>c=>c?c.length*(i*.6):0,e=i=>c=>c?c.length*(i*.6):0,{plan:a}=q(n,o,s,e);return{columns:a.columns,size:a.lyricSizePt,pages:a.layout.pages.length}}const dt=Object.freeze(Object.defineProperty({__proto__:null,DEFAULT_LAYOUT_OPT:w,chooseBestLayout:q,getLayoutMetrics:ht,normalizeSongInput:O,planForTest:yt,planSongLayout:L},Symbol.toStringTag,{value:"Module"}));export{w as D,dt as a,q as c,gt as m,O as n,L as p};
