const G=[16,15,14,13,12],x=()=>{var e;try{return typeof window<"u"&&((e=window.localStorage)==null?void 0:e.getItem("pdfPlanTrace"))==="1"}catch{return!1}};function q(e){if(typeof(e==null?void 0:e.measureSectionsForPt)=="function")return e.measureSectionsForPt;if(Array.isArray(e==null?void 0:e.sections)&&typeof(e==null?void 0:e.measureSectionAtPt)=="function"){const n=e.sections,l=e.measureSectionAtPt;return h=>n.map((i,c)=>{const a=l(i,h);return{id:(a==null?void 0:a.id)??(i==null?void 0:i.id)??c+1,height:(a==null?void 0:a.height)??(a==null?void 0:a.h)??0,type:(a==null?void 0:a.type)??(i==null?void 0:i.type)}})}return null}const N=(e,n)=>{x()&&e.push(n)},B=(e,n)=>{x()&&n.length&&(console.groupCollapsed(`[pdfPlanTrace] ${e}`),console.table(n),console.groupEnd())};function v(e,n,l,h={}){const i=!!h.honorColumnBreaks,c=new Array(n).fill(0),a=Array.from({length:n},()=>[]);let s=0,d="";if(!Array.isArray(e))return{singlePage:!1,colHeights:c,occupancy:c.map(()=>0),balance:1,reasonRejected:"no_sections_provided",placed:a};const k=p=>{if(s+1>=n)return!1;const o=e[p];return o?o.height<=l-c[s+1]:!1};for(let p=0;p<e.length;p++){const o=e[p];if(i&&o.type==="column_break"){k(p+1)&&(s+=1);continue}const b=l-c[s];if(o.height<=b)a[s].push(o.id),c[s]+=o.height;else if(s+1<n){s+=1;const r=l-c[s];if(o.height<=r)a[s].push(o.id),c[s]+=o.height;else return d=`section ${o.id} needs ${Math.ceil(o.height)}pt > remaining ${Math.floor(r)}pt in col ${s+1}`,{singlePage:!1,colHeights:c,occupancy:c.map(f=>f/l),balance:n===2?1-Math.abs(c[0]-c[1])/l:1,reasonRejected:d,placed:a}}else return d=`section ${o.id} needs ${Math.ceil(o.height)}pt > remaining ${Math.floor(b)}pt in col ${s+1}`,{singlePage:!1,colHeights:c,occupancy:c.map(r=>r/l),balance:n===2?1-Math.abs(c[0]-c[1])/l:1,reasonRejected:d,placed:a}}return{singlePage:!0,colHeights:c,occupancy:c.map(p=>p/l),balance:n===2?1-Math.abs(c[0]-c[1])/l:1,reasonRejected:void 0,placed:a}}function J({pt:e,cols:n,balance:l,occupancy:h,hasColumnsHint:i}){let c=0;n===2&&Math.min(...h)<.18&&(c+=50),h.some(s=>s>.98)&&(c+=5),i&&n===2&&(c-=3);const a=e*100+l*10-c-(n===2?2:0);return{penalties:c,finalScore:a}}function D({measuredSections:e,measureSectionsForPt:n,sections:l,measureSectionAtPt:h,pageContentHeight:i,hasColumnsHint:c=!1,honorColumnBreaks:a=!0,ptWindow:s=G}){const d=[],k=[],p=n||q({measureSectionsForPt:n,sections:l,measureSectionAtPt:h});for(const o of s){const b=i;for(const r of[1,2]){const f=typeof p=="function"?p(o):e;if(!Array.isArray(f)){N(d,{pt:o,cols:r,singlePage:!1,colHeights:[],occupancy:[],balance:1,penalties:"",finalScore:"",reasonRejected:"no_measurements_for_pt"});continue}const y=v(f,r,b,{honorColumnBreaks:a}),M={pt:o,cols:r,singlePage:y.singlePage,colHeights:y.colHeights.map(P=>Math.round(P)),occupancy:y.occupancy.map(P=>Number(P.toFixed(2))),balance:Number(y.balance.toFixed(2))};if(!y.singlePage){N(d,{...M,penalties:"",finalScore:"",reasonRejected:y.reasonRejected});continue}const{penalties:w,finalScore:W}=J({pt:o,cols:r,balance:y.balance,occupancy:y.occupancy,hasColumnsHint:c});k.push({pt:o,cols:r,pack:y,penalties:w,finalScore:W}),N(d,{...M,penalties:w,finalScore:W})}}if(k.length){k.sort((r,f)=>f.finalScore-r.finalScore);const o=k[0];B("Single‑page candidate scan (16→12pt, 1/2 columns)",d);const b=x()?`Plan: ${o.cols} col • ${o.pt}pt • singlePage=yes • occ=${JSON.stringify(o.pack.occupancy.map(r=>r.toFixed(2)))} • bal=${o.pack.balance.toFixed(2)}`:"";return{...o,debugFooter:b}}return B("No single‑page candidates; falling back to multi‑page 12pt",d),{multipage:!0,pt:12,reason:"no_single_page"}}const O=Object.freeze({honorColumnBreaks:!0,hasColumnsHint:!1,ptWindow:G.slice()});function Q(e){return e}function V(e,n,l,h={}){return v(e,n,l,h).colHeights}function E(e){const n=D(e);return n.multipage?n:{pt:n.pt,cols:n.cols,singlePage:!0,occupancy:n.pack.occupancy,balance:n.pack.balance,debugFooter:n.debugFooter,placed:n.pack.placed,colHeights:n.pack.colHeights}}function X(e){return E(e)}function Z(e,n,l,h){var _,z,I,T;const i=n.margin??36,c=n.headerOffsetY??0,a=n.pageWidth??612,s=n.pageHeight??792,d=i+c,k=s-d-i,p=a-i*2,o=n.gutter??24,b=Array.isArray(e==null?void 0:e.blocks)?e.blocks:[],r=[];let f=null;for(const t of b)(t==null?void 0:t.type)==="section"?(f={header:t.header||t.name||"Section",blocks:[t]},r.push(f)):(f||(f={header:"Section",blocks:[]},r.push(f)),f.blocks.push(t));r.length||r.push({header:"Section",blocks:[]});const y=(t,g)=>{const u=l(t);try{return u(g||"")}catch{return 0}},M=(t,g)=>{const u=h(t);try{return u(g||"")}catch{return 0}},w=t=>{const u=Math.round(t*.85);return r.map((m,$)=>{let S=u;for(const F of m.blocks)if(F.type!=="section"&&F.type==="line"){if(F.comment){const A=Math.max(10,t-2);y(A,F.comment),S+=A;continue}Array.isArray(F.chords)&&F.chords.length&&(M(t,F.chords.map(A=>(A==null?void 0:A.sym)||"").join(" ")),S+=t+4/2),y(t,F.lyrics||""),S+=t+4}return S<u+t&&(S=u+t),{id:$+1,type:"section",height:S,header:m.header}})},W=((_=e==null?void 0:e.meta)==null?void 0:_.columns)===2||((z=e==null?void 0:e.hints)==null?void 0:z.columns)===2,P=[];for(const t of(O==null?void 0:O.ptWindow)||[16,15,14,13,12]){const g=w(t);for(const u of[1,2]){const m=v(g,u,k,{honorColumnBreaks:!0});if(!m.singlePage)continue;const{penalties:$,finalScore:S}=J({pt:t,cols:u,balance:m.balance,occupancy:m.occupancy,hasColumnsHint:W});P.push({pt:t,cols:u,pack:m,penalties:$,finalScore:S})}}if(!P.length){const t={lyricFamily:n.lyricFamily||"Helvetica",chordFamily:n.chordFamily||"Courier",lyricSizePt:12,chordSizePt:12,columns:1,margin:i,headerOffsetY:c,gutter:o,layout:{pages:[]},debugFooter:x()?"Plan: 1 col • 12pt • singlePage=no":void 0};return t.layout.pages=[{columns:[{x:i,blocks:b}]},{columns:[{x:i,blocks:[]}]}],{plan:t}}P.sort((t,g)=>g.finalScore-t.finalScore);const C=P[0],H=C.pt,j=C.cols,Y=j===2?(p-o)/2:p,L=r.map(t=>t.blocks),R={columns:[]};for(let t=0;t<j;t++){const g=C.pack.placed[t]||[],u=[];for(const m of g){const $=L[m-1]||[];(!$.length||((I=$[0])==null?void 0:I.type)!=="section")&&u.push({type:"section",header:((T=r[m-1])==null?void 0:T.header)||`Section ${m}`}),u.push(...$)}R.columns.push({x:i+t*(Y+(t?o:0)),blocks:u})}return{plan:{lyricFamily:n.lyricFamily||"Helvetica",chordFamily:n.chordFamily||"Courier",lyricSizePt:H,chordSizePt:H,columns:j,margin:i,headerOffsetY:c,gutter:o,layout:{pages:[R]},debugFooter:x()?`Plan: ${j} col • ${H}pt • singlePage=yes • occ=${JSON.stringify(C.pack.occupancy.map(t=>t.toFixed(2)))} • bal=${C.pack.balance.toFixed(2)}`:void 0}}}export{O as DEFAULT_LAYOUT_OPT,Z as chooseBestLayout,E as chooseBestLayoutFromArgs,D as chooseBestPlan,V as columnHeights,Q as normalizeSongInput,X as planSongLayout};
