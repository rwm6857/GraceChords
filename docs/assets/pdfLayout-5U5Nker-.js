function nt(t,r,s="normal"){return i=>n=>(t.setFont(r,s),t.setFontSize(i),t.getTextWidth(n||""))}function Q(t,r=3){if(!Array.isArray(t)||t.length<2)return t;t.sort((n,o)=>n.x-o.x);let s=!0,i=0;for(;s&&i<10;){s=!1,i++;for(let n=1;n<t.length;n++){const o=t[n-1],u=t[n];if(o.x+o.w>u.x){const c=o.x+o.w-u.x,l=Math.min(r,Math.ceil(c/2));o.x-=l,u.x+=l,s=!0}}}return t.sort((n,o)=>n.x-o.x),t}function R(t=""){return/^(?:verse(?:\s*\d+)?|chorus|bridge|tag|pre[-\s]?chorus|intro|outro|ending|refrain)\s*\d*$/i.test(String(t).trim())}function F(t){const r=s=>{const i=[];let n=null;const o=()=>{n&&n.lines.length&&i.push(n),n=null};for(const u of s||[]){if(u.section){o(),i.push(u);continue}for(const c of u.lines||[]){const l=c.plain||c.text||"";!!!(c.chordPositions&&c.chordPositions.length)&&R(l)?(o(),n={section:l.trim(),lines:[]}):(n||(n={lines:[]}),n.lines.push(c))}}return o(),i.length?i:s||[]};if(t!=null&&t.lyricsBlocks)return{title:t.title||"Untitled",key:t.key||t.originalKey||"C",lyricsBlocks:r(t.lyricsBlocks)};if(Array.isArray(t==null?void 0:t.blocks)){const s=[];let i={lines:[]};for(const n of t.blocks)n.type==="section"?(i.lines.length&&s.push(i),i={section:n.header,lines:[]}):n.type==="line"&&i.lines.push({plain:n.lyrics||n.text||"",chordPositions:(n.chords||[]).map(o=>({index:o.index??0,sym:o.sym}))});return i.lines.length&&s.push(i),{title:t.title||"Untitled",key:t.key||t.originalKey||"C",lyricsBlocks:r(s)}}return{title:(t==null?void 0:t.title)||"Untitled",key:(t==null?void 0:t.key)||(t==null?void 0:t.originalKey)||"C",lyricsBlocks:[]}}const T={lyricSizePt:16,chordSizePt:16,margin:36,gutter:24,headerOffsetY:54,columns:1,pageWidth:612,pageHeight:792,lyricFamily:"Helvetica",chordFamily:"Courier",title:"Untitled",key:"C"},V=6;function G(t,r,s,i,n,o){const u=i.margin,c=i.pageWidth-u*2,h=(r===2?(c-i.gutter)/2:c)-V,f=n(s),C=o(s);for(const w of t.lyricsBlocks||[])for(const y of w.lines||[]){const B=y.plain||y.text||"";if(f(B)>h)return!0;for(const W of y.chordPositions||[]){const z=f(B.slice(0,W.index||0)),_=C(W.sym||"");if(z+_>h)return!0}}return!1}function Z(t,r={},s=()=>()=>0,i=()=>()=>0){const n=F(t),o={...T,...r,gutter:T.gutter},u=[16,15,14,13,12];for(const f of u){const C=O(n,{...o,columns:1,lyricSizePt:f,chordSizePt:f},s(f),i(f)),w=!G(n,1,f,o,s,i),y={...o,columns:1,lyricSizePt:f,chordSizePt:f,layout:C};if(N(y)&&w)return{plan:y}}for(const f of u){const C=O(n,{...o,columns:2,lyricSizePt:f,chordSizePt:f},s(f),i(f)),w=!G(n,2,f,o,s,i),y={...o,columns:2,lyricSizePt:f,chordSizePt:f,layout:C};if(!(!N(y)||!w)&&!M(y))return{plan:y}}const c=12;let l=O(n,{...o,columns:1,lyricSizePt:c,chordSizePt:c},s(c),i(c)),h={...o,columns:1,lyricSizePt:c,chordSizePt:c,layout:l};return X(h)||(l=O(n,{...o,columns:2,lyricSizePt:c,chordSizePt:c},s(c),i(c)),h={...o,columns:2,lyricSizePt:c,chordSizePt:c,layout:l}),{plan:h}}function N(t){var r,s;return((s=(r=t==null?void 0:t.layout)==null?void 0:r.pages)==null?void 0:s.length)===1}function X(t){var r,s;return(((s=(r=t==null?void 0:t.layout)==null?void 0:r.pages)==null?void 0:s.length)||99)<=2}function M(t){var u,c,l;const r=(c=(u=t==null?void 0:t.layout)==null?void 0:u.pages)==null?void 0:c[0];if(!r||((l=r.columns)==null?void 0:l.length)!==2)return!1;const s=r.columns[1];let i=0,n=0,o=0;for(const h of s.blocks||[])h.type==="section"?(o>0&&n++,o=0):h.type==="line"&&(o++,i++);return o>0&&n++,i<=5||n===1&&o<3}function O(t,r={},s=n=>0,i=n=>0){const n=F(t),o={...T,...r,gutter:T.gutter},u=4,c=o.lyricSizePt,l=Math.round(o.lyricSizePt*.85),h=o.margin,f=o.pageHeight,C=o.pageWidth-h*2,w=o.columns===2?(C-o.gutter)/2:C,y=h+o.headerOffsetY,B=f-h,W=[];let z={columns:[]};W.push(z);function _(){const e={x:h,yStart:y,blocks:[]};if(z.columns.push(e),o.columns===2){const a={x:h+w+o.gutter,yStart:y,blocks:[]};z.columns.push(a)}}function $(){z={columns:[]},W.push(z)}z.columns.length===0&&_(),n.lyricsBlocks=(n.lyricsBlocks||[]).map(e=>{if(!(e!=null&&e.section)&&Array.isArray(e==null?void 0:e.lines)&&e.lines.length){const a=e.lines[0],H=(a==null?void 0:a.plain)||(a==null?void 0:a.text)||"";if(!(Array.isArray(a==null?void 0:a.chordPositions)&&a.chordPositions.length>0)&&R(H))return{section:H.trim(),lines:e.lines.slice(1)}}return e});let L=0,d=y;const Y=()=>z.columns[L],v=()=>{o.columns===2&&L===0?(L=1,d=y):($(),_(),L=0,d=y)},b=(e,a=0,H=(S=>(S=e.lines)==null?void 0:S.length)()??0)=>{var m;let g=0;!!e.section&&a===0&&(g+=l+c+4);for(let x=a;x<H;x++){const k=e.lines[x];(m=k==null?void 0:k.chordPositions)!=null&&m.length&&(g+=o.chordSizePt+u/2),g+=o.lyricSizePt+u}return g+4},U=e=>{var a;return((a=e==null?void 0:e.chordPositions)!=null&&a.length?o.chordSizePt+u/2:0)+o.lyricSizePt+u},j=(e,a)=>{e.blocks.push({type:"section",header:a})},E=(e,a,H)=>{const S=H.map(g=>({x:s(a.slice(0,g.index||0)),w:i(g.sym||""),sym:g.sym}));Q(S),e.blocks.push({type:"line",lyrics:a,chords:S})};for(const e of n.lyricsBlocks||[]){const a=b(e);if(d+a<=B){const p=Y();e.section&&(d+=l,j(p,e.section),d+=c+4);for(const m of e.lines||[]){const x=m.plain||m.text||"",k=m.chordPositions||[];E(p,x,k),d+=U(m)}d+=4;continue}const H=B-y;if(a<=H){v();const p=Y();e.section&&(d+=l,j(p,e.section),d+=c+4);for(const m of e.lines||[]){const x=m.plain||m.text||"",k=m.chordPositions||[];E(p,x,k),d+=U(m)}d+=4;continue}const S=(e.lines||[]).map(U);let g=0;for(;g<(e.lines||[]).length;){const p=(e.lines||[]).length-g,m=g===0&&e.section?l+c+4:0,x=S[g]||0;if(d+m+x>B){v();continue}const k=B-d-m;let P=0,I=0;for(;g+P<S.length&&I+S[g+P]<=k;)I+=S[g+P],P++;if(P<2&&p>P){v();continue}if(p-P<2&&p>P)if(P>2)I-=S[g+P-1],P--;else{v();continue}const K=Y();e.section&&d===y&&(d+=l,j(K,e.section),d+=c+4);for(let D=0;D<P;D++){const A=e.lines[g],q=A.plain||A.text||"",J=A.chordPositions||[];E(K,q,J),d+=S[g],g++}d+=4,g<(e.lines||[]).length&&v()}}return{pages:W}}function tt(t,r){const s={...T,...r};s.pageWidth=612,s.pageHeight=792;const i=o=>o?o.length*(s.lyricSizePt*.6):0;return O(F(t),s,i,i).pages.map((o,u)=>({p:u,cols:o.columns.map((c,l)=>({c:l,blocks:c.blocks.map(h=>({t:h.type,h:h.type==="section"&&h.header||null,line:h.type==="line"?{text:h.lyrics,chords:(h.chords||[]).map(f=>({x:Number(f.x.toFixed(2)),s:f.sym}))}:null}))}))}))}function ot(t,r){const s=F(t),i={...T,...r};i.pageWidth=612,i.pageHeight=792;const n=c=>l=>l?l.length*(c*.6):0,o=c=>l=>l?l.length*(c*.6):0,{plan:u}=Z(s,i,n,o);return{columns:u.columns,size:u.lyricSizePt,pages:u.layout.pages.length}}const et=Object.freeze(Object.defineProperty({__proto__:null,DEFAULT_LAYOUT_OPT:T,chooseBestLayout:Z,getLayoutMetrics:tt,normalizeSongInput:F,planForTest:ot,planSongLayout:O},Symbol.toStringTag,{value:"Module"}));export{T as D,et as a,Z as c,nt as m,F as n,O as p};
