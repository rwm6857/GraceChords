const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-CuKMy2HD.js","./index-Cpb4nWSJ.js","./index-jNAjngcX.css","./jszip.min-CyTdhfvH.js"])))=>i.map(i=>d[i]);
import{j as e,u as $e,a as Ke,b as De,r as c,i as Ee,d as Oe,F as Ae,B as p,c as Be,T as Z,D as E,L as ee,e as te,M as se,S as Re,C as _e,P as ne,f as Me,I as Ue,g as ie,K as ze,A as Fe,h as We,k as Xe,l as He,_ as le,m as qe,p as Je,s as Ve,t as Ye,n as Ge,o as O}from"./index-Cpb4nWSJ.js";import{P as Qe}from"./PageContainer-BOwF0dE-.js";const ce="gracechords.sets.v1";function A(){try{const l=localStorage.getItem(ce);return l?JSON.parse(l):{sets:{}}}catch{return{sets:{}}}}function de(l){localStorage.setItem(ce,JSON.stringify(l))}function Ze(){return typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():"id-"+Math.random().toString(36).slice(2)+Date.now().toString(36)}function b(){const{sets:l}=A();return Object.values(l).sort((d,m)=>(m.updatedAt||0)-(d.updatedAt||0))}function et(l){const{sets:d}=A();return d[l]||null}function ae(l){const d=Date.now(),m={id:l.id||Ze(),name:l.name?.trim()||"Untitled Set",items:Array.isArray(l.items)?l.items:[],createdAt:l.createdAt||d,updatedAt:d},g=A();return g.sets[m.id]=m,de(g),m}function tt(l){const d=A();return d.sets[l]?(delete d.sets[l],de(d),!0):!1}function st({label:l,id:d,children:m,className:g="",...y}){return e.jsxs("label",{className:"gc-field",htmlFor:d,children:[l?e.jsx("span",{className:"gc-label",children:l}):null,e.jsx("span",{className:"gc-select",children:e.jsx("select",{id:d,className:g,...y,children:m})})]})}let oe;const re=()=>oe||(oe=le(()=>import("./index-CuKMy2HD.js").then(l=>l.i),__vite__mapDeps([0,1,2]),import.meta.url));function ot(){const{code:l,songIds:d}=$e(),m=Ke(),g=De(),[y,C]=c.useState("New Setlist"),[I,pe]=c.useState(""),[f,ue]=c.useState([]),[w,me]=c.useState(()=>{try{return localStorage.getItem("pref:icpOnly")==="1"}catch{return!1}});c.useEffect(()=>{try{localStorage.setItem("pref:icpOnly",w?"1":"0")}catch{}},[w]);const[a,h]=c.useState([]),[R,fe]=c.useState({}),[P,L]=c.useState("");Object.keys(R).length;const[N,_]=c.useState(!1),[he,ge]=c.useState(()=>{try{return window.innerWidth<=640}catch{return!1}}),[nt,xe]=c.useState(()=>{try{return window.innerWidth<=820}catch{return!1}}),[k,T]=c.useState(null),[S,M]=c.useState(()=>b()),[U,$]=c.useState(""),[ye,K]=c.useState(!1),[z,F]=c.useState("");c.useEffect(()=>{const t=Ee?.items||[],s=new Set,i=[];for(const n of t)s.has(n.id)||(s.add(n.id),i.push(n));ue(i)},[]),c.useEffect(()=>{let t=!1;async function s(){const i={};for(const n of a){const o=f.find(v=>v.id===n.id);if(!o)continue;const r=o.filename.replace(/\.chordpro$/i,""),u=`./pptx/${r}.pptx`;await He(u,r)&&(i[r]=!0)}t||fe(i)}return s(),()=>{t=!0}},[a,f]),c.useEffect(()=>{if(!l)return;const{entries:t,error:s}=Oe(l);if(s){alert(s),g("/setlist",{replace:!0});return}const i=t.map(r=>({id:r.id,toKey:r.toKey}));h(i);const n=i.map(r=>r.id).join(","),o=i.map(r=>encodeURIComponent(r.toKey||"")).join(",");g(`/setlist/${n}?toKeys=${o}`,{replace:!0})},[l]),c.useEffect(()=>{if(!d)return;const t=(d||"").split(",").map(o=>o.trim()).filter(Boolean);if(!t.length)return;const i=(new URLSearchParams(m.search||"").get("toKeys")||"").split(",").map(o=>decodeURIComponent(o)).filter(Boolean),n=t.map((o,r)=>({id:o,toKey:i[r]||""}));h(n)},[d,m.search]),c.useEffect(()=>{try{if(!Array.isArray(a))return;if(a.length===0){(l||d)&&g("/setlist",{replace:!0});return}const t=a.map(o=>o.id).join(","),s=a.map(o=>encodeURIComponent(o.toKey||"")).join(","),i=d||"",n=new URLSearchParams(m.search||"").get("toKeys")||"";(t!==i||s!==n)&&g(`/setlist/${t}?toKeys=${s}`,{replace:!0})}catch{}},[a.map(t=>`${t.id}:${t.toKey}`).join("|"),d,m.search,l]),c.useEffect(()=>{try{const t=localStorage.getItem("setlist");if(!t||b().length>0)return;const s=JSON.parse(t);if(s?.name||(s?.list?.length||0)>0){const i=ae({name:s.name||"Imported Set",items:s.list||[]});M(b()),T(i.id),C(i.name),h(i.items||[]),$(i.id)}}catch{}},[]),c.useEffect(()=>{function t(){try{const s=window.innerWidth;ge(s<=640),xe(s<=820)}catch{}}return window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[]);const B=c.useMemo(()=>new Ae(f,{keys:["title","tags"],threshold:.4}),[f]);function je(t){return!w||(Array.isArray(t.tags)?t.tags.includes("ICP"):t.tags==="ICP")}const we=c.useMemo(()=>(I?B.search(I).map(s=>s.item):f.slice().sort((s,i)=>s.title.localeCompare(i.title))).filter(je),[I,B,f,w]);function W(t){a.find(s=>s.id===t.id)||h([...a,{id:t.id,toKey:t.originalKey||"C"}])}function Se(t){h(a.filter(s=>s.id!==t))}function X(t,s){const i=a.findIndex(u=>u.id===t);if(i<0)return;const n=i+(s==="up"?-1:1);if(n<0||n>=a.length)return;const o=a.slice(),[r]=o.splice(i,1);o.splice(n,0,r),h(o)}function ve(t,s){const i=a.findIndex(r=>r.id===t);if(i<0||s<0||s>=a.length||i===s)return;const n=a.slice(),[o]=n.splice(i,1);n.splice(s,0,o),h(n)}function be(t,s){h(a.map(i=>i.id===t?{...i,toKey:s}:i))}function H(t){M(b()),$(t||"")}function q(){T(null),C("New Setlist"),h([]),$("")}function Ce(){const t=y?.trim()||"New Setlist",s=window.prompt("Save set as:",t);if(s===null)return;const i=String(s).trim()||"New Setlist";let n=k;if(!n){const r=(b()||[]).find(u=>(u.name||"")===i);r&&(n=r.id)}const o=ae({id:n,name:i,items:a});C(o.name),T(o.id),H(o.id)}function Ie(){const t=z||U||"";if(!t){K(!1);return}const s=et(t);s&&(T(s.id),C(s.name||"New Setlist"),h(s.items||[]),$(s.id)),K(!1)}function Pe(){const t=S[0]?.id||"";F(U||t),K(!0)}function Le(){k&&window.confirm(`Delete set "${y}"? This cannot be undone.`)&&(tt(k),q(),H(""))}async function J(){_(!0);try{const{downloadMultiSongPdf:t}=await re(),s=[];for(const i of a){const n=f.find(o=>o.id===i.id);if(n)try{const o=`./songs/${n.filename}`,r=await qe(o),u=Je(r),x=u.meta?.key||u.meta?.originalkey||n.originalKey||"C",v=Ve(x,i.toKey||x),Ne=(u.sections||[]).map(G=>({section:G.label,lines:(G.lines||[]).map(j=>({plain:j.comment?j.comment:j.lyrics||"",chordPositions:(j.chords||[]).map(Q=>({sym:Ye(Q.sym,v),index:Q.index})),comment:j.comment?j.comment:void 0}))})),ke=n.filename.replace(/\.chordpro$/i,""),Te=Ge({title:u.meta?.title||n.title||ke,key:i.toKey||x,capo:u.meta?.capo,lyricsBlocks:Ne});s.push(Te)}catch(o){console.error(o),O(`Failed to process ${n.filename}`)}}s.length&&await t(s)}finally{_(!1)}}function D(){re()}async function V(){try{const t=a.map(n=>n.id).join(","),s=a.map(n=>encodeURIComponent(n.toKey||"")).join(","),i=`${m.origin}${m.pathname}#/setlist/${t}?toKeys=${s}`;await navigator.clipboard.writeText(i);try{O?.("Link copied!")}catch{}}catch{alert("Failed to copy link")}}async function Y(){L(`Bundling 0/${a.length}…`);const t=(await le(async()=>{const{default:n}=await import("./jszip.min-CyTdhfvH.js").then(o=>o.j);return{default:n}},__vite__mapDeps([3,1,2]),import.meta.url)).default,s=new t;let i=0;for(let n=0;n<a.length;n++){const o=a[n],r=f.find(x=>x.id===o.id);if(!r){L(`Bundling ${n+1}/${a.length}…`);continue}L(`Bundling ${n+1}/${a.length}…`);const u=r.filename.replace(/\.chordpro$/i,"");if(R[u])try{const x=await fetch(`./pptx/${u}.pptx`);if(!x.ok)continue;const v=await x.blob();i++,s.file(`${String(i).padStart(2,"0")}-${u}.pptx`,v)}catch{}}if(i>0){const n=await s.generateAsync({type:"blob"}),o=new Date().toISOString().slice(0,10).replace(/-/g,""),r=document.createElement("a");r.href=URL.createObjectURL(n),r.download=`setlist-pptx-${o}.zip`,r.click(),URL.revokeObjectURL(r.href)}else try{O&&O("No PPTX files found for selected songs")||alert("No PPTX files found for selected songs")}catch{}L("")}return e.jsxs(Qe,{children:[ye?e.jsx("div",{style:{position:"fixed",inset:0,display:"flex",alignItems:"center",justifyContent:"center",background:"rgba(0,0,0,.45)",zIndex:90},role:"dialog","aria-modal":"true",children:e.jsxs("div",{style:{background:"var(--card)",color:"var(--text)",border:"1px solid var(--line)",borderRadius:10,padding:16,width:"min(560px, 92vw)"},children:[e.jsx("h3",{style:{marginTop:0,marginBottom:8},children:"Load Set"}),S.length?e.jsxs("label",{style:{display:"block",margin:"8px 0"},children:["Select a saved set",e.jsx("select",{value:z,onChange:t=>F(t.target.value),style:{width:"100%"},children:S.map(t=>e.jsxs("option",{value:t.id,children:[t.name," · ",new Date(t.updatedAt).toLocaleString()]},t.id))})]}):e.jsx("div",{className:"meta",children:"No saved sets yet."}),e.jsxs("div",{className:"row",style:{justifyContent:"flex-end",gap:8,marginTop:12},children:[e.jsx(p,{onClick:()=>K(!1),children:"Cancel"}),e.jsx(p,{variant:"primary",onClick:Ie,disabled:!S.length,children:"Load"})]})]})}):null,e.jsx(Be,{busy:N}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginTop:12,marginBottom:4},children:[e.jsx("div",{}),e.jsx("h1",{style:{margin:0},children:"Setlist Builder"}),e.jsx("div",{})]}),he?e.jsx(Z,{className:"card",style:{marginTop:8,position:"static"},children:e.jsxs("div",{className:"setlist-actions--mobile",style:{width:"100%"},children:[e.jsx(p,{variant:"primary",onClick:J,onMouseEnter:D,onFocus:D,disabled:N||a.length===0,title:"Export set as a single PDF",iconLeft:e.jsx(E,{}),children:"PDF"}),e.jsx(p,{onClick:Y,disabled:a.length===0||!!P,title:a.length===0?"Add songs to export PPTX bundle":"Export PPTX bundle for selected songs",iconLeft:e.jsx(E,{}),children:"PPTX"}),e.jsx(p,{onClick:V,title:"Copy shareable link",iconLeft:e.jsx(ee,{}),disabled:a.length===0,children:"Share"}),e.jsx(p,{as:te,to:a.length?`/worship/${a.map(t=>t.id).join(",")}?toKeys=${a.map(t=>encodeURIComponent(t.toKey)).join(",")}`:"/worship",title:"Open Worship Mode",iconLeft:e.jsx(se,{}),children:"Worship"})]})}):e.jsxs(Z,{className:"card",style:{marginTop:8,position:"static"},children:[e.jsx("div",{style:{width:"100%",marginBottom:6},children:e.jsx("strong",{title:"Current set name",children:y||"New Setlist"})}),e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",flexWrap:"wrap",width:"100%"},children:[e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"},children:[e.jsxs(p,{size:"sm",variant:"secondary",onClick:Ce,title:"Save set",iconLeft:e.jsx(Re,{}),children:[" ",e.jsx("span",{className:"text-when-wide",children:"Save"})]}),e.jsxs(p,{size:"sm",variant:"secondary",onClick:Pe,title:"Load saved set",iconLeft:e.jsx(_e,{}),disabled:!S.length,children:[" ",e.jsx("span",{className:"text-when-wide",children:"Load"})]}),e.jsxs(p,{size:"sm",variant:"secondary",onClick:q,title:"New set",iconLeft:e.jsx(ne,{}),children:[" ",e.jsx("span",{className:"text-when-wide",children:"New"})]}),e.jsxs(p,{size:"sm",variant:"secondary",onClick:Le,disabled:!k,title:"Delete set",iconLeft:e.jsx(Me,{}),children:[" ",e.jsx("span",{className:"text-when-wide",children:"Delete"})]})]}),e.jsxs("div",{style:{marginLeft:"auto",display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"},children:[e.jsx(p,{variant:"primary",size:"md",onClick:J,onMouseEnter:D,onFocus:D,disabled:N||a.length===0,title:"Export set as a single PDF",iconLeft:e.jsx(E,{}),children:N?"Exporting…":e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-when-wide",children:"Export PDF"}),e.jsx("span",{className:"text-when-narrow",children:"PDF"})]})}),e.jsx(p,{variant:"primary",size:"md",onClick:Y,disabled:a.length===0||!!P,title:a.length===0?"Add songs to export PPTX bundle":"Export PPTX bundle for selected songs",iconLeft:e.jsx(E,{}),children:P||e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-when-wide",children:"Export PPTX"}),e.jsx("span",{className:"text-when-narrow",children:"PPTX"})]})}),e.jsx(p,{variant:"primary",size:"md",onClick:V,title:"Copy shareable link",iconLeft:e.jsx(ee,{}),disabled:a.length===0,children:"Share Set"}),e.jsxs(p,{variant:"primary",size:"md",as:te,to:a.length?`/worship/${a.map(t=>t.id).join(",")}?toKeys=${a.map(t=>encodeURIComponent(t.toKey)).join(",")}`:"/worship",title:"Open Worship Mode",iconLeft:e.jsx(se,{}),children:[" ",e.jsx("span",{className:"text-when-wide",children:"Worship Mode"}),e.jsx("span",{className:"text-when-narrow",children:"Worship"})]})]})]})]}),e.jsxs("div",{className:"BuilderPage",style:{marginTop:8},children:[e.jsx("div",{className:"BuilderLeft",children:e.jsx("div",{className:"card",style:{display:"flex",flexDirection:"column",flex:"1 1 auto",minHeight:0},children:e.jsxs("div",{className:"BuilderScroll pane--addSongs",style:{minHeight:0,flex:"1 1 auto",overflow:"auto",marginTop:8},children:[e.jsxs("div",{className:"BuilderHeader",style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx("strong",{style:{whiteSpace:"nowrap"},children:"Add songs"}),e.jsx(Ue,{value:I,onChange:t=>pe(t.target.value),placeholder:"Search...",style:{flex:1,minWidth:0}}),e.jsxs("label",{className:"row",style:{gap:6,alignItems:"center"},children:[e.jsx("input",{type:"checkbox",checked:w,onChange:t=>me(t.target.checked)}),e.jsx("span",{className:"meta",title:"Limit results to songs tagged ICP",children:"ICP only"})]})]}),B?e.jsx("div",{style:{display:"grid",gap:".5rem",gridTemplateColumns:"repeat(auto-fill, minmax(320px, 1fr))",marginTop:6},children:we.map(t=>e.jsx(ie,{title:t.title,subtitle:`${t.originalKey||""}${t.tags?.length?` • ${t.tags.join(", ")}`:""}`,rightSlot:e.jsx(p,{"aria-label":"Add",title:"Add to set",variant:"primary",iconLeft:e.jsx(ne,{}),iconOnly:!0,onClick:s=>{s.stopPropagation(),W(t)}}),onClick:()=>W(t)},t.id))}):e.jsx("div",{children:"Loading search…"})]})})}),e.jsx("div",{className:"BuilderRight",style:{minHeight:0,display:"flex",flexDirection:"column"},children:e.jsxs("div",{className:"card",style:{display:"flex",flexDirection:"column",flex:"1 1 auto",minHeight:0},children:[e.jsxs("div",{className:"BuilderScroll pane--currentSet",style:{minHeight:0,flex:"1 1 auto",overflow:"auto",marginTop:8},children:[e.jsx("div",{className:"BuilderHeader",children:e.jsxs("strong",{children:["Current setlist (",a.length,")"]})}),e.jsx("div",{style:{marginTop:6},children:a.map((t,s)=>{const i=f.find(n=>n.id===t.id);return i?e.jsx(ie,{draggable:!0,onDragStart:n=>{n.dataTransfer.setData("text/plain",String(t.id)),n.dataTransfer.effectAllowed="move"},onDragOver:n=>{n.preventDefault(),n.dataTransfer.dropEffect="move"},onDrop:n=>{n.preventDefault();const o=n.dataTransfer.getData("text/plain");ve(o,s)},title:i.title,subtitle:`Original: ${i.originalKey||"—"}`,rightSlot:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx(st,{value:t.toKey,onChange:n=>be(t.id,n.target.value),children:ze.map(n=>e.jsx("option",{value:n,children:n},n))}),e.jsx(p,{onClick:()=>X(t.id,"up"),title:"Move up",iconLeft:e.jsx(Fe,{})}),e.jsx(p,{onClick:()=>X(t.id,"down"),title:"Move down",iconLeft:e.jsx(We,{})}),e.jsx(p,{onClick:()=>Se(t.id),title:"Remove",iconLeft:e.jsx(Xe,{}),iconOnly:!0,style:{color:"#b91c1c"}})]})},t.id):null})})]}),e.jsxs("div",{className:"print-only",style:{marginTop:16},children:[e.jsx("h2",{style:{fontSize:"20pt",margin:"0 0 8pt 0"},children:y}),e.jsx("ol",{style:{fontSize:"12pt",lineHeight:1.4,paddingLeft:"1.2em"},children:a.map(t=>{const s=f.find(i=>i.id===t.id);return s?e.jsxs("li",{children:[s.title," — ",t.toKey||s.originalKey||"—"]},t.id):null})})]})]})})]})]})}export{ot as default};
