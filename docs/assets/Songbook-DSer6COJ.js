const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-BUciLPta.js","./index-Csyg9gWS.js","./index-CShPCUf5.css"])))=>i.map(i=>d[i]);
import{r as l,i as G,w as J,x as K,F as V,j as e,y as X,T as Y,B as f,z as Z,D as ee,I as te,P as T,E as se,M as ne,G as E,H as ae,_ as ie,h as re,p as oe,J as le,s as b,N as ce}from"./index-Csyg9gWS.js";import{P as de}from"./PageContainer-L-f6Oo79.js";let M;const F=()=>M||(M=ie(()=>import("./index-BUciLPta.js").then(o=>o.i),__vite__mapDeps([0,1,2]),import.meta.url));function p(o,u){return ce(o,u)}function he(){const o=l.useMemo(()=>{const t=G?.items||[],n=new Set,s=[];for(const a of t)n.has(a.id)||(n.add(a.id),s.push(a));return s.slice().sort(p)},[]),u=J(),R=K(),N=l.useRef(!1),[x,D]=l.useState(""),C=l.useMemo(()=>new V(o,{keys:["title","tags","authors"],threshold:.4}),[o]),h=l.useMemo(()=>x?C.search(x).map(t=>t.item):o.slice().sort(p),[o,C,x]),[y,m]=l.useState(()=>new Set),g=l.useMemo(()=>h.filter(t=>y.has(t.id)).slice().sort(p),[h,y]),I=h.length,O=y.size;function v(t,n){m(s=>{const a=new Set(s);return n?a.add(t):a.delete(t),a})}function _(){h.length&&m(t=>{const n=new Set(t);for(const s of h)n.add(s.id);return n})}function z(){m(new Set)}function H(t,n){if(!t)return;const s=n||[],a=i=>new Set(i.map(r=>r.id));if(t==="random10SongCollection"){const i=Math.min(10,s.length),r=i===s.length?s:E(s,i);m(a(r));return}if(t==="sendMeSongbook"){const i=["NATION","NATIONS","MISSION","MISSIONS","ICP"],r=s.filter(c=>i.some(S=>ae([c],S).length));if(r.length)r.sort(p),m(a(r));else{const c=E(s,Math.min(5,s.length));m(a(c))}return}if(t==="graceChordsSongbook"){const i=s.slice().sort(p);m(a(i))}}const[W,j]=l.useState(null),[w,k]=l.useState(!1),[A,q]=l.useState(()=>{try{return window.innerWidth<=640}catch{return!1}});l.useEffect(()=>{function t(){try{q(window.innerWidth<=640)}catch{}}return window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[]),l.useEffect(()=>{const n=new URLSearchParams(u.search||"").get("tags");if(!n)return;const s=n.split(",").map(i=>i.trim().toLowerCase()).filter(Boolean);if(!s.length)return;const a=o.filter(i=>(Array.isArray(i.tags)?i.tags.map(c=>String(c).toLowerCase()):[]).some(c=>s.includes(c)));a.length&&m(i=>{const r=new Set(i);return a.forEach(c=>r.add(c.id)),r})},[u.search,o]),l.useEffect(()=>{if(N.current)return;const t=u.state?.quickAction;t&&o.length&&(H(t,o),N.current=!0,R(u.pathname+(u.search||""),{replace:!0,state:null}))},[u.state,o.map(t=>t.id).join("|")]);async function U(){if(g.length){k(!0);try{const{downloadSongbookPdf:t}=await F(),n=[];for(const s of g)try{const a=`./songs/${s.filename}`,i=await re(a),r=oe(i),c=(r.sections||[]).map(L=>({section:L.label,lines:(L.lines||[]).map(d=>d.instrumental?{instrumental:{chords:Array.isArray(d.instrumental?.chords)?d.instrumental.chords.slice():[],repeat:typeof d.instrumental?.repeat=="number"?d.instrumental.repeat:void 0}}:d.comment?{plain:d.comment,chordPositions:[],comment:d.comment}:{plain:d.lyrics||"",chordPositions:(d.chords||[]).map(B=>({sym:B.sym,index:B.index}))})})),S=s.filename.replace(/\.chordpro$/,""),Q=le({title:r.meta.title||s.title||S,key:r.meta.key||r.meta.originalkey||s.originalKey||"C",capo:r.meta?.capo,lyricsBlocks:c});n.push(Q)}catch(a){console.error(a),b(`Failed to process ${s.filename}`)}n.length&&await t(n,{includeTOC:!0,coverImageDataUrl:W})}finally{k(!1)}}}function P(){F()}function $(t){const n=t.target.files?.[0];if(!n){j(null);return}if(n.size>2*1024*1024){b("Image must be under 2 MB"),t.target.value="",j(null);return}if(!n.type.startsWith("image/")){b("File must be an image"),t.target.value="",j(null);return}const s=new FileReader;s.onload=()=>j(String(s.result||"")),s.readAsDataURL(n)}return o.length===0?e.jsxs("div",{className:"container",children:[e.jsx("h1",{children:"No songs found"}),e.jsx("p",{className:"Small",children:"The song index is empty or failed to load."})]}):e.jsxs(de,{children:[e.jsx(X,{busy:w}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginTop:12,marginBottom:4},children:[e.jsx("div",{}),e.jsx("h1",{style:{margin:0},children:"Songbook Builder"}),e.jsx("div",{})]}),e.jsxs(Y,{className:"card",style:{marginTop:8},children:[e.jsxs("div",{className:"Field",style:{minWidth:0},children:[e.jsx("label",{htmlFor:"sb-cover",children:"Upload Cover Image:"}),e.jsx("input",{id:"sb-cover",className:"CoverInput",type:"file",accept:"image/*",onChange:$,style:A?{maxWidth:"50vw",textOverflow:"ellipsis",overflow:"hidden",whiteSpace:"nowrap"}:void 0})]}),e.jsxs("div",{style:{marginLeft:"auto",display:"flex",gap:6},children:[e.jsx(f,{onClick:z,disabled:!O,title:"Clear selection",iconLeft:e.jsx(Z,{}),children:e.jsx("span",{className:"text-when-wide",children:"Clear"})}),e.jsx(f,{variant:"primary",onClick:U,onMouseEnter:P,onFocus:P,disabled:!g.length||w,title:g.length?"Export PDF":"Select some songs first",iconLeft:e.jsx(ee,{}),children:w?"Exporting…":A?"PDF":e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-when-wide",children:"Export PDF"}),e.jsx("span",{className:"text-when-narrow",children:"PDF"})]})})]})]}),e.jsxs("div",{className:"BuilderPage",style:{marginTop:8},children:[e.jsx("div",{className:"BuilderLeft",children:e.jsx("section",{className:"setlist-section songbook-add","data-role":"add",children:e.jsxs("div",{className:"card setlist-pane",children:[e.jsxs("div",{className:["BuilderHeader","section-header"].filter(Boolean).join(" "),style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx("strong",{style:{whiteSpace:"nowrap"},children:"Add songs"}),e.jsx(te,{value:x,onChange:t=>D(t.target.value),placeholder:"Search...",style:{flex:1,minWidth:0}}),e.jsxs(f,{onClick:_,disabled:!I,title:"Add all filtered",iconLeft:e.jsx(T,{}),variant:"primary",style:{marginLeft:"auto"},children:[e.jsxs("span",{className:"text-when-wide",children:["Add all (",I,")"]}),e.jsx("span",{className:"text-when-narrow",children:"All"})]})]}),e.jsx("div",{className:["BuilderScroll","setlist-scroll","pane--addSongs"].join(" "),style:{minHeight:0,flex:"1 1 auto",overflow:"auto",marginTop:6},role:"region","aria-label":"Song list",children:e.jsx("div",{className:"gc-list",style:{display:"grid",gap:".5rem",gridTemplateColumns:"repeat(auto-fill, minmax(320px, 1fr))"},children:h.map(t=>{const n=y.has(t.id),a=[(Array.isArray(t.authors)?t.authors.join(", "):t.authors||"")||"—",t.country].filter(Boolean).join(" • ");return e.jsx(se,{title:t.title,subtitle:a,rightSlot:n?e.jsx(f,{"aria-label":"Remove",title:"Remove",onClick:i=>{i.stopPropagation(),v(t.id,!1)},iconLeft:e.jsx(ne,{}),iconOnly:!0,style:{color:"#b91c1c"}}):e.jsx(f,{"aria-label":"Add",title:"Add",variant:"primary",onClick:i=>{i.stopPropagation(),v(t.id,!0)},iconLeft:e.jsx(T,{}),iconOnly:!0}),onClick:()=>v(t.id,!n)},t.id)})})})]})})}),e.jsx("div",{className:"BuilderRight",style:{minHeight:0,display:"flex",flexDirection:"column"},children:e.jsx("section",{className:"setlist-section songbook-current","data-role":"current",children:e.jsxs("div",{className:"card setlist-pane",children:[e.jsx("div",{className:"BuilderHeader section-header",children:e.jsxs("strong",{children:["Current selection (",g.length,")"]})}),e.jsx("div",{className:"BuilderScroll pane--currentSet",role:"region","aria-label":"Selected songs",style:{minHeight:0,flex:"1 1 auto",overflow:"auto",marginTop:6},children:e.jsx("ol",{className:"List",style:{listStyle:"decimal inside",margin:0,padding:0},children:g.map(t=>e.jsxs("li",{children:[t.title,Array.isArray(t.authors)&&t.authors.length?e.jsxs("span",{className:"Small",children:[" — ",t.authors.join(", ")]}):null]},t.id))})})]})})})]})]})}export{he as default};
