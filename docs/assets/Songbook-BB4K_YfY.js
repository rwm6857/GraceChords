const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-C6xNTZdA.js","assets/index-Dkj_NwFk.js","assets/index-CyC6WuKM.css"])))=>i.map(i=>d[i]);
import{r as l,i as X,Y,W as G,X as J,$ as Z,j as t,a1 as ee,P as te,B as v,ap as se,a3 as ne,T as ae,C as L,a8 as re,x as E,a9 as ie,I as M,ad as oe,ag as F,af as le,_ as ce,p as de,k as ue,l as me,al as he,s as b,aq as ge}from"./index-Dkj_NwFk.js";import{F as fe}from"./Field-Bsx8pB0b.js";import{P as pe}from"./PageContainer-_p5Kf-nW.js";let R;const D=()=>R||(R=ce(()=>import("./index-C6xNTZdA.js").then(o=>o.i),__vite__mapDeps([0,1,2])));function f(o,u){return ge(o,u)}function Se(){const o=l.useMemo(()=>{const e=X?.items||[],n=new Set,s=[];for(const a of e)n.has(a.id)||Y(a)||(n.add(a.id),s.push(a));return s.slice().sort(f)},[]),u=G(),_=J(),N=l.useRef(!1),[p,O]=l.useState(""),C=l.useMemo(()=>new Z(o,{keys:["title","tags","authors"],threshold:.4}),[o]),h=l.useMemo(()=>p?C.search(p).map(e=>e.item):o.slice().sort(f),[o,C,p]),[x,m]=l.useState(()=>new Set),g=l.useMemo(()=>h.filter(e=>x.has(e.id)).slice().sort(f),[h,x]),I=h.length,W=x.size;function j(e,n){m(s=>{const a=new Set(s);return n?a.add(e):a.delete(e),a})}function q(){h.length&&m(e=>{const n=new Set(e);for(const s of h)n.add(s.id);return n})}function z(){m(new Set)}function H(e,n){if(!e)return;const s=n||[],a=r=>new Set(r.map(i=>i.id));if(e==="random10SongCollection"){const r=Math.min(10,s.length),i=r===s.length?s:F(s,r);m(a(i));return}if(e==="sendMeSongbook"){const r=["NATION","NATIONS","MISSION","MISSIONS","ICP"],i=s.filter(c=>r.some(w=>le([c],w).length));if(i.length)i.sort(f),m(a(i));else{const c=F(s,Math.min(5,s.length));m(a(c))}return}if(e==="graceChordsSongbook"){const r=s.slice().sort(f);m(a(r))}}const[U,y]=l.useState(null),[S,k]=l.useState(!1),[P,$]=l.useState(()=>{try{return window.innerWidth<=640}catch{return!1}});l.useEffect(()=>{function e(){try{$(window.innerWidth<=640)}catch{}}return window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),l.useEffect(()=>{const n=new URLSearchParams(u.search||"").get("tags");if(!n)return;const s=n.split(",").map(r=>r.trim().toLowerCase()).filter(Boolean);if(!s.length)return;const a=o.filter(r=>(Array.isArray(r.tags)?r.tags.map(c=>String(c).toLowerCase()):[]).some(c=>s.includes(c)));a.length&&m(r=>{const i=new Set(r);return a.forEach(c=>i.add(c.id)),i})},[u.search,o]),l.useEffect(()=>{if(N.current)return;const e=u.state?.quickAction;e&&o.length&&(H(e,o),N.current=!0,_(u.pathname+(u.search||""),{replace:!0,state:null}))},[u.state,o.map(e=>e.id).join("|")]);async function Q(){if(g.length){k(!0);try{const{downloadSongbookPdf:e}=await D(),n=[];for(const s of g)try{const a=de(`songs/${s.filename}`),r=await ue(a),i=me(r),c=(i.sections||[]).map(B=>({section:B.label,lines:(B.lines||[]).map(d=>d.instrumental?{instrumental:{chords:Array.isArray(d.instrumental?.chords)?d.instrumental.chords.slice():[],repeat:typeof d.instrumental?.repeat=="number"?d.instrumental.repeat:void 0}}:d.comment?{plain:d.comment,chordPositions:[],comment:d.comment}:{plain:d.lyrics||"",chordPositions:(d.chords||[]).map(T=>({sym:T.sym,index:T.index}))})})),w=s.filename.replace(/\.chordpro$/,""),V=he({title:i.meta.title||s.title||w,key:i.meta.key||i.meta.originalkey||s.originalKey||"C",capo:i.meta?.capo,lyricsBlocks:c});n.push(V)}catch(a){console.error(a),b(`Failed to process ${s.filename}`)}n.length&&await e(n,{includeTOC:!0,coverImageDataUrl:U})}finally{k(!1)}}}function A(){D()}function K(e){const n=e.target.files?.[0];if(!n){y(null);return}if(n.size>2*1024*1024){b("Image must be under 2 MB"),e.target.value="",y(null);return}if(!n.type.startsWith("image/")){b("File must be an image"),e.target.value="",y(null);return}const s=new FileReader;s.onload=()=>y(String(s.result||"")),s.readAsDataURL(n)}return o.length===0?t.jsxs("div",{className:"container",children:[t.jsx("h1",{children:"No songs found"}),t.jsx("p",{className:"Small",children:"The song index is empty or failed to load."})]}):t.jsxs(pe,{children:[t.jsx(ee,{busy:S}),t.jsx(te,{title:"Songbook Builder",actions:t.jsxs("div",{className:"gc-toolbar__actions",children:[t.jsx(v,{onClick:z,disabled:!W,title:"Clear selection",leftIcon:t.jsx(se,{}),children:t.jsx("span",{className:"text-when-wide",children:"Clear"})}),t.jsx(v,{variant:"primary",onClick:Q,onMouseEnter:A,onFocus:A,disabled:!g.length||S,loading:S,title:g.length?"Export PDF":"Select some songs first",leftIcon:t.jsx(ne,{}),children:P?"PDF":t.jsxs(t.Fragment,{children:[t.jsx("span",{className:"text-when-wide",children:"Export PDF"}),t.jsx("span",{className:"text-when-narrow",children:"PDF"})]})})]})}),t.jsx(ae,{className:"gc-songbook-toolbar",style:{marginTop:8},children:t.jsx(fe,{label:"Upload Cover Image",className:"gc-songbook-cover",style:{minWidth:0},children:t.jsx("input",{className:"CoverInput",type:"file",accept:"image/*",onChange:K,style:P?{maxWidth:"50vw",textOverflow:"ellipsis",overflow:"hidden",whiteSpace:"nowrap"}:void 0})})}),t.jsxs("div",{className:"BuilderPage",style:{marginTop:8},children:[t.jsx("div",{className:"BuilderLeft",children:t.jsx("section",{className:"setlist-section songbook-add","data-role":"add",children:t.jsxs(L,{className:"setlist-pane",children:[t.jsxs("div",{className:["BuilderHeader","section-header"].filter(Boolean).join(" "),style:{display:"flex",alignItems:"center",gap:8},children:[t.jsx("strong",{style:{whiteSpace:"nowrap"},children:"Add songs"}),t.jsx(re,{value:p,onChange:e=>O(e.target.value),placeholder:"Search...",style:{flex:1,minWidth:0}}),t.jsxs(v,{onClick:q,disabled:!I,title:"Add all filtered",leftIcon:t.jsx(E,{}),variant:"primary",style:{marginLeft:"auto"},children:[t.jsxs("span",{className:"text-when-wide",children:["Add all (",I,")"]}),t.jsx("span",{className:"text-when-narrow",children:"All"})]})]}),t.jsx("div",{className:["BuilderScroll","setlist-scroll","pane--addSongs"].join(" "),style:{minHeight:0,flex:"1 1 auto",overflow:"auto",marginTop:6},role:"region","aria-label":"Song list",children:t.jsx("div",{className:"gc-list",style:{display:"grid",gap:".5rem",gridTemplateColumns:"repeat(auto-fill, minmax(320px, 1fr))"},children:h.map(e=>{const n=x.has(e.id),a=[(Array.isArray(e.authors)?e.authors.join(", "):e.authors||"")||"—",e.country].filter(Boolean).join(" • ");return t.jsx(ie,{title:e.title,subtitle:a,rightSlot:n?t.jsx(M,{variant:"destructive","aria-label":"Remove",title:"Remove",onClick:r=>{r.stopPropagation(),j(e.id,!1)},children:t.jsx(oe,{})}):t.jsx(M,{variant:"primary","aria-label":"Add",title:"Add",onClick:r=>{r.stopPropagation(),j(e.id,!0)},children:t.jsx(E,{})}),onClick:()=>j(e.id,!n)},e.id)})})})]})})}),t.jsx("div",{className:"BuilderRight",style:{minHeight:0,display:"flex",flexDirection:"column"},children:t.jsx("section",{className:"setlist-section songbook-current","data-role":"current",children:t.jsxs(L,{className:"setlist-pane",children:[t.jsx("div",{className:"BuilderHeader section-header",children:t.jsxs("strong",{children:["Current selection (",g.length,")"]})}),t.jsx("div",{className:"BuilderScroll pane--currentSet",role:"region","aria-label":"Selected songs",style:{minHeight:0,flex:"1 1 auto",overflow:"auto",marginTop:6},children:t.jsx("ol",{className:"List",style:{listStyle:"decimal inside",margin:0,padding:0},children:g.map(e=>t.jsxs("li",{children:[e.title,Array.isArray(e.authors)&&e.authors.length?t.jsxs("span",{className:"Small",children:[" — ",e.authors.join(", ")]}):null]},e.id))})})]})})})]})]})}export{Se as default};
