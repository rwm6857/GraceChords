const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-DUvKCHnn.js","./index-hUgj_0i5.js","./index-DAWVrhm9.css","./jszip.min-BX1uOeVY.js"])))=>i.map(i=>d[i]);
import{j as e,u as Ne,a as ke,r,i as Te,d as J,F as De,B as $e,T as Ae,I as q,b as p,P as G,S as Oe,C as Ee,c as Ke,D as V,e as _e,L as Be,M as Me,f as Ue,g as Y,K as Fe,A as Re,h as He,k as We,l as Xe,_ as te,m as ze,p as Je,s as qe,t as Ge,n as Ve,o as L,q as Ye}from"./index-hUgj_0i5.js";import{P as Qe}from"./PageContainer-Bos7Hjn_.js";const se="gracechords.sets.v1";function T(){try{const o=localStorage.getItem(se);return o?JSON.parse(o):{sets:{}}}catch{return{sets:{}}}}function ne(o){localStorage.setItem(se,JSON.stringify(o))}function Ze(){return typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():"id-"+Math.random().toString(36).slice(2)+Date.now().toString(36)}function N(){const{sets:o}=T();return Object.values(o).sort((c,u)=>(u.updatedAt||0)-(c.updatedAt||0))}function ie(o){const{sets:c}=T();return c[o]||null}function k(o){const c=Date.now(),u={id:o.id||Ze(),name:o.name?.trim()||"Untitled Set",items:Array.isArray(o.items)?o.items:[],createdAt:o.createdAt||c,updatedAt:c},m=T();return m.sets[u.id]=u,ne(m),u}function et(o){const c=T();return c.sets[o]?(delete c.sets[o],ne(c),!0):!1}function tt(o){const c=ie(o);return c?k({name:`Copy of ${c.name}`,items:c.items.map(u=>({...u}))}):null}function Q({label:o,id:c,children:u,className:m="",...y}){return e.jsxs("label",{className:"gc-field",htmlFor:c,children:[o?e.jsx("span",{className:"gc-label",children:o}):null,e.jsx("span",{className:"gc-select",children:e.jsx("select",{id:c,className:m,...y,children:u})})]})}let Z;const ee=()=>Z||(Z=te(()=>import("./index-DUvKCHnn.js").then(o=>o.i),__vite__mapDeps([0,1,2]),import.meta.url));function it(){const{code:o}=Ne(),c=ke(),[u,m]=r.useState("Untitled Set"),[y,ae]=r.useState(""),[g,oe]=r.useState([]),[w,le]=r.useState(()=>{try{return localStorage.getItem("pref:icpOnly")==="1"}catch{return!1}});r.useEffect(()=>{try{localStorage.setItem("pref:icpOnly",w?"1":"0")}catch{}},[w]);const[a,h]=r.useState([]),[K,re]=r.useState({}),[D,b]=r.useState("");Object.keys(K).length;const[$,_]=r.useState(!1),[j,S]=r.useState(null),[ce,B]=r.useState(()=>N()),[de,P]=r.useState("");r.useEffect(()=>{const t=Te?.items||[],s=new Set,n=[];for(const i of t)s.has(i.id)||(s.add(i.id),n.push(i));oe(n)},[]),r.useEffect(()=>{let t=!1;async function s(){const n={};for(const i of a){const l=g.find(C=>C.id===i.id);if(!l)continue;const d=l.filename.replace(/\.chordpro$/i,""),f=`./pptx/${d}.pptx`;await Xe(f,d)&&(n[d]=!0)}t||re(n)}return s(),()=>{t=!0}},[a,g]),r.useEffect(()=>{if(!o)return;const{entries:t,error:s}=J(o);if(s){alert(s),c("/setlist",{replace:!0});return}h(t.map(n=>({id:n.id,toKey:n.toKey})))},[o]),r.useEffect(()=>{try{const t=localStorage.getItem("setlist");if(!t||N().length>0)return;const s=JSON.parse(t);if(s?.name||(s?.list?.length||0)>0){const n=k({name:s.name||"Imported Set",items:s.list||[]});B(N()),S(n.id),m(n.name),h(n.items||[]),P(n.id)}}catch{}},[]);const A=r.useMemo(()=>new De(g,{keys:["title","tags"],threshold:.4}),[g]);function ue(t){return!w||(Array.isArray(t.tags)?t.tags.includes("ICP"):t.tags==="ICP")}const pe=r.useMemo(()=>(y?A.search(y).map(s=>s.item):g.slice().sort((s,n)=>s.title.localeCompare(n.title))).filter(ue),[y,A,g,w]);function M(t){a.find(s=>s.id===t.id)||h([...a,{id:t.id,toKey:t.originalKey||"C"}])}function fe(t){h(a.filter(s=>s.id!==t))}function U(t,s){const n=a.findIndex(f=>f.id===t);if(n<0)return;const i=n+(s==="up"?-1:1);if(i<0||i>=a.length)return;const l=a.slice(),[d]=l.splice(n,1);l.splice(i,0,d),h(l)}function me(t,s){const n=a.findIndex(d=>d.id===t);if(n<0||s<0||s>=a.length||n===s)return;const i=a.slice(),[l]=i.splice(n,1);i.splice(s,0,l),h(i)}function he(t,s){h(a.map(n=>n.id===t?{...n,toKey:s}:n))}function I(t){B(N()),P(t||"")}function F(){S(null),m("Untitled Set"),h([]),P("")}function ge(){const t=u?.trim()||"Untitled Set",s=k({id:j,name:t,items:a});m(s.name),S(s.id),I(s.id)}function xe(t){const s=t.target.value;if(P(s),!s)return;const n=ie(s);n&&(S(n.id),m(n.name||"Untitled Set"),h(n.items||[]))}function ye(){if(!j){const s=`Copy of ${u||"Untitled Set"}`,n=k({id:null,name:s,items:a});m(n.name),S(n.id),I(n.id);return}const t=tt(j);t&&(S(t.id),m(t.name),h(t.items||[]),I(t.id))}function je(){j&&window.confirm(`Delete set "${u}"? This cannot be undone.`)&&(et(j),F(),I(""))}async function Se(){_(!0);try{const{downloadMultiSongPdf:t}=await ee(),s=[];for(const n of a){const i=g.find(l=>l.id===n.id);if(i)try{const l=`./songs/${i.filename}`,d=await ze(l),f=Je(d),x=f.meta?.key||f.meta?.originalkey||i.originalKey||"C",C=qe(x,n.toKey||x),Pe=(f.sections||[]).map(X=>({section:X.label,lines:(X.lines||[]).map(v=>({plain:v.comment?v.comment:v.lyrics||"",chordPositions:(v.chords||[]).map(z=>({sym:Ge(z.sym,C),index:z.index})),comment:v.comment?v.comment:void 0}))})),Ie=i.filename.replace(/\.chordpro$/i,""),Le=Ve({title:f.meta?.title||i.title||Ie,key:n.toKey||x,capo:f.meta?.capo,lyricsBlocks:Pe});s.push(Le)}catch(l){console.error(l),L(`Failed to process ${i.filename}`)}}s.length&&await t(s)}finally{_(!1)}}function R(){ee()}const[O,H]=r.useState(""),[E,W]=r.useState("");function ve(){const t=Ye(a);H(t)}async function we(){try{const t=`${location.origin}${location.pathname}#/set/${O}`;await navigator.clipboard.writeText(t);try{L?.("Link copied!")}catch{}}catch{alert("Failed to copy link")}}function Ce(){const t=String(E||"").trim(),{entries:s,error:n}=J(t);if(n){alert(n);return}h(s.map(i=>({id:i.id,toKey:i.toKey}))),W(""),H(t)}async function be(){b(`Bundling 0/${a.length}…`);const t=(await te(async()=>{const{default:i}=await import("./jszip.min-BX1uOeVY.js").then(l=>l.j);return{default:i}},__vite__mapDeps([3,1,2]),import.meta.url)).default,s=new t;let n=0;for(let i=0;i<a.length;i++){const l=a[i],d=g.find(x=>x.id===l.id);if(!d){b(`Bundling ${i+1}/${a.length}…`);continue}b(`Bundling ${i+1}/${a.length}…`);const f=d.filename.replace(/\.chordpro$/i,"");if(K[f])try{const x=await fetch(`./pptx/${f}.pptx`);if(!x.ok)continue;const C=await x.blob();n++,s.file(`${String(n).padStart(2,"0")}-${f}.pptx`,C)}catch{}}if(n>0){const i=await s.generateAsync({type:"blob"}),l=new Date().toISOString().slice(0,10).replace(/-/g,""),d=document.createElement("a");d.href=URL.createObjectURL(i),d.download=`setlist-pptx-${l}.zip`,d.click(),URL.revokeObjectURL(d.href)}else try{L&&L("No PPTX files found for selected songs")||alert("No PPTX files found for selected songs")}catch{}b("")}return e.jsxs(Qe,{children:[e.jsx($e,{busy:$}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx("div",{}),e.jsx("h1",{style:{margin:0},children:"Setlist Builder"}),e.jsx("div",{})]}),e.jsxs(Ae,{className:"card",style:{marginTop:8,position:"static"},children:[e.jsx(q,{label:"Set","aria-label":"Set name",value:u,onChange:t=>m(t.target.value),style:{minWidth:220},placeholder:"Sunday AM"}),e.jsxs(Q,{"aria-label":"Saved sets",value:de,onChange:xe,children:[e.jsx("option",{value:"",children:"— Load saved set —"}),ce.map(t=>e.jsxs("option",{value:t.id,children:[t.name," · ",new Date(t.updatedAt).toLocaleString()]},t.id))]}),e.jsxs(p,{onClick:F,title:"New set",iconLeft:e.jsx(G,{}),children:[" ",e.jsx("span",{className:"text-when-wide",children:"New"})]}),e.jsxs(p,{variant:"primary",onClick:ge,title:"Save set",iconLeft:e.jsx(Oe,{}),children:[" ",e.jsx("span",{className:"text-when-wide",children:"Save"})]}),e.jsxs(p,{onClick:ye,disabled:!a.length,title:"Duplicate set",iconLeft:e.jsx(Ee,{}),children:[" ",e.jsx("span",{className:"text-when-wide",children:"Duplicate"})]}),e.jsxs(p,{onClick:je,disabled:!j,title:"Delete set",iconLeft:e.jsx(Ke,{}),children:[" ",e.jsx("span",{className:"text-when-wide",children:"Delete"})]}),e.jsxs("div",{style:{marginLeft:"auto",display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"},children:[e.jsx(p,{variant:"primary",onClick:Se,onMouseEnter:R,onFocus:R,disabled:$,title:"Export set as a single PDF",iconLeft:e.jsx(V,{}),children:$?"Exporting…":e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-when-wide",children:"Export PDF"}),e.jsx("span",{className:"text-when-narrow",children:"PDF"})]})}),e.jsx(p,{onClick:be,disabled:a.length===0||!!D,title:a.length===0?"Add songs to export PPTX bundle":"Export PPTX bundle for selected songs",iconLeft:e.jsx(V,{}),children:D||e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-when-wide",children:"Export PPTX"}),e.jsx("span",{className:"text-when-narrow",children:"PPTX"})]})}),e.jsx(p,{onClick:()=>h([]),title:"Clear setlist",iconLeft:e.jsx(_e,{}),children:e.jsx("span",{className:"text-when-wide",children:"Clear"})}),e.jsxs(p,{as:Be,to:a.length?`/worship/${a.map(t=>t.id).join(",")}?toKeys=${a.map(t=>encodeURIComponent(t.toKey)).join(",")}`:"#",title:a.length?"Open Worship Mode with this set":"Add songs to open Worship Mode","aria-disabled":!a.length,onClick:t=>{a.length||t.preventDefault()},iconLeft:e.jsx(Me,{}),children:[e.jsx("span",{className:"text-when-wide",children:"Worship Mode"}),e.jsx("span",{className:"text-when-narrow",children:"Worship"})]})]})]}),e.jsxs("div",{className:"card",style:{marginTop:8},children:[e.jsx("strong",{children:"Set Sharing"}),e.jsxs("div",{className:"Row",style:{alignItems:"center",gap:8,flexWrap:"wrap",marginTop:6},children:[e.jsx(p,{onClick:ve,title:"Generate code for this set",children:"Generate Set Code"}),e.jsx("input",{readOnly:!0,placeholder:"(code)",value:O,onFocus:t=>t.currentTarget.select(),style:{width:240},"aria-label":"Set code"}),e.jsx(p,{onClick:we,disabled:!O,title:"Copy shareable link",iconLeft:e.jsx(Ue,{}),children:"Copy Link"})]}),e.jsxs("div",{className:"Row",style:{alignItems:"center",gap:8,flexWrap:"wrap",marginTop:8},children:[e.jsx("span",{className:"meta",children:"Load from code"}),e.jsx("input",{value:E,onChange:t=>W(t.target.value),placeholder:"Paste set code…",style:{width:240},"aria-label":"Load set code"}),e.jsx(p,{onClick:Ce,disabled:!E.trim(),title:"Load set from code",children:"Load"})]})]}),e.jsxs("div",{className:"BuilderPage",style:{marginTop:8},children:[e.jsx("div",{className:"BuilderLeft",children:e.jsx("div",{className:"card",style:{display:"flex",flexDirection:"column",flex:"1 1 auto",minHeight:0},children:e.jsxs("div",{className:"BuilderScroll",style:{minHeight:0,flex:"1 1 auto",overflow:"auto",marginTop:8},children:[e.jsxs("div",{className:"BuilderHeader",children:[e.jsx("strong",{children:"Add songs"}),e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",marginTop:6},children:[e.jsx(q,{value:y,onChange:t=>ae(t.target.value),placeholder:"Search...",style:{flex:1}}),e.jsxs("label",{className:"row",style:{gap:6,alignItems:"center"},children:[e.jsx("input",{type:"checkbox",checked:w,onChange:t=>le(t.target.checked)}),e.jsx("span",{className:"meta",title:"Limit results to songs tagged ICP",children:"ICP only"})]})]})]}),A?e.jsx("div",{style:{display:"grid",gap:".5rem",gridTemplateColumns:"repeat(auto-fill, minmax(320px, 1fr))",marginTop:6},children:pe.map(t=>e.jsx(Y,{title:t.title,subtitle:`${t.originalKey||""}${t.tags?.length?` • ${t.tags.join(", ")}`:""}`,rightSlot:e.jsx(p,{"aria-label":"Add",title:"Add to set",variant:"primary",iconLeft:e.jsx(G,{}),iconOnly:!0,onClick:s=>{s.stopPropagation(),M(t)}}),onClick:()=>M(t)},t.id))}):e.jsx("div",{children:"Loading search…"})]})})}),e.jsx("div",{className:"BuilderRight",style:{minHeight:0,display:"flex",flexDirection:"column"},children:e.jsxs("div",{className:"card",style:{display:"flex",flexDirection:"column",flex:"1 1 auto",minHeight:0},children:[e.jsxs("div",{className:"BuilderScroll",style:{minHeight:0,flex:"1 1 auto",overflow:"auto",marginTop:8},children:[e.jsx("div",{className:"BuilderHeader",children:e.jsxs("strong",{children:["Current setlist (",a.length,")"]})}),e.jsx("div",{style:{marginTop:6},children:a.map((t,s)=>{const n=g.find(i=>i.id===t.id);return n?e.jsx(Y,{draggable:!0,onDragStart:i=>{i.dataTransfer.setData("text/plain",String(t.id)),i.dataTransfer.effectAllowed="move"},onDragOver:i=>{i.preventDefault(),i.dataTransfer.dropEffect="move"},onDrop:i=>{i.preventDefault();const l=i.dataTransfer.getData("text/plain");me(l,s)},title:n.title,subtitle:`Original: ${n.originalKey||"—"}`,rightSlot:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx(Q,{value:t.toKey,onChange:i=>he(t.id,i.target.value),children:Fe.map(i=>e.jsx("option",{value:i,children:i},i))}),e.jsx(p,{onClick:()=>U(t.id,"up"),title:"Move up",iconLeft:e.jsx(Re,{})}),e.jsx(p,{onClick:()=>U(t.id,"down"),title:"Move down",iconLeft:e.jsx(He,{})}),e.jsx(p,{onClick:()=>fe(t.id),title:"Remove",iconLeft:e.jsx(We,{}),iconOnly:!0,style:{color:"#b91c1c"}})]})},t.id):null})})]}),e.jsxs("div",{className:"print-only",style:{marginTop:16},children:[e.jsx("h2",{style:{fontSize:"20pt",margin:"0 0 8pt 0"},children:u}),e.jsx("ol",{style:{fontSize:"12pt",lineHeight:1.4,paddingLeft:"1.2em"},children:a.map(t=>{const s=g.find(n=>n.id===t.id);return s?e.jsxs("li",{children:[s.title," — ",t.toKey||s.originalKey||"—"]},t.id):null})})]})]})})]})]})}export{it as default};
