const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-Ch0Du8gd.js","./index-oaQ1E6S8.js","./index-Bfhc0_j7.css"])))=>i.map(i=>d[i]);
import{r as a,i as U,F as K,j as e,B as Q,T as V,a as g,e as W,D as G,I as J,P as A,c as X,M as Y,_ as Z,f as ee,p as se,n as te,g as v,k as ne}from"./index-oaQ1E6S8.js";let F;const T=()=>F||(F=Z(()=>import("./index-Ch0Du8gd.js").then(i=>i.i),__vite__mapDeps([0,1,2]),import.meta.url));function b(i,r){return ne(i,r)}function ae(){const i=a.useMemo(()=>{const s=U?.items||[],t=new Set,n=[];for(const l of s)t.has(l.id)||(t.add(l.id),n.push(l));return n.slice().sort(b)},[]),[r,D]=a.useState(""),[m,B]=a.useState(()=>{try{return localStorage.getItem("pref:icpOnly")==="1"}catch{return!1}});a.useEffect(()=>{try{localStorage.setItem("pref:icpOnly",m?"1":"0")}catch{}},[m]);const C=a.useMemo(()=>new K(i,{keys:["title","tags"],threshold:.4}),[i]),c=a.useMemo(()=>(r?C.search(r).map(t=>t.item):i.slice().sort(b)).filter(t=>!m||(Array.isArray(t.tags)?t.tags.includes("ICP"):t.tags==="ICP")),[i,C,r,m]),[x,p]=a.useState(()=>new Set),o=a.useMemo(()=>c.filter(s=>x.has(s.id)).slice().sort(b),[c,x]),S=c.length,w=x.size;function y(s,t){p(n=>{const l=new Set(n);return t?l.add(s):l.delete(s),l})}function E(){c.length&&p(s=>{const t=new Set(s);for(const n of c)t.add(n.id);return t})}function O(){p(new Set)}const[N,M]=a.useState(!0),[R,f]=a.useState(null),[j,I]=a.useState(!1);async function _(){if(o.length){I(!0);try{const{downloadSongbookPdf:s}=await T(),t=[];for(const n of o)try{const l=`./songs/${n.filename}`,u=await ee(l),h=se(u),$=(h.sections||[]).map(P=>({section:P.label,lines:(P.lines||[]).map(d=>({plain:d.comment?d.comment:d.lyrics||"",chordPositions:(d.chords||[]).map(L=>({sym:L.sym,index:L.index})),comment:d.comment?d.comment:void 0}))})),z=n.filename.replace(/\.chordpro$/,""),q=te({title:h.meta.title||n.title||z,key:h.meta.key||h.meta.originalkey||n.originalKey||"C",capo:h.meta?.capo,lyricsBlocks:$});t.push(q)}catch(l){console.error(l),v(`Failed to process ${n.filename}`)}t.length&&await s(t,{includeTOC:N,coverImageDataUrl:R})}finally{I(!1)}}}function k(){T()}function H(s){const t=s.target.files?.[0];if(!t){f(null);return}if(t.size>2*1024*1024){v("Image must be under 2 MB"),s.target.value="",f(null);return}if(!t.type.startsWith("image/")){v("File must be an image"),s.target.value="",f(null);return}const n=new FileReader;n.onload=()=>f(String(n.result||"")),n.readAsDataURL(t)}return i.length===0?e.jsxs("div",{className:"container",children:[e.jsx("h1",{children:"No songs found"}),e.jsx("p",{className:"Small",children:"The song index is empty or failed to load."})]}):e.jsxs("div",{className:"container",children:[e.jsx(Q,{busy:j}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx("div",{}),e.jsx("h1",{style:{margin:0},children:"Songbook Builder"}),e.jsx("div",{})]}),e.jsxs(V,{className:"card",style:{marginTop:12},children:[e.jsxs("div",{className:"Field",children:[e.jsx("input",{id:"sb-toc",type:"checkbox",checked:N,onChange:s=>M(s.target.checked)}),e.jsx("label",{htmlFor:"sb-toc",children:"Include table of contents"})]}),e.jsxs("div",{className:"Field",children:[e.jsx("label",{htmlFor:"sb-cover",children:"Cover page (image):"}),e.jsx("input",{id:"sb-cover",className:"CoverInput",type:"file",accept:"image/*",onChange:H})]}),e.jsxs("div",{style:{marginLeft:"auto",display:"flex",gap:6},children:[e.jsx(g,{onClick:O,disabled:!w,title:"Clear selection",iconLeft:e.jsx(W,{}),children:e.jsx("span",{className:"text-when-wide",children:"Clear"})}),e.jsx(g,{variant:"primary",onClick:_,onMouseEnter:k,onFocus:k,disabled:!o.length||j,title:o.length?"Export PDF":"Select some songs first",iconLeft:e.jsx(G,{}),children:j?"Exporting…":e.jsxs(e.Fragment,{children:[e.jsxs("span",{className:"text-when-wide",children:["Export PDF (",o.length,")"]}),e.jsx("span",{className:"text-when-narrow",children:"PDF"})]})})]})]}),e.jsxs("div",{className:"BuilderPage",style:{marginTop:12},children:[e.jsx("div",{className:"BuilderLeft",children:e.jsxs("div",{className:"card",style:{display:"flex",flexDirection:"column",flex:"1 1 auto",minHeight:0},children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Add songs"}),e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",marginTop:6},children:[e.jsx(J,{value:r,onChange:s=>D(s.target.value),placeholder:"Search...",style:{flex:1}}),e.jsxs("label",{className:"row",style:{gap:6,alignItems:"center"},children:[e.jsx("input",{type:"checkbox",checked:m,onChange:s=>B(s.target.checked)}),e.jsx("span",{className:"meta",title:"Limit results to songs tagged ICP",children:"ICP only"})]}),e.jsxs(g,{onClick:E,disabled:!S,title:"Add all filtered",iconLeft:e.jsx(A,{}),children:[e.jsxs("span",{className:"text-when-wide",children:["Add all (",S,")"]}),e.jsx("span",{className:"text-when-narrow",children:"All"})]})]})]}),e.jsxs("div",{className:"Row Small",style:{marginTop:".5rem"},children:[e.jsx("strong",{children:w})," selected"]}),e.jsx("div",{className:"SongList",role:"region","aria-label":"Song list",style:{display:"flex",flexDirection:"column",minHeight:0,flex:"1 1 auto",overflow:"auto",marginTop:6},children:e.jsx("div",{className:"gc-list",style:{display:"grid",gap:".5rem"},children:c.map(s=>{const t=x.has(s.id),l=[(Array.isArray(s.authors)?s.authors.join(", "):s.authors||"")||"—",s.country].filter(Boolean).join(" • ");return e.jsx(X,{title:s.title,subtitle:l,rightSlot:t?e.jsx(g,{"aria-label":"Remove",title:"Remove",onClick:u=>{u.stopPropagation(),y(s.id,!1)},iconLeft:e.jsx(Y,{}),iconOnly:!0,style:{color:"#b91c1c"}}):e.jsx(g,{"aria-label":"Add",title:"Add",variant:"primary",onClick:u=>{u.stopPropagation(),y(s.id,!0)},iconLeft:e.jsx(A,{}),iconOnly:!0}),onClick:()=>y(s.id,!t)},s.id)})})})]})}),e.jsx("div",{className:"BuilderRight",style:{minHeight:0,display:"flex",flexDirection:"column"},children:e.jsxs("div",{className:"card",style:{display:"flex",flexDirection:"column",flex:"1 1 auto",minHeight:0},children:[e.jsxs("strong",{children:["Current selection (",o.length,")"]}),e.jsx("div",{className:"PreviewList",role:"region","aria-label":"Selected songs",style:{minHeight:0,flex:"1 1 auto",overflow:"auto",marginTop:6},children:e.jsx("ol",{className:"List",style:{listStyle:"decimal inside"},children:o.map(s=>e.jsxs("li",{children:[s.title,Array.isArray(s.authors)&&s.authors.length?e.jsxs("span",{className:"Small",children:[" — ",s.authors.join(", ")]}):null]},s.id))})})]})})]})]})}export{ae as default};
