const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./pdf-Xp_2Ry0-.js","./index-Elk7g4Vv.js","./index-CgYN5LtB.css","./fonts-OQpvcT7Z.js","./pdf-plan-DduNKW6E.js","./jszip.min-Bxb5TuWh.js"])))=>i.map(i=>d[i]);
import{r as u,i as me,F as pe,j as t,L as fe,K as he,A as ge,a as xe,R as ye,D as R,h as je,t as M,_ as F,f as Se,p as be,s as ve,b as we}from"./index-Elk7g4Vv.js";const H="gracechords.sets.v1";function N(){try{const o=localStorage.getItem(H);return o?JSON.parse(o):{sets:{}}}catch{return{sets:{}}}}function J(o){localStorage.setItem(H,JSON.stringify(o))}function Ce(){return typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():"id-"+Math.random().toString(36).slice(2)+Date.now().toString(36)}function w(){const{sets:o}=N();return Object.values(o).sort((a,p)=>(p.updatedAt||0)-(a.updatedAt||0))}function W(o){const{sets:a}=N();return a[o]||null}function C(o){var d;const a=Date.now(),p={id:o.id||Ce(),name:((d=o.name)==null?void 0:d.trim())||"Untitled Set",items:Array.isArray(o.items)?o.items:[],createdAt:o.createdAt||a,updatedAt:a},y=N();return y.sets[p.id]=p,J(y),p}function Ne(o){const a=N();return a.sets[o]?(delete a.sets[o],J(a),!0):!1}function ke(o){const a=W(o);return a?C({name:`Copy of ${a.name}`,items:a.items.map(p=>({...p}))}):null}let B;const z=()=>B||(B=F(()=>import("./pdf-Xp_2Ry0-.js"),__vite__mapDeps([0,1,2,3,4]),import.meta.url));function Ke(){const[o,a]=u.useState("Untitled Set"),[p,y]=u.useState(""),[d,V]=u.useState([]),[l,f]=u.useState([]),[I,X]=u.useState({}),[k,j]=u.useState(""),T=Object.keys(I).length,[g,x]=u.useState(null),[Y,_]=u.useState(()=>w()),[q,S]=u.useState("");u.useEffect(()=>{var e;V(((e=me)==null?void 0:e.items)||[])},[]),u.useEffect(()=>{let e=!1;async function s(){const n={};for(const i of l){const r=d.find(h=>h.id===i.id);if(!r)continue;const c=`./pptx/${r.id}.pptx`;await je(c,r.id)&&(n[r.id]=!0)}e||X(n)}return s(),()=>{e=!0}},[l,d]),u.useEffect(()=>{var e;try{const s=localStorage.getItem("setlist");if(!s||w().length>0)return;const n=JSON.parse(s);if(n!=null&&n.name||(((e=n==null?void 0:n.list)==null?void 0:e.length)||0)>0){const i=C({name:n.name||"Imported Set",items:n.list||[]});_(w()),x(i.id),a(i.name),f(i.items||[]),S(i.id)}}catch{}},[]);const P=u.useMemo(()=>new pe(d,{keys:["title","tags"],threshold:.4}),[d]),G=u.useMemo(()=>p?P.search(p).map(e=>e.item):d.slice().sort((e,s)=>e.title.localeCompare(s.title)),[p,P,d]);function Q(e){l.find(s=>s.id===e.id)||f([...l,{id:e.id,toKey:e.originalKey||"C"}])}function Z(e){f(l.filter(s=>s.id!==e))}function $(e,s){const n=l.findIndex(m=>m.id===e);if(n<0)return;const i=n+(s==="up"?-1:1);if(i<0||i>=l.length)return;const r=l.slice(),[c]=r.splice(n,1);r.splice(i,0,c),f(r)}function ee(e,s){f(l.map(n=>n.id===e?{...n,toKey:s}:n))}function A(e){f(s=>s.map(n=>{const i=d.find(c=>c.id===n.id),r=n.toKey||(i==null?void 0:i.originalKey)||"C";return{...n,toKey:M(r,e)}}))}function te(){f(e=>e.map(s=>{const n=d.find(i=>i.id===s.id);return{...s,toKey:(n==null?void 0:n.originalKey)||"C"}}))}function b(e){_(w()),S(e||"")}function D(){x(null),a("Untitled Set"),f([]),S("")}function ne(){const e=(o==null?void 0:o.trim())||"Untitled Set",s=C({id:g,name:e,items:l});a(s.name),x(s.id),b(s.id)}function se(e){const s=e.target.value;if(S(s),!s)return;const n=W(s);n&&(x(n.id),a(n.name||"Untitled Set"),f(n.items||[]))}function ie(){if(!g){const s=`Copy of ${o||"Untitled Set"}`,n=C({id:null,name:s,items:l});a(n.name),x(n.id),b(n.id);return}const e=ke(g);e&&(x(e.id),a(e.name),f(e.items||[]),b(e.id))}function oe(){g&&window.confirm(`Delete set "${o}"? This cannot be undone.`)&&(Ne(g),D(),b(""))}async function ae(){var n,i,r;const{downloadMultiSongPdf:e}=await z(),s=[];for(const c of l){const m=d.find(h=>h.id===c.id);if(m)try{const h=`./songs/${m.filename}`,ce=await Se(h),v=be(ce),K=((n=v.meta)==null?void 0:n.key)||((i=v.meta)==null?void 0:i.originalkey)||m.originalKey||"C",de=ve(K,c.toKey||K),ue=v.blocks.map(E=>({section:E.section,lines:E.lines.map(U=>({plain:U.text,chordPositions:(U.chords||[]).map(O=>({sym:M(O.sym,de),index:O.index}))}))}));s.push({title:((r=v.meta)==null?void 0:r.title)||m.title,key:c.toKey||K,lyricsBlocks:ue})}catch(h){console.error(h),we(`Failed to process ${m.filename}`)}}s.length&&await e(s,{lyricSizePt:16,chordSizePt:16})}function L(){z()}async function le(){j(`Bundling 0/${l.length}…`);const e=(await F(async()=>{const{default:i}=await import("./jszip.min-Bxb5TuWh.js").then(r=>r.j);return{default:i}},__vite__mapDeps([5,1,2]),import.meta.url)).default,s=new e;let n=0;for(let i=0;i<l.length;i++){const r=l[i],c=d.find(m=>m.id===r.id);if(!c){j(`Bundling ${i+1}/${l.length}…`);continue}if(j(`Bundling ${i+1}/${l.length}…`),!!I[c.id])try{const m=await fetch(`./pptx/${c.id}.pptx`);if(!m.ok)continue;const h=await m.blob();n++,s.file(`${String(n).padStart(2,"0")}-${c.id}.pptx`,h)}catch{}}if(n>0){const i=await s.generateAsync({type:"blob"}),r=new Date().toISOString().slice(0,10).replace(/-/g,""),c=document.createElement("a");c.href=URL.createObjectURL(i),c.download=`setlist-pptx-${r}.zip`,c.click(),URL.revokeObjectURL(c.href)}j("")}function re(){window.print()}return t.jsxs("div",{className:"container",children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[t.jsx("div",{children:t.jsx(fe,{to:"/",className:"back",children:"← Back"})}),t.jsx("h1",{style:{margin:0},children:"Setlist Builder"}),t.jsx("div",{})]}),t.jsxs("div",{className:"card toolbar",style:{marginTop:12},children:[t.jsxs("label",{style:{display:"flex",alignItems:"center",gap:6},children:[t.jsx("span",{children:"Set:"}),t.jsx("input",{"aria-label":"Set name",value:o,onChange:e=>a(e.target.value),style:{minWidth:220},placeholder:"Sunday AM"})]}),t.jsxs("select",{"aria-label":"Saved sets",value:q,onChange:se,children:[t.jsx("option",{value:"",children:"— Load saved set —"}),Y.map(e=>t.jsxs("option",{value:e.id,children:[e.name," · ",new Date(e.updatedAt).toLocaleString()]},e.id))]}),t.jsx("button",{className:"btn",onClick:D,children:"New"}),t.jsx("button",{className:"btn primary",onClick:ne,children:"Save"}),t.jsx("button",{className:"btn",onClick:ie,disabled:!l.length,children:"Duplicate"}),t.jsx("button",{className:"btn",onClick:oe,disabled:!g,children:"Delete"}),t.jsxs("div",{style:{marginLeft:"auto",display:"flex",alignItems:"center",gap:6},children:[t.jsx("span",{className:"meta",children:"Transpose:"}),t.jsx("button",{className:"btn",onClick:()=>A(-1),title:"Transpose set down 1 semitone",children:"–1"}),t.jsx("button",{className:"btn",onClick:te,title:"Reset all to originals",children:"Reset"}),t.jsx("button",{className:"btn",onClick:()=>A(1),title:"Transpose set up 1 semitone",children:"+1"})]})]}),t.jsxs("div",{className:"card",style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12},children:[t.jsx("div",{children:t.jsxs("div",{style:{marginTop:8},children:[t.jsx("strong",{children:"Add songs"}),t.jsx("input",{value:p,onChange:e=>y(e.target.value),placeholder:"Search...",style:{display:"block",width:"100%",marginTop:6}}),t.jsx("div",{style:{minHeight:0,maxHeight:300,overflow:"auto",marginTop:6},children:P?G.map(e=>{var s;return t.jsxs("div",{className:"row",style:{padding:"6px 0"},children:[t.jsxs("div",{style:{flex:1},children:[t.jsx("div",{style:{fontWeight:600},children:e.title}),t.jsxs("div",{className:"meta",children:[e.originalKey||"",(s=e.tags)!=null&&s.length?` • ${e.tags.join(", ")}`:""]})]}),t.jsx("button",{className:"btn",onClick:()=>Q(e),children:"Add"})]},e.id)}):t.jsx("div",{children:"Loading search…"})})]})}),t.jsxs("div",{children:[t.jsxs("strong",{children:["Current setlist (",l.length,")"]}),t.jsx("div",{style:{minHeight:0,maxHeight:360,overflow:"auto",marginTop:6},children:l.map(e=>{const s=d.find(n=>n.id===e.id);return s?t.jsxs("div",{className:"row",style:{padding:"6px 0"},children:[t.jsxs("div",{style:{flex:1},children:[t.jsx("div",{style:{fontWeight:600},children:s.title}),t.jsxs("div",{className:"meta",children:["Original: ",s.originalKey||"—"]})]}),t.jsx("select",{value:e.toKey,onChange:n=>ee(e.id,n.target.value),children:he.map(n=>t.jsx("option",{value:n,children:n},n))}),t.jsx("button",{className:"btn",onClick:()=>$(e.id,"up"),title:"Move up",children:t.jsx(ge,{})}),t.jsx("button",{className:"btn",onClick:()=>$(e.id,"down"),title:"Move down",children:t.jsx(xe,{})}),t.jsx("button",{className:"btn",onClick:()=>Z(e.id),title:"Remove",children:t.jsx(ye,{})})]},e.id):null})}),t.jsxs("div",{style:{display:"flex",gap:8,marginTop:8},children:[t.jsxs("button",{className:"btn primary iconbtn",onClick:ae,onMouseEnter:L,onFocus:L,children:[t.jsx(R,{})," Export PDF"]}),t.jsx("button",{className:"btn iconbtn",onClick:le,disabled:T===0||!!k,title:T===0?"No PPTX files found for this set.":"",children:k||t.jsxs(t.Fragment,{children:[t.jsx(R,{})," Bundle PPTX"]})}),t.jsx("button",{className:"btn",onClick:re,children:"Print"}),t.jsx("button",{className:"btn",onClick:()=>f([]),children:"Clear"})]}),t.jsxs("div",{className:"print-only",style:{marginTop:16},children:[t.jsx("h2",{style:{fontSize:"20pt",margin:"0 0 8pt 0"},children:o}),t.jsx("ol",{style:{fontSize:"12pt",lineHeight:1.4,paddingLeft:"1.2em"},children:l.map(e=>{const s=d.find(n=>n.id===e.id);return s?t.jsxs("li",{children:[s.title," — ",e.toKey||s.originalKey||"—"]},e.id):null})})]})]})]})]})}export{Ke as default};
