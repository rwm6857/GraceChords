const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-Cg57-isj.js","./index-B-kUmedf.css"])))=>i.map(i=>d[i]);
import{d as U,_ as J}from"./index-Cg57-isj.js";function j(t=""){return/^(?:verse(?:\s*\d+)?|chorus|bridge|tag|pre[-\s]?chorus|intro|outro|ending|refrain)\s*\d*$/i.test(String(t).trim())}function E(t){const e=n=>{const o=[];let i=null;const l=()=>{i&&i.lines.length&&o.push(i),i=null};for(const y of n||[]){if(y.section){l(),o.push(y);continue}for(const r of y.lines||[]){const c=r.plain||r.text||"";!!!(r.chordPositions&&r.chordPositions.length)&&j(c)?(l(),i={section:c.trim(),lines:[]}):(i||(i={lines:[]}),i.lines.push(r))}}return l(),o.length?o:n||[]};if(t!=null&&t.lyricsBlocks)return{title:t.title||"Untitled",key:t.key||t.originalKey||"C",lyricsBlocks:e(t.lyricsBlocks)};if(Array.isArray(t==null?void 0:t.blocks)){const n=[];let o={lines:[]};for(const i of t.blocks)i.type==="section"?(o.lines.length&&n.push(o),o={section:i.header,lines:[]}):i.type==="line"&&o.lines.push({plain:i.lyrics||i.text||"",chordPositions:(i.chords||[]).map(l=>({index:l.index??0,sym:l.sym}))});return o.lines.length&&n.push(o),{title:t.title||"Untitled",key:t.key||t.originalKey||"C",lyricsBlocks:e(n)}}return{title:(t==null?void 0:t.title)||"Untitled",key:(t==null?void 0:t.key)||(t==null?void 0:t.originalKey)||"C",lyricsBlocks:[]}}const b={lyricSizePt:16,chordSizePt:16,margin:36,gutter:18,headerOffsetY:54,columns:1,pageWidth:612,pageHeight:792,lyricFamily:"Helvetica",chordFamily:"Courier",title:"Untitled",key:"C"},V=6;function q(t,e,n,o,i,l){const y=o.margin,r=o.pageWidth-y*2,P=(e===2?(r-o.gutter)/2:r)-V,S=i(n),d=l(n);for(const u of t.lyricsBlocks||[])for(const a of u.lines||[]){const g=a.plain||a.text||"";if(S(g)>P)return!0;for(const F of a.chordPositions||[]){const h=S(g.slice(0,F.index||0)),x=d(F.sym||"");if(h+x>P)return!0}}return!1}function Q(t,e={},n=()=>()=>0,o=()=>()=>0){const i=E(t),l={...b,...e},y=12,r=l.lyricSizePt,c=[],P=(a,g)=>{const F=X(i,{...l,columns:a,lyricSizePt:g,chordSizePt:g},n(g)),h=!q(i,a,g,l,n,o);return{columns:a,lyricSizePt:g,chordSizePt:g,layout:F,widthOk:h}},S=l.columns===2?2:1;c.push(P(S,r));let d=c[c.length-1];if(S===1&&(d.layout.pages.length>1||!d.widthOk)){let a=r;for(c.push(P(2,a)),d=c[c.length-1];(d.layout.pages.length>1||!d.widthOk)&&a>y;)a--,d=P(2,a),c.push(d)}else{let a=r;for(;(d.layout.pages.length>1||!d.widthOk)&&a>y;)a--,d=P(S,a),c.push(d)}c.sort((a,g)=>a.layout.pages.length!==g.layout.pages.length?a.layout.pages.length-g.layout.pages.length:a.widthOk!==g.widthOk?a.widthOk?-1:1:a.columns!==g.columns?a.columns-g.columns:g.lyricSizePt-a.lyricSizePt);const u=c[0];return{plan:{...l,columns:u.columns,lyricSizePt:u.lyricSizePt,chordSizePt:u.chordSizePt,layout:u.layout},chosenOpts:{columns:u.columns,lyricSizePt:u.lyricSizePt,chordSizePt:u.chordSizePt}}}function X(t,e={},n=o=>0){const o=E(t),i={...b,...e},l=4,y=i.lyricSizePt,r=Math.round(i.lyricSizePt*.85),c=i.margin,P=i.pageHeight,S=i.pageWidth-c*2,d=i.columns===2?(S-i.gutter)/2:S,u=c+i.headerOffsetY,a=P-c,g=[];let F={columns:[]};g.push(F);function h(){const s={x:c,yStart:u,blocks:[]};if(F.columns.push(s),i.columns===2){const m={x:c+d+i.gutter,yStart:u,blocks:[]};F.columns.push(m)}}function x(){F={columns:[]},g.push(F)}F.columns.length===0&&h(),o.lyricsBlocks=(o.lyricsBlocks||[]).map(s=>{if(!(s!=null&&s.section)&&Array.isArray(s==null?void 0:s.lines)&&s.lines.length){const m=s.lines[0],W=(m==null?void 0:m.plain)||(m==null?void 0:m.text)||"";if(!(Array.isArray(m==null?void 0:m.chordPositions)&&m.chordPositions.length>0)&&j(W))return{section:W.trim(),lines:s.lines.slice(1)}}return s});let C=0,f=u;const H=()=>F.columns[C],k=()=>{i.columns===2&&C===0?(C=1,f=u):(x(),h(),C=0,f=u)},B=(s,m=0,W=(z=>(z=s.lines)==null?void 0:z.length)()??0)=>{var D;let O=0;!!s.section&&m===0&&(O+=r+y+4);for(let $=m;$<W;$++){const w=s.lines[$];(D=w==null?void 0:w.chordPositions)!=null&&D.length&&(O+=i.chordSizePt+l/2),O+=i.lyricSizePt+l}return O+4},T=s=>{var m;return((m=s==null?void 0:s.chordPositions)!=null&&m.length?i.chordSizePt+l/2:0)+i.lyricSizePt+l},_=(s,m)=>{s.blocks.push({type:"section",header:m})},M=(s,m,W)=>{s.blocks.push({type:"line",lyrics:m,chords:W.map(z=>({x:n(m.slice(0,z.index||0)),sym:z.sym}))})};for(const s of o.lyricsBlocks||[]){const m=B(s);if(f+m<=a){const O=H();s.section&&(f+=r,_(O,s.section),f+=y+4);for(const v of s.lines||[]){const D=v.plain||v.text||"",$=v.chordPositions||[];M(O,D,$),f+=T(v)}f+=4;continue}const W=(s.lines||[]).map(T);let z=0;for(;z<(s.lines||[]).length;){const O=(s.lines||[]).length-z,v=z===0&&s.section?r+y+4:0,D=W[z]||0;if(f+v+D>a){k();continue}const $=a-f-v;let w=0,A=0;for(;z+w<W.length&&A+W[z+w]<=$;)A+=W[z+w],w++;if(w===1&&O>1){k();continue}if(O-w===1)if(w>1)A-=W[z+w-1],w--;else{k();continue}const I=H();z===0&&s.section&&(f+=r,_(I,s.section),f+=y+4);for(let K=0;K<w;K++){const L=s.lines[z],p=L.plain||L.text||"",R=L.chordPositions||[];M(I,p,R),f+=W[z],z++}f+=4,z<(s.lines||[]).length&&k()}}return{pages:g}}const Z=typeof window<"u"&&(()=>{try{return localStorage.getItem("pdfDebug")==="1"}catch{return!1}})();async function G(){const{jsPDF:t}=await J(async()=>{const{jsPDF:e}=await import("./index-Cg57-isj.js").then(n=>n.m);return{jsPDF:e}},__vite__mapDeps([0,1]),import.meta.url);return new t({unit:"pt",format:"letter"})}function Y(t,e,n){const o=t.internal.pageSize.getWidth(),i=t.internal.pageSize.getHeight(),l={...b,...n,pageWidth:o,pageHeight:i};return Q(e,l,c=>P=>(t.setFont(l.lyricFamily,"normal"),t.setFontSize(c),t.getTextWidth(P||"")),c=>P=>(t.setFont(l.chordFamily,"bold"),t.setFontSize(c),t.getTextWidth(P||"")))}function N(t,e,{title:n,key:o}){const i=String(e.lyricFamily||"Helvetica"),l=String(e.chordFamily||"Courier"),y=t.internal.pageSize.getWidth(),r=t.internal.pageSize.getHeight(),c=e.margin,P=Math.max(22,e.lyricSizePt+6),S=Math.max(12,e.lyricSizePt-2),d=4,u=e.lyricSizePt,a=Math.round(e.lyricSizePt*.85),g=c+e.headerOffsetY,F=y-c*2,h=e.columns===2?(F-e.gutter)/2:F;e.layout.pages.forEach((x,C)=>{C>0&&t.addPage(),t.setFont(i,"bold"),t.setFontSize(P),t.text(n,c,c+24),t.setFont(i,"italic"),t.setFontSize(S),t.text(`Key: ${o||"—"}`,c,c+40),Z&&(t.setDrawColor(180),t.rect(c,g,h,r-c-g),e.columns===2&&t.rect(c+h+e.gutter,g,h,r-c-g),t.setFont(i,"normal"),t.setFontSize(9),t.text(`Plan: ${e.columns} col • size ${e.lyricSizePt}pt • family ${e.lyricFamily}/${e.chordFamily}`,c,r-c*.6)),x.columns.forEach(f=>{var B;let H=f.x,k=g;for(const T of f.blocks)if(T.type==="section")k+=a,t.setFont(i,"bold"),t.setFontSize(u),t.text(`[${T.header}]`,H,k),k+=u+4;else if(T.type==="line"){if((B=T.chords)!=null&&B.length){t.setFont(l,"bold"),t.setFontSize(e.chordSizePt);for(const _ of T.chords)t.text(_.sym,H+_.x,k);k+=e.chordSizePt+d/2}t.setFont(i,"normal"),t.setFontSize(e.lyricSizePt),t.text(T.lyrics,H,k),k+=e.lyricSizePt+d}})})}async function nt(t,e={}){const n=await G();let o={};try{o=await U(n)}catch{}const i={lyricFamily:o.lyricFamily||e.lyricFamily||"Helvetica",chordFamily:o.chordFamily||e.chordFamily||"Courier",...e};return Y(n,E(t),i)}async function it(t,e){const n=await G();let o={};try{o=await U(n)}catch{}const i={lyricSizePt:Math.max(12,(e==null?void 0:e.lyricSizePt)||16),chordSizePt:Math.max(12,(e==null?void 0:e.chordSizePt)||16),margin:36,lyricFamily:o.lyricFamily||"Helvetica",chordFamily:o.chordFamily||"Courier",columns:(e==null?void 0:e.columns)===2?2:1},l=E(t),{plan:y}=Y(n,l,i),r=t.title||l.title||"Untitled",c=t.key||l.key||"C";return N(n,y,{title:r,key:c}),n.setProperties({title:`${r} – GraceChords`}),n.save(`${r.replace(/\s+/g,"_")}.pdf`),{plan:y}}async function tt(t,e={}){const n=await G();let o={};try{o=await U(n)}catch{}const i={lyricSizePt:Math.max(12,(e==null?void 0:e.lyricSizePt)||16),chordSizePt:Math.max(12,(e==null?void 0:e.chordSizePt)||16),margin:36,lyricFamily:o.lyricFamily||"Helvetica",chordFamily:o.chordFamily||"Courier",columns:(e==null?void 0:e.columns)===2?2:1},l=!!(e!=null&&e.includeTOC),y=e==null?void 0:e.coverImageDataUrl,r=t.map((h,x)=>{const C=E(h),{plan:f}=Y(n,C,i),H=h.title||C.title||"Untitled",k=h.key||C.key||"C";return{raw:h,plan:f,title:H,key:k,num:h._songbookNum||x+1,origTitle:h._origTitle||H}}),c=n.internal.pageSize.getWidth(),P=n.internal.pageSize.getHeight(),S=i.margin,d=16,u=Math.floor((P-S*2-40)/d),a=l?Math.ceil(r.length/u):0;let g=1+(y?1:0)+a;const F=r.map(h=>{const x={num:h.num,title:h.origTitle,page:g};return g+=h.plan.layout.pages.length,x});if(y){try{n.addImage(y,"JPEG",0,0,c,P,void 0,"FAST")}catch{}(l||r.length)&&n.addPage()}if(l){n.setFont(i.lyricFamily,"bold"),n.setFontSize(24),n.text("Table of Contents",c/2,S+20,{align:"center"}),n.setFont(i.lyricFamily,"normal"),n.setFontSize(12);let h=S+40;F.forEach((x,C)=>{C>0&&C%u===0&&(n.addPage(),h=S);const f=`${x.num} ${x.title}`;n.text(f,S,h);const H=String(x.page),k=c-S,B=n.getTextWidth(f),T=n.getTextWidth(H),_=k-S-B-T-4;if(_>0){const M=n.getTextWidth("."),s=".".repeat(Math.max(0,Math.floor(_/M)));n.text(s,S+B+2,h)}n.text(H,k,h,{align:"right"}),h+=d}),r.length&&n.addPage()}r.forEach((h,x)=>{x>0&&n.addPage(),N(n,h.plan,{title:h.title,key:h.key})}),n.setProperties({title:(e==null?void 0:e.docTitle)||"GraceChords Setlist"}),n.save((e==null?void 0:e.fileName)||"GraceChords_Selection.pdf")}async function ct(t,{includeTOC:e,coverImageDataUrl:n}={}){const o=t.map((l,y)=>({...l,title:`${y+1}. ${l.title}`,_songbookNum:y+1,_origTitle:l.title})),i=new Date().toISOString().slice(0,10).replace(/-/g,"");await tt(o,{includeTOC:e,coverImageDataUrl:n,docTitle:"GraceChords Songbook",fileName:`songbook-${i}.pdf`})}export{nt as chooseBestLayoutAuto,tt as downloadMultiSongPdf,it as downloadSingleSongPdf,ct as downloadSongbookPdf,X as planSongLayout};
