const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-WlZjTqqs.js","assets/index-CAfecu1d.js","assets/index-DYvWMATf.css"])))=>i.map(i=>d[i]);
import{r as l,R as M,j as e,i as K,Q as Y,N as G,O as J,V as X,W as Z,af as ee,B as y,ag as te,Y as se,I as ne,P as F,a2 as ae,a6 as ie,a9 as R,a8 as oe,_ as re,p as le,f as ce,h as de,ae as ue,s as B,ah as me}from"./index-CAfecu1d.js";import{P as he}from"./PageContainer-CmVlc-rd.js";function ge({label:o,help:c,error:x,id:w,className:j="",children:f,...S}){const p=l.useId(),h=w||`gc-field-${p}`,d=c?`${h}-help`:void 0,g=x?`${h}-error`:void 0,b=[d,g].filter(Boolean).join(" ")||void 0;let N=f;return M.isValidElement(f)&&(N=M.cloneElement(f,{id:f.props.id||h,"aria-describedby":[f.props["aria-describedby"],b].filter(Boolean).join(" ")||void 0,"aria-invalid":x?!0:f.props["aria-invalid"]})),e.jsxs("label",{className:`gc-field ${j}`.trim(),htmlFor:h,...S,children:[o?e.jsx("span",{className:"gc-field__label",children:o}):null,e.jsx("div",{className:"gc-field__control",children:N}),c?e.jsx("div",{className:"gc-field__help",id:d,children:c}):null,x?e.jsx("div",{className:"gc-field__error",id:g,children:x}):null]})}let O;const D=()=>O||(O=re(()=>import("./index-WlZjTqqs.js").then(o=>o.i),__vite__mapDeps([0,1,2])));function v(o,c){return me(o,c)}function xe(){const o=l.useMemo(()=>{const t=K?.items||[],n=new Set,s=[];for(const a of t)n.has(a.id)||Y(a)||(n.add(a.id),s.push(a));return s.slice().sort(v)},[]),c=G(),x=J(),w=l.useRef(!1),[j,f]=l.useState(""),S=l.useMemo(()=>new X(o,{keys:["title","tags","authors"],threshold:.4}),[o]),p=l.useMemo(()=>j?S.search(j).map(t=>t.item):o.slice().sort(v),[o,S,j]),[h,d]=l.useState(()=>new Set),g=l.useMemo(()=>p.filter(t=>h.has(t.id)).slice().sort(v),[p,h]),b=p.length,N=h.size;function I(t,n){d(s=>{const a=new Set(s);return n?a.add(t):a.delete(t),a})}function W(){p.length&&d(t=>{const n=new Set(t);for(const s of p)n.add(s.id);return n})}function $(){d(new Set)}function z(t,n){if(!t)return;const s=n||[],a=i=>new Set(i.map(r=>r.id));if(t==="random10SongCollection"){const i=Math.min(10,s.length),r=i===s.length?s:R(s,i);d(a(r));return}if(t==="sendMeSongbook"){const i=["NATION","NATIONS","MISSION","MISSIONS","ICP"],r=s.filter(u=>i.some(A=>oe([u],A).length));if(r.length)r.sort(v),d(a(r));else{const u=R(s,Math.min(5,s.length));d(a(u))}return}if(t==="graceChordsSongbook"){const i=s.slice().sort(v);d(a(i))}}const[q,C]=l.useState(null),[k,P]=l.useState(!1),[L,H]=l.useState(()=>{try{return window.innerWidth<=640}catch{return!1}});l.useEffect(()=>{function t(){try{H(window.innerWidth<=640)}catch{}}return window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[]),l.useEffect(()=>{const n=new URLSearchParams(c.search||"").get("tags");if(!n)return;const s=n.split(",").map(i=>i.trim().toLowerCase()).filter(Boolean);if(!s.length)return;const a=o.filter(i=>(Array.isArray(i.tags)?i.tags.map(u=>String(u).toLowerCase()):[]).some(u=>s.includes(u)));a.length&&d(i=>{const r=new Set(i);return a.forEach(u=>r.add(u.id)),r})},[c.search,o]),l.useEffect(()=>{if(w.current)return;const t=c.state?.quickAction;t&&o.length&&(z(t,o),w.current=!0,x(c.pathname+(c.search||""),{replace:!0,state:null}))},[c.state,o.map(t=>t.id).join("|")]);async function U(){if(g.length){P(!0);try{const{downloadSongbookPdf:t}=await D(),n=[];for(const s of g)try{const a=le(`songs/${s.filename}`),i=await ce(a),r=de(i),u=(r.sections||[]).map(T=>({section:T.label,lines:(T.lines||[]).map(m=>m.instrumental?{instrumental:{chords:Array.isArray(m.instrumental?.chords)?m.instrumental.chords.slice():[],repeat:typeof m.instrumental?.repeat=="number"?m.instrumental.repeat:void 0}}:m.comment?{plain:m.comment,chordPositions:[],comment:m.comment}:{plain:m.lyrics||"",chordPositions:(m.chords||[]).map(E=>({sym:E.sym,index:E.index}))})})),A=s.filename.replace(/\.chordpro$/,""),V=ue({title:r.meta.title||s.title||A,key:r.meta.key||r.meta.originalkey||s.originalKey||"C",capo:r.meta?.capo,lyricsBlocks:u});n.push(V)}catch(a){console.error(a),B(`Failed to process ${s.filename}`)}n.length&&await t(n,{includeTOC:!0,coverImageDataUrl:q})}finally{P(!1)}}}function _(){D()}function Q(t){const n=t.target.files?.[0];if(!n){C(null);return}if(n.size>2*1024*1024){B("Image must be under 2 MB"),t.target.value="",C(null);return}if(!n.type.startsWith("image/")){B("File must be an image"),t.target.value="",C(null);return}const s=new FileReader;s.onload=()=>C(String(s.result||"")),s.readAsDataURL(n)}return o.length===0?e.jsxs("div",{className:"container",children:[e.jsx("h1",{children:"No songs found"}),e.jsx("p",{className:"Small",children:"The song index is empty or failed to load."})]}):e.jsxs(he,{children:[e.jsx(Z,{busy:k}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginTop:12,marginBottom:4},children:[e.jsx("div",{}),e.jsx("h1",{style:{margin:0},children:"Songbook Builder"}),e.jsx("div",{})]}),e.jsxs(ee,{className:"gc-songbook-toolbar",style:{marginTop:8},children:[e.jsx(ge,{label:"Upload Cover Image",className:"gc-songbook-cover",style:{minWidth:0},children:e.jsx("input",{id:"sb-cover",className:"CoverInput",type:"file",accept:"image/*",onChange:Q,style:L?{maxWidth:"50vw",textOverflow:"ellipsis",overflow:"hidden",whiteSpace:"nowrap"}:void 0})}),e.jsxs("div",{className:"gc-toolbar__actions",children:[e.jsx(y,{onClick:$,disabled:!N,title:"Clear selection",iconLeft:e.jsx(te,{}),children:e.jsx("span",{className:"text-when-wide",children:"Clear"})}),e.jsx(y,{variant:"primary",onClick:U,onMouseEnter:_,onFocus:_,disabled:!g.length||k,title:g.length?"Export PDF":"Select some songs first",iconLeft:e.jsx(se,{}),children:k?"Exporting…":L?"PDF":e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-when-wide",children:"Export PDF"}),e.jsx("span",{className:"text-when-narrow",children:"PDF"})]})})]})]}),e.jsxs("div",{className:"BuilderPage",style:{marginTop:8},children:[e.jsx("div",{className:"BuilderLeft",children:e.jsx("section",{className:"setlist-section songbook-add","data-role":"add",children:e.jsxs("div",{className:"card setlist-pane",children:[e.jsxs("div",{className:["BuilderHeader","section-header"].filter(Boolean).join(" "),style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx("strong",{style:{whiteSpace:"nowrap"},children:"Add songs"}),e.jsx(ne,{value:j,onChange:t=>f(t.target.value),placeholder:"Search...",style:{flex:1,minWidth:0}}),e.jsxs(y,{onClick:W,disabled:!b,title:"Add all filtered",iconLeft:e.jsx(F,{}),variant:"primary",style:{marginLeft:"auto"},children:[e.jsxs("span",{className:"text-when-wide",children:["Add all (",b,")"]}),e.jsx("span",{className:"text-when-narrow",children:"All"})]})]}),e.jsx("div",{className:["BuilderScroll","setlist-scroll","pane--addSongs"].join(" "),style:{minHeight:0,flex:"1 1 auto",overflow:"auto",marginTop:6},role:"region","aria-label":"Song list",children:e.jsx("div",{className:"gc-list",style:{display:"grid",gap:".5rem",gridTemplateColumns:"repeat(auto-fill, minmax(320px, 1fr))"},children:p.map(t=>{const n=h.has(t.id),a=[(Array.isArray(t.authors)?t.authors.join(", "):t.authors||"")||"—",t.country].filter(Boolean).join(" • ");return e.jsx(ae,{title:t.title,subtitle:a,rightSlot:n?e.jsx(y,{"aria-label":"Remove",title:"Remove",onClick:i=>{i.stopPropagation(),I(t.id,!1)},iconLeft:e.jsx(ie,{}),iconOnly:!0,style:{color:"#b91c1c"}}):e.jsx(y,{"aria-label":"Add",title:"Add",variant:"primary",onClick:i=>{i.stopPropagation(),I(t.id,!0)},iconLeft:e.jsx(F,{}),iconOnly:!0}),onClick:()=>I(t.id,!n)},t.id)})})})]})})}),e.jsx("div",{className:"BuilderRight",style:{minHeight:0,display:"flex",flexDirection:"column"},children:e.jsx("section",{className:"setlist-section songbook-current","data-role":"current",children:e.jsxs("div",{className:"card setlist-pane",children:[e.jsx("div",{className:"BuilderHeader section-header",children:e.jsxs("strong",{children:["Current selection (",g.length,")"]})}),e.jsx("div",{className:"BuilderScroll pane--currentSet",role:"region","aria-label":"Selected songs",style:{minHeight:0,flex:"1 1 auto",overflow:"auto",marginTop:6},children:e.jsx("ol",{className:"List",style:{listStyle:"decimal inside",margin:0,padding:0},children:g.map(t=>e.jsxs("li",{children:[t.title,Array.isArray(t.authors)&&t.authors.length?e.jsxs("span",{className:"Small",children:[" — ",t.authors.join(", ")]}):null]},t.id))})})]})})})]})]})}export{xe as default};
