const P=[16,15,14,13,12],h=()=>{var t;try{return typeof window<"u"&&((t=window.localStorage)==null?void 0:t.getItem("pdfPlanTrace"))==="1"}catch{return!1}},d=(t,e)=>{h()&&t.push(e)},m=(t,e)=>{h()&&e.length&&(console.groupCollapsed(`[pdfPlanTrace] ${t}`),console.table(e),console.groupEnd())};function b(t,e,i,u={}){const p=!!u.honorColumnBreaks,n=new Array(e).fill(0),c=Array.from({length:e},()=>[]);let a=0,s="";const r=l=>{if(a+1>=e)return!1;const o=t[l];return o?o.height<=i-n[a+1]:!1};for(let l=0;l<t.length;l++){const o=t[l];if(p&&o.type==="column_break"){r(l+1)&&(a+=1);continue}const g=i-n[a];if(o.height<=g)c[a].push(o.id),n[a]+=o.height;else if(a+1<e){a+=1;const f=i-n[a];if(o.height<=f)c[a].push(o.id),n[a]+=o.height;else return s=`section ${o.id} needs ${Math.ceil(o.height)}pt > remaining ${Math.floor(f)}pt in col ${a+1}`,{singlePage:!1,colHeights:n,occupancy:n.map(y=>y/i),balance:e===2?1-Math.abs(n[0]-n[1])/i:1,reasonRejected:s,placed:c}}else return s=`section ${o.id} needs ${Math.ceil(o.height)}pt > remaining ${Math.floor(g)}pt in col ${a+1}`,{singlePage:!1,colHeights:n,occupancy:n.map(f=>f/i),balance:e===2?1-Math.abs(n[0]-n[1])/i:1,reasonRejected:s,placed:c}}return{singlePage:!0,colHeights:n,occupancy:n.map(l=>l/i),balance:e===2?1-Math.abs(n[0]-n[1])/i:1,reasonRejected:void 0,placed:c}}function k({pt:t,cols:e,balance:i,occupancy:u,hasColumnsHint:p}){let n=0;e===2&&Math.min(...u)<.18&&(n+=50),u.some(a=>a>.98)&&(n+=5),p&&e===2&&(n-=3);const c=t*100+i*10-n-(e===2?2:0);return{penalties:n,finalScore:c}}function $({measuredSections:t,pageContentHeight:e,hasColumnsHint:i=!1,honorColumnBreaks:u=!0}){const p=[],n=[];for(let c=16;c>=12;c--){const a=e;for(const s of[1,2]){const r=b(t,s,a,{honorColumnBreaks:u}),l={pt:c,cols:s,singlePage:r.singlePage,colHeights:r.colHeights.map(f=>Math.round(f)),occupancy:r.occupancy.map(f=>Number(f.toFixed(2))),balance:Number(r.balance.toFixed(2))};if(!r.singlePage){d(p,{...l,penalties:"",finalScore:"",reasonRejected:r.reasonRejected});continue}const{penalties:o,finalScore:g}=k({pt:c,cols:s,balance:r.balance,occupancy:r.occupancy,hasColumnsHint:i});n.push({pt:c,cols:s,pack:r,penalties:o,finalScore:g}),d(p,{...l,penalties:o,finalScore:Number(g.toFixed(2))})}}if(n.length){n.sort((s,r)=>r.finalScore-s.finalScore);const c=n[0];m("Single‑page candidate scan (16→12pt, 1/2 columns)",p);const a=h()?`Plan: ${c.cols} col • ${c.pt}pt • singlePage=yes • occ=${JSON.stringify(c.pack.occupancy.map(s=>s.toFixed(2)))} • bal=${c.pack.balance.toFixed(2)}`:"";return{...c,debugFooter:a}}return m("No single‑page candidates; falling back to multi‑page 12pt",p),{multipage:!0,pt:12,reason:"no_single_page"}}const F=Object.freeze({honorColumnBreaks:!0,hasColumnsHint:!1,ptWindow:P.slice()});function x(t){return t}function M(t,e,i,u={}){return b(t,e,i,u).colHeights}function S(t){const e=$(t);return e.multipage?e:{pt:e.pt,cols:e.cols,singlePage:!0,occupancy:e.pack.occupancy,balance:e.pack.balance,debugFooter:e.debugFooter,placed:e.pack.placed,colHeights:e.pack.colHeights}}function T(t){return S(t)}export{F as DEFAULT_LAYOUT_OPT,S as chooseBestLayout,$ as chooseBestPlan,M as columnHeights,x as normalizeSongInput,T as planSongLayout};
