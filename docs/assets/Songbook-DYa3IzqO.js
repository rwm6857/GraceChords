const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-CTrefq04.js","./index-CgcJDPmR.js","./index-DAWVrhm9.css"])))=>i.map(i=>d[i]);
import{r as a,i as q,F as z,j as e,b as U,T as W,B as g,q as K,D as Q,I as V,P as L,f as G,h as J,_ as X,l as Y,p as Z,n as ee,m as v,v as te}from"./index-CgcJDPmR.js";import{P as se}from"./PageContainer-BV6YC4uY.js";let T;const A=()=>T||(T=X(()=>import("./index-CTrefq04.js").then(i=>i.i),__vite__mapDeps([0,1,2]),import.meta.url));function S(i,r){return te(i,r)}function ae(){const i=a.useMemo(()=>{const t=q?.items||[],s=new Set,l=[];for(const n of t)s.has(n.id)||(s.add(n.id),l.push(n));return l.slice().sort(S)},[]),[r,B]=a.useState(""),[m,F]=a.useState(()=>{try{return localStorage.getItem("pref:icpOnly")==="1"}catch{return!1}});a.useEffect(()=>{try{localStorage.setItem("pref:icpOnly",m?"1":"0")}catch{}},[m]);const w=a.useMemo(()=>new z(i,{keys:["title","tags"],threshold:.4}),[i]),o=a.useMemo(()=>(r?w.search(r).map(s=>s.item):i.slice().sort(S)).filter(s=>!m||(Array.isArray(s.tags)?s.tags.includes("ICP"):s.tags==="ICP")),[i,w,r,m]),[x,f]=a.useState(()=>new Set),c=a.useMemo(()=>o.filter(t=>x.has(t.id)).slice().sort(S),[o,x]),C=o.length,b=x.size;function y(t,s){f(l=>{const n=new Set(l);return s?n.add(t):n.delete(t),n})}function D(){o.length&&f(t=>{const s=new Set(t);for(const l of o)s.add(l.id);return s})}function E(){f(new Set)}const[O,p]=a.useState(null),[j,N]=a.useState(!1);async function R(){if(c.length){N(!0);try{const{downloadSongbookPdf:t}=await A(),s=[];for(const l of c)try{const n=`./songs/${l.filename}`,u=await Y(n),h=Z(u),H=(h.sections||[]).map(P=>({section:P.label,lines:(P.lines||[]).map(d=>({plain:d.comment?d.comment:d.lyrics||"",chordPositions:(d.chords||[]).map(k=>({sym:k.sym,index:k.index})),comment:d.comment?d.comment:void 0}))})),M=l.filename.replace(/\.chordpro$/,""),$=ee({title:h.meta.title||l.title||M,key:h.meta.key||h.meta.originalkey||l.originalKey||"C",capo:h.meta?.capo,lyricsBlocks:H});s.push($)}catch(n){console.error(n),v(`Failed to process ${l.filename}`)}s.length&&await t(s,{includeTOC:!0,coverImageDataUrl:O})}finally{N(!1)}}}function I(){A()}function _(t){const s=t.target.files?.[0];if(!s){p(null);return}if(s.size>2*1024*1024){v("Image must be under 2 MB"),t.target.value="",p(null);return}if(!s.type.startsWith("image/")){v("File must be an image"),t.target.value="",p(null);return}const l=new FileReader;l.onload=()=>p(String(l.result||"")),l.readAsDataURL(s)}return i.length===0?e.jsxs("div",{className:"container",children:[e.jsx("h1",{children:"No songs found"}),e.jsx("p",{className:"Small",children:"The song index is empty or failed to load."})]}):e.jsxs(se,{children:[e.jsx(U,{busy:j}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginTop:12,marginBottom:4},children:[e.jsx("div",{}),e.jsx("h1",{style:{margin:0},children:"Songbook Builder"}),e.jsx("div",{})]}),e.jsxs(W,{className:"card",style:{marginTop:8},children:[e.jsxs("div",{className:"Field",children:[e.jsx("label",{htmlFor:"sb-cover",children:"Upload Cover Image:"}),e.jsx("input",{id:"sb-cover",className:"CoverInput",type:"file",accept:"image/*",onChange:_})]}),e.jsxs("div",{style:{marginLeft:"auto",display:"flex",gap:6},children:[e.jsx(g,{onClick:E,disabled:!b,title:"Clear selection",iconLeft:e.jsx(K,{}),children:e.jsx("span",{className:"text-when-wide",children:"Clear"})}),e.jsx(g,{variant:"primary",onClick:R,onMouseEnter:I,onFocus:I,disabled:!c.length||j,title:c.length?"Export PDF":"Select some songs first",iconLeft:e.jsx(Q,{}),children:j?"Exporting…":e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-when-wide",children:"Export PDF"}),e.jsx("span",{className:"text-when-narrow",children:"PDF"})]})})]})]}),e.jsxs("div",{className:"BuilderPage",style:{marginTop:8},children:[e.jsx("div",{className:"BuilderLeft",children:e.jsx("div",{className:"card",style:{display:"flex",flexDirection:"column",flex:"1 1 auto",minHeight:0},children:e.jsxs("div",{className:"BuilderScroll",style:{minHeight:0,flex:"1 1 auto",overflow:"auto",marginTop:8},children:[e.jsxs("div",{className:"BuilderHeader",style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx("strong",{style:{whiteSpace:"nowrap"},children:"Add songs"}),e.jsx(V,{value:r,onChange:t=>B(t.target.value),placeholder:"Search...",style:{flex:1,minWidth:0}}),e.jsxs("label",{className:"row",style:{gap:6,alignItems:"center"},children:[e.jsx("input",{type:"checkbox",checked:m,onChange:t=>F(t.target.checked)}),e.jsx("span",{className:"meta",title:"Limit results to songs tagged ICP",children:"ICP only"})]}),e.jsxs(g,{onClick:D,disabled:!C,title:"Add all filtered",iconLeft:e.jsx(L,{}),children:[e.jsxs("span",{className:"text-when-wide",children:["Add all (",C,")"]}),e.jsx("span",{className:"text-when-narrow",children:"All"})]})]}),e.jsxs("div",{className:"Row Small",style:{marginTop:".5rem"},children:[e.jsx("strong",{children:b})," selected"]}),e.jsx("div",{className:"SongList",role:"region","aria-label":"Song list",style:{display:"flex",flexDirection:"column",minHeight:0,flex:"1 1 auto",marginTop:6},children:e.jsx("div",{className:"gc-list",style:{display:"grid",gap:".5rem",gridTemplateColumns:"repeat(auto-fill, minmax(320px, 1fr))"},children:o.map(t=>{const s=x.has(t.id),n=[(Array.isArray(t.authors)?t.authors.join(", "):t.authors||"")||"—",t.country].filter(Boolean).join(" • ");return e.jsx(G,{title:t.title,subtitle:n,rightSlot:s?e.jsx(g,{"aria-label":"Remove",title:"Remove",onClick:u=>{u.stopPropagation(),y(t.id,!1)},iconLeft:e.jsx(J,{}),iconOnly:!0,style:{color:"#b91c1c"}}):e.jsx(g,{"aria-label":"Add",title:"Add",variant:"primary",onClick:u=>{u.stopPropagation(),y(t.id,!0)},iconLeft:e.jsx(L,{}),iconOnly:!0}),onClick:()=>y(t.id,!s)},t.id)})})})]})})}),e.jsx("div",{className:"BuilderRight",style:{minHeight:0,display:"flex",flexDirection:"column"},children:e.jsxs("div",{className:"card",style:{display:"flex",flexDirection:"column",flex:"1 1 auto",minHeight:0},children:[e.jsxs("strong",{children:["Current selection (",c.length,")"]}),e.jsx("div",{className:"PreviewList",role:"region","aria-label":"Selected songs",style:{minHeight:0,flex:"1 1 auto",overflow:"auto",marginTop:6},children:e.jsx("ol",{className:"List",style:{listStyle:"decimal inside"},children:c.map(t=>e.jsxs("li",{children:[t.title,Array.isArray(t.authors)&&t.authors.length?e.jsxs("span",{className:"Small",children:[" — ",t.authors.join(", ")]}):null]},t.id))})})]})})]})]})}export{ae as default};
