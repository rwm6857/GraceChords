const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-CMBekISR.js","./index-C5RwKqO1.js","./index-DAWVrhm9.css","./jszip.min-CLp0W83I.js"])))=>i.map(i=>d[i]);
import{j as e,u as we,a as be,r as c,i as Ne,d as Ce,F as Ie,B as u,b as Pe,T as Le,S as ke,C as Te,P as J,c as De,D as q,L as $e,e as Oe,M as Ae,I as Ee,f as V,K as Be,A as Ke,g as _e,h as ze,k as Me,_ as Z,l as Re,p as Fe,s as Ue,t as He,n as We,m as k,o as Xe}from"./index-C5RwKqO1.js";import{P as Je}from"./PageContainer-BxLQ6n9I.js";const ee="gracechords.sets.v1";function T(){try{const o=localStorage.getItem(ee);return o?JSON.parse(o):{sets:{}}}catch{return{sets:{}}}}function te(o){localStorage.setItem(ee,JSON.stringify(o))}function qe(){return typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():"id-"+Math.random().toString(36).slice(2)+Date.now().toString(36)}function b(){const{sets:o}=T();return Object.values(o).sort((d,m)=>(m.updatedAt||0)-(d.updatedAt||0))}function Ve(o){const{sets:d}=T();return d[o]||null}function Y(o){const d=Date.now(),m={id:o.id||qe(),name:o.name?.trim()||"Untitled Set",items:Array.isArray(o.items)?o.items:[],createdAt:o.createdAt||d,updatedAt:d},h=T();return h.sets[m.id]=m,te(h),m}function Ye(o){const d=T();return d.sets[o]?(delete d.sets[o],te(d),!0):!1}function Ge({label:o,id:d,children:m,className:h="",...y}){return e.jsxs("label",{className:"gc-field",htmlFor:d,children:[o?e.jsx("span",{className:"gc-label",children:o}):null,e.jsx("span",{className:"gc-select",children:e.jsx("select",{id:d,className:h,...y,children:m})})]})}let G;const Q=()=>G||(G=Z(()=>import("./index-CMBekISR.js").then(o=>o.i),__vite__mapDeps([0,1,2]),import.meta.url));function et(){const{code:o}=we(),d=be(),[m,h]=c.useState("New Setlist"),[y,se]=c.useState(""),[f,ne]=c.useState([]),[v,ie]=c.useState(()=>{try{return localStorage.getItem("pref:icpOnly")==="1"}catch{return!1}});c.useEffect(()=>{try{localStorage.setItem("pref:icpOnly",v?"1":"0")}catch{}},[v]);const[a,g]=c.useState([]),[A,ae]=c.useState({}),[D,N]=c.useState("");Object.keys(A).length;const[$,E]=c.useState(!1),[C,I]=c.useState(null),[S,B]=c.useState(()=>b()),[K,P]=c.useState(""),[oe,L]=c.useState(!1),[_,z]=c.useState("");c.useEffect(()=>{const t=Ne?.items||[],s=new Set,i=[];for(const n of t)s.has(n.id)||(s.add(n.id),i.push(n));ne(i)},[]),c.useEffect(()=>{let t=!1;async function s(){const i={};for(const n of a){const r=f.find(w=>w.id===n.id);if(!r)continue;const l=r.filename.replace(/\.chordpro$/i,""),p=`./pptx/${l}.pptx`;await Me(p,l)&&(i[l]=!0)}t||ae(i)}return s(),()=>{t=!0}},[a,f]),c.useEffect(()=>{if(!o)return;const{entries:t,error:s}=Ce(o);if(s){alert(s),d("/setlist",{replace:!0});return}g(t.map(i=>({id:i.id,toKey:i.toKey})))},[o]),c.useEffect(()=>{try{const t=localStorage.getItem("setlist");if(!t||b().length>0)return;const s=JSON.parse(t);if(s?.name||(s?.list?.length||0)>0){const i=Y({name:s.name||"Imported Set",items:s.list||[]});B(b()),I(i.id),h(i.name),g(i.items||[]),P(i.id)}}catch{}},[]);const O=c.useMemo(()=>new Ie(f,{keys:["title","tags"],threshold:.4}),[f]);function re(t){return!v||(Array.isArray(t.tags)?t.tags.includes("ICP"):t.tags==="ICP")}const le=c.useMemo(()=>(y?O.search(y).map(s=>s.item):f.slice().sort((s,i)=>s.title.localeCompare(i.title))).filter(re),[y,O,f,v]);function M(t){a.find(s=>s.id===t.id)||g([...a,{id:t.id,toKey:t.originalKey||"C"}])}function ce(t){g(a.filter(s=>s.id!==t))}function R(t,s){const i=a.findIndex(p=>p.id===t);if(i<0)return;const n=i+(s==="up"?-1:1);if(n<0||n>=a.length)return;const r=a.slice(),[l]=r.splice(i,1);r.splice(n,0,l),g(r)}function de(t,s){const i=a.findIndex(l=>l.id===t);if(i<0||s<0||s>=a.length||i===s)return;const n=a.slice(),[r]=n.splice(i,1);n.splice(s,0,r),g(n)}function pe(t,s){g(a.map(i=>i.id===t?{...i,toKey:s}:i))}function F(t){B(b()),P(t||"")}function U(){I(null),h("New Setlist"),g([]),P("")}function ue(){const t=m?.trim()||"New Setlist",s=window.prompt("Save set as:",t);if(s===null)return;const i=String(s).trim()||"New Setlist";let n=C;if(!n){const l=(b()||[]).find(p=>(p.name||"")===i);l&&(n=l.id)}const r=Y({id:n,name:i,items:a});h(r.name),I(r.id),F(r.id)}function me(){const t=_||K||"";if(!t){L(!1);return}const s=Ve(t);s&&(I(s.id),h(s.name||"New Setlist"),g(s.items||[]),P(s.id)),L(!1)}function fe(){const t=S[0]?.id||"";z(K||t),L(!0)}function he(){C&&window.confirm(`Delete set "${m}"? This cannot be undone.`)&&(Ye(C),U(),F(""))}async function ge(){E(!0);try{const{downloadMultiSongPdf:t}=await Q(),s=[];for(const i of a){const n=f.find(r=>r.id===i.id);if(n)try{const r=`./songs/${n.filename}`,l=await Re(r),p=Fe(l),x=p.meta?.key||p.meta?.originalkey||n.originalKey||"C",w=Ue(x,i.toKey||x),je=(p.sections||[]).map(W=>({section:W.label,lines:(W.lines||[]).map(j=>({plain:j.comment?j.comment:j.lyrics||"",chordPositions:(j.chords||[]).map(X=>({sym:He(X.sym,w),index:X.index})),comment:j.comment?j.comment:void 0}))})),ve=n.filename.replace(/\.chordpro$/i,""),Se=We({title:p.meta?.title||n.title||ve,key:i.toKey||x,capo:p.meta?.capo,lyricsBlocks:je});s.push(Se)}catch(r){console.error(r),k(`Failed to process ${n.filename}`)}}s.length&&await t(s)}finally{E(!1)}}function H(){Q()}async function xe(){try{const t=Xe(a),s=`${location.origin}${location.pathname}#/set/${t}`;await navigator.clipboard.writeText(s);try{k?.("Link copied!")}catch{}}catch{alert("Failed to copy link")}}async function ye(){N(`Bundling 0/${a.length}…`);const t=(await Z(async()=>{const{default:n}=await import("./jszip.min-CLp0W83I.js").then(r=>r.j);return{default:n}},__vite__mapDeps([3,1,2]),import.meta.url)).default,s=new t;let i=0;for(let n=0;n<a.length;n++){const r=a[n],l=f.find(x=>x.id===r.id);if(!l){N(`Bundling ${n+1}/${a.length}…`);continue}N(`Bundling ${n+1}/${a.length}…`);const p=l.filename.replace(/\.chordpro$/i,"");if(A[p])try{const x=await fetch(`./pptx/${p}.pptx`);if(!x.ok)continue;const w=await x.blob();i++,s.file(`${String(i).padStart(2,"0")}-${p}.pptx`,w)}catch{}}if(i>0){const n=await s.generateAsync({type:"blob"}),r=new Date().toISOString().slice(0,10).replace(/-/g,""),l=document.createElement("a");l.href=URL.createObjectURL(n),l.download=`setlist-pptx-${r}.zip`,l.click(),URL.revokeObjectURL(l.href)}else try{k&&k("No PPTX files found for selected songs")||alert("No PPTX files found for selected songs")}catch{}N("")}return e.jsxs(Je,{children:[oe?e.jsx("div",{style:{position:"fixed",inset:0,display:"flex",alignItems:"center",justifyContent:"center",background:"rgba(0,0,0,.45)",zIndex:90},role:"dialog","aria-modal":"true",children:e.jsxs("div",{style:{background:"var(--card)",color:"var(--text)",border:"1px solid var(--line)",borderRadius:10,padding:16,width:"min(560px, 92vw)"},children:[e.jsx("h3",{style:{marginTop:0,marginBottom:8},children:"Load Set"}),S.length?e.jsxs("label",{style:{display:"block",margin:"8px 0"},children:["Select a saved set",e.jsx("select",{value:_,onChange:t=>z(t.target.value),style:{width:"100%"},children:S.map(t=>e.jsxs("option",{value:t.id,children:[t.name," · ",new Date(t.updatedAt).toLocaleString()]},t.id))})]}):e.jsx("div",{className:"meta",children:"No saved sets yet."}),e.jsxs("div",{className:"row",style:{justifyContent:"flex-end",gap:8,marginTop:12},children:[e.jsx(u,{onClick:()=>L(!1),children:"Cancel"}),e.jsx(u,{variant:"primary",onClick:me,disabled:!S.length,children:"Load"})]})]})}):null,e.jsx(Pe,{busy:$}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginTop:12,marginBottom:4},children:[e.jsx("div",{}),e.jsx("h1",{style:{margin:0},children:"Setlist Builder"}),e.jsx("div",{})]}),e.jsxs(Le,{className:"card",style:{marginTop:8,position:"static"},children:[e.jsx("div",{style:{width:"100%",marginBottom:6},children:e.jsx("strong",{title:"Current set name",children:m||"New Setlist"})}),e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",flexWrap:"wrap",width:"100%"},children:[e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"},children:[e.jsxs(u,{size:"sm",variant:"secondary",onClick:ue,title:"Save set",iconLeft:e.jsx(ke,{}),children:[" ",e.jsx("span",{className:"text-when-wide",children:"Save"})]}),e.jsxs(u,{size:"sm",variant:"secondary",onClick:fe,title:"Load saved set",iconLeft:e.jsx(Te,{}),disabled:!S.length,children:[" ",e.jsx("span",{className:"text-when-wide",children:"Load"})]}),e.jsxs(u,{size:"sm",variant:"secondary",onClick:U,title:"New set",iconLeft:e.jsx(J,{}),children:[" ",e.jsx("span",{className:"text-when-wide",children:"New"})]}),e.jsxs(u,{size:"sm",variant:"secondary",onClick:he,disabled:!C,title:"Delete set",iconLeft:e.jsx(De,{}),children:[" ",e.jsx("span",{className:"text-when-wide",children:"Delete"})]})]}),e.jsxs("div",{style:{marginLeft:"auto",display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"},children:[e.jsx(u,{variant:"primary",size:"md",onClick:ge,onMouseEnter:H,onFocus:H,disabled:$||a.length===0,title:"Export set as a single PDF",iconLeft:e.jsx(q,{}),children:$?"Exporting…":e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-when-wide",children:"Export PDF"}),e.jsx("span",{className:"text-when-narrow",children:"PDF"})]})}),e.jsx(u,{variant:"primary",size:"md",onClick:ye,disabled:a.length===0||!!D,title:a.length===0?"Add songs to export PPTX bundle":"Export PPTX bundle for selected songs",iconLeft:e.jsx(q,{}),children:D||e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-when-wide",children:"Export PPTX"}),e.jsx("span",{className:"text-when-narrow",children:"PPTX"})]})}),e.jsx(u,{variant:"primary",size:"md",onClick:xe,title:"Copy shareable link",iconLeft:e.jsx($e,{}),disabled:a.length===0,children:"Share Set"}),e.jsxs(u,{variant:"primary",size:"md",as:Oe,to:a.length?`/worship/${a.map(t=>t.id).join(",")}?toKeys=${a.map(t=>encodeURIComponent(t.toKey)).join(",")}`:"/worship",title:"Open Worship Mode",iconLeft:e.jsx(Ae,{}),children:[e.jsx("span",{className:"text-when-wide",children:"Worship Mode"}),e.jsx("span",{className:"text-when-narrow",children:"Worship"})]})]})]})]}),e.jsxs("div",{className:"BuilderPage",style:{marginTop:8},children:[e.jsx("div",{className:"BuilderLeft",children:e.jsx("div",{className:"card",style:{display:"flex",flexDirection:"column",flex:"1 1 auto",minHeight:0},children:e.jsxs("div",{className:"BuilderScroll",style:{minHeight:0,flex:"1 1 auto",overflow:"auto",marginTop:8},children:[e.jsxs("div",{className:"BuilderHeader",style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx("strong",{style:{whiteSpace:"nowrap"},children:"Add songs"}),e.jsx(Ee,{value:y,onChange:t=>se(t.target.value),placeholder:"Search...",style:{flex:1,minWidth:0}}),e.jsxs("label",{className:"row",style:{gap:6,alignItems:"center"},children:[e.jsx("input",{type:"checkbox",checked:v,onChange:t=>ie(t.target.checked)}),e.jsx("span",{className:"meta",title:"Limit results to songs tagged ICP",children:"ICP only"})]})]}),O?e.jsx("div",{style:{display:"grid",gap:".5rem",gridTemplateColumns:"repeat(auto-fill, minmax(320px, 1fr))",marginTop:6},children:le.map(t=>e.jsx(V,{title:t.title,subtitle:`${t.originalKey||""}${t.tags?.length?` • ${t.tags.join(", ")}`:""}`,rightSlot:e.jsx(u,{"aria-label":"Add",title:"Add to set",variant:"primary",iconLeft:e.jsx(J,{}),iconOnly:!0,onClick:s=>{s.stopPropagation(),M(t)}}),onClick:()=>M(t)},t.id))}):e.jsx("div",{children:"Loading search…"})]})})}),e.jsx("div",{className:"BuilderRight",style:{minHeight:0,display:"flex",flexDirection:"column"},children:e.jsxs("div",{className:"card",style:{display:"flex",flexDirection:"column",flex:"1 1 auto",minHeight:0},children:[e.jsxs("div",{className:"BuilderScroll",style:{minHeight:0,flex:"1 1 auto",overflow:"auto",marginTop:8},children:[e.jsx("div",{className:"BuilderHeader",children:e.jsxs("strong",{children:["Current setlist (",a.length,")"]})}),e.jsx("div",{style:{marginTop:6},children:a.map((t,s)=>{const i=f.find(n=>n.id===t.id);return i?e.jsx(V,{draggable:!0,onDragStart:n=>{n.dataTransfer.setData("text/plain",String(t.id)),n.dataTransfer.effectAllowed="move"},onDragOver:n=>{n.preventDefault(),n.dataTransfer.dropEffect="move"},onDrop:n=>{n.preventDefault();const r=n.dataTransfer.getData("text/plain");de(r,s)},title:i.title,subtitle:`Original: ${i.originalKey||"—"}`,rightSlot:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx(Ge,{value:t.toKey,onChange:n=>pe(t.id,n.target.value),children:Be.map(n=>e.jsx("option",{value:n,children:n},n))}),e.jsx(u,{onClick:()=>R(t.id,"up"),title:"Move up",iconLeft:e.jsx(Ke,{})}),e.jsx(u,{onClick:()=>R(t.id,"down"),title:"Move down",iconLeft:e.jsx(_e,{})}),e.jsx(u,{onClick:()=>ce(t.id),title:"Remove",iconLeft:e.jsx(ze,{}),iconOnly:!0,style:{color:"#b91c1c"}})]})},t.id):null})})]}),e.jsxs("div",{className:"print-only",style:{marginTop:16},children:[e.jsx("h2",{style:{fontSize:"20pt",margin:"0 0 8pt 0"},children:m}),e.jsx("ol",{style:{fontSize:"12pt",lineHeight:1.4,paddingLeft:"1.2em"},children:a.map(t=>{const s=f.find(i=>i.id===t.id);return s?e.jsxs("li",{children:[s.title," — ",t.toKey||s.originalKey||"—"]},t.id):null})})]})]})})]})]})}export{et as default};
