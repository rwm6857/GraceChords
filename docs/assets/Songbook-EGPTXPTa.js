const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-CN5WZqp1.js","./index-6e1UIAnr.js","./index-CymyriFs.css"])))=>i.map(i=>d[i]);
import{r as i,i as Y,j as t,B as Z,T as ee,a as x,P as M,e as te,D as se,I as ae,c as ne,M as le,_ as ie,f as re,p as oe,n as ce,g as w,k as de}from"./index-6e1UIAnr.js";import{S as C}from"./Select-D5EI4Xu4.js";let E;const D=()=>E||(E=ie(()=>import("./index-CN5WZqp1.js").then(n=>n.i),__vite__mapDeps([0,1,2]),import.meta.url));function A(n,o){return de(n,o)}function N(n){return[...new Set(n.filter(Boolean))].sort((o,y)=>String(o).localeCompare(String(y),void 0,{sensitivity:"base"}))}function me(){const n=i.useMemo(()=>{const e=Y?.items||[],a=new Set,s=[];for(const l of e)a.has(l.id)||(a.add(l.id),s.push(l));return s.slice().sort(A)},[]),[o,y]=i.useState(""),[h,R]=i.useState("All"),[p,_]=i.useState("All"),[m,O]=i.useState("All"),H=i.useMemo(()=>N(n.flatMap(e=>Array.isArray(e.tags)?e.tags:e.tags?[e.tags]:[])),[n]),$=i.useMemo(()=>N(n.map(e=>e.country).filter(Boolean)),[n]),q=i.useMemo(()=>N(n.flatMap(e=>Array.isArray(e.authors)?e.authors:e.authors?[e.authors]:[])),[n]),d=i.useMemo(()=>{const e=o.trim().toLowerCase();let a=n;return e&&(a=a.filter(s=>{const l=(s.title||"").toLowerCase(),g=(Array.isArray(s.authors)?s.authors.join(", "):s.authors||"").toLowerCase();return l.includes(e)||g.includes(e)})),h!=="All"&&(a=a.filter(s=>Array.isArray(s.tags)?s.tags.includes(h):s.tags===h)),p!=="All"&&(a=a.filter(s=>s.country===p)),m!=="All"&&(a=a.filter(s=>Array.isArray(s.authors)?s.authors.includes(m):s.authors===m)),a.slice().sort(A)},[n,o,h,p,m]),[f,v]=i.useState(()=>new Set),c=i.useMemo(()=>d.filter(e=>f.has(e.id)).slice().sort(A),[d,f]),k=d.length,L=f.size;function S(e,a){v(s=>{const l=new Set(s);return a?l.add(e):l.delete(e),l})}function z(){d.length&&v(e=>{const a=new Set(e);for(const s of d)a.add(s.id);return a})}function W(){v(new Set)}const[F,U]=i.useState(!0),[K,j]=i.useState(null),[b,T]=i.useState(!1);async function V(){if(c.length){T(!0);try{const{downloadSongbookPdf:e}=await D(),a=[];for(const s of c)try{const l=`./songs/${s.filename}`,g=await re(l),r=oe(g),J=(r.sections||[]).map(P=>({section:P.label,lines:(P.lines||[]).map(u=>({plain:u.comment?u.comment:u.lyrics||"",chordPositions:(u.chords||[]).map(B=>({sym:B.sym,index:B.index})),comment:u.comment?u.comment:void 0}))})),Q=s.filename.replace(/\.chordpro$/,""),X=ce({title:r.meta.title||s.title||Q,key:r.meta.key||r.meta.originalkey||s.originalKey||"C",capo:r.meta?.capo,lyricsBlocks:J});a.push(X)}catch(l){console.error(l),w(`Failed to process ${s.filename}`)}a.length&&await e(a,{includeTOC:F,coverImageDataUrl:K})}finally{T(!1)}}}function I(){D()}function G(e){const a=e.target.files?.[0];if(!a){j(null);return}if(a.size>2*1024*1024){w("Image must be under 2 MB"),e.target.value="",j(null);return}if(!a.type.startsWith("image/")){w("File must be an image"),e.target.value="",j(null);return}const s=new FileReader;s.onload=()=>j(String(s.result||"")),s.readAsDataURL(a)}return n.length===0?t.jsxs("div",{className:"container",children:[t.jsx("h1",{children:"No songs found"}),t.jsx("p",{className:"Small",children:"The song index is empty or failed to load."})]}):t.jsxs("div",{className:"container",children:[t.jsx(Z,{busy:b}),t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[t.jsx("div",{}),t.jsx("h1",{style:{margin:0},children:"Songbook Builder"}),t.jsx("div",{})]}),t.jsxs(ee,{className:"card",style:{marginTop:12},children:[t.jsxs("div",{className:"Field",children:[t.jsx("input",{id:"sb-toc",type:"checkbox",checked:F,onChange:e=>U(e.target.checked)}),t.jsx("label",{htmlFor:"sb-toc",children:"Include table of contents"})]}),t.jsxs("div",{className:"Field",children:[t.jsx("label",{htmlFor:"sb-cover",children:"Cover page (image):"}),t.jsx("input",{id:"sb-cover",className:"CoverInput",type:"file",accept:"image/*",onChange:G})]}),t.jsxs("div",{style:{marginLeft:"auto",display:"flex",gap:6},children:[t.jsxs(x,{onClick:z,disabled:!k,title:"Select all filtered",iconLeft:t.jsx(M,{}),children:[t.jsxs("span",{className:"text-when-wide",children:["Select all (",k,")"]}),t.jsx("span",{className:"text-when-narrow",children:"All"})]}),t.jsx(x,{onClick:W,disabled:!L,title:"Clear selection",iconLeft:t.jsx(te,{}),children:t.jsx("span",{className:"text-when-wide",children:"Clear"})}),t.jsx(x,{variant:"primary",onClick:V,onMouseEnter:I,onFocus:I,disabled:!c.length||b,title:c.length?"Export PDF":"Select some songs first",iconLeft:t.jsx(se,{}),children:b?"Exporting…":t.jsxs(t.Fragment,{children:[t.jsxs("span",{className:"text-when-wide",children:["Export PDF (",c.length,")"]}),t.jsx("span",{className:"text-when-narrow",children:"PDF"})]})})]})]}),t.jsxs("div",{className:"BuilderPage",style:{marginTop:12},children:[t.jsx("div",{className:"BuilderLeft",children:t.jsxs("div",{className:"card",children:[t.jsxs("div",{className:"Row",style:{gap:"1rem",alignItems:"flex-end",flexWrap:"wrap",marginTop:8},children:[t.jsx("div",{className:"Field",style:{minWidth:220},children:t.jsx(ae,{id:"sb-search",type:"search",label:"Search",placeholder:"Title or author",value:o,onChange:e=>y(e.target.value),style:{width:"100%"}})}),t.jsx("div",{className:"Field",children:t.jsxs(C,{id:"sb-tag",value:h,onChange:e=>R(e.target.value),children:[t.jsx("option",{children:"All"}),H.map(e=>t.jsx("option",{value:e,children:e},e))]})}),t.jsx("div",{className:"Field",children:t.jsxs(C,{id:"sb-country",value:p,onChange:e=>_(e.target.value),children:[t.jsx("option",{children:"All"}),$.map(e=>t.jsx("option",{value:e,children:e},e))]})}),t.jsx("div",{className:"Field",children:t.jsxs(C,{id:"sb-author",value:m,onChange:e=>O(e.target.value),children:[t.jsx("option",{children:"All"}),q.map(e=>t.jsx("option",{value:e,children:e},e))]})})]}),t.jsxs("div",{className:"Row Small",style:{marginTop:".5rem"},children:[t.jsx("strong",{children:L})," selected"]}),t.jsx("div",{className:"SongList",role:"region","aria-label":"Song list",style:{minHeight:0,maxHeight:300,overflow:"auto",marginTop:6},children:t.jsx("div",{className:"gc-list",children:d.map(e=>{const a=f.has(e.id),s=Array.isArray(e.authors)?e.authors.join(", "):e.authors||"",l=Array.isArray(e.tags)?e.tags:e.tags?String(e.tags).split(",").map(r=>r.trim()):[],g=[s||"—",e.country].filter(Boolean).join(" • ");return t.jsx(ne,{title:e.title,subtitle:g,tags:l,rightSlot:a?t.jsx(x,{title:"Remove",onClick:r=>{r.stopPropagation(),S(e.id,!1)},iconLeft:t.jsx(le,{}),style:{color:"#b91c1c"},children:"Remove"}):t.jsx(x,{variant:"primary",title:"Add",onClick:r=>{r.stopPropagation(),S(e.id,!0)},iconLeft:t.jsx(M,{}),children:"Add"}),onClick:()=>S(e.id,!a)},e.id)})})})]})}),t.jsx("div",{className:"BuilderRight",children:t.jsxs("div",{className:"card",children:[t.jsxs("strong",{children:["Current selection (",c.length,")"]}),t.jsx("div",{className:"PreviewList",role:"region","aria-label":"Selected songs",style:{minHeight:0,maxHeight:360,overflow:"auto",marginTop:6},children:t.jsx("ol",{className:"List",style:{listStyle:"decimal inside"},children:c.map(e=>t.jsxs("li",{children:[e.title,Array.isArray(e.authors)&&e.authors.length?t.jsxs("span",{className:"Small",children:[" — ",e.authors.join(", ")]}):null]},e.id))})})]})})]})]})}export{me as default};
