const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./pdf-DwianqlC.js","./index-CBAsPKxu.js","./index-CgYN5LtB.css","./fonts-OQpvcT7Z.js","./pdfLayout-B8mhuvOX.js","./jszip.min-BJ3qPN9L.js"])))=>i.map(i=>d[i]);
import{r as m,i as pe,F as fe,j as t,L as he,K as ge,A as xe,a as ye,R as je,D as R,h as be,t as M,_ as H,f as Se,p as ve,s as we,b as Ce}from"./index-CBAsPKxu.js";const z="gracechords.sets.v1";function N(){try{const o=localStorage.getItem(z);return o?JSON.parse(o):{sets:{}}}catch{return{sets:{}}}}function J(o){localStorage.setItem(z,JSON.stringify(o))}function Ne(){return typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():"id-"+Math.random().toString(36).slice(2)+Date.now().toString(36)}function w(){const{sets:o}=N();return Object.values(o).sort((a,p)=>(p.updatedAt||0)-(a.updatedAt||0))}function W(o){const{sets:a}=N();return a[o]||null}function C(o){var d;const a=Date.now(),p={id:o.id||Ne(),name:((d=o.name)==null?void 0:d.trim())||"Untitled Set",items:Array.isArray(o.items)?o.items:[],createdAt:o.createdAt||a,updatedAt:a},y=N();return y.sets[p.id]=p,J(y),p}function ke(o){const a=N();return a.sets[o]?(delete a.sets[o],J(a),!0):!1}function Ke(o){const a=W(o);return a?C({name:`Copy of ${a.name}`,items:a.items.map(p=>({...p}))}):null}let B;const F=()=>B||(B=H(()=>import("./pdf-DwianqlC.js"),__vite__mapDeps([0,1,2,3,4]),import.meta.url));function Ie(){const[o,a]=m.useState("Untitled Set"),[p,y]=m.useState(""),[d,V]=m.useState([]),[l,f]=m.useState([]),[I,X]=m.useState({}),[k,j]=m.useState(""),$=Object.keys(I).length,[g,x]=m.useState(null),[Y,T]=m.useState(()=>w()),[q,b]=m.useState("");m.useEffect(()=>{var e;V(((e=pe)==null?void 0:e.items)||[])},[]),m.useEffect(()=>{let e=!1;async function s(){const n={};for(const i of l){const r=d.find(h=>h.id===i.id);if(!r)continue;const c=`./pptx/${r.id}.pptx`;await be(c,r.id)&&(n[r.id]=!0)}e||X(n)}return s(),()=>{e=!0}},[l,d]),m.useEffect(()=>{var e;try{const s=localStorage.getItem("setlist");if(!s||w().length>0)return;const n=JSON.parse(s);if(n!=null&&n.name||(((e=n==null?void 0:n.list)==null?void 0:e.length)||0)>0){const i=C({name:n.name||"Imported Set",items:n.list||[]});T(w()),x(i.id),a(i.name),f(i.items||[]),b(i.id)}}catch{}},[]);const K=m.useMemo(()=>new fe(d,{keys:["title","tags"],threshold:.4}),[d]),G=m.useMemo(()=>p?K.search(p).map(e=>e.item):d.slice().sort((e,s)=>e.title.localeCompare(s.title)),[p,K,d]);function Q(e){l.find(s=>s.id===e.id)||f([...l,{id:e.id,toKey:e.originalKey||"C"}])}function Z(e){f(l.filter(s=>s.id!==e))}function _(e,s){const n=l.findIndex(u=>u.id===e);if(n<0)return;const i=n+(s==="up"?-1:1);if(i<0||i>=l.length)return;const r=l.slice(),[c]=r.splice(n,1);r.splice(i,0,c),f(r)}function ee(e,s){f(l.map(n=>n.id===e?{...n,toKey:s}:n))}function A(e){f(s=>s.map(n=>{const i=d.find(c=>c.id===n.id),r=n.toKey||(i==null?void 0:i.originalKey)||"C";return{...n,toKey:M(r,e)}}))}function te(){f(e=>e.map(s=>{const n=d.find(i=>i.id===s.id);return{...s,toKey:(n==null?void 0:n.originalKey)||"C"}}))}function S(e){T(w()),b(e||"")}function D(){x(null),a("Untitled Set"),f([]),b("")}function ne(){const e=(o==null?void 0:o.trim())||"Untitled Set",s=C({id:g,name:e,items:l});a(s.name),x(s.id),S(s.id)}function se(e){const s=e.target.value;if(b(s),!s)return;const n=W(s);n&&(x(n.id),a(n.name||"Untitled Set"),f(n.items||[]))}function ie(){if(!g){const s=`Copy of ${o||"Untitled Set"}`,n=C({id:null,name:s,items:l});a(n.name),x(n.id),S(n.id);return}const e=Ke(g);e&&(x(e.id),a(e.name),f(e.items||[]),S(e.id))}function oe(){g&&window.confirm(`Delete set "${o}"? This cannot be undone.`)&&(ke(g),D(),S(""))}async function ae(){var n,i,r;const{downloadMultiSongPdf:e}=await F(),s=[];for(const c of l){const u=d.find(h=>h.id===c.id);if(u)try{const h=`./songs/${u.filename}`,ce=await Se(h),v=ve(ce),P=((n=v.meta)==null?void 0:n.key)||((i=v.meta)==null?void 0:i.originalkey)||u.originalKey||"C",de=we(P,c.toKey||P),ue=v.blocks.map(E=>({section:E.section,lines:E.lines.map(U=>({plain:U.text,chordPositions:(U.chords||[]).map(O=>({sym:M(O.sym,de),index:O.index}))}))})),me=u.filename.replace(/\.chordpro$/,"");s.push({title:((r=v.meta)==null?void 0:r.title)||u.title||me,key:c.toKey||P,lyricsBlocks:ue})}catch(h){console.error(h),Ce(`Failed to process ${u.filename}`)}}s.length&&await e(s)}function L(){F()}async function le(){j(`Bundling 0/${l.length}…`);const e=(await H(async()=>{const{default:i}=await import("./jszip.min-BJ3qPN9L.js").then(r=>r.j);return{default:i}},__vite__mapDeps([5,1,2]),import.meta.url)).default,s=new e;let n=0;for(let i=0;i<l.length;i++){const r=l[i],c=d.find(u=>u.id===r.id);if(!c){j(`Bundling ${i+1}/${l.length}…`);continue}if(j(`Bundling ${i+1}/${l.length}…`),!!I[c.id])try{const u=await fetch(`./pptx/${c.id}.pptx`);if(!u.ok)continue;const h=await u.blob();n++,s.file(`${String(n).padStart(2,"0")}-${c.id}.pptx`,h)}catch{}}if(n>0){const i=await s.generateAsync({type:"blob"}),r=new Date().toISOString().slice(0,10).replace(/-/g,""),c=document.createElement("a");c.href=URL.createObjectURL(i),c.download=`setlist-pptx-${r}.zip`,c.click(),URL.revokeObjectURL(c.href)}j("")}function re(){window.print()}return t.jsxs("div",{className:"container",children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[t.jsx("div",{children:t.jsx(he,{to:"/",className:"back",children:"← Back"})}),t.jsx("h1",{style:{margin:0},children:"Setlist Builder"}),t.jsx("div",{})]}),t.jsxs("div",{className:"card toolbar",style:{marginTop:12},children:[t.jsxs("label",{style:{display:"flex",alignItems:"center",gap:6},children:[t.jsx("span",{children:"Set:"}),t.jsx("input",{"aria-label":"Set name",value:o,onChange:e=>a(e.target.value),style:{minWidth:220},placeholder:"Sunday AM"})]}),t.jsxs("select",{"aria-label":"Saved sets",value:q,onChange:se,children:[t.jsx("option",{value:"",children:"— Load saved set —"}),Y.map(e=>t.jsxs("option",{value:e.id,children:[e.name," · ",new Date(e.updatedAt).toLocaleString()]},e.id))]}),t.jsx("button",{className:"btn",onClick:D,children:"New"}),t.jsx("button",{className:"btn primary",onClick:ne,children:"Save"}),t.jsx("button",{className:"btn",onClick:ie,disabled:!l.length,children:"Duplicate"}),t.jsx("button",{className:"btn",onClick:oe,disabled:!g,children:"Delete"}),t.jsxs("div",{style:{marginLeft:"auto",display:"flex",alignItems:"center",gap:6},children:[t.jsx("span",{className:"meta",children:"Transpose:"}),t.jsx("button",{className:"btn",onClick:()=>A(-1),title:"Transpose set down 1 semitone",children:"–1"}),t.jsx("button",{className:"btn",onClick:te,title:"Reset all to originals",children:"Reset"}),t.jsx("button",{className:"btn",onClick:()=>A(1),title:"Transpose set up 1 semitone",children:"+1"})]})]}),t.jsxs("div",{className:"card",style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12},children:[t.jsx("div",{children:t.jsxs("div",{style:{marginTop:8},children:[t.jsx("strong",{children:"Add songs"}),t.jsx("input",{value:p,onChange:e=>y(e.target.value),placeholder:"Search...",style:{display:"block",width:"100%",marginTop:6}}),t.jsx("div",{style:{minHeight:0,maxHeight:300,overflow:"auto",marginTop:6},children:K?G.map(e=>{var s;return t.jsxs("div",{className:"row",style:{padding:"6px 0"},children:[t.jsxs("div",{style:{flex:1},children:[t.jsx("div",{style:{fontWeight:600},children:e.title}),t.jsxs("div",{className:"meta",children:[e.originalKey||"",(s=e.tags)!=null&&s.length?` • ${e.tags.join(", ")}`:""]})]}),t.jsx("button",{className:"btn",onClick:()=>Q(e),children:"Add"})]},e.id)}):t.jsx("div",{children:"Loading search…"})})]})}),t.jsxs("div",{children:[t.jsxs("strong",{children:["Current setlist (",l.length,")"]}),t.jsx("div",{style:{minHeight:0,maxHeight:360,overflow:"auto",marginTop:6},children:l.map(e=>{const s=d.find(n=>n.id===e.id);return s?t.jsxs("div",{className:"row",style:{padding:"6px 0"},children:[t.jsxs("div",{style:{flex:1},children:[t.jsx("div",{style:{fontWeight:600},children:s.title}),t.jsxs("div",{className:"meta",children:["Original: ",s.originalKey||"—"]})]}),t.jsx("select",{value:e.toKey,onChange:n=>ee(e.id,n.target.value),children:ge.map(n=>t.jsx("option",{value:n,children:n},n))}),t.jsx("button",{className:"btn",onClick:()=>_(e.id,"up"),title:"Move up",children:t.jsx(xe,{})}),t.jsx("button",{className:"btn",onClick:()=>_(e.id,"down"),title:"Move down",children:t.jsx(ye,{})}),t.jsx("button",{className:"btn",onClick:()=>Z(e.id),title:"Remove",children:t.jsx(je,{})})]},e.id):null})}),t.jsxs("div",{style:{display:"flex",gap:8,marginTop:8},children:[t.jsxs("button",{className:"btn primary iconbtn",onClick:ae,onMouseEnter:L,onFocus:L,children:[t.jsx(R,{})," Export PDF"]}),t.jsx("button",{className:"btn iconbtn",onClick:le,disabled:$===0||!!k,title:$===0?"No PPTX files found for this set.":"",children:k||t.jsxs(t.Fragment,{children:[t.jsx(R,{})," Bundle PPTX"]})}),t.jsx("button",{className:"btn",onClick:re,children:"Print"}),t.jsx("button",{className:"btn",onClick:()=>f([]),children:"Clear"})]}),t.jsxs("div",{className:"print-only",style:{marginTop:16},children:[t.jsx("h2",{style:{fontSize:"20pt",margin:"0 0 8pt 0"},children:o}),t.jsx("ol",{style:{fontSize:"12pt",lineHeight:1.4,paddingLeft:"1.2em"},children:l.map(e=>{const s=d.find(n=>n.id===e.id);return s?t.jsxs("li",{children:[s.title," — ",e.toKey||s.originalKey||"—"]},e.id):null})})]})]})]})]})}export{Ie as default};
