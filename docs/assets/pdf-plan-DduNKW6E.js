function I(o=""){return/^(?:verse(?:\s*\d+)?|chorus|bridge|tag|pre[-\s]?chorus|intro|outro|ending|refrain)\s*\d*$/i.test(String(o).trim())}function L(o){const g=i=>{const c=[];let n=null;const a=()=>{n&&n.lines.length&&c.push(n),n=null};for(const l of i||[]){if(l.section){a(),c.push(l);continue}for(const r of l.lines||[]){const u=r.plain||r.text||"";!!!(r.chordPositions&&r.chordPositions.length)&&I(u)?(a(),n={section:u.trim(),lines:[]}):(n||(n={lines:[]}),n.lines.push(r))}}return a(),c.length?c:i||[]};if(o!=null&&o.lyricsBlocks)return{title:o.title||"Untitled",key:o.key||o.originalKey||"C",lyricsBlocks:g(o.lyricsBlocks)};if(Array.isArray(o==null?void 0:o.blocks)){const i=[];let c={lines:[]};for(const n of o.blocks)n.type==="section"?(c.lines.length&&i.push(c),c={section:n.header,lines:[]}):n.type==="line"&&c.lines.push({plain:n.lyrics||n.text||"",chordPositions:(n.chords||[]).map(a=>({index:a.index??0,sym:a.sym}))});return c.lines.length&&i.push(c),{title:o.title||"Untitled",key:o.key||o.originalKey||"C",lyricsBlocks:g(i)}}return{title:(o==null?void 0:o.title)||"Untitled",key:(o==null?void 0:o.key)||(o==null?void 0:o.originalKey)||"C",lyricsBlocks:[]}}const _={lyricSizePt:16,chordSizePt:16,margin:36,gutter:18,headerOffsetY:54,columns:1,pageWidth:612,pageHeight:792,lyricFamily:"Helvetica",chordFamily:"Courier",title:"Untitled",key:"C"},J=6,N=.92,Q=.86;function V(o,g,i,c,n,a){const l=c.margin,r=c.pageWidth-l*2,d=(g===2?(r-c.gutter)/2:r)-J,P=n(i),t=a(i);for(const s of o.lyricsBlocks||[])for(const m of s.lines||[]){const x=m.plain||m.text||"";if(P(x)>d)return!0;for(const f of m.chordPositions||[]){const C=P(x.slice(0,f.index||0)),H=t(f.sym||"");if(C+H>d)return!0}}return!1}function M(o,g,i,c,n,a){const l=c.margin,r=c.pageWidth-l*2,u=g===2?(r-c.gutter)/2:r,d=n(i),P=a(i);let t=0;for(const s of o.lyricsBlocks||[])for(const m of s.lines||[]){const x=m.plain||m.text||"";t=Math.max(t,(d(x)||0)/u);for(const f of m.chordPositions||[]){const C=d(x.slice(0,f.index||0)),H=P(f.sym||"");t=Math.max(t,(C+H)/u)}}return t}function j(o,g,i,c){const l={...o,lyricsBlocks:(o.lyricsBlocks||[]).map(t=>{if(!(t!=null&&t.section)&&Array.isArray(t==null?void 0:t.lines)&&t.lines.length){const s=t.lines[0],m=(s==null?void 0:s.plain)||(s==null?void 0:s.text)||"";if(!(Array.isArray(s==null?void 0:s.chordPositions)&&s.chordPositions.length>0)&&I(m))return{section:m.trim(),lines:t.lines.slice(1)}}return t})},r=(t,s)=>{const m=!V(l,t,s,g,i,c),x=i(s),f=E(l,{...g,columns:t,lyricSizePt:s,chordSizePt:s},x),C=f.pages.length<=1,H=t===2&&M(l,t,s,g,i,c)>=N;return{widthOk:m,heightOk:C,tight:H,layout:f}};for(let t=16;t>=12;t--){{const s=r(1,t);if(s.widthOk&&s.heightOk)return{columns:1,lyricSizePt:t,chordSizePt:t,layout:s.layout}}{const s=r(2,t),m=t===12&&M(l,2,t,g,i,c)>=Q;if(s.widthOk&&s.heightOk&&!s.tight&&!m)return{columns:2,lyricSizePt:t,chordSizePt:t,layout:s.layout}}}const u=12,d=[1,2].map(t=>({cols:t,...r(t,u)}));d.sort((t,s)=>t.layout.pages.length!==s.layout.pages.length?t.layout.pages.length-s.layout.pages.length:t.widthOk!==s.widthOk?t.widthOk?-1:1:t.cols!==s.cols?t.cols===1?-1:1:0);const P=d[0];return{columns:P.cols,lyricSizePt:u,chordSizePt:u,layout:P.layout}}function X(o,g={},i=()=>()=>0,c=()=>()=>0){const n=L(o),a={..._,...g},l=j(n,a,i,c);return{...a,columns:l.columns,lyricSizePt:l.lyricSizePt,chordSizePt:l.chordSizePt,layout:l.layout}}function E(o,g={},i=c=>0){const c=L(o),n={..._,...g},a=4,l=n.lyricSizePt,r=Math.round(n.lyricSizePt*.85),u=n.margin,d=n.pageHeight,P=n.pageWidth-u*2,t=n.columns===2?(P-n.gutter)/2:P,s=u+n.headerOffsetY,m=d-u,x=[];let f={columns:[]};x.push(f);function C(){const e={x:u,yStart:s,blocks:[]};if(f.columns.push(e),n.columns===2){const h={x:u+t+n.gutter,yStart:s,blocks:[]};f.columns.push(h)}}function H(){f={columns:[]},x.push(f)}f.columns.length===0&&C(),c.lyricsBlocks=(c.lyricsBlocks||[]).map(e=>{if(!(e!=null&&e.section)&&Array.isArray(e==null?void 0:e.lines)&&e.lines.length){const h=e.lines[0],S=(h==null?void 0:h.plain)||(h==null?void 0:h.text)||"";if(!(Array.isArray(h==null?void 0:h.chordPositions)&&h.chordPositions.length>0)&&I(S))return{section:S.trim(),lines:e.lines.slice(1)}}return e});let W=0,k=s;const Y=()=>f.columns[W],w=()=>{n.columns===2&&W===0?(W=1,k=s):(H(),C(),W=0,k=s)},D=(e,h=0,S=(y=>(y=e.lines)==null?void 0:y.length)()??0)=>{var T;let z=0;!!e.section&&h===0&&(z+=r+l+4);for(let A=h;A<S;A++){const p=e.lines[A];(T=p==null?void 0:p.chordPositions)!=null&&T.length&&(z+=n.chordSizePt+a/2),z+=n.lyricSizePt+a}return z+4},v=e=>{var h;return((h=e==null?void 0:e.chordPositions)!=null&&h.length?n.chordSizePt+a/2:0)+n.lyricSizePt+a},U=(e,h)=>{e.blocks.push({type:"section",header:h})},R=(e,h,S)=>{e.blocks.push({type:"line",lyrics:h,chords:S.map(y=>({x:i(h.slice(0,y.index||0)),sym:y.sym}))})};for(const e of c.lyricsBlocks||[]){const h=D(e);if(k+h<=m){const z=Y();e.section&&(k+=r,U(z,e.section),k+=l+4);for(const O of e.lines||[]){const T=O.plain||O.text||"",A=O.chordPositions||[];R(z,T,A),k+=v(O)}k+=4;continue}const S=(e.lines||[]).map(v);let y=0;for(;y<(e.lines||[]).length;){const z=(e.lines||[]).length-y,O=y===0&&e.section?r+l+4:0,T=S[y]||0;if(k+O+T>m){w();continue}const A=m-k-O;let p=0,B=0;for(;y+p<S.length&&B+S[y+p]<=A;)B+=S[y+p],p++;if(p===1&&z>1){w();continue}if(z-p===1)if(p>1)B-=S[y+p-1],p--;else{w();continue}const G=Y();y===0&&e.section&&(k+=r,U(G,e.section),k+=l+4);for(let K=0;K<p;K++){const F=e.lines[y],$=F.plain||F.text||"",q=F.chordPositions||[];R(G,$,q),k+=S[y],y++}k+=4,y<(e.lines||[]).length&&w()}}return{pages:x}}function Z(o,g){const i={..._,...g};i.pageWidth=612,i.pageHeight=792;const c=a=>a?a.length*(i.lyricSizePt*.6):0;return E(L(o),i,c).pages.map((a,l)=>({p:l,cols:a.columns.map((r,u)=>({c:u,blocks:r.blocks.map(d=>({t:d.type,h:d.type==="section"&&d.header||null,line:d.type==="line"?{text:d.lyrics,chords:(d.chords||[]).map(P=>({x:Number(P.x.toFixed(2)),s:P.sym}))}:null}))}))}))}function b(o,g){const i=L(o),c={..._,...g};c.pageWidth=612,c.pageHeight=792;const l=j(i,c,r=>u=>u?u.length*(r*.6):0,r=>u=>u?u.length*(r*.6):0);return{columns:l.columns,size:l.lyricSizePt,pages:l.layout.pages.length}}export{_ as DEFAULT_LAYOUT_OPT,E as computeLayout,Z as getLayoutMetrics,L as normalizeSongInput,b as planForTest,X as planSongLayout};
