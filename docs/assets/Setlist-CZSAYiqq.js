const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/jszip.min-xLYr3ZWB.js","assets/index-CclnaSPP.js","assets/index-CWMdvkis.css","assets/index-OuuujBaH.js"])))=>i.map(i=>d[i]);
import{_ as Me,p as be,J as ht,N as gt,O as yt,r as x,i as xt,Q as wt,U as St,j as s,B as L,V as Tt,W as _e,X as de,Y as Oe,L as Ke,Z as Xe,$ as bt,a0 as Nt,P as Ue,T as Pt,I as jt,a1 as Fe,a2 as It,a3 as Et,a4 as Mt,a5 as vt,a6 as At,a7 as Te,a8 as ue,a9 as We,f as Lt,h as Ct,aa as Rt,ab as $t,ac as kt,ad as Dt,s as ee}from"./index-CclnaSPP.js";import{P as Bt}from"./PageContainer-CWiJ7230.js";const Ve="gracechords.sets.v1";function Pe(){try{const e=localStorage.getItem(Ve);return e?JSON.parse(e):{sets:{}}}catch{return{sets:{}}}}function Ge(e){localStorage.setItem(Ve,JSON.stringify(e))}function _t(){return typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():"id-"+Math.random().toString(36).slice(2)+Date.now().toString(36)}function ge(){const{sets:e}=Pe();return Object.values(e).sort((n,i)=>(i.updatedAt||0)-(n.updatedAt||0))}function Ot(e){const{sets:n}=Pe();return n[e]||null}function ze(e){const n=Date.now(),i={id:e.id||_t(),name:e.name?.trim()||"Untitled Set",items:Array.isArray(e.items)?e.items:[],createdAt:e.createdAt||n,updatedAt:n},c=Pe();return c.sets[i.id]=i,Ge(c),i}function Kt(e){const n=Pe();return n.sets[e]?(delete n.sets[e],Ge(n),!0):!1}const Xt="application/vnd.openxmlformats-officedocument.presentationml.slide+xml",Ye="application/vnd.openxmlformats-officedocument.presentationml.slideMaster+xml",Ut="application/vnd.openxmlformats-officedocument.presentationml.slideLayout+xml",Ft="application/vnd.openxmlformats-officedocument.theme+xml",J="http://schemas.openxmlformats.org/presentationml/2006/main",ve="http://schemas.openxmlformats.org/officeDocument/2006/relationships",qe="application/vnd.openxmlformats-officedocument.presentationml.notesMaster+xml",Wt=new DOMParser,zt=new XMLSerializer;function Yt(e){const n="setlist",i=String(e).trim();return i&&i.replace(/\s+/g,"_").replace(/[^A-Za-z0-9_.-]/g,"_").replace(/_+/g,"_").replace(/^_+|_+$/g,"")||n}async function He(e){const n=await fetch(e);if(!n.ok)throw new Error(`Failed to load PPTX: ${e}`);return n.arrayBuffer()}function ie(e){const n=Wt.parseFromString(e,"application/xml"),i=n.getElementsByTagName("parsererror")[0];if(i)throw new Error(i.textContent||"Failed to parse XML");return n}function xe(e){return zt.serializeToString(e)}function F(e){const n=String(e||"").match(/(\d+)$/);return n?Number(n[1]):0}function ce(e,n){let i=0;return e.filter(c=>n.test(c)).forEach(c=>{const r=c.name.match(n);if(!r)return;const d=Number(r[1]);Number.isNaN(d)||(i=Math.max(i,d))}),i}function Qe(e,n,i){if(Array.from(e.getElementsByTagName("Override")).some(d=>d.getAttribute("PartName")===n))return;const r=e.createElement("Override");r.setAttribute("PartName",n),r.setAttribute("ContentType",i),e.documentElement.appendChild(r)}function fe(e,n){if(!n)return null;if(n.startsWith("/"))return n.slice(1);const i=e.split("/");i.pop();const c=n.split("/");for(const r of c)if(r==="..")i.pop();else{if(r===".")continue;i.push(r)}return i.join("/")}function re(e,n){const i=e.split("/");i.pop();const c=n.split("/");let r=0;for(;r<i.length&&r<c.length&&i[r]===c[r];)r++;const d=i.length-r,p=[];for(let h=0;h<d;h++)p.push("..");return p.push(...c.slice(r)),p.join("/")}function et(e){const n=e.match(/^(.*\/)([^/]*?)(\d+)(\.[^.]+)$/);return n?{dir:n[1],prefix:n[2],number:Number(n[3]),ext:n[4]}:null}function se(e,n,i){const c=Number(e[n]||0);i>c&&(e[n]=i)}function tt(e,n){const c=Number(e[n]||0)+1;return e[n]=c,c}function W(e,n){if(!e)return null;const i=e.file(n);return Array.isArray(i)?i.length?i[0]:null:i||null}function pe(e){const n=e.lastIndexOf("/"),i=n>=0?e.slice(0,n+1):"",c=n>=0?e.slice(n+1):e;return`${i}_rels/${c}.rels`}function qt(e,n){if(!e||!n)return{contentType:"",fromOverride:!1,extension:""};const i=`/${n}`,r=Array.from(e.getElementsByTagName("Override")).find(m=>m.getAttribute("PartName")===i);if(r)return{contentType:r.getAttribute("ContentType")||"",fromOverride:!0,extension:n.split(".").pop()||""};const d=Array.from(e.getElementsByTagName("Default")),p=n.split(".").pop()||"",h=d.find(m=>m.getAttribute("Extension")===p);return h?{contentType:h.getAttribute("ContentType")||"",fromOverride:!1,extension:p}:{contentType:"",fromOverride:!1,extension:p}}function Ht(e,n,i){if(!i||Array.from(e.getElementsByTagName("Default")).some(p=>p.getAttribute("Extension")===i))return;const r=Array.from(n?.getElementsByTagName?.("Default")||[]).find(p=>p.getAttribute("Extension")===i);if(!r)return;const d=e.createElement("Default");d.setAttribute("Extension",i),d.setAttribute("ContentType",r.getAttribute("ContentType")||""),e.documentElement.appendChild(d)}function Jt(e){return e?!/xml|text|application\/(.*\+xml)/i.test(e):!1}function Zt(e){const n=/(.*\D)(\d+)(\.\w+)$/,i=e&&e.match(n);if(i){const[,c,,r]=i;return d=>`${c}${d}${r}`}return c=>`slides/slide${c}.xml`}async function Vt(e){const n="ppt/presentation.xml",i=W(e,n);if(!i)throw new Error("Base PPTX missing ppt/presentation.xml");const c=await i.async("string"),r=ie(c),d=r.getElementsByTagNameNS(J,"sldIdLst")[0]||r.getElementsByTagName("p:sldIdLst")[0],h=(d?Array.from(d.getElementsByTagNameNS(J,"sldId")).concat(Array.from(d.getElementsByTagName("p:sldId"))):[]).reduce((y,S)=>{const P=Number(S.getAttribute("id"));return Number.isNaN(P)?y:Math.max(y,P)},255),m="ppt/_rels/presentation.xml.rels",b=W(e,m);if(!b)throw new Error("Base PPTX missing ppt/_rels/presentation.xml.rels");const w=await b.async("string"),C=ie(w),u=Array.from(C.getElementsByTagName("Relationship")),R=u.reduce((y,S)=>{const P=F(S.getAttribute("Id"));return Math.max(y,P)},0),O=u.filter(y=>(y.getAttribute("Type")||"").endsWith("/slide")),N=O.length&&O[0].getAttribute("Target")||"",M=Zt(N),k=r.getElementsByTagNameNS(J,"sldMasterIdLst")[0]||r.getElementsByTagName("p:sldMasterIdLst")[0]||null,D=(k?Array.from(k.getElementsByTagNameNS(J,"sldMasterId")).concat(Array.from(k.getElementsByTagName("p:sldMasterId"))):[]).reduce((y,S)=>{const P=Number(S.getAttribute("id"));return Number.isNaN(P)?y:Math.max(y,P)},2147483647),Z=r.getElementsByTagNameNS(J,"notesMasterIdLst")[0]||r.getElementsByTagName("p:notesMasterIdLst")[0]||null;let z=null;const ae=u.find(y=>(y.getAttribute("Type")||"").endsWith("/notesMaster"));if(ae){const y=ae.getAttribute("Target")||"";z=fe("ppt/presentation.xml",y)}let oe=null;const me=u.find(y=>(y.getAttribute("Type")||"").endsWith("/theme"));if(me){const y=me.getAttribute("Target")||"";oe=fe("ppt/presentation.xml",y)}const G="[Content_Types].xml",le=W(e,G);if(!le)throw new Error("Base PPTX missing [Content_Types].xml");const je=await le.async("string"),we=ie(je),K={};e.filter(()=>!0).forEach(y=>{const S=et(y.name);if(!S)return;const P=`${S.dir}${S.prefix}`;se(K,P,S.number)}),se(K,"ppt/slides/slide",ce(e,/^ppt\/slides\/slide(\d+)\.xml$/)),se(K,"ppt/notesSlides/notesSlide",ce(e,/^ppt\/notesSlides\/notesSlide(\d+)\.xml$/)),se(K,"ppt/slideMasters/slideMaster",ce(e,/^ppt\/slideMasters\/slideMaster(\d+)\.xml$/)),se(K,"ppt/slideLayouts/slideLayout",ce(e,/^ppt\/slideLayouts\/slideLayout(\d+)\.xml$/)),se(K,"ppt/theme/theme",ce(e,/^ppt\/theme\/theme(\d+)\.xml$/)),se(K,"ppt/notesMasters/notesMaster",ce(e,/^ppt\/notesMasters\/notesMaster(\d+)\.xml$/)),se(K,"ppt/media/image",ce(e,/^ppt\/media\/image(\d+)\.[^.]+$/));const Q=e.file(/^ppt\/slides\/slide\d+\.xml$/).sort((y,S)=>F(y.name)-F(S.name));let Y="",B="",V="";if(Q.length){const y=Q[0],S=W(e,pe(y.name));if(S){const P=ie(await S.async("string")),q=Array.from(P.getElementsByTagName("Relationship")).find(_=>(_.getAttribute("Type")||"").endsWith("/slideLayout"));if(q){Y=q.getAttribute("Target")||"";const _=fe(y.name,Y);_&&W(e,_)&&(B=_)}}}if(B)!Y&&Q.length&&(Y=re(Q[0].name,B));else{const y=e.file(/^ppt\/slideLayouts\/.*\.xml$/).sort((S,P)=>F(S.name)-F(P.name));y.length&&(B=y[0].name,Y=Q.length?re(Q[0].name,B):"../slideLayouts/slideLayout1.xml")}if(B){const y=W(e,pe(B));if(y){const S=ie(await y.async("string")),he=Array.from(S.getElementsByTagName("Relationship")).find(q=>(q.getAttribute("Type")||"").endsWith("/slideMaster"));if(he){const q=he.getAttribute("Target")||"",_=fe(B,q);_&&W(e,_)&&(V=_)}}}if(!V){const y=e.file(/^ppt\/slideMasters\/.*\.xml$/).sort((S,P)=>F(S.name)-F(P.name));y.length&&(V=y[0].name)}if(!z){const y=e.file(/^ppt\/notesMasters\/.*\.xml$/).sort((S,P)=>F(S.name)-F(P.name));y.length&&(z=y[0].name)}return{zip:e,presentationXmlPath:n,presentationDoc:r,sldIdList:d,sldMasterList:k,notesMasterList:Z,presentationRelsPath:m,presentationRelsDoc:C,contentTypesPath:G,contentTypesDoc:we,nextSlideId:h,nextRelId:R,nextMasterId:D,counters:K,partMap:new Map,masterRelMap:new Map,notesMasterRelMap:new Map,getSlideTarget:M,defaultLayoutTarget:Y,defaultLayoutPath:B,defaultMasterPath:V,defaultNotesMasterPath:z,defaultThemePath:oe}}function Gt(e,n,i){const c=e.presentationRelsDoc.documentElement,r=e.presentationRelsDoc.createElement("Relationship");r.setAttribute("Id",i),r.setAttribute("Type","http://schemas.openxmlformats.org/officeDocument/2006/relationships/slide");const d=e.getSlideTarget?e.getSlideTarget(n):`slides/slide${n}.xml`;r.setAttribute("Target",d),c.appendChild(r)}function Qt(e,n){const i=e.presentationDoc,c=e.sldIdList||(()=>{const d=i.createElementNS(J,"p:sldIdLst");return i.documentElement.appendChild(d),e.sldIdList=d,d})(),r=i.createElementNS(J,"p:sldId");e.nextSlideId+=1,r.setAttribute("id",String(e.nextSlideId)),r.setAttributeNS(ve,"r:id",n),c.appendChild(r)}function en(e,n){if(e.masterRelMap.has(n))return e.masterRelMap.get(n);const i=e.presentationDoc,c=e.presentationRelsDoc;let r=e.sldMasterList;if(!r){r=i.createElementNS(J,"p:sldMasterIdLst");const m=i.documentElement.firstChild;m?i.documentElement.insertBefore(r,m):i.documentElement.appendChild(r),e.sldMasterList=r}e.nextMasterId=Number(e.nextMasterId||2147483647),e.nextMasterId+=1,e.nextRelId+=1;const d=`rId${e.nextRelId}`,p=i.createElementNS(J,"p:sldMasterId");p.setAttribute("id",String(e.nextMasterId)),p.setAttributeNS(ve,"r:id",d),r.appendChild(p);const h=c.createElement("Relationship");return h.setAttribute("Id",d),h.setAttribute("Type","http://schemas.openxmlformats.org/officeDocument/2006/relationships/slideMaster"),h.setAttribute("Target",re("ppt/presentation.xml",n)),c.documentElement.appendChild(h),e.masterRelMap.set(n,d),d}function tn(e,n){if(e.notesMasterRelMap.has(n))return e.notesMasterRelMap.get(n);const i=e.presentationDoc,c=e.presentationRelsDoc;let r=e.notesMasterList;if(!r){r=i.createElementNS(J,"p:notesMasterIdLst");const m=i.documentElement,b=e.sldIdList||m.firstChild;b?m.insertBefore(r,b):m.appendChild(r),e.notesMasterList=r}e.nextRelId+=1;const d=`rId${e.nextRelId}`,p=i.createElementNS(J,"p:notesMasterId");p.setAttributeNS(ve,"r:id",d),r.appendChild(p);const h=c.createElement("Relationship");return h.setAttribute("Id",d),h.setAttribute("Type","http://schemas.openxmlformats.org/officeDocument/2006/relationships/notesMaster"),h.setAttribute("Target",re("ppt/presentation.xml",n)),c.documentElement.appendChild(h),e.notesMasterRelMap.set(n,d),d}async function Ne(e,n,i,c,r,d={}){if(!r)return null;const p=`${c}:${r}`;if(e.partMap.has(p))return e.partMap.get(p);const h=qt(i,r),m=W(n,r);if(!m)return null;if(h.contentType===Ut&&e.defaultLayoutPath)return e.partMap.set(p,e.defaultLayoutPath),e.defaultLayoutPath;if(h.contentType===Ye&&e.defaultMasterPath)return e.partMap.set(p,e.defaultMasterPath),e.defaultMasterPath;if(h.contentType===qe&&e.defaultNotesMasterPath)return e.partMap.set(p,e.defaultNotesMasterPath),e.defaultNotesMasterPath;if(h.contentType===Ft&&e.defaultThemePath)return e.partMap.set(p,e.defaultThemePath),e.defaultThemePath;const b=et(r);let w;if(b){const O=`${b.dir}${b.prefix}`,N=tt(e.counters,O);w=`${b.dir}${b.prefix}${N}${b.ext}`}else{if(W(e.zip,r))return e.partMap.set(p,r),r;w=r}e.partMap.set(p,w),h.fromOverride?Qe(e.contentTypesDoc,`/${w}`,h.contentType):h.extension&&Ht(e.contentTypesDoc,i,h.extension);const C=await m.async(Jt(h.contentType)?"uint8array":"string");e.zip.file(w,C);const u=pe(r),R=W(n,u);if(R){const O=await R.async("string"),N=ie(O),M=Array.from(N.getElementsByTagName("Relationship"));for(const v of M){if((v.getAttribute("TargetMode")||"").toLowerCase()==="external")continue;const Z=v.getAttribute("Target")||"",z=fe(r,Z);if(!z)continue;let ae=null;if(typeof d.relationshipMutator=="function"){const G=await d.relationshipMutator({node:v,type:v.getAttribute("Type")||"",absolutePath:z,newPartPath:w,originalPartPath:r});if(G===!1)continue;G&&G.targetPath&&(ae=G.targetPath)}const oe=ae||await Ne(e,n,i,c,z);if(!oe)continue;const me=re(w,oe);v.setAttribute("Target",me)}const k=pe(w);e.zip.file(k,xe(N))}return h.contentType===Ye?en(e,w):h.contentType===qe&&tn(e,w),w}async function nn(e,n,i,c,r,d){const p=pe(r),h=W(n,p);if(!h)return;const m=await h.async("string"),b=ie(m),w=Array.from(b.getElementsByTagName("Relationship")),C=b.documentElement;let u=!1,R=w.reduce((N,M)=>{const k=M.getAttribute("Id")||"";return Math.max(N,F(k))},0);for(const N of w){const M=N.getAttribute("Type")||"",k=N.getAttribute("Target")||"";if(!k)continue;const v=fe(r,k);if(v){if(M.endsWith("/slideLayout")){e.defaultLayoutTarget?u?C.removeChild(N):(u=!0,N.setAttribute("Target",e.defaultLayoutTarget)):u?C.removeChild(N):u=!0;continue}if(M.endsWith("/notesSlide")){const D=await Ne(e,n,i,c,v,{relationshipMutator:({type:Z})=>Z.endsWith("/slide")?{targetPath:d}:null});if(!D)continue;N.setAttribute("Target",re(d,D))}else if(M.includes("/image")||M.includes("/audio")||M.includes("/video")){const D=await Ne(e,n,i,c,v);if(!D)continue;N.setAttribute("Target",re(d,D))}else{const D=await Ne(e,n,i,c,v);if(!D)continue;N.setAttribute("Target",re(d,D))}}}if(!u&&e.defaultLayoutTarget){const N=b.createElement("Relationship"),M=`rId${R+1||1}`;N.setAttribute("Id",M),N.setAttribute("Type","http://schemas.openxmlformats.org/officeDocument/2006/relationships/slideLayout"),N.setAttribute("Target",e.defaultLayoutTarget),C.appendChild(N)}const O=pe(d);e.zip.file(O,xe(b))}async function sn(e,n,i){const c=n.file(/^ppt\/slides\/slide\d+\.xml$/).sort((p,h)=>{const m=F(p.name),b=F(h.name);return m-b});if(!c.length)return;const r=W(n,"[Content_Types].xml");if(!r)throw new Error("Source PPTX missing [Content_Types].xml");const d=ie(await r.async("string"));for(const p of c){const h=tt(e.counters,"ppt/slides/slide"),m=`ppt/slides/slide${h}.xml`,b=await p.async("string");e.zip.file(m,b),Qe(e.contentTypesDoc,`/${m}`,Xt),e.nextRelId+=1;const w=`rId${e.nextRelId}`;Gt(e,h,w),Qt(e,w);const C=p.name;e.partMap.set(`${i}:${C}`,m),await nn(e,n,d,i,C,m)}}function rn(e){e.zip.file(e.presentationXmlPath,xe(e.presentationDoc)),e.zip.file(e.presentationRelsPath,xe(e.presentationRelsDoc)),e.zip.file(e.contentTypesPath,xe(e.contentTypesDoc))}function an(e,n){const i=document.createElement("a");i.href=URL.createObjectURL(e),i.download=n,i.rel="noopener",i.click(),URL.revokeObjectURL(i.href)}async function on(e=[],n="Setlist"){if(!Array.isArray(e)||e.length===0)throw new Error("No PPTX files to merge");const i=(await Me(async()=>{const{default:w}=await import("./jszip.min-xLYr3ZWB.js").then(C=>C.j);return{default:w}},__vite__mapDeps([0,1,2]))).default,[c,...r]=e,d=await He(c),p=await i.loadAsync(d),h=await Vt(p);for(let w=0;w<r.length;w++){const C=await He(r[w]),u=await i.loadAsync(C);await sn(h,u,`src${w+1}`)}rn(h);const m=await p.generateAsync({type:"blob"}),b=Yt(n||"Setlist");an(m,`${b}.pptx`)}function ln(e){return e?e.slug?e.slug:e.filename?e.filename.replace(/\.chordpro$/i,""):e.title?e.title.trim().toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_.-]/g,""):"":""}async function cn(e={},n={}){const{name:i="Setlist",songs:c=[]}=e||{},{availablePptxMap:r=null,onEmpty:d}=n,p=[];for(const h of c){const m=ln(h);m&&(r&&!r[m]||p.push(be(`pptx/${m}.pptx`)))}if(!p.length){typeof d=="function"&&d();return}await on(p,i)}let Je;const Ze=()=>Je||(Je=Me(()=>import("./index-OuuujBaH.js").then(e=>e.i),__vite__mapDeps([3,1,2])));function dn(){try{if(typeof crypto<"u"&&crypto.randomUUID)return crypto.randomUUID()}catch{}return`sel-${Math.random().toString(36).slice(2)}${Date.now().toString(36)}`}function nt(e){if(!e)return null;const{id:n,toKey:i=""}=e;return n==null?null:{uid:dn(),id:n,toKey:i}}function ye(e=[]){return e.map(n=>nt(n)).filter(Boolean)}function pn(){const{code:e,songIds:n}=ht(),i=gt(),c=yt(),[r,d]=x.useState("New Setlist"),[p,h]=x.useState(""),[m,b]=x.useState([]),[w,C]=x.useState(()=>{try{return localStorage.getItem("pref:icpOnly")==="1"}catch{return!1}});x.useEffect(()=>{try{localStorage.setItem("pref:icpOnly",w?"1":"0")}catch{}},[w]);const[u,R]=x.useState([]),[O,N]=x.useState({}),[M,k]=x.useState(""),[v,D]=x.useState("");Object.keys(O).length;const[Z,z]=x.useState(!1),[ae,oe]=x.useState(()=>{try{return window.innerWidth<=640}catch{return!1}}),[me,G]=x.useState(()=>{try{return window.innerWidth<=820}catch{return!1}}),[le,je]=x.useState(()=>{try{return window.innerWidth<=900}catch{return!1}}),we=x.useRef(""),K=x.useRef(""),Q=x.useRef(!1),[Y,B]=x.useState(null),[V,y]=x.useState(()=>ge()),[S,P]=x.useState(""),[he,q]=x.useState(!1),[_,Ie]=x.useState("");x.useEffect(()=>{const t=xt?.items||[],a=new Set,l=[];for(const o of t)a.has(o.id)||(a.add(o.id),l.push(o));b(l)},[]),x.useEffect(()=>{let t=!1;async function a(){const l={};for(const o of u){const f=m.find(te=>te.id===o.id);if(!f)continue;const g=f.filename.replace(/\.chordpro$/i,""),I=be(`pptx/${g}.pptx`);await At(I,g)&&(l[g]=!0)}t||N(l)}return a(),()=>{t=!0}},[u,m]),x.useEffect(()=>{try{const t=document.documentElement,a=document.body;we.current=t.style.overflowY||"",K.current=a.style.overflowY||"",getComputedStyle(t).overflowY==="hidden"&&(t.style.overflowY=""),getComputedStyle(a).overflowY==="hidden"&&(a.style.overflowY="")}catch{}return()=>{try{document.documentElement.style.overflowY=we.current,document.body.style.overflowY=K.current}catch{}}},[]),x.useEffect(()=>{if(!e)return;const{entries:t,error:a}=wt(e);if(a){alert(a),c("/setlist",{replace:!0});return}const l=t.map(g=>({id:g.id,toKey:g.toKey}));R(ye(l));const o=l.map(g=>g.id).join(","),f=l.map(g=>encodeURIComponent(g.toKey||"")).join(",");c(`/setlist/${o}?toKeys=${f}`,{replace:!0})},[e]),x.useEffect(()=>{if(!n)return;const t=(n||"").split(",").map(f=>f.trim()).filter(Boolean);if(!t.length)return;const l=(new URLSearchParams(i.search||"").get("toKeys")||"").split(",").map(f=>decodeURIComponent(f)).filter(Boolean),o=t.map((f,g)=>({id:f,toKey:l[g]||""}));R(ye(o))},[n,i.search]),x.useEffect(()=>{try{if(!Array.isArray(u))return;if(u.length===0){(e||n)&&c("/setlist",{replace:!0});return}const t=u.map(f=>f.id).join(","),a=u.map(f=>encodeURIComponent(f.toKey||"")).join(","),l=n||"",o=new URLSearchParams(i.search||"").get("toKeys")||"";(t!==l||a!==o)&&c(`/setlist/${t}?toKeys=${a}`,{replace:!0})}catch{}},[u.map(t=>`${t.id}:${t.toKey}`).join("|"),n,i.search,e]),x.useEffect(()=>{try{const t=localStorage.getItem("setlist");if(!t||ge().length>0)return;const a=JSON.parse(t);if(a?.name||(a?.list?.length||0)>0){const l=ze({name:a.name||"Imported Set",items:a.list||[]});y(ge()),B(l.id),d(l.name),R(ye(l.items||[])),P(l.id)}}catch{}},[]),x.useEffect(()=>{function t(){try{const a=window.innerWidth;oe(a<=640),G(a<=820),je(a<=900)}catch{}}return window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[]),x.useEffect(()=>{new URLSearchParams(i.search||"").get("icp")==="1"&&C(!0)},[i.search]),x.useEffect(()=>{if(Q.current)return;const t=i.state?.quickAction;t&&m.length&&(ot(t,m),Q.current=!0,c(i.pathname+(i.search||""),{replace:!0,state:null}))},[i.state,m.map(t=>t.id).join("|")]);const Ee=x.useMemo(()=>new St(m,{keys:["title","tags"],threshold:.4}),[m]);function st(t){return!w||(Array.isArray(t.tags)?t.tags.includes("ICP"):t.tags==="ICP")}const it=x.useMemo(()=>(p?Ee.search(p).map(a=>a.item):m.slice().sort((a,l)=>a.title.localeCompare(l.title))).filter(st),[p,Ee,m,w]);function Ae(t){if(!t)return;const a=nt({id:t.id,toKey:t.originalKey||t.key||"C"});R(l=>[...l,a])}function rt(t){R(a=>a.filter(l=>l.uid!==t))}function Le(t,a){R(l=>{const o=l.findIndex($=>$.uid===t);if(o<0)return l;const f=o+(a==="up"?-1:1);if(f<0||f>=l.length)return l;const g=l.slice(),[I]=g.splice(o,1);return g.splice(f,0,I),g})}function at(t,a){R(l=>{if(a<0||a>=l.length)return l;const o=l.findIndex(I=>I.uid===t);if(o<0||o===a)return l;const f=l.slice(),[g]=f.splice(o,1);return f.splice(a,0,g),f})}function ot(t,a){if(!t)return;function l(T){!T||!T.length||R(ye(T.map(E=>({id:E.id,toKey:E.toKey}))))}function o(T){return T?{id:T.id,toKey:T.originalKey||T.key||"C"}:null}function f(T,E){return T.filter(A=>A&&!E.has(A.id))}function g(T,E){const A=f(T,E),X=A.length?We(A):null;return X&&E.add(X.id),X}function I(){const T=Te(a,"FAST"),E=[],A=new Set;if((T.length>=4?ue(T,4):T.slice()).forEach(j=>{j&&A.add(j.id),E.push(j)}),E.length<4){const j=ue(f(a,A),Math.min(4-E.length,Math.max(0,a.length-E.length)));E.push(...j)}return E.filter(Boolean).map(o).filter(Boolean).slice(0,4)}function $(){const T=new Set,E=Te(a,"SLOW"),A=pt=>E.filter(mt=>(mt?.originalKey||"").toUpperCase()===pt.toUpperCase()),X=Te(a,"FAST"),j=g(A("G"),T)||g(E,T)||g(a,T),U=g(X,T)||g(a,T),H=g(A("A"),T)||g(E,T)||g(a,T);return[j,U,H].filter(Boolean).map(o).filter(Boolean)}function te(){const E=We(["CROSS","COMMITMENT","MISSION","MISSIONS","PRAISE","HYMN"]),A=Te(a,E),X=new Set,j=[];A.length>=4?j.push(...ue(A,4)):A.length>=2?j.push(...ue(A,Math.min(4,A.length))):A.length&&j.push(...A),j.forEach(H=>H&&X.add(H.id));const U=Math.max(0,2-j.length);if(U>0){const H=ue(f(a,X),Math.min(U,a.length-j.length));j.push(...H)}if(j.length<4){const H=ue(f(a,X),Math.min(4-j.length,a.length-j.length));j.push(...H)}return j.filter(Boolean).map(o).filter(Boolean).slice(0,4)}let ne=[];t==="celebrationSet"?ne=I():t==="threeSongFlow"?ne=$():t==="randomThemeSet"&&(ne=te()),ne.length&&l(ne)}function lt(t,a){R(l=>l.map(o=>o.uid===t?{...o,toKey:a}:o))}function Ce(t){y(ge()),P(t||"")}function Re(){B(null),d("New Setlist"),R([]),P("")}function ct(){const t=r?.trim()||"New Setlist",a=window.prompt("Save set as:",t);if(a===null)return;const l=String(a).trim()||"New Setlist";let o=Y;if(!o){const I=(ge()||[]).find($=>($.name||"")===l);I&&(o=I.id)}const f=u.map(({id:I,toKey:$})=>({id:I,toKey:$})),g=ze({id:o,name:l,items:f});d(g.name),B(g.id),Ce(g.id)}function dt(){const t=_||S||"";if(!t){q(!1);return}const a=Ot(t);a&&(B(a.id),d(a.name||"New Setlist"),R(ye(a.items||[])),P(a.id)),q(!1)}function ut(){const t=V[0]?.id||"";Ie(S||t),q(!0)}function ft(){Y&&window.confirm(`Delete set "${r}"? This cannot be undone.`)&&(Kt(Y),Re(),Ce(""))}async function $e(){z(!0);try{const{downloadMultiSongPdf:t}=await Ze(),a=[];for(const l of u){const o=m.find(f=>f.id===l.id);if(o)try{const f=be(`songs/${o.filename}`),g=await Lt(f),I=Ct(g),$=I.meta?.key||I.meta?.originalkey||o.originalKey||"C",te=Rt($,l.toKey||$),ne=(String($).match(/^([A-G][#b]?)/)||[,""])[1],T=!!(ne&&/b$/.test(ne)),E=(I.sections||[]).map(j=>({section:j.label,lines:(j.lines||[]).map(U=>U.instrumental?{instrumental:$t(U.instrumental,te,T)}:U.comment?{plain:U.comment,chordPositions:[],comment:U.comment}:{plain:U.lyrics||"",chordPositions:(U.chords||[]).map(H=>({sym:kt(H.sym,te,T),index:H.index}))})})),A=o.filename.replace(/\.chordpro$/i,""),X=Dt({title:I.meta?.title||o.title||A,key:l.toKey||$,capo:I.meta?.capo,lyricsBlocks:E});a.push(X)}catch(f){console.error(f),ee(`Failed to process ${o.filename}`)}}a.length&&await t(a)}finally{z(!1)}}function Se(){Ze()}async function ke(){try{const t=u.map(f=>f.id).join(","),a=u.map(f=>encodeURIComponent(f.toKey||"")).join(","),o=`${(()=>{try{if(typeof window<"u"&&window.location)return`${window.location.origin||""}/`}catch{}return""})()}setlist/${t}?toKeys=${a}`;await navigator.clipboard.writeText(o);try{ee?.("Link copied!")}catch{}}catch{alert("Failed to copy link")}}async function De(){if(v)return;k(`Bundling 0/${u.length}…`);const t=(await Me(async()=>{const{default:o}=await import("./jszip.min-xLYr3ZWB.js").then(f=>f.j);return{default:o}},__vite__mapDeps([0,1,2]))).default,a=new t;let l=0;for(let o=0;o<u.length;o++){const f=u[o],g=m.find($=>$.id===f.id);if(!g){k(`Bundling ${o+1}/${u.length}…`);continue}k(`Bundling ${o+1}/${u.length}…`);const I=g.filename.replace(/\.chordpro$/i,"");if(O[I])try{const $=await fetch(be(`pptx/${I}.pptx`));if(!$.ok)continue;const te=await $.blob();l++,a.file(`${String(l).padStart(2,"0")}-${I}.pptx`,te)}catch{}}if(l>0){const o=await a.generateAsync({type:"blob"}),f=new Date().toISOString().slice(0,10).replace(/-/g,""),g=document.createElement("a");g.href=URL.createObjectURL(o),g.download=`setlist-pptx-${f}.zip`,g.click(),URL.revokeObjectURL(g.href)}else try{ee&&ee("No PPTX files found for selected songs")||alert("No PPTX files found for selected songs")}catch{}k("")}async function Be(){if(!(M||v)){D("Combining…");try{const t=[],a=[];for(const l of u){const o=m.find(g=>g.id===l.id);if(!o)continue;const f=o.filename.replace(/\.chordpro$/i,"");if(!O[f]){a.push(o.title||f);continue}t.push(o)}if(!t.length){try{ee&&ee("No PPTX files found for selected songs")||alert("No PPTX files found for selected songs")}catch{}return}if(a.length){const l=a.length===1?`${a[0]} PPT file unavailable`:`${a.length} songs missing PPT files`;try{ee?.(l)}catch{}}await cn({name:r||"Setlist",songs:t},{})}catch(t){console.error(t);try{ee&&ee("Failed to combine PPTX files")||alert("Failed to combine PPTX files")}catch{}}finally{D("")}}}return s.jsxs(Bt,{className:"is-setlist",children:[he?s.jsx("div",{style:{position:"fixed",inset:0,display:"flex",alignItems:"center",justifyContent:"center",background:"rgba(0,0,0,.45)",zIndex:90},role:"dialog","aria-modal":"true",children:s.jsxs("div",{style:{background:"var(--card)",color:"var(--text)",border:"1px solid var(--line)",borderRadius:10,padding:16,width:"min(560px, 92vw)"},children:[s.jsx("h3",{style:{marginTop:0,marginBottom:8},children:"Load Set"}),V.length?s.jsxs("label",{style:{display:"block",margin:"8px 0"},children:["Select a saved set",s.jsx("select",{value:_,onChange:t=>Ie(t.target.value),style:{width:"100%"},children:V.map(t=>s.jsxs("option",{value:t.id,children:[t.name," · ",new Date(t.updatedAt).toLocaleString()]},t.id))})]}):s.jsx("div",{className:"meta",children:"No saved sets yet."}),s.jsxs("div",{className:"row",style:{justifyContent:"flex-end",gap:8,marginTop:12},children:[s.jsx(L,{onClick:()=>q(!1),children:"Cancel"}),s.jsx(L,{variant:"primary",onClick:dt,disabled:!V.length,children:"Load"})]})]})}):null,s.jsx(Tt,{busy:Z}),s.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginTop:12,marginBottom:4},children:[s.jsx("div",{}),s.jsx("h1",{style:{margin:0},children:"Setlist Builder"}),s.jsx("div",{})]}),ae?s.jsx(_e,{className:"card",style:{marginTop:8,position:"static"},children:s.jsxs("div",{className:"setlist-actions--mobile",style:{width:"100%"},children:[s.jsx(L,{variant:"primary",onClick:$e,onMouseEnter:Se,onFocus:Se,disabled:Z||u.length===0,title:"Export set as a single PDF",iconLeft:s.jsx(de,{}),children:"PDF"}),s.jsx(L,{onClick:Be,disabled:u.length===0||!!M||!!v,title:u.length===0?"Add songs to combine PPTX files":"Combine PPTX files into a single presentation",iconLeft:s.jsx(de,{}),children:v||"Export PPT"}),s.jsx(L,{onClick:De,disabled:u.length===0||!!M||!!v,title:u.length===0?"Add songs to export PPTX bundle":"Export PPTX bundle (ZIP) for selected songs",iconLeft:s.jsx(de,{}),children:"PPT ZIP"}),s.jsx(L,{onClick:ke,title:"Copy shareable link",iconLeft:s.jsx(Oe,{}),disabled:u.length===0,children:"Share"}),s.jsx(L,{as:Ke,to:u.length?`/worship/${u.map(t=>t.id).join(",")}?toKeys=${u.map(t=>encodeURIComponent(t.toKey)).join(",")}`:"/worship",title:"Open Worship Mode",iconLeft:s.jsx(Xe,{}),children:"Worship"})]})}):s.jsxs(_e,{className:"card",style:{marginTop:8,position:"static"},children:[s.jsx("div",{style:{width:"100%",marginBottom:6},children:s.jsx("strong",{title:"Current set name",children:r||"New Setlist"})}),s.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",flexWrap:"wrap",width:"100%"},children:[s.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"},children:[s.jsxs(L,{size:"sm",variant:"secondary",onClick:ct,title:"Save set",iconLeft:s.jsx(bt,{}),children:[" ",s.jsx("span",{className:"text-when-wide",children:"Save"})]}),s.jsxs(L,{size:"sm",variant:"secondary",onClick:ut,title:"Load saved set",iconLeft:s.jsx(Nt,{}),disabled:!V.length,children:[" ",s.jsx("span",{className:"text-when-wide",children:"Load"})]}),s.jsxs(L,{size:"sm",variant:"secondary",onClick:Re,title:"New set",iconLeft:s.jsx(Ue,{}),children:[" ",s.jsx("span",{className:"text-when-wide",children:"New"})]}),s.jsxs(L,{size:"sm",variant:"secondary",onClick:ft,disabled:!Y,title:"Delete set",iconLeft:s.jsx(Pt,{}),children:[" ",s.jsx("span",{className:"text-when-wide",children:"Delete"})]}),s.jsxs(L,{size:"sm",variant:"secondary",onClick:ke,title:"Copy shareable link",iconLeft:s.jsx(Oe,{}),disabled:u.length===0,children:[" ",s.jsx("span",{className:"text-when-wide",children:"Share Set"})]})]}),s.jsxs("div",{style:{marginLeft:"auto",display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"},children:[s.jsx(L,{variant:"primary",size:"md",onClick:$e,onMouseEnter:Se,onFocus:Se,disabled:Z||u.length===0,title:"Export set as a single PDF",iconLeft:s.jsx(de,{}),children:Z?"Exporting…":s.jsxs(s.Fragment,{children:[s.jsx("span",{className:"text-when-wide",children:"Export PDF"}),s.jsx("span",{className:"text-when-narrow",children:"PDF"})]})}),s.jsx(L,{variant:"primary",size:"md",onClick:Be,disabled:u.length===0||!!M||!!v,title:u.length===0?"Add songs to combine PPTX files":"Combine PPTX files into a single presentation",iconLeft:s.jsx(de,{}),children:v||s.jsxs(s.Fragment,{children:[s.jsx("span",{className:"text-when-wide",children:"Export PPT"}),s.jsx("span",{className:"text-when-narrow",children:"Export PPT"})]})}),s.jsx(L,{variant:"primary",size:"md",onClick:De,disabled:u.length===0||!!M||!!v,title:u.length===0?"Add songs to export PPTX bundle":"Export PPTX bundle (ZIP) for selected songs",iconLeft:s.jsx(de,{}),children:M||s.jsxs(s.Fragment,{children:[s.jsx("span",{className:"text-when-wide",children:"PPT ZIP"}),s.jsx("span",{className:"text-when-narrow",children:"PPT ZIP"})]})}),s.jsxs(L,{variant:"primary",size:"md",as:Ke,to:u.length?`/worship/${u.map(t=>t.id).join(",")}?toKeys=${u.map(t=>encodeURIComponent(t.toKey)).join(",")}`:"/worship",title:"Open Worship Mode",iconLeft:s.jsx(Xe,{}),children:[" ",s.jsx("span",{className:"text-when-wide",children:"Worship Mode"}),s.jsx("span",{className:"text-when-narrow",children:"Worship"})]})]})]})]}),s.jsxs("div",{className:"BuilderPage",style:{marginTop:8},children:[s.jsx("div",{className:"BuilderLeft",children:s.jsx("section",{className:"setlist-section setlist-add","data-role":"add",children:s.jsxs("div",{className:"card setlist-pane",children:[s.jsxs("div",{className:["BuilderHeader","section-header",le?"no-sticky":""].filter(Boolean).join(" "),style:{display:"flex",alignItems:"center",gap:8},children:[s.jsx("strong",{style:{whiteSpace:"nowrap"},children:"Add songs"}),s.jsx(jt,{value:p,onChange:t=>h(t.target.value),placeholder:"Search...",style:{flex:1,minWidth:0}}),s.jsxs("label",{className:"row",style:{gap:6,alignItems:"center"},children:[s.jsx("input",{type:"checkbox",checked:w,onChange:t=>C(t.target.checked)}),s.jsx("span",{className:"meta",title:"Limit results to songs tagged ICP",children:"ICP only"})]})]}),s.jsx("div",{className:["BuilderScroll","setlist-scroll","setlist-list",le?"no-pane-scroll":"pane-scroll","pane--addSongs"].join(" "),children:Ee?s.jsx("div",{style:{display:"grid",gap:".5rem",gridTemplateColumns:"repeat(auto-fill, minmax(320px, 1fr))",marginTop:6},children:it.map(t=>s.jsx(Fe,{title:t.title,subtitle:`${t.originalKey||""}${t.tags?.length?` • ${t.tags.join(", ")}`:""}`,rightSlot:s.jsx(L,{"aria-label":"Add",title:"Add to set",variant:"primary",iconLeft:s.jsx(Ue,{}),iconOnly:!0,onClick:a=>{a.stopPropagation(),Ae(t)}}),onClick:()=>Ae(t)},t.id))}):s.jsx("div",{children:"Loading search…"})})]})})}),s.jsx("div",{className:"BuilderRight",style:{minHeight:0,display:"flex",flexDirection:"column"},children:s.jsxs("section",{className:"setlist-section setlist-current","data-role":"current",children:[s.jsxs("div",{className:"card setlist-pane",children:[s.jsx("div",{className:["BuilderHeader","section-header",le?"no-sticky":""].filter(Boolean).join(" "),children:s.jsxs("strong",{children:["Current setlist (",u.length,")"]})}),s.jsx("div",{className:["BuilderScroll","setlist-scroll","setlist-list",le?"no-pane-scroll":"pane-scroll","pane--currentSet"].join(" "),style:{marginTop:6},children:u.map((t,a)=>{const l=m.find(o=>o.id===t.id);return l?s.jsx(Fe,{draggable:!0,onDragStart:o=>{o.dataTransfer.setData("text/plain",String(t.uid||t.id)),o.dataTransfer.effectAllowed="move"},onDragOver:o=>{o.preventDefault(),o.dataTransfer.dropEffect="move"},onDrop:o=>{o.preventDefault();const f=o.dataTransfer.getData("text/plain");at(f,a)},title:l.title,subtitle:`Original: ${l.originalKey||"—"}`,rightSlot:s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6},children:[s.jsx(It,{variant:"ui",baseKey:l.originalKey||"C",valueKey:t.toKey||l.originalKey||"C",onChange:o=>lt(t.uid,o)}),s.jsx(L,{onClick:()=>Le(t.uid,"up"),title:"Move up",iconLeft:s.jsx(Et,{})}),s.jsx(L,{onClick:()=>Le(t.uid,"down"),title:"Move down",iconLeft:s.jsx(Mt,{})}),s.jsx(L,{onClick:()=>rt(t.uid),title:"Remove",iconLeft:s.jsx(vt,{}),iconOnly:!0,style:{color:"#b91c1c"}})]})},t.uid||`${t.id}-${a}`):null})})]}),s.jsxs("div",{className:"print-only",style:{marginTop:16},children:[s.jsx("h2",{style:{fontSize:"20pt",margin:"0 0 8pt 0"},children:r}),s.jsx("ol",{style:{fontSize:"12pt",lineHeight:1.4,paddingLeft:"1.2em"},children:u.map((t,a)=>{const l=m.find(o=>o.id===t.id);return l?s.jsxs("li",{children:[l.title," — ",t.toKey||l.originalKey||"—"]},t.uid||`${t.id}-${a}`):null})})]})]})})]})]})}export{pn as default};
