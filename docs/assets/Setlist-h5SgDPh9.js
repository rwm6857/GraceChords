const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./jszip.min-BzspKW9F.js","./index-Bsw-X9YX.js","./index-CL-sUeVH.css","./index-DrXv61UL.js"])))=>i.map(i=>d[i]);
import{_ as ye,u as rt,a as at,b as ot,r as b,i as lt,d as ct,F as dt,j as s,B as E,c as ut,T as Ae,D as ie,L as Me,e as Le,M as Ce,S as pt,C as ft,P as $e,f as mt,I as ht,g as Re,K as gt,A as yt,h as xt,k as wt,l as bt,m as Tt,p as St,s as Nt,t as Pt,n as jt,o as It,q as Y}from"./index-Bsw-X9YX.js";import{P as Et}from"./PageContainer-B_0K_Xps.js";const Xe="gracechords.sets.v1";function he(){try{const e=localStorage.getItem(Xe);return e?JSON.parse(e):{sets:{}}}catch{return{sets:{}}}}function Ue(e){localStorage.setItem(Xe,JSON.stringify(e))}function vt(){return typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():"id-"+Math.random().toString(36).slice(2)+Date.now().toString(36)}function le(){const{sets:e}=he();return Object.values(e).sort((t,i)=>(i.updatedAt||0)-(t.updatedAt||0))}function At(e){const{sets:t}=he();return t[e]||null}function De(e){const t=Date.now(),i={id:e.id||vt(),name:e.name?.trim()||"Untitled Set",items:Array.isArray(e.items)?e.items:[],createdAt:e.createdAt||t,updatedAt:t},c=he();return c.sets[i.id]=i,Ue(c),i}function Mt(e){const t=he();return t.sets[e]?(delete t.sets[e],Ue(t),!0):!1}const Lt="application/vnd.openxmlformats-officedocument.presentationml.slide+xml",ke="application/vnd.openxmlformats-officedocument.presentationml.slideMaster+xml",Ct="application/vnd.openxmlformats-officedocument.presentationml.slideLayout+xml",$t="application/vnd.openxmlformats-officedocument.theme+xml",U="http://schemas.openxmlformats.org/presentationml/2006/main",xe="http://schemas.openxmlformats.org/officeDocument/2006/relationships",_e="application/vnd.openxmlformats-officedocument.presentationml.notesMaster+xml",Rt=new DOMParser,Dt=new XMLSerializer;function kt(e){const t="setlist",i=String(e).trim();return i&&i.replace(/\s+/g,"_").replace(/[^A-Za-z0-9_.-]/g,"_").replace(/_+/g,"_").replace(/^_+|_+$/g,"")||t}async function Be(e){const t=await fetch(e);if(!t.ok)throw new Error(`Failed to load PPTX: ${e}`);return t.arrayBuffer()}function J(e){const t=Rt.parseFromString(e,"application/xml"),i=t.getElementsByTagName("parsererror")[0];if(i)throw new Error(i.textContent||"Failed to parse XML");return t}function ce(e){return Dt.serializeToString(e)}function _(e){const t=String(e||"").match(/(\d+)$/);return t?Number(t[1]):0}function ne(e,t){let i=0;return e.filter(c=>t.test(c)).forEach(c=>{const r=c.name.match(t);if(!r)return;const d=Number(r[1]);Number.isNaN(d)||(i=Math.max(i,d))}),i}function We(e,t,i){if(Array.from(e.getElementsByTagName("Override")).some(d=>d.getAttribute("PartName")===t))return;const r=e.createElement("Override");r.setAttribute("PartName",t),r.setAttribute("ContentType",i),e.documentElement.appendChild(r)}function re(e,t){if(!t)return null;if(t.startsWith("/"))return t.slice(1);const i=e.split("/");i.pop();const c=t.split("/");for(const r of c)if(r==="..")i.pop();else{if(r===".")continue;i.push(r)}return i.join("/")}function Z(e,t){const i=e.split("/");i.pop();const c=t.split("/");let r=0;for(;r<i.length&&r<c.length&&i[r]===c[r];)r++;const d=i.length-r,f=[];for(let m=0;m<d;m++)f.push("..");return f.push(...c.slice(r)),f.join("/")}function Fe(e){const t=e.match(/^(.*\/)([^/]*?)(\d+)(\.[^.]+)$/);return t?{dir:t[1],prefix:t[2],number:Number(t[3]),ext:t[4]}:null}function q(e,t,i){const c=Number(e[t]||0);i>c&&(e[t]=i)}function ze(e,t){const c=Number(e[t]||0)+1;return e[t]=c,c}function B(e,t){if(!e)return null;const i=e.file(t);return Array.isArray(i)?i.length?i[0]:null:i||null}function ae(e){const t=e.lastIndexOf("/"),i=t>=0?e.slice(0,t+1):"",c=t>=0?e.slice(t+1):e;return`${i}_rels/${c}.rels`}function _t(e,t){if(!e||!t)return{contentType:"",fromOverride:!1,extension:""};const i=`/${t}`,r=Array.from(e.getElementsByTagName("Override")).find(h=>h.getAttribute("PartName")===i);if(r)return{contentType:r.getAttribute("ContentType")||"",fromOverride:!0,extension:t.split(".").pop()||""};const d=Array.from(e.getElementsByTagName("Default")),f=t.split(".").pop()||"",m=d.find(h=>h.getAttribute("Extension")===f);return m?{contentType:m.getAttribute("ContentType")||"",fromOverride:!1,extension:f}:{contentType:"",fromOverride:!1,extension:f}}function Bt(e,t,i){if(!i||Array.from(e.getElementsByTagName("Default")).some(f=>f.getAttribute("Extension")===i))return;const r=Array.from(t?.getElementsByTagName?.("Default")||[]).find(f=>f.getAttribute("Extension")===i);if(!r)return;const d=e.createElement("Default");d.setAttribute("Extension",i),d.setAttribute("ContentType",r.getAttribute("ContentType")||""),e.documentElement.appendChild(d)}function Ot(e){return e?!/xml|text|application\/(.*\+xml)/i.test(e):!1}function Kt(e){const t=/(.*\D)(\d+)(\.\w+)$/,i=e&&e.match(t);if(i){const[,c,,r]=i;return d=>`${c}${d}${r}`}return c=>`slides/slide${c}.xml`}async function Xt(e){const t="ppt/presentation.xml",i=B(e,t);if(!i)throw new Error("Base PPTX missing ppt/presentation.xml");const c=await i.async("string"),r=J(c),d=r.getElementsByTagNameNS(U,"sldIdLst")[0]||r.getElementsByTagName("p:sldIdLst")[0],m=(d?Array.from(d.getElementsByTagNameNS(U,"sldId")).concat(Array.from(d.getElementsByTagName("p:sldId"))):[]).reduce((g,w)=>{const j=Number(w.getAttribute("id"));return Number.isNaN(j)?g:Math.max(g,j)},255),h="ppt/_rels/presentation.xml.rels",T=B(e,h);if(!T)throw new Error("Base PPTX missing ppt/_rels/presentation.xml.rels");const y=await T.async("string"),v=J(y),u=Array.from(v.getElementsByTagName("Relationship")),A=u.reduce((g,w)=>{const j=_(w.getAttribute("Id"));return Math.max(g,j)},0),D=u.filter(g=>(g.getAttribute("Type")||"").endsWith("/slide")),S=D.length&&D[0].getAttribute("Target")||"",N=Kt(S),M=r.getElementsByTagNameNS(U,"sldMasterIdLst")[0]||r.getElementsByTagName("p:sldMasterIdLst")[0]||null,$=(M?Array.from(M.getElementsByTagNameNS(U,"sldMasterId")).concat(Array.from(M.getElementsByTagName("p:sldMasterId"))):[]).reduce((g,w)=>{const j=Number(w.getAttribute("id"));return Number.isNaN(j)?g:Math.max(g,j)},2147483647),W=r.getElementsByTagNameNS(U,"notesMasterIdLst")[0]||r.getElementsByTagName("p:notesMasterIdLst")[0]||null;let O=null;const V=u.find(g=>(g.getAttribute("Type")||"").endsWith("/notesMaster"));if(V){const g=V.getAttribute("Target")||"";O=re("ppt/presentation.xml",g)}let G=null;const oe=u.find(g=>(g.getAttribute("Type")||"").endsWith("/theme"));if(oe){const g=oe.getAttribute("Target")||"";G=re("ppt/presentation.xml",g)}const F="[Content_Types].xml",Q=B(e,F);if(!Q)throw new Error("Base PPTX missing [Content_Types].xml");const ge=await Q.async("string"),de=J(ge),k={};e.filter(()=>!0).forEach(g=>{const w=Fe(g.name);if(!w)return;const j=`${w.dir}${w.prefix}`;q(k,j,w.number)}),q(k,"ppt/slides/slide",ne(e,/^ppt\/slides\/slide(\d+)\.xml$/)),q(k,"ppt/notesSlides/notesSlide",ne(e,/^ppt\/notesSlides\/notesSlide(\d+)\.xml$/)),q(k,"ppt/slideMasters/slideMaster",ne(e,/^ppt\/slideMasters\/slideMaster(\d+)\.xml$/)),q(k,"ppt/slideLayouts/slideLayout",ne(e,/^ppt\/slideLayouts\/slideLayout(\d+)\.xml$/)),q(k,"ppt/theme/theme",ne(e,/^ppt\/theme\/theme(\d+)\.xml$/)),q(k,"ppt/notesMasters/notesMaster",ne(e,/^ppt\/notesMasters\/notesMaster(\d+)\.xml$/)),q(k,"ppt/media/image",ne(e,/^ppt\/media\/image(\d+)\.[^.]+$/));const K=e.file(/^ppt\/slides\/slide\d+\.xml$/).sort((g,w)=>_(g.name)-_(w.name));let X="",L="",ee="";if(K.length){const g=K[0],w=B(e,ae(g.name));if(w){const j=J(await w.async("string")),z=Array.from(j.getElementsByTagName("Relationship")).find(R=>(R.getAttribute("Type")||"").endsWith("/slideLayout"));if(z){X=z.getAttribute("Target")||"";const R=re(g.name,X);R&&B(e,R)&&(L=R)}}}if(L)!X&&K.length&&(X=Z(K[0].name,L));else{const g=e.file(/^ppt\/slideLayouts\/.*\.xml$/).sort((w,j)=>_(w.name)-_(j.name));g.length&&(L=g[0].name,X=K.length?Z(K[0].name,L):"../slideLayouts/slideLayout1.xml")}if(L){const g=B(e,ae(L));if(g){const w=J(await g.async("string")),H=Array.from(w.getElementsByTagName("Relationship")).find(z=>(z.getAttribute("Type")||"").endsWith("/slideMaster"));if(H){const z=H.getAttribute("Target")||"",R=re(L,z);R&&B(e,R)&&(ee=R)}}}if(!ee){const g=e.file(/^ppt\/slideMasters\/.*\.xml$/).sort((w,j)=>_(w.name)-_(j.name));g.length&&(ee=g[0].name)}if(!O){const g=e.file(/^ppt\/notesMasters\/.*\.xml$/).sort((w,j)=>_(w.name)-_(j.name));g.length&&(O=g[0].name)}return{zip:e,presentationXmlPath:t,presentationDoc:r,sldIdList:d,sldMasterList:M,notesMasterList:W,presentationRelsPath:h,presentationRelsDoc:v,contentTypesPath:F,contentTypesDoc:de,nextSlideId:m,nextRelId:A,nextMasterId:$,counters:k,partMap:new Map,masterRelMap:new Map,notesMasterRelMap:new Map,getSlideTarget:N,defaultLayoutTarget:X,defaultLayoutPath:L,defaultMasterPath:ee,defaultNotesMasterPath:O,defaultThemePath:G}}function Ut(e,t,i){const c=e.presentationRelsDoc.documentElement,r=e.presentationRelsDoc.createElement("Relationship");r.setAttribute("Id",i),r.setAttribute("Type","http://schemas.openxmlformats.org/officeDocument/2006/relationships/slide");const d=e.getSlideTarget?e.getSlideTarget(t):`slides/slide${t}.xml`;r.setAttribute("Target",d),c.appendChild(r)}function Wt(e,t){const i=e.presentationDoc,c=e.sldIdList||(()=>{const d=i.createElementNS(U,"p:sldIdLst");return i.documentElement.appendChild(d),e.sldIdList=d,d})(),r=i.createElementNS(U,"p:sldId");e.nextSlideId+=1,r.setAttribute("id",String(e.nextSlideId)),r.setAttributeNS(xe,"r:id",t),c.appendChild(r)}function Ft(e,t){if(e.masterRelMap.has(t))return e.masterRelMap.get(t);const i=e.presentationDoc,c=e.presentationRelsDoc;let r=e.sldMasterList;if(!r){r=i.createElementNS(U,"p:sldMasterIdLst");const h=i.documentElement.firstChild;h?i.documentElement.insertBefore(r,h):i.documentElement.appendChild(r),e.sldMasterList=r}e.nextMasterId=Number(e.nextMasterId||2147483647),e.nextMasterId+=1,e.nextRelId+=1;const d=`rId${e.nextRelId}`,f=i.createElementNS(U,"p:sldMasterId");f.setAttribute("id",String(e.nextMasterId)),f.setAttributeNS(xe,"r:id",d),r.appendChild(f);const m=c.createElement("Relationship");return m.setAttribute("Id",d),m.setAttribute("Type","http://schemas.openxmlformats.org/officeDocument/2006/relationships/slideMaster"),m.setAttribute("Target",Z("ppt/presentation.xml",t)),c.documentElement.appendChild(m),e.masterRelMap.set(t,d),d}function zt(e,t){if(e.notesMasterRelMap.has(t))return e.notesMasterRelMap.get(t);const i=e.presentationDoc,c=e.presentationRelsDoc;let r=e.notesMasterList;if(!r){r=i.createElementNS(U,"p:notesMasterIdLst");const h=i.documentElement,T=e.sldIdList||h.firstChild;T?h.insertBefore(r,T):h.appendChild(r),e.notesMasterList=r}e.nextRelId+=1;const d=`rId${e.nextRelId}`,f=i.createElementNS(U,"p:notesMasterId");f.setAttributeNS(xe,"r:id",d),r.appendChild(f);const m=c.createElement("Relationship");return m.setAttribute("Id",d),m.setAttribute("Type","http://schemas.openxmlformats.org/officeDocument/2006/relationships/notesMaster"),m.setAttribute("Target",Z("ppt/presentation.xml",t)),c.documentElement.appendChild(m),e.notesMasterRelMap.set(t,d),d}async function me(e,t,i,c,r,d={}){if(!r)return null;const f=`${c}:${r}`;if(e.partMap.has(f))return e.partMap.get(f);const m=_t(i,r),h=B(t,r);if(!h)return null;if(m.contentType===Ct&&e.defaultLayoutPath)return e.partMap.set(f,e.defaultLayoutPath),e.defaultLayoutPath;if(m.contentType===ke&&e.defaultMasterPath)return e.partMap.set(f,e.defaultMasterPath),e.defaultMasterPath;if(m.contentType===_e&&e.defaultNotesMasterPath)return e.partMap.set(f,e.defaultNotesMasterPath),e.defaultNotesMasterPath;if(m.contentType===$t&&e.defaultThemePath)return e.partMap.set(f,e.defaultThemePath),e.defaultThemePath;const T=Fe(r);let y;if(T){const D=`${T.dir}${T.prefix}`,S=ze(e.counters,D);y=`${T.dir}${T.prefix}${S}${T.ext}`}else{if(B(e.zip,r))return e.partMap.set(f,r),r;y=r}e.partMap.set(f,y),m.fromOverride?We(e.contentTypesDoc,`/${y}`,m.contentType):m.extension&&Bt(e.contentTypesDoc,i,m.extension);const v=await h.async(Ot(m.contentType)?"uint8array":"string");e.zip.file(y,v);const u=ae(r),A=B(t,u);if(A){const D=await A.async("string"),S=J(D),N=Array.from(S.getElementsByTagName("Relationship"));for(const P of N){if((P.getAttribute("TargetMode")||"").toLowerCase()==="external")continue;const W=P.getAttribute("Target")||"",O=re(r,W);if(!O)continue;let V=null;if(typeof d.relationshipMutator=="function"){const F=await d.relationshipMutator({node:P,type:P.getAttribute("Type")||"",absolutePath:O,newPartPath:y,originalPartPath:r});if(F===!1)continue;F&&F.targetPath&&(V=F.targetPath)}const G=V||await me(e,t,i,c,O);if(!G)continue;const oe=Z(y,G);P.setAttribute("Target",oe)}const M=ae(y);e.zip.file(M,ce(S))}return m.contentType===ke?Ft(e,y):m.contentType===_e&&zt(e,y),y}async function Yt(e,t,i,c,r,d){const f=ae(r),m=B(t,f);if(!m)return;const h=await m.async("string"),T=J(h),y=Array.from(T.getElementsByTagName("Relationship")),v=T.documentElement;let u=!1,A=y.reduce((S,N)=>{const M=N.getAttribute("Id")||"";return Math.max(S,_(M))},0);for(const S of y){const N=S.getAttribute("Type")||"",M=S.getAttribute("Target")||"";if(!M)continue;const P=re(r,M);if(P){if(N.endsWith("/slideLayout")){e.defaultLayoutTarget?u?v.removeChild(S):(u=!0,S.setAttribute("Target",e.defaultLayoutTarget)):u?v.removeChild(S):u=!0;continue}if(N.endsWith("/notesSlide")){const $=await me(e,t,i,c,P,{relationshipMutator:({type:W})=>W.endsWith("/slide")?{targetPath:d}:null});if(!$)continue;S.setAttribute("Target",Z(d,$))}else if(N.includes("/image")||N.includes("/audio")||N.includes("/video")){const $=await me(e,t,i,c,P);if(!$)continue;S.setAttribute("Target",Z(d,$))}else{const $=await me(e,t,i,c,P);if(!$)continue;S.setAttribute("Target",Z(d,$))}}}if(!u&&e.defaultLayoutTarget){const S=T.createElement("Relationship"),N=`rId${A+1||1}`;S.setAttribute("Id",N),S.setAttribute("Type","http://schemas.openxmlformats.org/officeDocument/2006/relationships/slideLayout"),S.setAttribute("Target",e.defaultLayoutTarget),v.appendChild(S)}const D=ae(d);e.zip.file(D,ce(T))}async function Ht(e,t,i){const c=t.file(/^ppt\/slides\/slide\d+\.xml$/).sort((f,m)=>{const h=_(f.name),T=_(m.name);return h-T});if(!c.length)return;const r=B(t,"[Content_Types].xml");if(!r)throw new Error("Source PPTX missing [Content_Types].xml");const d=J(await r.async("string"));for(const f of c){const m=ze(e.counters,"ppt/slides/slide"),h=`ppt/slides/slide${m}.xml`,T=await f.async("string");e.zip.file(h,T),We(e.contentTypesDoc,`/${h}`,Lt),e.nextRelId+=1;const y=`rId${e.nextRelId}`;Ut(e,m,y),Wt(e,y);const v=f.name;e.partMap.set(`${i}:${v}`,h),await Yt(e,t,d,i,v,h)}}function qt(e){e.zip.file(e.presentationXmlPath,ce(e.presentationDoc)),e.zip.file(e.presentationRelsPath,ce(e.presentationRelsDoc)),e.zip.file(e.contentTypesPath,ce(e.contentTypesDoc))}function Jt(e,t){const i=document.createElement("a");i.href=URL.createObjectURL(e),i.download=t,i.rel="noopener",i.click(),URL.revokeObjectURL(i.href)}async function Zt(e=[],t="Setlist"){if(!Array.isArray(e)||e.length===0)throw new Error("No PPTX files to merge");const i=(await ye(async()=>{const{default:y}=await import("./jszip.min-BzspKW9F.js").then(v=>v.j);return{default:y}},__vite__mapDeps([0,1,2]),import.meta.url)).default,[c,...r]=e,d=await Be(c),f=await i.loadAsync(d),m=await Xt(f);for(let y=0;y<r.length;y++){const v=await Be(r[y]),u=await i.loadAsync(v);await Ht(m,u,`src${y+1}`)}qt(m);const h=await f.generateAsync({type:"blob"}),T=kt(t||"Setlist");Jt(h,`${T}.pptx`)}function Vt(e){const t=e||"/";return t.endsWith("/")?t:`${t}/`}function Gt(e){return e?e.slug?e.slug:e.filename?e.filename.replace(/\.chordpro$/i,""):e.title?e.title.trim().toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_.-]/g,""):"":""}async function Qt(e={},t={}){const{name:i="Setlist",songs:c=[]}=e||{},{availablePptxMap:r=null,baseUrl:d="./",onEmpty:f}=t,m=Vt(d),h=[];for(const T of c){const y=Gt(T);y&&(r&&!r[y]||h.push(`${m}pptx/${y}.pptx`))}if(!h.length){typeof f=="function"&&f();return}await Zt(h,i)}let Oe;const Ke=()=>Oe||(Oe=ye(()=>import("./index-DrXv61UL.js").then(e=>e.i),__vite__mapDeps([3,1,2]),import.meta.url));function en(){try{if(typeof crypto<"u"&&crypto.randomUUID)return crypto.randomUUID()}catch{}return`sel-${Math.random().toString(36).slice(2)}${Date.now().toString(36)}`}function Ye(e){if(!e)return null;const{id:t,toKey:i=""}=e;return t==null?null:{uid:en(),id:t,toKey:i}}function fe(e=[]){return e.map(t=>Ye(t)).filter(Boolean)}function sn(){const{code:e,songIds:t}=rt(),i=at(),c=ot(),[r,d]=b.useState("New Setlist"),[f,m]=b.useState(""),[h,T]=b.useState([]),[y,v]=b.useState(()=>{try{return localStorage.getItem("pref:icpOnly")==="1"}catch{return!1}});b.useEffect(()=>{try{localStorage.setItem("pref:icpOnly",y?"1":"0")}catch{}},[y]);const[u,A]=b.useState([]),[D,S]=b.useState({}),[N,M]=b.useState(""),[P,$]=b.useState("");Object.keys(D).length;const[W,O]=b.useState(!1),[V,G]=b.useState(()=>{try{return window.innerWidth<=640}catch{return!1}}),[oe,F]=b.useState(()=>{try{return window.innerWidth<=820}catch{return!1}}),[Q,ge]=b.useState(()=>{try{return window.innerWidth<=900}catch{return!1}}),de=b.useRef(""),k=b.useRef(""),[K,X]=b.useState(null),[L,ee]=b.useState(()=>le()),[g,w]=b.useState(""),[j,H]=b.useState(!1),[z,R]=b.useState("");b.useEffect(()=>{const n=lt?.items||[],a=new Set,l=[];for(const o of n)a.has(o.id)||(a.add(o.id),l.push(o));T(l)},[]),b.useEffect(()=>{let n=!1;async function a(){const l={};for(const o of u){const p=h.find(se=>se.id===o.id);if(!p)continue;const x=p.filename.replace(/\.chordpro$/i,""),I=`./pptx/${x}.pptx`;await bt(I,x)&&(l[x]=!0)}n||S(l)}return a(),()=>{n=!0}},[u,h]),b.useEffect(()=>{try{const n=document.documentElement,a=document.body;de.current=n.style.overflowY||"",k.current=a.style.overflowY||"",getComputedStyle(n).overflowY==="hidden"&&(n.style.overflowY=""),getComputedStyle(a).overflowY==="hidden"&&(a.style.overflowY="")}catch{}return()=>{try{document.documentElement.style.overflowY=de.current,document.body.style.overflowY=k.current}catch{}}},[]),b.useEffect(()=>{if(!e)return;const{entries:n,error:a}=ct(e);if(a){alert(a),c("/setlist",{replace:!0});return}const l=n.map(x=>({id:x.id,toKey:x.toKey}));A(fe(l));const o=l.map(x=>x.id).join(","),p=l.map(x=>encodeURIComponent(x.toKey||"")).join(",");c(`/setlist/${o}?toKeys=${p}`,{replace:!0})},[e]),b.useEffect(()=>{if(!t)return;const n=(t||"").split(",").map(p=>p.trim()).filter(Boolean);if(!n.length)return;const l=(new URLSearchParams(i.search||"").get("toKeys")||"").split(",").map(p=>decodeURIComponent(p)).filter(Boolean),o=n.map((p,x)=>({id:p,toKey:l[x]||""}));A(fe(o))},[t,i.search]),b.useEffect(()=>{try{if(!Array.isArray(u))return;if(u.length===0){(e||t)&&c("/setlist",{replace:!0});return}const n=u.map(p=>p.id).join(","),a=u.map(p=>encodeURIComponent(p.toKey||"")).join(","),l=t||"",o=new URLSearchParams(i.search||"").get("toKeys")||"";(n!==l||a!==o)&&c(`/setlist/${n}?toKeys=${a}`,{replace:!0})}catch{}},[u.map(n=>`${n.id}:${n.toKey}`).join("|"),t,i.search,e]),b.useEffect(()=>{try{const n=localStorage.getItem("setlist");if(!n||le().length>0)return;const a=JSON.parse(n);if(a?.name||(a?.list?.length||0)>0){const l=De({name:a.name||"Imported Set",items:a.list||[]});ee(le()),X(l.id),d(l.name),A(fe(l.items||[])),w(l.id)}}catch{}},[]),b.useEffect(()=>{function n(){try{const a=window.innerWidth;G(a<=640),F(a<=820),ge(a<=900)}catch{}}return window.addEventListener("resize",n),()=>window.removeEventListener("resize",n)},[]);const ue=b.useMemo(()=>new dt(h,{keys:["title","tags"],threshold:.4}),[h]);function He(n){return!y||(Array.isArray(n.tags)?n.tags.includes("ICP"):n.tags==="ICP")}const qe=b.useMemo(()=>(f?ue.search(f).map(a=>a.item):h.slice().sort((a,l)=>a.title.localeCompare(l.title))).filter(He),[f,ue,h,y]);function we(n){if(!n)return;const a=Ye({id:n.id,toKey:n.originalKey||n.key||"C"});A(l=>[...l,a])}function Je(n){A(a=>a.filter(l=>l.uid!==n))}function be(n,a){A(l=>{const o=l.findIndex(C=>C.uid===n);if(o<0)return l;const p=o+(a==="up"?-1:1);if(p<0||p>=l.length)return l;const x=l.slice(),[I]=x.splice(o,1);return x.splice(p,0,I),x})}function Ze(n,a){A(l=>{if(a<0||a>=l.length)return l;const o=l.findIndex(I=>I.uid===n);if(o<0||o===a)return l;const p=l.slice(),[x]=p.splice(o,1);return p.splice(a,0,x),p})}function Ve(n,a){A(l=>l.map(o=>o.uid===n?{...o,toKey:a}:o))}function Te(n){ee(le()),w(n||"")}function Se(){X(null),d("New Setlist"),A([]),w("")}function Ge(){const n=r?.trim()||"New Setlist",a=window.prompt("Save set as:",n);if(a===null)return;const l=String(a).trim()||"New Setlist";let o=K;if(!o){const I=(le()||[]).find(C=>(C.name||"")===l);I&&(o=I.id)}const p=u.map(({id:I,toKey:C})=>({id:I,toKey:C})),x=De({id:o,name:l,items:p});d(x.name),X(x.id),Te(x.id)}function Qe(){const n=z||g||"";if(!n){H(!1);return}const a=At(n);a&&(X(a.id),d(a.name||"New Setlist"),A(fe(a.items||[])),w(a.id)),H(!1)}function et(){const n=L[0]?.id||"";R(g||n),H(!0)}function tt(){K&&window.confirm(`Delete set "${r}"? This cannot be undone.`)&&(Mt(K),Se(),Te(""))}async function Ne(){O(!0);try{const{downloadMultiSongPdf:n}=await Ke(),a=[];for(const l of u){const o=h.find(p=>p.id===l.id);if(o)try{const p=`./songs/${o.filename}`,x=await Tt(p),I=St(x),C=I.meta?.key||I.meta?.originalkey||o.originalKey||"C",se=Nt(C,l.toKey||C),nt=(I.sections||[]).map(Ee=>({section:Ee.label,lines:(Ee.lines||[]).map(te=>te.instrumental?{instrumental:Pt(te.instrumental,se)}:te.comment?{plain:te.comment,chordPositions:[],comment:te.comment}:{plain:te.lyrics||"",chordPositions:(te.chords||[]).map(ve=>({sym:jt(ve.sym,se),index:ve.index}))})})),st=o.filename.replace(/\.chordpro$/i,""),it=It({title:I.meta?.title||o.title||st,key:l.toKey||C,capo:I.meta?.capo,lyricsBlocks:nt});a.push(it)}catch(p){console.error(p),Y(`Failed to process ${o.filename}`)}}a.length&&await n(a)}finally{O(!1)}}function pe(){Ke()}async function Pe(){try{const n=u.map(p=>p.id).join(","),a=u.map(p=>encodeURIComponent(p.toKey||"")).join(","),o=`${(()=>{try{if(typeof window<"u"&&window.location){const p=window.location.origin||"",x="./".replace(/^\./,"");return`${p}${x}`.replace(/\/+$/,"/")}}catch{}return""})()}#/setlist/${n}?toKeys=${a}`;await navigator.clipboard.writeText(o);try{Y?.("Link copied!")}catch{}}catch{alert("Failed to copy link")}}async function je(){if(P)return;M(`Bundling 0/${u.length}…`);const n=(await ye(async()=>{const{default:o}=await import("./jszip.min-BzspKW9F.js").then(p=>p.j);return{default:o}},__vite__mapDeps([0,1,2]),import.meta.url)).default,a=new n;let l=0;for(let o=0;o<u.length;o++){const p=u[o],x=h.find(C=>C.id===p.id);if(!x){M(`Bundling ${o+1}/${u.length}…`);continue}M(`Bundling ${o+1}/${u.length}…`);const I=x.filename.replace(/\.chordpro$/i,"");if(D[I])try{const C=await fetch(`./pptx/${I}.pptx`);if(!C.ok)continue;const se=await C.blob();l++,a.file(`${String(l).padStart(2,"0")}-${I}.pptx`,se)}catch{}}if(l>0){const o=await a.generateAsync({type:"blob"}),p=new Date().toISOString().slice(0,10).replace(/-/g,""),x=document.createElement("a");x.href=URL.createObjectURL(o),x.download=`setlist-pptx-${p}.zip`,x.click(),URL.revokeObjectURL(x.href)}else try{Y&&Y("No PPTX files found for selected songs")||alert("No PPTX files found for selected songs")}catch{}M("")}async function Ie(){if(!(N||P)){$("Combining…");try{const n=[],a=[];for(const l of u){const o=h.find(x=>x.id===l.id);if(!o)continue;const p=o.filename.replace(/\.chordpro$/i,"");if(!D[p]){a.push(o.title||p);continue}n.push(o)}if(!n.length){try{Y&&Y("No PPTX files found for selected songs")||alert("No PPTX files found for selected songs")}catch{}return}if(a.length){const l=a.length===1?`${a[0]} PPT file unavailable`:`${a.length} songs missing PPT files`;try{Y?.(l)}catch{}}await Qt({name:r||"Setlist",songs:n},{baseUrl:"./"})}catch(n){console.error(n);try{Y&&Y("Failed to combine PPTX files")||alert("Failed to combine PPTX files")}catch{}}finally{$("")}}}return s.jsxs(Et,{className:"is-setlist",children:[j?s.jsx("div",{style:{position:"fixed",inset:0,display:"flex",alignItems:"center",justifyContent:"center",background:"rgba(0,0,0,.45)",zIndex:90},role:"dialog","aria-modal":"true",children:s.jsxs("div",{style:{background:"var(--card)",color:"var(--text)",border:"1px solid var(--line)",borderRadius:10,padding:16,width:"min(560px, 92vw)"},children:[s.jsx("h3",{style:{marginTop:0,marginBottom:8},children:"Load Set"}),L.length?s.jsxs("label",{style:{display:"block",margin:"8px 0"},children:["Select a saved set",s.jsx("select",{value:z,onChange:n=>R(n.target.value),style:{width:"100%"},children:L.map(n=>s.jsxs("option",{value:n.id,children:[n.name," · ",new Date(n.updatedAt).toLocaleString()]},n.id))})]}):s.jsx("div",{className:"meta",children:"No saved sets yet."}),s.jsxs("div",{className:"row",style:{justifyContent:"flex-end",gap:8,marginTop:12},children:[s.jsx(E,{onClick:()=>H(!1),children:"Cancel"}),s.jsx(E,{variant:"primary",onClick:Qe,disabled:!L.length,children:"Load"})]})]})}):null,s.jsx(ut,{busy:W}),s.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginTop:12,marginBottom:4},children:[s.jsx("div",{}),s.jsx("h1",{style:{margin:0},children:"Setlist Builder"}),s.jsx("div",{})]}),V?s.jsx(Ae,{className:"card",style:{marginTop:8,position:"static"},children:s.jsxs("div",{className:"setlist-actions--mobile",style:{width:"100%"},children:[s.jsx(E,{variant:"primary",onClick:Ne,onMouseEnter:pe,onFocus:pe,disabled:W||u.length===0,title:"Export set as a single PDF",iconLeft:s.jsx(ie,{}),children:"PDF"}),s.jsx(E,{onClick:Ie,disabled:u.length===0||!!N||!!P,title:u.length===0?"Add songs to combine PPTX files":"Combine PPTX files into a single presentation",iconLeft:s.jsx(ie,{}),children:P||"Export PPT"}),s.jsx(E,{onClick:je,disabled:u.length===0||!!N||!!P,title:u.length===0?"Add songs to export PPTX bundle":"Export PPTX bundle (ZIP) for selected songs",iconLeft:s.jsx(ie,{}),children:"PPT ZIP"}),s.jsx(E,{onClick:Pe,title:"Copy shareable link",iconLeft:s.jsx(Me,{}),disabled:u.length===0,children:"Share"}),s.jsx(E,{as:Le,to:u.length?`/worship/${u.map(n=>n.id).join(",")}?toKeys=${u.map(n=>encodeURIComponent(n.toKey)).join(",")}`:"/worship",title:"Open Worship Mode",iconLeft:s.jsx(Ce,{}),children:"Worship"})]})}):s.jsxs(Ae,{className:"card",style:{marginTop:8,position:"static"},children:[s.jsx("div",{style:{width:"100%",marginBottom:6},children:s.jsx("strong",{title:"Current set name",children:r||"New Setlist"})}),s.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",flexWrap:"wrap",width:"100%"},children:[s.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"},children:[s.jsxs(E,{size:"sm",variant:"secondary",onClick:Ge,title:"Save set",iconLeft:s.jsx(pt,{}),children:[" ",s.jsx("span",{className:"text-when-wide",children:"Save"})]}),s.jsxs(E,{size:"sm",variant:"secondary",onClick:et,title:"Load saved set",iconLeft:s.jsx(ft,{}),disabled:!L.length,children:[" ",s.jsx("span",{className:"text-when-wide",children:"Load"})]}),s.jsxs(E,{size:"sm",variant:"secondary",onClick:Se,title:"New set",iconLeft:s.jsx($e,{}),children:[" ",s.jsx("span",{className:"text-when-wide",children:"New"})]}),s.jsxs(E,{size:"sm",variant:"secondary",onClick:tt,disabled:!K,title:"Delete set",iconLeft:s.jsx(mt,{}),children:[" ",s.jsx("span",{className:"text-when-wide",children:"Delete"})]}),s.jsxs(E,{size:"sm",variant:"secondary",onClick:Pe,title:"Copy shareable link",iconLeft:s.jsx(Me,{}),disabled:u.length===0,children:[" ",s.jsx("span",{className:"text-when-wide",children:"Share Set"})]})]}),s.jsxs("div",{style:{marginLeft:"auto",display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"},children:[s.jsx(E,{variant:"primary",size:"md",onClick:Ne,onMouseEnter:pe,onFocus:pe,disabled:W||u.length===0,title:"Export set as a single PDF",iconLeft:s.jsx(ie,{}),children:W?"Exporting…":s.jsxs(s.Fragment,{children:[s.jsx("span",{className:"text-when-wide",children:"Export PDF"}),s.jsx("span",{className:"text-when-narrow",children:"PDF"})]})}),s.jsx(E,{variant:"primary",size:"md",onClick:Ie,disabled:u.length===0||!!N||!!P,title:u.length===0?"Add songs to combine PPTX files":"Combine PPTX files into a single presentation",iconLeft:s.jsx(ie,{}),children:P||s.jsxs(s.Fragment,{children:[s.jsx("span",{className:"text-when-wide",children:"Export PPT"}),s.jsx("span",{className:"text-when-narrow",children:"Export PPT"})]})}),s.jsx(E,{variant:"primary",size:"md",onClick:je,disabled:u.length===0||!!N||!!P,title:u.length===0?"Add songs to export PPTX bundle":"Export PPTX bundle (ZIP) for selected songs",iconLeft:s.jsx(ie,{}),children:N||s.jsxs(s.Fragment,{children:[s.jsx("span",{className:"text-when-wide",children:"PPT ZIP"}),s.jsx("span",{className:"text-when-narrow",children:"PPT ZIP"})]})}),s.jsxs(E,{variant:"primary",size:"md",as:Le,to:u.length?`/worship/${u.map(n=>n.id).join(",")}?toKeys=${u.map(n=>encodeURIComponent(n.toKey)).join(",")}`:"/worship",title:"Open Worship Mode",iconLeft:s.jsx(Ce,{}),children:[" ",s.jsx("span",{className:"text-when-wide",children:"Worship Mode"}),s.jsx("span",{className:"text-when-narrow",children:"Worship"})]})]})]})]}),s.jsxs("div",{className:"BuilderPage",style:{marginTop:8},children:[s.jsx("div",{className:"BuilderLeft",children:s.jsx("section",{className:"setlist-section setlist-add","data-role":"add",children:s.jsxs("div",{className:"card setlist-pane",children:[s.jsxs("div",{className:["BuilderHeader","section-header",Q?"no-sticky":""].filter(Boolean).join(" "),style:{display:"flex",alignItems:"center",gap:8},children:[s.jsx("strong",{style:{whiteSpace:"nowrap"},children:"Add songs"}),s.jsx(ht,{value:f,onChange:n=>m(n.target.value),placeholder:"Search...",style:{flex:1,minWidth:0}}),s.jsxs("label",{className:"row",style:{gap:6,alignItems:"center"},children:[s.jsx("input",{type:"checkbox",checked:y,onChange:n=>v(n.target.checked)}),s.jsx("span",{className:"meta",title:"Limit results to songs tagged ICP",children:"ICP only"})]})]}),s.jsx("div",{className:["BuilderScroll","setlist-scroll","setlist-list",Q?"no-pane-scroll":"pane-scroll","pane--addSongs"].join(" "),children:ue?s.jsx("div",{style:{display:"grid",gap:".5rem",gridTemplateColumns:"repeat(auto-fill, minmax(320px, 1fr))",marginTop:6},children:qe.map(n=>s.jsx(Re,{title:n.title,subtitle:`${n.originalKey||""}${n.tags?.length?` • ${n.tags.join(", ")}`:""}`,rightSlot:s.jsx(E,{"aria-label":"Add",title:"Add to set",variant:"primary",iconLeft:s.jsx($e,{}),iconOnly:!0,onClick:a=>{a.stopPropagation(),we(n)}}),onClick:()=>we(n)},n.id))}):s.jsx("div",{children:"Loading search…"})})]})})}),s.jsx("div",{className:"BuilderRight",style:{minHeight:0,display:"flex",flexDirection:"column"},children:s.jsxs("section",{className:"setlist-section setlist-current","data-role":"current",children:[s.jsxs("div",{className:"card setlist-pane",children:[s.jsx("div",{className:["BuilderHeader","section-header",Q?"no-sticky":""].filter(Boolean).join(" "),children:s.jsxs("strong",{children:["Current setlist (",u.length,")"]})}),s.jsx("div",{className:["BuilderScroll","setlist-scroll","setlist-list",Q?"no-pane-scroll":"pane-scroll","pane--currentSet"].join(" "),style:{marginTop:6},children:u.map((n,a)=>{const l=h.find(o=>o.id===n.id);return l?s.jsx(Re,{draggable:!0,onDragStart:o=>{o.dataTransfer.setData("text/plain",String(n.uid||n.id)),o.dataTransfer.effectAllowed="move"},onDragOver:o=>{o.preventDefault(),o.dataTransfer.dropEffect="move"},onDrop:o=>{o.preventDefault();const p=o.dataTransfer.getData("text/plain");Ze(p,a)},title:l.title,subtitle:`Original: ${l.originalKey||"—"}`,rightSlot:s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6},children:[s.jsx(gt,{variant:"ui",baseKey:l.originalKey||"C",valueKey:n.toKey||l.originalKey||"C",onChange:o=>Ve(n.uid,o)}),s.jsx(E,{onClick:()=>be(n.uid,"up"),title:"Move up",iconLeft:s.jsx(yt,{})}),s.jsx(E,{onClick:()=>be(n.uid,"down"),title:"Move down",iconLeft:s.jsx(xt,{})}),s.jsx(E,{onClick:()=>Je(n.uid),title:"Remove",iconLeft:s.jsx(wt,{}),iconOnly:!0,style:{color:"#b91c1c"}})]})},n.uid||`${n.id}-${a}`):null})})]}),s.jsxs("div",{className:"print-only",style:{marginTop:16},children:[s.jsx("h2",{style:{fontSize:"20pt",margin:"0 0 8pt 0"},children:r}),s.jsx("ol",{style:{fontSize:"12pt",lineHeight:1.4,paddingLeft:"1.2em"},children:u.map((n,a)=>{const l=h.find(o=>o.id===n.id);return l?s.jsxs("li",{children:[l.title," — ",n.toKey||l.originalKey||"—"]},n.uid||`${n.id}-${a}`):null})})]})]})})]})]})}export{sn as default};
