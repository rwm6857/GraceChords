import{c as A}from"./index-CH1NwEcj.js";function X(t,c,n="normal"){return o=>s=>(t.setFont(c,n),t.setFontSize(o),t.getTextWidth(s||""))}function N(t,c=3){if(!Array.isArray(t)||t.length<2)return t;t.sort((s,e)=>s.x-e.x);let n=!0,o=0;for(;n&&o<10;){n=!1,o++;for(let s=1;s<t.length;s++){const e=t[s-1],i=t[s];if(e.x+e.w>i.x){const l=e.x+e.w-i.x,r=Math.min(c,Math.ceil(l/2));e.x-=r,i.x+=r,n=!0}}}return t.sort((s,e)=>s.x-e.x),t}function F(t){if(!t)return{meta:{title:"Untitled",key:"C"},sections:[]};if(t.meta&&Array.isArray(t.sections)){const c={title:t.meta.title||t.title||"Untitled",key:t.meta.key||t.key||"C",capo:t.meta.capo,meta:t.meta.meta},n=(t.sections||[]).map(o=>({kind:o.kind||"verse",label:o.label,lines:(o.lines||[]).map(s=>({lyrics:s.comment?s.comment:s.lyrics||s.plain||s.text||"",chords:(s.chords||s.chordPositions||[]).map(e=>({index:e.index||0,sym:e.sym})),comment:s.comment}))}));return{meta:c,sections:n,layoutHints:t.layoutHints}}if(t.lyricsBlocks){const c=(t.lyricsBlocks||[]).map(n=>({kind:"verse",label:n.section,lines:(n.lines||[]).map(o=>({lyrics:o.comment?o.comment:o.plain||o.text||"",chords:(o.chordPositions||[]).map(s=>({index:s.index||0,sym:s.sym})),comment:o.comment}))}));return{meta:{title:t.title||"Untitled",key:t.key||t.originalKey||"C",capo:t.capo},sections:c}}if(Array.isArray(t==null?void 0:t.blocks)){const c=[];let n={kind:"verse",label:"",lines:[]};for(const o of t.blocks)o.type==="section"?(n.lines.length&&c.push(n),n={kind:"verse",label:o.header,lines:[]}):o.type==="line"&&n.lines.push({lyrics:o.lyrics||o.text||"",chords:(o.chords||[]).map(s=>({index:s.index||0,sym:s.sym}))});return n.lines.length&&c.push(n),{meta:{title:t.title||"Untitled",key:t.key||t.originalKey||"C"},sections:c}}if(typeof t=="string")return A(t);if(t!=null&&t.body||t!=null&&t.lines){const c=(t.body||(Array.isArray(t.lines)?t.lines.join(`
`):""))+"";return A(c)}return{meta:{title:t.title||"Untitled",key:t.key||t.originalKey||"C"},sections:[]}}const v={lyricSizePt:16,chordSizePt:16,margin:36,gutter:24,headerOffsetY:40,columns:1,pageWidth:612,pageHeight:792,lyricFamily:"Helvetica",chordFamily:"Courier",title:"Untitled",key:"C"},R=6;function K(t,c){const n=[],o=Math.round(c*.85),s=Math.max(10,c-2);for(const e of t.columns||[]){let i=0,l=null;for(const r of e.blocks||[])r.type==="section"?(l==="line"&&(i+=4),i+=o+c+4,l="section"):r.type==="line"&&(r.comment?i+=s+3:(r.chords&&r.chords.length&&(i+=c+2),i+=c+4),l="line");l==="line"&&(i+=4),n.push(i)}return n}function E(t,c,n,o){const s=t.h,e=c+n,i=s-c-e,l=o.columns,r=o.lyricSizePt,g=o.layout.pages[0],a=K(g,r),d=i;let m=1;if(l===2){const T=a[0]||0,w=a[1]||0;m=1-Math.abs(T-w)/d}const z=(a[0]||0)+(a[1]||0),f=l===2?z/(2*d):(a[0]||0)/d;let p=0;l===2&&(a[1]||0)/d<.18&&(p+=20),f>.98&&(p+=5),l===1&&f<.45&&(p+=2);const y=r,k=l===2?2:0;return{score:y*100+m*10-p-k,occupancy:f,balance:m}}function I(t,c,n,o,s,e){const i=o.margin,l=o.pageWidth-i*2,g=(c===2?(l-o.gutter)/2:l)-R,a=s(n),d=e(n);for(const m of t.sections||[])for(const z of m.lines||[]){const f=z.lyrics||"";if(a(f)>g)return!0;for(const p of z.chords||[]){const y=a(f.slice(0,p.index||0)),k=d(p.sym||"");if(y+k>g)return!0}}return!1}function L(t,c={},n=()=>()=>0,o=()=>()=>0){var p;const s=F(t),e={...v,...c,gutter:v.gutter},i=[16,15,14,13,12],l=((p=s.layoutHints)==null?void 0:p.requestedColumns)===2,r={h:e.pageHeight},g=e.margin,a=e.headerOffsetY;let d=null;for(const y of i){const k=Y(s,{...e,columns:1,lyricSizePt:y,chordSizePt:y},n(y),o(y)),S={...e,columns:1,lyricSizePt:y,chordSizePt:y,layout:k},T=!I(s,1,y,e,n,o);if(j(S)&&T){const H=E(r,g,a,S);S.occupancy=H.occupancy,S.balance=H.balance,d={score:H.score,plan:S}}const w=Y(s,{...e,columns:2,lyricSizePt:y,chordSizePt:y},n(y),o(y)),P={...e,columns:2,lyricSizePt:y,chordSizePt:y,layout:w},x=!I(s,2,y,e,n,o);if(j(P)&&x){const H=E(r,g,a,P);let C=H.score;l&&(C+=.5),P.occupancy=H.occupancy,P.balance=H.balance,(!d||C>d.score)&&(d={score:C,plan:P})}if(d)return{plan:d.plan}}const m=12;let z=Y(s,{...e,columns:1,lyricSizePt:m,chordSizePt:m},n(m),o(m)),f={...e,columns:1,lyricSizePt:m,chordSizePt:m,layout:z};return Z(f)||(z=Y(s,{...e,columns:2,lyricSizePt:m,chordSizePt:m},n(m),o(m)),f={...e,columns:2,lyricSizePt:m,chordSizePt:m,layout:z}),{plan:f}}function j(t){var c,n;return((n=(c=t==null?void 0:t.layout)==null?void 0:c.pages)==null?void 0:n.length)===1}function Z(t){var c,n;return(((n=(c=t==null?void 0:t.layout)==null?void 0:c.pages)==null?void 0:n.length)||99)<=2}function Y(t,c={},n=s=>0,o=s=>0){var _,B;const s=F(t),e={...v,...c,gutter:v.gutter},i=4,l=e.lyricSizePt,r=Math.round(e.lyricSizePt*.85),g=Math.max(10,e.lyricSizePt-2),a=e.margin,d=e.pageHeight,m=e.pageWidth-a*2,z=e.columns===2?(m-e.gutter)/2:m,f=a+e.headerOffsetY,p=d-a,y=p-f,k=[];let S={columns:[]};k.push(S);function T(){const u={x:a,yStart:f,blocks:[]};if(S.columns.push(u),e.columns===2){const h={x:a+z+e.gutter,yStart:f,blocks:[]};S.columns.push(h)}}function w(){S={columns:[]},k.push(S)}S.columns.length===0&&T();let P=0,x=f;const H=()=>S.columns[P],C=()=>{e.columns===2&&P===0?(P=1,x=f):(w(),T(),P=0,x=f)},D=u=>{var O;let h=r+l+4;for(const b of u.lines||[])b.comment?h+=g+3:((O=b==null?void 0:b.chords)!=null&&O.length&&(h+=e.chordSizePt+i/2),h+=e.lyricSizePt+i);return h+4},G=u=>{var h;return u.comment?g+3:((h=u==null?void 0:u.chords)!=null&&h.length?e.chordSizePt+i/2:0)+e.lyricSizePt+i},M=(u,h)=>{u.blocks.push({type:"section",header:h})},q=(u,h,O,b)=>{if(b){u.blocks.push({type:"line",comment:b});return}const W=O.map(U=>({x:n(h.slice(0,U.index||0)),w:o(U.sym||""),sym:U.sym}));N(W),u.blocks.push({type:"line",lyrics:h,chords:W})};for(let u=0;u<(s.sections||[]).length;u++){const h=s.sections[u],O=D(h);(B=(_=s.layoutHints)==null?void 0:_.columnBreakAfter)!=null&&B.includes(u)&&O<=y&&x!==f?C():O>y?(x!==f||e.columns===2&&P===1)&&C():x+O>p&&C();const b=H();x+=r,M(b,h.label||h.kind),x+=l+4;for(const W of h.lines||[])q(b,W.lyrics||"",W.chords||[],W.comment),x+=G(W);x+=4}return{pages:k}}function J(t,c){const n={...v,...c};n.pageWidth=612,n.pageHeight=792;const o=e=>e?e.length*(n.lyricSizePt*.6):0;return Y(F(t),n,o,o).pages.map((e,i)=>({p:i,cols:e.columns.map((l,r)=>({c:r,blocks:l.blocks.map(g=>({t:g.type,h:g.type==="section"&&g.header||null,line:g.type==="line"?{text:g.lyrics,chords:(g.chords||[]).map(a=>({x:Number(a.x.toFixed(2)),s:a.sym}))}:null}))}))}))}function Q(t,c){const n=F(t),o={...v,...c};o.pageWidth=612,o.pageHeight=792;const s=l=>r=>r?r.length*(l*.6):0,e=l=>r=>r?r.length*(l*.6):0,{plan:i}=L(n,o,s,e);return{columns:i.columns,size:i.lyricSizePt,pages:i.layout.pages.length}}const $=Object.freeze(Object.defineProperty({__proto__:null,DEFAULT_LAYOUT_OPT:v,chooseBestLayout:L,columnHeights:K,getLayoutMetrics:J,normalizeSongInput:F,planForTest:Q,planSongLayout:Y},Symbol.toStringTag,{value:"Module"}));export{v as D,K as a,$ as b,L as c,X as m,F as n,Y as p};
