const k=[16,15,14,13,12],y=()=>{var e;try{return typeof window<"u"&&((e=window.localStorage)==null?void 0:e.getItem("pdfPlanTrace"))==="1"}catch{return!1}};function F(e){if(typeof(e==null?void 0:e.measureSectionsForPt)=="function")return e.measureSectionsForPt;if(Array.isArray(e==null?void 0:e.sections)&&typeof(e==null?void 0:e.measureSectionAtPt)=="function"){const n=e.sections,i=e.measureSectionAtPt;return u=>n.map((r,t)=>{const c=i(r,u);return{id:(c==null?void 0:c.id)??(r==null?void 0:r.id)??t+1,height:(c==null?void 0:c.height)??(c==null?void 0:c.h)??0,type:(c==null?void 0:c.type)??(r==null?void 0:r.type)}})}return null}const P=(e,n)=>{y()&&e.push(n)},S=(e,n)=>{y()&&n.length&&(console.groupCollapsed(`[pdfPlanTrace] ${e}`),console.table(n),console.groupEnd())};function $(e,n,i,u={}){const r=!!u.honorColumnBreaks,t=new Array(n).fill(0),c=Array.from({length:n},()=>[]);let a=0,f="";if(!Array.isArray(e))return{singlePage:!1,colHeights:t,occupancy:t.map(()=>0),balance:1,reasonRejected:"no_sections_provided",placed:c};const d=l=>{if(a+1>=n)return!1;const o=e[l];return o?o.height<=i-t[a+1]:!1};for(let l=0;l<e.length;l++){const o=e[l];if(r&&o.type==="column_break"){d(l+1)&&(a+=1);continue}const h=i-t[a];if(o.height<=h)c[a].push(o.id),t[a]+=o.height;else if(a+1<n){a+=1;const s=i-t[a];if(o.height<=s)c[a].push(o.id),t[a]+=o.height;else return f=`section ${o.id} needs ${Math.ceil(o.height)}pt > remaining ${Math.floor(s)}pt in col ${a+1}`,{singlePage:!1,colHeights:t,occupancy:t.map(g=>g/i),balance:n===2?1-Math.abs(t[0]-t[1])/i:1,reasonRejected:f,placed:c}}else return f=`section ${o.id} needs ${Math.ceil(o.height)}pt > remaining ${Math.floor(h)}pt in col ${a+1}`,{singlePage:!1,colHeights:t,occupancy:t.map(s=>s/i),balance:n===2?1-Math.abs(t[0]-t[1])/i:1,reasonRejected:f,placed:c}}return{singlePage:!0,colHeights:t,occupancy:t.map(l=>l/i),balance:n===2?1-Math.abs(t[0]-t[1])/i:1,reasonRejected:void 0,placed:c}}function M({pt:e,cols:n,balance:i,occupancy:u,hasColumnsHint:r}){let t=0;n===2&&Math.min(...u)<.18&&(t+=50),u.some(a=>a>.98)&&(t+=5),r&&n===2&&(t-=3);const c=e*100+i*10-t-(n===2?2:0);return{penalties:t,finalScore:c}}function j({measuredSections:e,measureSectionsForPt:n,sections:i,measureSectionAtPt:u,pageContentHeight:r,hasColumnsHint:t=!1,honorColumnBreaks:c=!0,ptWindow:a=k}){const f=[],d=[],l=n||F({measureSectionsForPt:n,sections:i,measureSectionAtPt:u});for(const o of a){const h=r;for(const s of[1,2]){const g=typeof l=="function"?l(o):e,p=$(g,s,h,{honorColumnBreaks:c}),b={pt:o,cols:s,singlePage:p.singlePage,colHeights:p.colHeights.map(m=>Math.round(m)),occupancy:p.occupancy.map(m=>Number(m.toFixed(2))),balance:Number(p.balance.toFixed(2))};if(!p.singlePage){P(f,{...b,penalties:"",finalScore:"",reasonRejected:p.reasonRejected});continue}const{penalties:_,finalScore:A}=M({pt:o,cols:s,balance:p.balance,occupancy:p.occupancy,hasColumnsHint:t});d.push({pt:o,cols:s,pack:p,penalties:_,finalScore:A});const C=p.reasonRejected||(g?"rejected":"no_measurements_for_pt");P(f,{...b,penalties:"",finalScore:"",reasonRejected:C})}}if(d.length){d.sort((s,g)=>g.finalScore-s.finalScore);const o=d[0];S("Single‑page candidate scan (16→12pt, 1/2 columns)",f);const h=y()?`Plan: ${o.cols} col • ${o.pt}pt • singlePage=yes • occ=${JSON.stringify(o.pack.occupancy.map(s=>s.toFixed(2)))} • bal=${o.pack.balance.toFixed(2)}`:"";return{...o,debugFooter:h}}return S("No single‑page candidates; falling back to multi‑page 12pt",f),{multipage:!0,pt:12,reason:"no_single_page"}}const O=Object.freeze({honorColumnBreaks:!0,hasColumnsHint:!1,ptWindow:k.slice()});function T(e){return e}function x(e,n,i,u={}){return $(e,n,i,u).colHeights}function w(e){const n=j(e);return n.multipage?n:{pt:n.pt,cols:n.cols,singlePage:!0,occupancy:n.pack.occupancy,balance:n.pack.balance,debugFooter:n.debugFooter,placed:n.pack.placed,colHeights:n.pack.colHeights}}function R(e){return w(e)}export{O as DEFAULT_LAYOUT_OPT,w as chooseBestLayout,j as chooseBestPlan,x as columnHeights,T as normalizeSongInput,R as planSongLayout};
