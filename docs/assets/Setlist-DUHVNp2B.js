const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-C2UC5Wxb.js","./index-Bo_CfB2t.js","./index-Wri8gDRg.css","./jszip.min-Dw4rQAkp.js"])))=>i.map(i=>d[i]);
import{r as u,i as yt,F as jt,j as e,B as St,L as bt,S as F,K as vt,A as wt,a as Ct,R as kt,D as z,h as Nt,t as H,_ as X,f as $t,p as It,s as Kt,n as Pt,b as Tt}from"./index-Bo_CfB2t.js";const Y="gracechords.sets.v1";function N(){try{const i=localStorage.getItem(Y);return i?JSON.parse(i):{sets:{}}}catch{return{sets:{}}}}function q(i){localStorage.setItem(Y,JSON.stringify(i))}function _t(){return typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():"id-"+Math.random().toString(36).slice(2)+Date.now().toString(36)}function C(){const{sets:i}=N();return Object.values(i).sort((a,m)=>(m.updatedAt||0)-(a.updatedAt||0))}function G(i){const{sets:a}=N();return a[i]||null}function k(i){var d;const a=Date.now(),m={id:i.id||_t(),name:((d=i.name)==null?void 0:d.trim())||"Untitled Set",items:Array.isArray(i.items)?i.items:[],createdAt:i.createdAt||a,updatedAt:a},S=N();return S.sets[m.id]=m,q(S),m}function At(i){const a=N();return a.sets[i]?(delete a.sets[i],q(a),!0):!1}function Dt(i){const a=G(i);return a?k({name:`Copy of ${a.name}`,items:a.items.map(m=>({...m}))}):null}let J;const V=()=>J||(J=X(()=>import("./index-C2UC5Wxb.js").then(i=>i.i),__vite__mapDeps([0,1,2]),import.meta.url));function Et(){const[i,a]=u.useState("Untitled Set"),[m,S]=u.useState(""),[d,Q]=u.useState([]),[l,p]=u.useState([]),[T,W]=u.useState({}),[$,b]=u.useState(""),_=Object.keys(T).length,[I,A]=u.useState(!1),[g,x]=u.useState(null),[Z,D]=u.useState(()=>C()),[tt,v]=u.useState("");u.useEffect(()=>{var t;Q(((t=yt)==null?void 0:t.items)||[])},[]),u.useEffect(()=>{let t=!1;async function s(){const n={};for(const o of l){const c=d.find(h=>h.id===o.id);if(!c)continue;const r=`./pptx/${c.id}.pptx`;await Nt(r,c.id)&&(n[c.id]=!0)}t||W(n)}return s(),()=>{t=!0}},[l,d]),u.useEffect(()=>{var t;try{const s=localStorage.getItem("setlist");if(!s||C().length>0)return;const n=JSON.parse(s);if(n!=null&&n.name||(((t=n==null?void 0:n.list)==null?void 0:t.length)||0)>0){const o=k({name:n.name||"Imported Set",items:n.list||[]});D(C()),x(o.id),a(o.name),p(o.items||[]),v(o.id)}}catch{}},[]);const K=u.useMemo(()=>new jt(d,{keys:["title","tags"],threshold:.4}),[d]),et=u.useMemo(()=>m?K.search(m).map(t=>t.item):d.slice().sort((t,s)=>t.title.localeCompare(s.title)),[m,K,d]);function nt(t){l.find(s=>s.id===t.id)||p([...l,{id:t.id,toKey:t.originalKey||"C"}])}function st(t){p(l.filter(s=>s.id!==t))}function L(t,s){const n=l.findIndex(f=>f.id===t);if(n<0)return;const o=n+(s==="up"?-1:1);if(o<0||o>=l.length)return;const c=l.slice(),[r]=c.splice(n,1);c.splice(o,0,r),p(c)}function it(t,s){p(l.map(n=>n.id===t?{...n,toKey:s}:n))}function E(t){p(s=>s.map(n=>{const o=d.find(r=>r.id===n.id),c=n.toKey||(o==null?void 0:o.originalKey)||"C";return{...n,toKey:H(c,t)}}))}function ot(){p(t=>t.map(s=>{const n=d.find(o=>o.id===s.id);return{...s,toKey:(n==null?void 0:n.originalKey)||"C"}}))}function w(t){D(C()),v(t||"")}function U(){x(null),a("Untitled Set"),p([]),v("")}function at(){const t=(i==null?void 0:i.trim())||"Untitled Set",s=k({id:g,name:t,items:l});a(s.name),x(s.id),w(s.id)}function lt(t){const s=t.target.value;if(v(s),!s)return;const n=G(s);n&&(x(n.id),a(n.name||"Untitled Set"),p(n.items||[]))}function rt(){if(!g){const s=`Copy of ${i||"Untitled Set"}`,n=k({id:null,name:s,items:l});a(n.name),x(n.id),w(n.id);return}const t=Dt(g);t&&(x(t.id),a(t.name),p(t.items||[]),w(t.id))}function ct(){g&&window.confirm(`Delete set "${i}"? This cannot be undone.`)&&(At(g),U(),w(""))}async function dt(){var t,s,n,o;A(!0);try{const{downloadMultiSongPdf:c}=await V(),r=[];for(const f of l){const h=d.find(y=>y.id===f.id);if(h)try{const y=`./songs/${h.filename}`,pt=await $t(y),j=It(pt),P=((t=j.meta)==null?void 0:t.key)||((s=j.meta)==null?void 0:s.originalkey)||h.originalKey||"C",ft=Kt(P,f.toKey||P),ht=(j.blocks||[]).map(R=>({section:R.section,lines:(R.lines||[]).map(B=>({plain:B.text,chordPositions:(B.chords||[]).map(M=>({sym:H(M.sym,ft),index:M.index}))}))})),gt=h.filename.replace(/\.chordpro$/i,""),xt=Pt({title:((n=j.meta)==null?void 0:n.title)||h.title||gt,key:f.toKey||P,capo:(o=j.meta)==null?void 0:o.capo,lyricsBlocks:ht});r.push(xt)}catch(y){console.error(y),Tt(`Failed to process ${h.filename}`)}}r.length&&await c(r)}finally{A(!1)}}function O(){V()}async function ut(){b(`Bundling 0/${l.length}…`);const t=(await X(async()=>{const{default:o}=await import("./jszip.min-Dw4rQAkp.js").then(c=>c.j);return{default:o}},__vite__mapDeps([3,1,2]),import.meta.url)).default,s=new t;let n=0;for(let o=0;o<l.length;o++){const c=l[o],r=d.find(f=>f.id===c.id);if(!r){b(`Bundling ${o+1}/${l.length}…`);continue}if(b(`Bundling ${o+1}/${l.length}…`),!!T[r.id])try{const f=await fetch(`./pptx/${r.id}.pptx`);if(!f.ok)continue;const h=await f.blob();n++,s.file(`${String(n).padStart(2,"0")}-${r.id}.pptx`,h)}catch{}}if(n>0){const o=await s.generateAsync({type:"blob"}),c=new Date().toISOString().slice(0,10).replace(/-/g,""),r=document.createElement("a");r.href=URL.createObjectURL(o),r.download=`setlist-pptx-${c}.zip`,r.click(),URL.revokeObjectURL(r.href)}b("")}function mt(){window.print()}return e.jsxs("div",{className:"container",children:[e.jsx(St,{busy:I}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx("div",{children:e.jsx(bt,{to:"/",className:"back",children:"← Back"})}),e.jsx("h1",{style:{margin:0},children:"Setlist Builder"}),e.jsx("div",{})]}),e.jsxs("div",{className:"card toolbar",style:{marginTop:12},children:[e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx("span",{children:"Set:"}),e.jsx("input",{"aria-label":"Set name",value:i,onChange:t=>a(t.target.value),style:{minWidth:220},placeholder:"Sunday AM"})]}),e.jsxs("select",{"aria-label":"Saved sets",value:tt,onChange:lt,children:[e.jsx("option",{value:"",children:"— Load saved set —"}),Z.map(t=>e.jsxs("option",{value:t.id,children:[t.name," · ",new Date(t.updatedAt).toLocaleString()]},t.id))]}),e.jsx("button",{className:"btn",onClick:U,children:"New"}),e.jsx("button",{className:"btn primary",onClick:at,children:"Save"}),e.jsx("button",{className:"btn",onClick:rt,disabled:!l.length,children:"Duplicate"}),e.jsx("button",{className:"btn",onClick:ct,disabled:!g,children:"Delete"}),e.jsxs("div",{style:{marginLeft:"auto",display:"flex",alignItems:"center",gap:6},children:[e.jsx("span",{className:"meta",children:"Transpose:"}),e.jsx("button",{className:"btn",onClick:()=>E(-1),title:"Transpose set down 1 semitone",children:"–1"}),e.jsx("button",{className:"btn",onClick:ot,title:"Reset all to originals",children:"Reset"}),e.jsx("button",{className:"btn",onClick:()=>E(1),title:"Transpose set up 1 semitone",children:"+1"})]})]}),e.jsxs("div",{className:"card",style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12},children:[e.jsx("div",{children:e.jsxs("div",{style:{marginTop:8},children:[e.jsx("strong",{children:"Add songs"}),e.jsx("input",{value:m,onChange:t=>S(t.target.value),placeholder:"Search...",style:{display:"block",width:"100%",marginTop:6}}),e.jsx("div",{style:{minHeight:0,maxHeight:300,overflow:"auto",marginTop:6},children:K?et.map(t=>{var s;return e.jsx(F,{title:t.title,subtitle:`${t.originalKey||""}${(s=t.tags)!=null&&s.length?` • ${t.tags.join(", ")}`:""}`,rightSlot:e.jsx("button",{className:"btn",onClick:()=>nt(t),children:"Add"})},t.id)}):e.jsx("div",{children:"Loading search…"})})]})}),e.jsxs("div",{children:[e.jsxs("strong",{children:["Current setlist (",l.length,")"]}),e.jsx("div",{style:{minHeight:0,maxHeight:360,overflow:"auto",marginTop:6},children:l.map(t=>{const s=d.find(n=>n.id===t.id);return s?e.jsx(F,{title:s.title,subtitle:`Original: ${s.originalKey||"—"}`,rightSlot:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx("select",{value:t.toKey,onChange:n=>it(t.id,n.target.value),children:vt.map(n=>e.jsx("option",{value:n,children:n},n))}),e.jsx("button",{className:"btn",onClick:()=>L(t.id,"up"),title:"Move up",children:e.jsx(wt,{})}),e.jsx("button",{className:"btn",onClick:()=>L(t.id,"down"),title:"Move down",children:e.jsx(Ct,{})}),e.jsx("button",{className:"btn",onClick:()=>st(t.id),title:"Remove",children:e.jsx(kt,{})})]})},t.id):null})}),e.jsxs("div",{style:{display:"flex",gap:8,marginTop:8},children:[e.jsx("button",{className:"btn primary iconbtn",onClick:dt,onMouseEnter:O,onFocus:O,disabled:I,children:I?"Exporting…":e.jsxs(e.Fragment,{children:[e.jsx(z,{})," Export PDF"]})}),e.jsx("button",{className:"btn iconbtn",onClick:ut,disabled:_===0||!!$,title:_===0?"No PPTX files found for this set.":"",children:$||e.jsxs(e.Fragment,{children:[e.jsx(z,{})," Bundle PPTX"]})}),e.jsx("button",{className:"btn",onClick:mt,children:"Print"}),e.jsx("button",{className:"btn",onClick:()=>p([]),children:"Clear"})]}),e.jsxs("div",{className:"print-only",style:{marginTop:16},children:[e.jsx("h2",{style:{fontSize:"20pt",margin:"0 0 8pt 0"},children:i}),e.jsx("ol",{style:{fontSize:"12pt",lineHeight:1.4,paddingLeft:"1.2em"},children:l.map(t=>{const s=d.find(n=>n.id===t.id);return s?e.jsxs("li",{children:[s.title," — ",t.toKey||s.originalKey||"—"]},t.id):null})})]})]})]})]})}export{Et as default};
