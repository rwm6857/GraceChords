const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-qoMu-8da.js","./index-BZvpzKCj.js","./index-B-kUmedf.css","./fonts-OQpvcT7Z.js","./pdfLayout-DHUdxPSD.js","./jszip.min-Bs66evrk.js"])))=>i.map(i=>d[i]);
import{r as u,i as gt,F as xt,j as e,B as yt,L as jt,S as M,K as St,A as bt,a as vt,R as wt,D as F,h as Ct,t as H,_ as V,f as kt,p as Nt,s as $t,b as Kt}from"./index-BZvpzKCj.js";const X="gracechords.sets.v1";function k(){try{const o=localStorage.getItem(X);return o?JSON.parse(o):{sets:{}}}catch{return{sets:{}}}}function Y(o){localStorage.setItem(X,JSON.stringify(o))}function Pt(){return typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():"id-"+Math.random().toString(36).slice(2)+Date.now().toString(36)}function w(){const{sets:o}=k();return Object.values(o).sort((a,p)=>(p.updatedAt||0)-(a.updatedAt||0))}function q(o){const{sets:a}=k();return a[o]||null}function C(o){var d;const a=Date.now(),p={id:o.id||Pt(),name:((d=o.name)==null?void 0:d.trim())||"Untitled Set",items:Array.isArray(o.items)?o.items:[],createdAt:o.createdAt||a,updatedAt:a},y=k();return y.sets[p.id]=p,Y(y),p}function It(o){const a=k();return a.sets[o]?(delete a.sets[o],Y(a),!0):!1}function Tt(o){const a=q(o);return a?C({name:`Copy of ${a.name}`,items:a.items.map(p=>({...p}))}):null}let z;const J=()=>z||(z=V(()=>import("./index-qoMu-8da.js"),__vite__mapDeps([0,1,2,3,4]),import.meta.url));function At(){const[o,a]=u.useState("Untitled Set"),[p,y]=u.useState(""),[d,G]=u.useState([]),[l,f]=u.useState([]),[I,Q]=u.useState({}),[N,j]=u.useState(""),T=Object.keys(I).length,[$,_]=u.useState(!1),[g,x]=u.useState(null),[W,A]=u.useState(()=>w()),[Z,S]=u.useState("");u.useEffect(()=>{var t;G(((t=gt)==null?void 0:t.items)||[])},[]),u.useEffect(()=>{let t=!1;async function s(){const n={};for(const i of l){const r=d.find(h=>h.id===i.id);if(!r)continue;const c=`./pptx/${r.id}.pptx`;await Ct(c,r.id)&&(n[r.id]=!0)}t||Q(n)}return s(),()=>{t=!0}},[l,d]),u.useEffect(()=>{var t;try{const s=localStorage.getItem("setlist");if(!s||w().length>0)return;const n=JSON.parse(s);if(n!=null&&n.name||(((t=n==null?void 0:n.list)==null?void 0:t.length)||0)>0){const i=C({name:n.name||"Imported Set",items:n.list||[]});A(w()),x(i.id),a(i.name),f(i.items||[]),S(i.id)}}catch{}},[]);const K=u.useMemo(()=>new xt(d,{keys:["title","tags"],threshold:.4}),[d]),tt=u.useMemo(()=>p?K.search(p).map(t=>t.item):d.slice().sort((t,s)=>t.title.localeCompare(s.title)),[p,K,d]);function et(t){l.find(s=>s.id===t.id)||f([...l,{id:t.id,toKey:t.originalKey||"C"}])}function nt(t){f(l.filter(s=>s.id!==t))}function D(t,s){const n=l.findIndex(m=>m.id===t);if(n<0)return;const i=n+(s==="up"?-1:1);if(i<0||i>=l.length)return;const r=l.slice(),[c]=r.splice(n,1);r.splice(i,0,c),f(r)}function st(t,s){f(l.map(n=>n.id===t?{...n,toKey:s}:n))}function L(t){f(s=>s.map(n=>{const i=d.find(c=>c.id===n.id),r=n.toKey||(i==null?void 0:i.originalKey)||"C";return{...n,toKey:H(r,t)}}))}function it(){f(t=>t.map(s=>{const n=d.find(i=>i.id===s.id);return{...s,toKey:(n==null?void 0:n.originalKey)||"C"}}))}function b(t){A(w()),S(t||"")}function E(){x(null),a("Untitled Set"),f([]),S("")}function ot(){const t=(o==null?void 0:o.trim())||"Untitled Set",s=C({id:g,name:t,items:l});a(s.name),x(s.id),b(s.id)}function at(t){const s=t.target.value;if(S(s),!s)return;const n=q(s);n&&(x(n.id),a(n.name||"Untitled Set"),f(n.items||[]))}function lt(){if(!g){const s=`Copy of ${o||"Untitled Set"}`,n=C({id:null,name:s,items:l});a(n.name),x(n.id),b(n.id);return}const t=Tt(g);t&&(x(t.id),a(t.name),f(t.items||[]),b(t.id))}function rt(){g&&window.confirm(`Delete set "${o}"? This cannot be undone.`)&&(It(g),E(),b(""))}async function ct(){var t,s,n;_(!0);try{const{downloadMultiSongPdf:i}=await J(),r=[];for(const c of l){const m=d.find(h=>h.id===c.id);if(m)try{const h=`./songs/${m.filename}`,mt=await kt(h),v=Nt(mt),P=((t=v.meta)==null?void 0:t.key)||((s=v.meta)==null?void 0:s.originalkey)||m.originalKey||"C",pt=$t(P,c.toKey||P),ft=(v.blocks||[]).map(O=>({section:O.section,lines:(O.lines||[]).map(R=>({plain:R.text,chordPositions:(R.chords||[]).map(B=>({sym:H(B.sym,pt),index:B.index}))}))})),ht=m.filename.replace(/\.chordpro$/i,"");r.push({title:((n=v.meta)==null?void 0:n.title)||m.title||ht,key:c.toKey||P,lyricsBlocks:ft})}catch(h){console.error(h),Kt(`Failed to process ${m.filename}`)}}r.length&&await i(r)}finally{_(!1)}}function U(){J()}async function dt(){j(`Bundling 0/${l.length}…`);const t=(await V(async()=>{const{default:i}=await import("./jszip.min-Bs66evrk.js").then(r=>r.j);return{default:i}},__vite__mapDeps([5,1,2]),import.meta.url)).default,s=new t;let n=0;for(let i=0;i<l.length;i++){const r=l[i],c=d.find(m=>m.id===r.id);if(!c){j(`Bundling ${i+1}/${l.length}…`);continue}if(j(`Bundling ${i+1}/${l.length}…`),!!I[c.id])try{const m=await fetch(`./pptx/${c.id}.pptx`);if(!m.ok)continue;const h=await m.blob();n++,s.file(`${String(n).padStart(2,"0")}-${c.id}.pptx`,h)}catch{}}if(n>0){const i=await s.generateAsync({type:"blob"}),r=new Date().toISOString().slice(0,10).replace(/-/g,""),c=document.createElement("a");c.href=URL.createObjectURL(i),c.download=`setlist-pptx-${r}.zip`,c.click(),URL.revokeObjectURL(c.href)}j("")}function ut(){window.print()}return e.jsxs("div",{className:"container",children:[e.jsx(yt,{busy:$}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx("div",{children:e.jsx(jt,{to:"/",className:"back",children:"← Back"})}),e.jsx("h1",{style:{margin:0},children:"Setlist Builder"}),e.jsx("div",{})]}),e.jsxs("div",{className:"card toolbar",style:{marginTop:12},children:[e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx("span",{children:"Set:"}),e.jsx("input",{"aria-label":"Set name",value:o,onChange:t=>a(t.target.value),style:{minWidth:220},placeholder:"Sunday AM"})]}),e.jsxs("select",{"aria-label":"Saved sets",value:Z,onChange:at,children:[e.jsx("option",{value:"",children:"— Load saved set —"}),W.map(t=>e.jsxs("option",{value:t.id,children:[t.name," · ",new Date(t.updatedAt).toLocaleString()]},t.id))]}),e.jsx("button",{className:"btn",onClick:E,children:"New"}),e.jsx("button",{className:"btn primary",onClick:ot,children:"Save"}),e.jsx("button",{className:"btn",onClick:lt,disabled:!l.length,children:"Duplicate"}),e.jsx("button",{className:"btn",onClick:rt,disabled:!g,children:"Delete"}),e.jsxs("div",{style:{marginLeft:"auto",display:"flex",alignItems:"center",gap:6},children:[e.jsx("span",{className:"meta",children:"Transpose:"}),e.jsx("button",{className:"btn",onClick:()=>L(-1),title:"Transpose set down 1 semitone",children:"–1"}),e.jsx("button",{className:"btn",onClick:it,title:"Reset all to originals",children:"Reset"}),e.jsx("button",{className:"btn",onClick:()=>L(1),title:"Transpose set up 1 semitone",children:"+1"})]})]}),e.jsxs("div",{className:"card",style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12},children:[e.jsx("div",{children:e.jsxs("div",{style:{marginTop:8},children:[e.jsx("strong",{children:"Add songs"}),e.jsx("input",{value:p,onChange:t=>y(t.target.value),placeholder:"Search...",style:{display:"block",width:"100%",marginTop:6}}),e.jsx("div",{style:{minHeight:0,maxHeight:300,overflow:"auto",marginTop:6},children:K?tt.map(t=>{var s;return e.jsx(M,{title:t.title,subtitle:`${t.originalKey||""}${(s=t.tags)!=null&&s.length?` • ${t.tags.join(", ")}`:""}`,rightSlot:e.jsx("button",{className:"btn",onClick:()=>et(t),children:"Add"})},t.id)}):e.jsx("div",{children:"Loading search…"})})]})}),e.jsxs("div",{children:[e.jsxs("strong",{children:["Current setlist (",l.length,")"]}),e.jsx("div",{style:{minHeight:0,maxHeight:360,overflow:"auto",marginTop:6},children:l.map(t=>{const s=d.find(n=>n.id===t.id);return s?e.jsx(M,{title:s.title,subtitle:`Original: ${s.originalKey||"—"}`,rightSlot:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx("select",{value:t.toKey,onChange:n=>st(t.id,n.target.value),children:St.map(n=>e.jsx("option",{value:n,children:n},n))}),e.jsx("button",{className:"btn",onClick:()=>D(t.id,"up"),title:"Move up",children:e.jsx(bt,{})}),e.jsx("button",{className:"btn",onClick:()=>D(t.id,"down"),title:"Move down",children:e.jsx(vt,{})}),e.jsx("button",{className:"btn",onClick:()=>nt(t.id),title:"Remove",children:e.jsx(wt,{})})]})},t.id):null})}),e.jsxs("div",{style:{display:"flex",gap:8,marginTop:8},children:[e.jsx("button",{className:"btn primary iconbtn",onClick:ct,onMouseEnter:U,onFocus:U,disabled:$,children:$?"Exporting…":e.jsxs(e.Fragment,{children:[e.jsx(F,{})," Export PDF"]})}),e.jsx("button",{className:"btn iconbtn",onClick:dt,disabled:T===0||!!N,title:T===0?"No PPTX files found for this set.":"",children:N||e.jsxs(e.Fragment,{children:[e.jsx(F,{})," Bundle PPTX"]})}),e.jsx("button",{className:"btn",onClick:ut,children:"Print"}),e.jsx("button",{className:"btn",onClick:()=>f([]),children:"Clear"})]}),e.jsxs("div",{className:"print-only",style:{marginTop:16},children:[e.jsx("h2",{style:{fontSize:"20pt",margin:"0 0 8pt 0"},children:o}),e.jsx("ol",{style:{fontSize:"12pt",lineHeight:1.4,paddingLeft:"1.2em"},children:l.map(t=>{const s=d.find(n=>n.id===t.id);return s?e.jsxs("li",{children:[s.title," — ",t.toKey||s.originalKey||"—"]},t.id):null})})]})]})]})]})}export{At as default};
